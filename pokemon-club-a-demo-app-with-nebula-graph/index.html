<!DOCTYPE html>
<html lang="default">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/wey_pixel_tinified.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/wey_pixel_tinified.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/wey_pixel_tinified.png">
  <link rel="mask-icon" href="/images/wey_pixel_tinified.png" color="#222">
  <link rel="manifest" href="/images/site.webmanifest">
  <meta name="google-site-verification" content="XgZjCjedxF82a4b0z1Nr0FiopL5MQKta4RZweqPZaBY">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"note.siwei.info","root":"/","images":"/images","scheme":"Gemini","version":"8.2.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":true,"nav":null,"activeClass":"gitalk"},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>
<meta name="description" content="AboutIn the database world, there is one type of NoSQL DB called graph database, which is good at the query of traversing relationships between small entities, like:  Find one person’s 5th-degree frie">
<meta property="og:type" content="article">
<meta property="og:title" content="Pokemon Club, a demo app with Nebula Graph">
<meta property="og:url" content="https://note.siwei.info/pokemon-club-a-demo-app-with-nebula-graph/index.html">
<meta property="og:site_name" content="Siwei Notes">
<meta property="og:description" content="AboutIn the database world, there is one type of NoSQL DB called graph database, which is good at the query of traversing relationships between small entities, like:  Find one person’s 5th-degree frie">
<meta property="og:locale">
<meta property="og:image" content="https://note.siwei.info/pokemon-club-a-demo-app-with-nebula-graph/michael-rivera-DypO_XgAE4Y-unsplash.jpg">
<meta property="og:image" content="https://note.siwei.info/pokemon-club-a-demo-app-with-nebula-graph/graph_schema.png">
<meta property="article:published_time" content="2021-02-21T15:29:50.000Z">
<meta property="article:modified_time" content="2021-02-21T15:29:50.000Z">
<meta property="article:author" content="Wey Gu | 古思为">
<meta property="article:tag" content="Nebula Graph">
<meta property="article:tag" content="NoSQL">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://note.siwei.info/pokemon-club-a-demo-app-with-nebula-graph/michael-rivera-DypO_XgAE4Y-unsplash.jpg">


<link rel="canonical" href="https://note.siwei.info/pokemon-club-a-demo-app-with-nebula-graph/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'default'
  };
</script>
<title>Pokemon Club, a demo app with Nebula Graph | Siwei Notes</title>
  




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Siwei Notes</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">思为笔记</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
        <li class="menu-item menu-item-résumé"><a href="/resume/" rel="section"><i class="fa fa-book fa-fw"></i>Résumé</a></li>
        <li class="menu-item menu-item-简历"><a href="/resume_chs/" rel="section"><i class="fa fa-book fa-fw"></i>简历</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">29</span></a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">4</span></a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">15</span></a></li>
        <li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>Commonweal 404</a></li>
        <li class="menu-item menu-item-links"><a href="/links/" rel="section"><i class="fa fa-link fa-fw"></i>Links</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#About"><span class="nav-number">1.</span> <span class="nav-text">About</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pokemon-Club"><span class="nav-number">2.</span> <span class="nav-text">Pokemon Club</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#The-Hands-on-part"><span class="nav-number">3.</span> <span class="nav-text">The Hands-on part!</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Deployment-of-Nebula-Graph"><span class="nav-number">3.1.</span> <span class="nav-text">Deployment of Nebula Graph</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Nebula-Graph-Schema-and-Mock-Data-Import"><span class="nav-number">3.2.</span> <span class="nav-text">Nebula Graph Schema and Mock Data Import</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Graph-Data-Schema"><span class="nav-number">3.2.1.</span> <span class="nav-text">Graph Data Schema</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Data-Import"><span class="nav-number">3.2.2.</span> <span class="nav-text">Data Import</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Query-the-data-from-Nebula-Graph"><span class="nav-number">3.3.</span> <span class="nav-text">Query the data from Nebula Graph</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#The-API-code-handles-Web-Request-and-Invokes-Nebula-Graph"><span class="nav-number">3.4.</span> <span class="nav-text">The API code handles Web Request and Invokes Nebula Graph</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#More-Working-In-Progress"><span class="nav-number">4.</span> <span class="nav-text">More Working In Progress</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#More-on-Nebula-Graph"><span class="nav-number">5.</span> <span class="nav-text">More on Nebula Graph</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Wey Gu | 古思为"
      src="/images/wey_pixel_tinified.png">
  <p class="site-author-name" itemprop="name">Wey Gu | 古思为</p>
  <div class="site-description" itemprop="description">I build things</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">15</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">29</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/wey-gu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;wey-gu" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:weyl.gu@gmail.com" title="E-Mail → mailto:weyl.gu@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/siweigu" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;siweigu" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/wey_gu" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;wey_gu" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.facebook.com/Weyl.GU" title="FB Page → https:&#x2F;&#x2F;www.facebook.com&#x2F;Weyl.GU" rel="noopener" target="_blank"><i class="fab fa-facebook fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://instagram.com/siwei.gu" title="Instagram → https:&#x2F;&#x2F;instagram.com&#x2F;siwei.gu" rel="noopener" target="_blank"><i class="fab fa-instagram fa-fw"></i></a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="default">
    <link itemprop="mainEntityOfPage" href="https://note.siwei.info/pokemon-club-a-demo-app-with-nebula-graph/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/wey_pixel_tinified.png">
      <meta itemprop="name" content="Wey Gu | 古思为">
      <meta itemprop="description" content="I build things">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Siwei Notes">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Pokemon Club, a demo app with Nebula Graph
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-02-21 23:29:50" itemprop="dateCreated datePublished" datetime="2021-02-21T23:29:50+08:00">2021-02-21</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="About"><a href="#About" class="headerlink" title="About"></a>About</h2><p>In the database world, there is one type of NoSQL DB called graph database, which is good at the query of traversing relationships between small entities, like:</p>
<ul>
<li>Find one person’s 5th-degree friend connections in LinkedIn</li>
<li>Detect fraud, starting from one bank account number, connected to its account address, card owner’s social identity number, and recent bank activities, the all linked relationship graph can be queried in realtime and then checked towards certain fraud pattern</li>
</ul>
<p>Today, I will create a minimal PoC to build one tiny App leveraging a graph database, Nebula Graph.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/vesoft-inc">Nebula Graph</a> is an open-source new graph DB built natively for globally distributed deployment in hyper-scale, with the help of <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Raft_(algorithm)">raft consensus algorithm</a> and architecture of <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Shared-nothing_architecture">shared-nothing</a>, it’s like the <a target="_blank" rel="noopener" href="https://research.google.com/archive/spanner-osdi2012.pdf">Google Spanner</a> or CRDB/TiDB in the graph DB world.</p>
<h2 id="Pokemon-Club"><a href="#Pokemon-Club" class="headerlink" title="Pokemon Club"></a>Pokemon Club</h2><blockquote>
<p>Photo from <a target="_blank" rel="noopener" href="https://unsplash.com/@michaelrivera_ph">Michael Rivera 🇵🇭</a></p>
</blockquote>
<img data-src="/pokemon-club-a-demo-app-with-nebula-graph/michael-rivera-DypO_XgAE4Y-unsplash.jpg" class="pikachu">

<p>Today, let’s build a new SNS for the Pokemon Trainers, the Pokemon Club<del>house</del> ;)</p>
<p>Pokemon Club is targeting to connect all Pokemon Trainers for their meetup or grouping to fight in certain Pokemon Go Gym.</p>
<p>Like FB or Linkedin, we for sure have the User System with relational DB backed and users metadata of age, avatar, location, and Pokemons she owned, etc. Users as a trainer can create meetups and share posts in Pokemon Club and her friends can get the news feed and comment, join or chat to her.</p>
<p>Apart from the main features, we will only focus on one feature to help trainers explore new friends recommended by the App, based on the Pokemons this trainer owns.</p>
<p>Now we assume either in streaming/ real-time or the batch way, we had put trainer and pokemon relationship in our Nebula Graph DB, and then to create a humble API to get the recommended trainer friends:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;v1&#x2F;recommended_friends&#x2F;&lt;user&gt;</span><br><span class="line">     +</span><br><span class="line">     |          +--------------+         +----------------+</span><br><span class="line">     |          |              |         |                |</span><br><span class="line">     +----------&gt;  API Server  +---------&gt;  Nebula Graph  |</span><br><span class="line">                |              |         |                |</span><br><span class="line">                +--------------+         +----------------+</span><br></pre></td></tr></table></figure>

<p>Then let’s start the hands-on part!</p>
<h2 id="The-Hands-on-part"><a href="#The-Hands-on-part" class="headerlink" title="The Hands-on part!"></a>The Hands-on part!</h2><p>Let’s do bottom-up from the Nebula Graph DB:</p>
<h3 id="Deployment-of-Nebula-Graph"><a href="#Deployment-of-Nebula-Graph" class="headerlink" title="Deployment of Nebula Graph"></a>Deployment of Nebula Graph</h3><p>Nebula Graph is released in shapes from <a target="_blank" rel="noopener" href="https://docs.nebula-graph.io/manual-EN/3.build-develop-and-administration/1.build/1.build-source-code/">source code tarball</a>, [RPM/DEB package](RPM/DEB package), <a target="_blank" rel="noopener" href="https://hub.docker.com/r/vesoft/">Docker containers</a>, and <a target="_blank" rel="noopener" href="https://github.com/vesoft-inc/nebula-docker-compose">docker-compose</a> to <a target="_blank" rel="noopener" href="https://github.com/vesoft-inc/nebula/tree/master/kubernetes/helm">helm chart</a> or <a target="_blank" rel="noopener" href="https://medium.com/nebula-graph/nebula-operator-automated-the-nebula-graph-cluster-deployment-and-maintenance-on-k8s-2730987b8c42">a k8s CRD/operator</a>.</p>
<p>Here, we will start with the smallest footprint and the easiest way, the docker-compose fashion referring to <a target="_blank" rel="noopener" href="https://github.com/vesoft-inc/nebula-docker-compose">https://github.com/vesoft-inc/nebula-docker-compose</a>.</p>
<p>Here I spawned a preemptible(cheap, no SLA) VM from GCP for this ad-hoc purpose, with the spec of Intel CPU and 8GiB ram, in a Ubuntu 18.04 LTS image.</p>
<p>Also, I allowed TCP ports of 6996 and 7001 from the firewall setting associated with the VM.</p>
<p>Below is the deployment commands in this machine:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">sudo su -i</span><br><span class="line">apt-get update</span><br><span class="line">apt-get install docker.io docker-compose</span><br><span class="line"></span><br><span class="line"><span class="comment"># deploy a nebula cluster</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/vesoft-inc/nebula-docker-compose.git</span><br><span class="line"><span class="built_in">cd</span> nebula-docker-compose/</span><br><span class="line">docker-compose up -d</span><br><span class="line"></span><br><span class="line">docker ps --filter health=healthy <span class="comment"># wait and verify that 3x graphd, 3x metad, 3x storaged are healthy</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># deploy a nebula Studio</span></span><br><span class="line"><span class="built_in">cd</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/vesoft-inc/nebula-web-docker.git</span><br><span class="line"><span class="built_in">cd</span> nebula-web-docker/v2</span><br><span class="line">docker-compose pull</span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<h3 id="Nebula-Graph-Schema-and-Mock-Data-Import"><a href="#Nebula-Graph-Schema-and-Mock-Data-Import" class="headerlink" title="Nebula Graph Schema and Mock Data Import"></a>Nebula Graph Schema and Mock Data Import</h3><h4 id="Graph-Data-Schema"><a href="#Graph-Data-Schema" class="headerlink" title="Graph Data Schema"></a>Graph Data Schema</h4><p>Here we created the plainest schema with two types(tags) of vertices and two types of edges:</p>
<ul>
<li><p>Vertices:</p>
<ul>
<li>trainer<ul>
<li>property:<ul>
<li>name</li>
<li>…</li>
</ul>
</li>
</ul>
</li>
<li>pokemon<ul>
<li>property:<ul>
<li>name</li>
<li>…</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>Edges:</p>
<ul>
<li>owns_pokemon<ul>
<li>source: trainer</li>
<li>dest: pokemon</li>
</ul>
</li>
<li>is_friend_with<ul>
<li>source: trainer</li>
<li>dest: trainer</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>From the below image, it’s easier for us to understand the schema:</p>
<img data-src="/pokemon-club-a-demo-app-with-nebula-graph/graph_schema.png" class="graph_schema">

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> SPACE pokemon_club (vid_type <span class="operator">=</span> FIXED_STRING(<span class="number">16</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> TAG pokemon (name string <span class="keyword">NOT</span> <span class="keyword">NULL</span> )</span><br><span class="line"><span class="keyword">CREATE</span> TAG trainer (name string <span class="keyword">NOT</span> <span class="keyword">NULL</span> )</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> EDGE owns_pokemon ()</span><br></pre></td></tr></table></figure>

<h4 id="Data-Import"><a href="#Data-Import" class="headerlink" title="Data Import"></a>Data Import</h4><p>For hyper-scale data migration into Nebula Graph, there is a <a target="_blank" rel="noopener" href="https://github.com/vesoft-inc/nebula-spark-utils">Spark utility</a> named Nebula Exchange to generate RocksDB SST files to enable extremely high import efficiency.</p>
<p>For a small scale of data, the utility <a target="_blank" rel="noopener" href="https://github.com/vesoft-inc/nebula-importer">nebula-importer</a> is enough, with which, we could define mapping rules in a yaml file and import CSV files.</p>
<p>Here we leverage a GUI utility in Nebula Studio as it comes with a guided process to define the mapping rule in the web console itself and call the underlying nebula-importer for us w/o composing the yaml file ;).</p>
<p>We have mocked data for importing as below:</p>
<ul>
<li>trainer–&gt;pokemon</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Tom,pikachu</span><br><span class="line">Tom,muk</span><br><span class="line">Jerry,weedle</span><br><span class="line">Jerry,pikachu</span><br><span class="line">Sue,pikachu</span><br><span class="line">Wey,pikachu</span><br><span class="line">Joe,koffing</span><br></pre></td></tr></table></figure>

<ul>
<li>trainer –&gt; trainer</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Tom,Jerry</span><br><span class="line">Sue,Wey</span><br></pre></td></tr></table></figure>

<p>Please refer to the video demo on how this mapping could be done in Nebula Studio :).</p>
<h3 id="Query-the-data-from-Nebula-Graph"><a href="#Query-the-data-from-Nebula-Graph" class="headerlink" title="Query the data from Nebula Graph"></a>Query the data from Nebula Graph</h3><p>Cool! Now we have a distributed graph DB with some data schema defined and some Pokemon Trainers data is also there!</p>
<p>To simplify the PoC, we assume that the recommendation API will query in this logic: </p>
<ul>
<li>For a given trainer Tom, what are those trainers own the same Pokemons Tom owned?</li>
</ul>
<p>I know it’s quite a silly logic though ;-), it’s just a minimal example here.</p>
<p>Nebula Graph comes with a SQL-like query language named nGQL, you can for sure refer to its doc <a target="_blank" rel="noopener" href="https://docs.nebula-graph.io/2.0/3.ngql-guide/2.nav.md/1.search-guide/">here</a>, and in the video, I showed you how to create a query with the help of the Explore GUI in Nebula Studio.</p>
<ul>
<li><code>owns_pokemon</code> is the edge</li>
<li>the query <code>OVER</code> it means to go <code>FROM</code> its source end, which is <code>trainer</code> tag</li>
<li>we <code>YIELD</code> its dest end, which is <code>pokemon</code> tag, as <code>pokemon_id</code></li>
<li>then we used <code>|</code> (<a target="_blank" rel="noopener" href="https://docs.nebula-graph.io/2.0/3.ngql-guide/5.operators/4.pipe/">pipe</a> operator) to pipe the query result in next query starting from the second <code>GO</code></li>
<li><code>$-</code> stands for the piped result namespace and wo start from <code>$-.pokemon_id</code> now</li>
<li>again we query <code>OVER</code> same edge with one extra <code>REVERSELY</code> key word, yes! it means the other direction this time: <code>FROM</code> its dest end!</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GO <span class="keyword">FROM</span> &quot;Tom&quot; <span class="keyword">OVER</span> owns_pokemon YIELD owns_pokemon._dst <span class="keyword">as</span> pokemon_id \</span><br><span class="line"><span class="operator">|</span> GO <span class="keyword">FROM</span> $<span class="operator">-</span>.pokemon_id <span class="keyword">OVER</span> owns_pokemon REVERSELY</span><br></pre></td></tr></table></figure>



<h3 id="The-API-code-handles-Web-Request-and-Invokes-Nebula-Graph"><a href="#The-API-code-handles-Web-Request-and-Invokes-Nebula-Graph" class="headerlink" title="The API code handles Web Request and Invokes Nebula Graph"></a>The API code handles Web Request and Invokes Nebula Graph</h3><p>There are <a target="_blank" rel="noopener" href="https://nebula-graph.io/download">different client libs</a> there and now we are using the Python one: <a target="_blank" rel="noopener" href="https://github.com/vesoft-inc/nebula-python">https://github.com/vesoft-inc/nebula-python</a>.</p>
<p>I created a simple Flask App with <code>nebula2-python</code> to call our Nebula Graph cluster, the main code logic is as below:</p>
<ul>
<li>it takes api query in format <code>/v1/recommended_friends/&lt;user&gt;</code> and returns result in JSON.</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/v1/recommended_friends/&lt;user&gt;&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">recommended_friends</span>(<span class="params">user</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Get Recommended new Friends</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    ng_credential = get_nebula_graph_crential()</span><br><span class="line">    session = connection_pool.get_session(*ng_credential)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        session.execute(<span class="string">&#x27;USE pokemon_club&#x27;</span>)</span><br><span class="line">        query = (</span><br><span class="line">            <span class="string">f&#x27;GO FROM &quot;<span class="subst">&#123; user &#125;</span>&quot; &#x27;</span></span><br><span class="line">             <span class="string">&#x27;OVER owns_pokemon &#x27;</span></span><br><span class="line">             <span class="string">&#x27;YIELD owns_pokemon._dst as pokemon_id &#x27;</span></span><br><span class="line">             <span class="string">&#x27;| GO FROM $-.pokemon_id &#x27;</span></span><br><span class="line">             <span class="string">&#x27;OVER owns_pokemon REVERSELY&#x27;</span>)</span><br><span class="line">        query_result = session.execute(query)</span><br><span class="line">        trainers = [<span class="built_in">str</span>(trainer.values[<span class="number">0</span>].get_sVal(), <span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">for</span> trainer <span class="keyword">in</span> query_result.rows()]</span><br><span class="line">        trainers = <span class="built_in">list</span>(<span class="built_in">set</span>(trainers))</span><br><span class="line">        <span class="keyword">if</span> user <span class="keyword">in</span> trainers:</span><br><span class="line">            trainers.remove(user)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        session.release()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> jsonify(trainers)</span><br></pre></td></tr></table></figure>

<p>After deployed it to Cloud Run and configured the Nebula Graph’s graphd endpoint in env of the cloud run instance, we will have an external URL to enable anyone in the word to query it, and it looks like this:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$curl</span> https://pokemon-club-v1-****-uw.a.run.app/v1/recommended_friends/Tom | jq</span><br><span class="line">[</span><br><span class="line">  <span class="string">&quot;Sue&quot;</span>,</span><br><span class="line">  <span class="string">&quot;Wey&quot;</span>,</span><br><span class="line">  <span class="string">&quot;Jerry&quot;</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>Below are how I deployed it into GCP Cloud Run and I put all code in GitHub(<a target="_blank" rel="noopener" href="https://github.com/wey-gu/pokemon_club">https://github.com/wey-gu/pokemon_club</a>) as well.</p>
<blockquote>
<p>The Dockerfile</p>
</blockquote>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Use Python37</span></span><br><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.7</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copy requirements.txt to the docker image and install packages</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> requirements.txt /</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip install -r requirements.txt</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set the WORKDIR to be the folder</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> . /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Expose port 5000</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">5000</span></span><br><span class="line"><span class="keyword">ENV</span> PORT <span class="number">5000</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Nebula Graph</span></span><br><span class="line"><span class="keyword">ENV</span> NG_GCP_PROPJECT_ID=</span><br><span class="line"><span class="keyword">ENV</span> NG_GCP_PASSWORD_SECRET_ID=</span><br><span class="line"><span class="keyword">ENV</span> NG_GCP_USER_SECRET_ID=</span><br><span class="line"><span class="keyword">ENV</span> NG_GCP_CREDENTIAL_VERSION <span class="string">&quot;latest&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> NG_ENDPOINTS <span class="string">&quot;127.0.0.1:9669,&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> NG_MAX_CONN_POOL_SIZE <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Use gunicorn as the entrypoint</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> <span class="built_in">exec</span> gunicorn --<span class="built_in">bind</span> :<span class="variable">$PORT</span> main:app --workers 1 --threads 1 --timeout 60</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>build and deploy container to Cloud Run</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PROPJECT_ID=&lt;GCP_PROJECT_ID&gt;</span><br><span class="line">docker build -t gcr.io/<span class="variable">$PROPJECT_ID</span>/pokemon_club:v1 . <span class="comment"># I know I shouldnt build on my own machine but I dont have time to use GCP Cloud Build :P</span></span><br><span class="line">docker push gcr.io/<span class="variable">$PROPJECT_ID</span>/pokemon_club:v1</span><br><span class="line"></span><br><span class="line">gcloud run deploy pokemon-club-v1 \</span><br><span class="line">    --image gcr.io/<span class="variable">$PROPJECT_ID</span>/pokemon_club:v1 \</span><br><span class="line">    --region us-west1 \</span><br><span class="line">    --platform managed \</span><br><span class="line">    --memory 128Mi</span><br></pre></td></tr></table></figure>



<h2 id="More-Working-In-Progress"><a href="#More-Working-In-Progress" class="headerlink" title="More Working In Progress"></a>More Working In Progress</h2><p>To Do:</p>
<ul>
<li><input disabled="" type="checkbox"> Video Demo(s)</li>
<li><input disabled="" type="checkbox"> Adding <del>Fraud</del> 🚀<a target="_blank" rel="noopener" href="https://bulbapedia.bulbagarden.net/wiki/Team_Rocket">Team Rocket</a> hidden member detection API, like based on who owns <a target="_blank" rel="noopener" href="https://pokeres.bastionbot.org/images/pokemon/109.png">Koffing</a></li>
<li><input disabled="" type="checkbox"> Front End Part<ul>
<li><input disabled="" type="checkbox"> Invoking Pokemon API<ul>
<li>catalog for human: <a target="_blank" rel="noopener" href="https://pokemondb.net/pokedex/national#gen-1">https://pokemondb.net/pokedex/national#gen-1</a></li>
<li>metadata fetching: <a target="_blank" rel="noopener" href="https://pokeapi.co/">https://pokeapi.co/</a></li>
<li>image fetching: <a target="_blank" rel="noopener" href="https://pokeres.bastionbot.org/images/pokemon/109.png">https://pokeres.bastionbot.org/images/pokemon/109.png</a> # <code>109</code> is Pokemon ID here.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="More-on-Nebula-Graph"><a href="#More-on-Nebula-Graph" class="headerlink" title="More on Nebula Graph"></a>More on Nebula Graph</h2><p>Nebula Graph is already used by some Gaint Companies and its community is quite active, with the help of that, it grows fast and comes with some great utilities like <a target="_blank" rel="noopener" href="https://github.com/vesoft-inc/nebula-spark-utils">an extremely fast batch importing tool</a>.</p>
<p>Apart from the k8s native deliverable, also it started to provide a managed service Graph DBaaS, in the test phase though.</p>
<p>Hopefully I could create more contents on Nebula Graph later :), stay tuned!</p>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>Post author:  </strong>Wey Gu | 古思为
  </li>
  <li class="post-copyright-link">
      <strong>Post link: </strong>
      <a href="https://note.siwei.info/pokemon-club-a-demo-app-with-nebula-graph/" title="Pokemon Club, a demo app with Nebula Graph">https://note.siwei.info/pokemon-club-a-demo-app-with-nebula-graph/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> unless stating additionally.
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/nebula-graph/" rel="tag"># Nebula Graph</a>
              <a href="/tags/nosql/" rel="tag"># NoSQL</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/performance-optimization-refactor-in-large-python-codebase-a-note/" rel="prev" title="Performance Optimization refactor in Large Python Codebase, a note">
                  <i class="fa fa-chevron-left"></i> Performance Optimization refactor in Large Python Codebase, a note
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/note-siwei-info-will-be-archived/" rel="next" title="note.siwei.info will be archived">
                  note.siwei.info will be archived <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Wey Gu | 古思为</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/js/local-search.js"></script>



<script>
if (document.querySelectorAll('.pdf-container').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/pdfobject@2.2.4/pdfobject.min.js', () => {
    document.querySelectorAll('.pdf-container').forEach(element => {
      PDFObject.embed(element.dataset.target, element, {
        pdfOpenParams: {
          navpanes : 0,
          toolbar  : 0,
          statusbar: 0,
          pagemode : 'thumbs',
          view     : 'FitH'
        },
        PDFJS_URL: '/lib/pdf/web/viewer.html',
        height   : element.dataset.height
      });
    });
  }, window.PDFObject);
}
</script>



  





<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1.7.0/dist/gitalk.css">

<script>
NexT.utils.loadComments('.gitalk-container', () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1.7.0/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : '458d0826a0f8a2a81f82',
      clientSecret: 'c7ba7c1e589c568e864e7a47aac5b94b64e0de88',
      repo        : 'wey-gu.github.io',
      owner       : 'wey-gu',
      admin       : ['wey-gu'],
      id          : '34fb38b9628f5a4d7f550648f52351b6',
        language: 'en',
      distractionFreeMode: true
    });
    gitalk.render(document.querySelector('.gitalk-container'));
  }, window.Gitalk);
});
</script>

</body>
</html>
