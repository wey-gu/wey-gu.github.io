<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Distributed bugs are often latent: a Troubleshoot Story</title>
    <url>/distributed-bugs-are-often-latent-a-troubleshoot-story/</url>
    <content><![CDATA[<h2 id="Abstract"><a href="#Abstract" class="headerlink" title="Abstract"></a>Abstract</h2><p>OpenStack, as a nested distributed system(where some of the subsystems are distributed systems), to troubleshoot on it could be quite tricky, not to mention its interdependence with other distributed systems in real word.</p>
<p>We all share the feelings on how hard it is to solve a hidden issue in a distributed system as each call during a chain of invocation is unpredictable, the methods/ tools for sniffing/ tracking each part are either too hard, incapable, outside of control, or too expensive.</p>
<p>The trigger made me composing this blog is the article: <a href="https://aws.amazon.com/builders-library/challenges-with-distributed-systems/">Challenges with distributed systems</a> from <a href="https://twitter.com/jacobgabrielson">Jacob Gabrielson</a>, where Jacob expounded how and why designing/ managing a request/response distributed system is challenging. I recommend to read it 😊. </p>
<p>The story in this blog is a troubleshoot case I solved in a customer staging network years ago, where OpenStack clusters were integrated with some other different (virtual) Network Function clusters.</p>
<h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p>There were many OpenStack Clusters onsite, with different VNFs running on top of them. </p>
<ul>
<li><p>Two months before I arrived the customer site, the alarm <code>[NTP Upstream Server Failure]</code> was raised in one of the OpenStack Cluster.</p>
</li>
<li><p>Every party involved on this issue had looked into it jointly and each of them claimed they are all good: no clue to move on, and after the whole site’s yearly power down and up activity, the issue was gone. </p>
</li>
<li><p>One week ago, after a control plane nodes reboot, this alarm was raised again on another OpenStack Cluster.</p>
</li>
</ul>
<p>Reviewing everything to have the pattern of the issue:</p>
<ul>
<li><p>There were two types of servers acted as upstream NTP for Openstack Clusters. Let’s say NTP-A and NTP-B, they were actually not dedicated NTP servers but a more heavy network function(NF):</p>
<!--
<img data-src="./distributed-bugs-are-often-latent-a-troubleshoot-story/NTP_Openstack_0.png" alt="NTP_Openstack_0" style="zoom:50%;" />
-->
<img data-src="/distributed-bugs-are-often-latent-a-troubleshoot-story/NTP_Openstack_0.png" class="">

<ul>
<li>NTP-A was the one associated with the issue OpenStack Clusters, which was a VNF running in Linux.</li>
<li>NTP-B was a native NF in Solaris, to be repalced by NTP-A in future. #Customer has reasons to worry the issue more 😜.</li>
</ul>
</li>
<li><p>The OpenStack side claimed they were good because they captured the NTP client packet sent to NTP-A and no response recieved.</p>
</li>
<li><p>The other side checked everything around NTP configuration, network etc. nothing abnormal was sorted out. Thus they had to blame the OpenStack side as there were other systems utilizing their NTP-A as upstream NTP, while no issues had encounterred.</p>
</li>
<li><p>Then both side suspected the packet was dropped somehow between NTP-A and OpenStack Cluster: the networking/ switches.</p>
<ul>
<li>The switch team observed nothing pointing to packet drop from the traffic .</li>
<li>Even though there was chance they didn’t capture the drop on right time, why only OpenStack’s NTP request not responded?</li>
<li>Was this issue happening in small frequency?</li>
</ul>
</li>
</ul>
<a id="more"></a>

<h2 id="Troubleshoot-Story"><a href="#Troubleshoot-Story" class="headerlink" title="Troubleshoot Story"></a>Troubleshoot Story</h2><p>Luckily yet unfortunately, the alarm was kept being raised from OpenStack Cluster a, let’s call it OS-a, I started to look into this issue from it.</p>
<p>First, allow me to explain how this OS-a call upstream NTP.</p>
<p>From below figure, I used blue arrow to show a NTP client to server call, we could see all nodes include control-plane node(cpn), and other nodes configured their upstream NTP server as the control-plane hypervisor. Thus the alarm actually means something is wrong around the circle in the figure.</p>
<blockquote>
<p>note, in this OpenStack Cluster, the control-plane nodes were VMs hosted by cpn hypervisor node</p>
</blockquote>
<!--
<img data-src="./distributed-bugs-are-often-latent-a-troubleshoot-story/NTP_Openstack_OS_to_external_NTP.png" alt="NTP_Openstack_OS_to_external_NTP" style="zoom:60%;" />
-->
<img data-src="/distributed-bugs-are-often-latent-a-troubleshoot-story/NTP_Openstack_OS_to_external_NTP.png" class="">

<p>And let’s check NTP stats from the cpn hypervisor node, from below we could tell the [NTP server side packet not being recieved] frequency was hard to say small: in last <code>256 * 8</code> seconds of the moment, 3 of 8 NTP polling hadn’t get responded packet. By checking the alarm triggerring code, it’s found only after more than 1800 seconds a upstream NTP server not responding, a alarm will be raised, which is a slightly high threhold.</p>
<blockquote>
<p>note, please refer to <strong><a href="#Appendix">Appendix: <code>ntpd -pn</code> explained</a></strong> on how we get this information from below printout.</p>
</blockquote>
<!--  
<img data-src="./distributed-bugs-are-often-latent-a-troubleshoot-story/ntpq_cpn_hypervisor.png" alt="ntpq_cpn_hypervisor" style="zoom:70%;" />
-->
<img data-src="/distributed-bugs-are-often-latent-a-troubleshoot-story/ntpq_cpn_hypervisor.png" class="">
<p>It’s a good sign to know this issue was actually easier to have the minimum reproduction: just query it directly from cpn hypervisor node, and, it’s in high frequency(easy to repoduce). </p>
<p>Then we have below questions:</p>
<ul>
<li>What made our NTP call different from other systems(to possibly cause this issue)?</li>
<li>Why it’s not happening not for always? And related to reboot?</li>
</ul>
<p>With above questions, I looked into the above blue circle between cpn hypervisor node and external NTP. The external NTP server is only reachable from OaM Network, under the hood cpn hypervisor node actually reached external NTP-A via a vRouter running inside cpn. That is, the last path of above blue circle is actually this orange circle below, aka, not from cpn hypervisor node itself.</p>
<!--
<img data-src="distributed-bugs-are-often-latent-a-troubleshoot-story/vrouter_to_external_NTP.png" alt="vrouter_to_external_NTP" style="zoom:67%;" />
--> 
<img data-src="/distributed-bugs-are-often-latent-a-troubleshoot-story/vrouter_to_external_NTP.png" class="">

<p>With above knowledge, packet from its cpn vRouter was captured:</p>
<p>By checking the packet with <code>no.482</code>, whose client NTP call was not responded(others around it got responded), something intresting was found:</p>
<ul>
<li>The Source Port of this packet is not the well-known <code>123</code> port, instead, it’s <code>108</code>.</li>
<li>For those got resonped in this cluster, they are in source port <code>123</code>.</li>
</ul>
<img data-src="/distributed-bugs-are-often-latent-a-troubleshoot-story/tcpdump_vrouter_ntp.png" class="">

<p>This was something close to the turth, still more questions to answer😀:</p>
<ul>
<li>Was other cluster(without issues) in samliar situation? <code>src.port==108</code>?<ul>
<li>Yes and No, I checked on other Openstack Cluster, all other clusters had one <code>non-123 port</code> being used when reaching NTP servers, while only this cluster encounted issues.<ul>
<li>Should client source port be the well-known 123? <ul>
<li>No, it’s not mandatory in <code>non-symmetric modes</code> referring to <a href="https://tools.ietf.org/html/rfc5905">rfc5905</a></li>
</ul>
</li>
<li>Seemed like a dead end!</li>
</ul>
</li>
</ul>
</li>
<li>Why was source port being modified?<ul>
<li>The vRouter used masquerade NAT, if at the same time(close enough) more than one NTP requests from different cpn hypervisor nodes were sent to same remote NTP, inside vRouter it would trigger source ports modification.<ul>
<li>The modification was randomly chosen and fixed in first time in memory.<ul>
<li>This also explained why it’s related to system reboot.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Now we know information on how and why source port was modified in the alarm-raising cluster, but still cannot figure out why only that cluster encountered issue. At that time I really didn’t have more ideas, but the difference seemed to be related to in the random source port it chosed. I guessed something could be wrong on handling non-123 src.port NTP requests, then I googled this with keyword like:</p>
<ul>
<li><a href="https://lmgtfy.com/?q=ntp+non-123+port+drop">ntp non-123 port drop</a></li>
</ul>
<p>And yes, I got some clue here: <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1171630">https://bugzilla.redhat.com/show_bug.cgi?id=1171630</a>.</p>
<p>From the bug page we could tell, in certain verison of ntpd (like 4.2.7) , there was a bug to drop ntp request with source port number below 123, and it was fixexd in 4.2.8:</p>
<!--  
![ntpd_bug_diff](distributed-bugs-are-often-latent-a-troubleshoot-story/ntpd_bug_diff.png)
-->
<img data-src="/distributed-bugs-are-often-latent-a-troubleshoot-story/ntpd_bug_diff.png" class="">

<h2 id="TLDR"><a href="#TLDR" class="headerlink" title="TLDR;"></a>TLDR;</h2><p>Then I asked the NTP-A administorator to confirm the ntpd version, it was 4.2.7😜. </p>
<p>The solution will be: upgrade nptd from NTP-A.</p>
<blockquote>
<p>also, we come to know that the NTP-B was too old to have this NTP bug in its ntpd.</p>
</blockquote>
<p>Well, I am not a story-teller but, I really consider this troubleshoot case intresting, and it’s true as quoted from Jacob: </p>
<blockquote>
<p>Distributed bugs are often latent.</p>
</blockquote>
<h2 id="Appendix"><a href="#Appendix" class="headerlink" title="Appendix"></a>Appendix</h2><h3 id="ntpq-pn-explained"><a href="#ntpq-pn-explained" class="headerlink" title="ntpq -pn explained"></a><code>ntpq -pn</code> explained</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ man ntpq</span><br><span class="line">NTPQ(1)                      BSD General Commands Manual                     NTPQ(1)</span><br><span class="line"></span><br><span class="line">NAME</span><br><span class="line">     ntpq — standard NTP query program</span><br><span class="line"></span><br><span class="line">SYNOPSIS</span><br><span class="line">     ntpq [-flags] [-flag [value]] [--option-name[[=| ]value]] [ host ...]</span><br><span class="line"></span><br><span class="line">OPTIONS</span><br><span class="line">     -n, --numeric</span><br><span class="line">                 numeric host addresses.</span><br><span class="line"></span><br><span class="line">                 Output all host addresses <span class="keyword">in</span> dotted-quad numeric format rather than</span><br><span class="line">                 converting to the canonical host names.</span><br><span class="line"></span><br><span class="line">     -p, --peers</span><br><span class="line">                 Print a list of the peers.  This option must not appear <span class="keyword">in</span> combina‐</span><br><span class="line">                 tion with any of the following options: interactive.</span><br><span class="line"></span><br><span class="line">                 Print a list of the peers known to the server as well as a summary</span><br><span class="line">                 of their state. This is equivalent to the <span class="string">&#x27;peers&#x27;</span> interactive com‐</span><br><span class="line">                 mand.</span><br><span class="line"></span><br><span class="line"><span class="comment">#...</span></span><br><span class="line">           peers      Display a list of peers <span class="keyword">in</span> the form:</span><br><span class="line"></span><br><span class="line">                            Variable   Description</span><br><span class="line">                            remote     host name (or IP number) of peer.  The value</span><br><span class="line">                                       displayed will be truncated to 15 characters</span><br><span class="line">                                       unless the -w flag is given, <span class="keyword">in</span> <span class="built_in">which</span> <span class="keyword">case</span></span><br><span class="line">                                       the full value will be displayed on the first</span><br><span class="line">                                       line, and the remaining data is displayed on</span><br><span class="line">                                       the next line.</span><br><span class="line"><span class="comment">#...</span></span><br><span class="line">                            when       sec/min/hr since last received packet <span class="comment"># &lt;----</span></span><br><span class="line">                            poll       poll interval (log2 s)                <span class="comment"># &lt;----</span></span><br><span class="line">                            reach      reach <span class="built_in">shift</span> register (octal)          <span class="comment"># &lt;----</span></span><br><span class="line">                            delay      roundtrip delay</span><br><span class="line">                            offset     offset of server relative to this host</span><br><span class="line">                            jitter     jitter</span><br></pre></td></tr></table></figure>
<p>We could focus on three columns of <code>when</code>, <code>poll</code>, <code>reach</code> as explained in above manual and below square. It told us:</p>
<ul>
<li>The stats will poll remote NTP servers in interval: 256 s</li>
<li>For remote server<code>172.21.96.29</code> marked in purple arrow:<ul>
<li>It received last packet since 204 seconds.</li>
<li>And for last 8 times stats, 3 times of the service side respond were not recieved</li>
</ul>
</li>
<li>For remote server<code>172.21.81.189</code> marked in purple arrow:<ul>
<li>It received last packet since 32 seconds.</li>
<li>And for last 8 times stats, 0 times of the service side respond were not recieved</li>
</ul>
</li>
</ul>
<!--
<img data-src="distributed-bugs-are-often-latent-a-troubleshoot-story/appendix_ntpq_stats.png" alt="appendix_ntpq_stats" style="zoom:70%;" />
--> 
<img data-src="/distributed-bugs-are-often-latent-a-troubleshoot-story/appendix_ntpq_stats.png" class="">
]]></content>
      <categories>
        <category>openstack</category>
      </categories>
      <tags>
        <tag>openstack</tag>
        <tag>distributed system</tag>
        <tag>troubleshoot</tag>
        <tag>NTP</tag>
      </tags>
  </entry>
  <entry>
    <title>jupyter pyenv and virtualenv in macOS</title>
    <url>/jupyter-notes/</url>
    <content><![CDATA[<blockquote>
<p>Conbined with <code>pyenv</code>  <code>virtualenv</code> and <code>Jupyter kernal specification</code>, we could have different versions of project-specific python wrapper as below.</p>
<p>This article includes needed information on enabling this.</p>
</blockquote>
<h1 id="pyenv"><a href="#pyenv" class="headerlink" title="pyenv"></a>pyenv</h1><blockquote>
<p>ref: <a href="https://github.com/pyenv/pyenv/issues/1219">https://github.com/pyenv/pyenv/issues/1219</a></p>
</blockquote>
<p><code>zlib not available</code>, one thing to highlight is to enable zlib, we have to do this:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">xcode-select --install</span><br><span class="line">sudo installer -pkg /Library/Developer/CommandLineTools/Packages/macOS_SDK_headers_for_macOS_10.14.pkg -target /</span><br></pre></td></tr></table></figure>
<p>Below are things we need to ensure pyenv magically modified our enviroment variables to point specific version of python.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ brew install pyenv</span><br><span class="line">$ <span class="built_in">cd</span> &lt;project_path&gt;</span><br><span class="line">$ pyenv install 3.6.8</span><br><span class="line">$ pyenv <span class="built_in">local</span> 3.6.8</span><br><span class="line">$ pyenv init</span><br><span class="line"><span class="comment"># Load pyenv automatically by appending</span></span><br><span class="line"><span class="comment"># the following to ~/.zshrc:</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">eval</span> <span class="string">&quot;<span class="subst">$(pyenv init -)</span>&quot;</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">which</span> python</span><br><span class="line">/usr/<span class="built_in">local</span>/bin/python</span><br><span class="line">$ <span class="built_in">eval</span> <span class="string">&quot;<span class="subst">$(pyenv init -)</span>&quot;</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">which</span> python</span><br><span class="line">/Users/&lt;user&gt;/.pyenv/shims/python</span><br></pre></td></tr></table></figure>


<h2 id="jupyter-IPython-kernel-management"><a href="#jupyter-IPython-kernel-management" class="headerlink" title="jupyter/IPython kernel management"></a>jupyter/IPython kernel management</h2><blockquote>
<p>ref: <a href="https://ipython.readthedocs.io/en/latest/install/kernel_install.html">https://ipython.readthedocs.io/en/latest/install/kernel_install.html</a></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ jupyter kernelspec list</span><br><span class="line">Available kernels:</span><br><span class="line">  python3    /usr/<span class="built_in">local</span>/share/jupyter/kernels/python3</span><br><span class="line"></span><br><span class="line">$ python -m virtualenv py36</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">source</span> py36/bin/activate</span><br><span class="line"></span><br><span class="line">$ pip install ipykernel</span><br><span class="line"></span><br><span class="line">$ python -m ipykernel install --user --name py36 --display-name <span class="string">&quot;ProjectName py36&quot;</span></span><br><span class="line"></span><br><span class="line">$ jupyter kernelspec list</span><br><span class="line">Available kernels:</span><br><span class="line">  py36       /Users/&lt;user&gt;/Library/Jupyter/kernels/py36</span><br><span class="line">  python3    /usr/<span class="built_in">local</span>/share/jupyter/kernels/python3</span><br></pre></td></tr></table></figure>
<p>Then, from the jupyter notebook webpage, you could select kernels from <code>Kernel: Change Kernel</code></p>
<h2 id="matplotlib-calling-latex-failed-on-macOS"><a href="#matplotlib-calling-latex-failed-on-macOS" class="headerlink" title="matplotlib calling latex failed on macOS"></a><code>matplotlib</code> calling <code>latex</code> failed on macOS</h2><blockquote>
<p>plot call failed due to latex could not be invoked</p>
</blockquote>
<h3 id="Root-cause"><a href="#Root-cause" class="headerlink" title="Root cause"></a>Root cause</h3><p>LaTeX was not installed or cannot be called from<code>latex</code></p>
<h3 id="Minimal-reproducing"><a href="#Minimal-reproducing" class="headerlink" title="Minimal reproducing"></a>Minimal reproducing</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; import subprocess; subprocess.check_call(<span class="string">&quot;latex&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># FileNotFoundError: [Errno 2] No such file or directory: &#x27;latex&#x27;: &#x27;latex&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># or from shell</span></span><br><span class="line"></span><br><span class="line">$ latex</span><br><span class="line"><span class="comment"># latex not found</span></span><br></pre></td></tr></table></figure>
<h3 id="Fix"><a href="#Fix" class="headerlink" title="Fix"></a>Fix</h3><ul>
<li>install Tex Live for macOS</li>
<li>append <code>PATH</code> for <code>/Library/TeX/texbin</code></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ wget http://tug.org/cgi-bin/mactex-download/MacTeX.pkg</span><br><span class="line"><span class="comment"># checksum and install MacTeX.pkg</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># assuming you are using zsh</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;export PATH=&quot;$PATH:/Library/TeX/texbin&quot;&#x27;</span> &gt;&gt; ~/.zshrc</span><br><span class="line"></span><br><span class="line"><span class="comment"># assuming you are using bash</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;export PATH=&quot;$PATH:/Library/TeX/texbin&quot;&#x27;</span> &gt;&gt; ~/.bashrc</span><br></pre></td></tr></table></figure>
<h3 id="Verify-it"><a href="#Verify-it" class="headerlink" title="Verify it"></a>Verify it</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">export</span> PATH=<span class="string">&quot;<span class="variable">$PATH</span>:/Library/TeX/texbin&quot;</span></span><br><span class="line">$ latex --version</span><br><span class="line">pdfTeX 3.14159265-2.6-1.40.19 (TeX Live 2018)</span><br><span class="line">kpathsea version 6.3.0</span><br><span class="line">Copyright 2018 Han The Thanh (pdfTeX) et al.</span><br><span class="line">There is NO warranty.  Redistribution of this software is</span><br><span class="line">covered by the terms of both the pdfTeX copyright and</span><br><span class="line">the Lesser GNU General Public License.</span><br><span class="line">For more information about these matters, see the file</span><br><span class="line">named COPYING and the pdfTeX <span class="built_in">source</span>.</span><br><span class="line">Primary author of pdfTeX: Han The Thanh (pdfTeX) et al.</span><br><span class="line">Compiled with libpng 1.6.34; using libpng 1.6.34</span><br><span class="line">Compiled with zlib 1.2.11; using zlib 1.2.11</span><br><span class="line">Compiled with xpdf version 4.00</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>random notes</category>
      </categories>
      <tags>
        <tag>jupyter</tag>
        <tag>pyenv</tag>
        <tag>virtualenv</tag>
      </tags>
  </entry>
  <entry>
    <title>my HHKB and macOS setup</title>
    <url>/my-hhkb-and-macos-setup/</url>
    <content><![CDATA[<h1 id="Key-mapping"><a href="#Key-mapping" class="headerlink" title="Key mapping"></a>Key mapping</h1><blockquote>
<p>几个月前，我从 <code>HHKB Lite2 for Mac</code>  切换到了  <code>HHKB Pro 2 Type-S</code>，方向键需要map成 <code>Ctrl + h/ j/ k/ l</code> ，参考了@zjun 的 <a href="http://www.zjunothing.com/2017/05/28/hhkb%E5%9F%BA%E6%9C%AC%E8%AE%BE%E7%BD%AE/">best practise</a> ，用到了 <a href="http://www.hammerspoon.org/">Hammerspoon</a>，这里记录一下配置。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">~/.hammerspoon</span><br><span class="line">❯ cat init.lua</span><br></pre></td></tr></table></figure>


<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">pressFn</span><span class="params">(mods, key)</span></span></span><br><span class="line">	<span class="keyword">if</span> key == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">		key = mods</span><br><span class="line">		mods = &#123;&#125;</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">()</span></span> hs.eventtap.keyStroke(mods, key, <span class="number">1000</span>) <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">remap</span><span class="params">(mods, key, pressFn)</span></span></span><br><span class="line">	hs.hotkey.bind(mods, key, pressFn, <span class="literal">nil</span>, pressFn)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">remap(&#123;<span class="string">&#x27;ctrl&#x27;</span>&#125;, <span class="string">&#x27;h&#x27;</span>, pressFn(<span class="string">&#x27;left&#x27;</span>))</span><br><span class="line">remap(&#123;<span class="string">&#x27;ctrl&#x27;</span>&#125;, <span class="string">&#x27;j&#x27;</span>, pressFn(<span class="string">&#x27;down&#x27;</span>))</span><br><span class="line">remap(&#123;<span class="string">&#x27;ctrl&#x27;</span>&#125;, <span class="string">&#x27;k&#x27;</span>, pressFn(<span class="string">&#x27;up&#x27;</span>))</span><br><span class="line">remap(&#123;<span class="string">&#x27;ctrl&#x27;</span>&#125;, <span class="string">&#x27;l&#x27;</span>, pressFn(<span class="string">&#x27;right&#x27;</span>))</span><br><span class="line"></span><br><span class="line">remap(&#123;<span class="string">&#x27;ctrl&#x27;</span>, <span class="string">&#x27;shift&#x27;</span>&#125;, <span class="string">&#x27;h&#x27;</span>, pressFn(&#123;<span class="string">&#x27;shift&#x27;</span>&#125;, <span class="string">&#x27;left&#x27;</span>))</span><br><span class="line">remap(&#123;<span class="string">&#x27;ctrl&#x27;</span>, <span class="string">&#x27;shift&#x27;</span>&#125;, <span class="string">&#x27;j&#x27;</span>, pressFn(&#123;<span class="string">&#x27;shift&#x27;</span>&#125;, <span class="string">&#x27;down&#x27;</span>))</span><br><span class="line">remap(&#123;<span class="string">&#x27;ctrl&#x27;</span>, <span class="string">&#x27;shift&#x27;</span>&#125;, <span class="string">&#x27;k&#x27;</span>, pressFn(&#123;<span class="string">&#x27;shift&#x27;</span>&#125;, <span class="string">&#x27;up&#x27;</span>))</span><br><span class="line">remap(&#123;<span class="string">&#x27;ctrl&#x27;</span>, <span class="string">&#x27;shift&#x27;</span>&#125;, <span class="string">&#x27;l&#x27;</span>, pressFn(&#123;<span class="string">&#x27;shift&#x27;</span>&#125;, <span class="string">&#x27;right&#x27;</span>))</span><br><span class="line"></span><br><span class="line">remap(&#123;<span class="string">&#x27;ctrl&#x27;</span>, <span class="string">&#x27;cmd&#x27;</span>&#125;, <span class="string">&#x27;h&#x27;</span>, pressFn(&#123;<span class="string">&#x27;cmd&#x27;</span>&#125;, <span class="string">&#x27;left&#x27;</span>))</span><br><span class="line">remap(&#123;<span class="string">&#x27;ctrl&#x27;</span>, <span class="string">&#x27;cmd&#x27;</span>&#125;, <span class="string">&#x27;j&#x27;</span>, pressFn(&#123;<span class="string">&#x27;cmd&#x27;</span>&#125;, <span class="string">&#x27;down&#x27;</span>))</span><br><span class="line">remap(&#123;<span class="string">&#x27;ctrl&#x27;</span>, <span class="string">&#x27;cmd&#x27;</span>&#125;, <span class="string">&#x27;k&#x27;</span>, pressFn(&#123;<span class="string">&#x27;cmd&#x27;</span>&#125;, <span class="string">&#x27;up&#x27;</span>))</span><br><span class="line">remap(&#123;<span class="string">&#x27;ctrl&#x27;</span>, <span class="string">&#x27;cmd&#x27;</span>&#125;, <span class="string">&#x27;l&#x27;</span>, pressFn(&#123;<span class="string">&#x27;cmd&#x27;</span>&#125;, <span class="string">&#x27;right&#x27;</span>))</span><br><span class="line"></span><br><span class="line">remap(&#123;<span class="string">&#x27;ctrl&#x27;</span>, <span class="string">&#x27;alt&#x27;</span>&#125;, <span class="string">&#x27;h&#x27;</span>, pressFn(&#123;<span class="string">&#x27;alt&#x27;</span>&#125;, <span class="string">&#x27;left&#x27;</span>))</span><br><span class="line">remap(&#123;<span class="string">&#x27;ctrl&#x27;</span>, <span class="string">&#x27;alt&#x27;</span>&#125;, <span class="string">&#x27;j&#x27;</span>, pressFn(&#123;<span class="string">&#x27;alt&#x27;</span>&#125;, <span class="string">&#x27;down&#x27;</span>))</span><br><span class="line">remap(&#123;<span class="string">&#x27;ctrl&#x27;</span>, <span class="string">&#x27;alt&#x27;</span>&#125;, <span class="string">&#x27;k&#x27;</span>, pressFn(&#123;<span class="string">&#x27;alt&#x27;</span>&#125;, <span class="string">&#x27;up&#x27;</span>))</span><br><span class="line">remap(&#123;<span class="string">&#x27;ctrl&#x27;</span>, <span class="string">&#x27;alt&#x27;</span>&#125;, <span class="string">&#x27;l&#x27;</span>, pressFn(&#123;<span class="string">&#x27;alt&#x27;</span>&#125;, <span class="string">&#x27;right&#x27;</span>))</span><br><span class="line"></span><br><span class="line">remap(&#123;<span class="string">&#x27;ctrl&#x27;</span>, <span class="string">&#x27;shift&#x27;</span>, <span class="string">&#x27;cmd&#x27;</span>&#125;, <span class="string">&#x27;h&#x27;</span>, pressFn(&#123;<span class="string">&#x27;shift&#x27;</span>, <span class="string">&#x27;cmd&#x27;</span>&#125;, <span class="string">&#x27;left&#x27;</span>))</span><br><span class="line">remap(&#123;<span class="string">&#x27;ctrl&#x27;</span>, <span class="string">&#x27;shift&#x27;</span>, <span class="string">&#x27;cmd&#x27;</span>&#125;, <span class="string">&#x27;j&#x27;</span>, pressFn(&#123;<span class="string">&#x27;shift&#x27;</span>, <span class="string">&#x27;cmd&#x27;</span>&#125;, <span class="string">&#x27;down&#x27;</span>))</span><br><span class="line">remap(&#123;<span class="string">&#x27;ctrl&#x27;</span>, <span class="string">&#x27;shift&#x27;</span>, <span class="string">&#x27;cmd&#x27;</span>&#125;, <span class="string">&#x27;k&#x27;</span>, pressFn(&#123;<span class="string">&#x27;shift&#x27;</span>, <span class="string">&#x27;cmd&#x27;</span>&#125;, <span class="string">&#x27;up&#x27;</span>))</span><br><span class="line">remap(&#123;<span class="string">&#x27;ctrl&#x27;</span>, <span class="string">&#x27;shift&#x27;</span>, <span class="string">&#x27;cmd&#x27;</span>&#125;, <span class="string">&#x27;l&#x27;</span>, pressFn(&#123;<span class="string">&#x27;shift&#x27;</span>, <span class="string">&#x27;cmd&#x27;</span>&#125;, <span class="string">&#x27;right&#x27;</span>))</span><br><span class="line"></span><br><span class="line">remap(&#123;<span class="string">&#x27;ctrl&#x27;</span>, <span class="string">&#x27;shift&#x27;</span>, <span class="string">&#x27;alt&#x27;</span>&#125;, <span class="string">&#x27;h&#x27;</span>, pressFn(&#123;<span class="string">&#x27;shift&#x27;</span>, <span class="string">&#x27;alt&#x27;</span>&#125;, <span class="string">&#x27;left&#x27;</span>))</span><br><span class="line">remap(&#123;<span class="string">&#x27;ctrl&#x27;</span>, <span class="string">&#x27;shift&#x27;</span>, <span class="string">&#x27;alt&#x27;</span>&#125;, <span class="string">&#x27;j&#x27;</span>, pressFn(&#123;<span class="string">&#x27;shift&#x27;</span>, <span class="string">&#x27;alt&#x27;</span>&#125;, <span class="string">&#x27;down&#x27;</span>))</span><br><span class="line">remap(&#123;<span class="string">&#x27;ctrl&#x27;</span>, <span class="string">&#x27;shift&#x27;</span>, <span class="string">&#x27;alt&#x27;</span>&#125;, <span class="string">&#x27;k&#x27;</span>, pressFn(&#123;<span class="string">&#x27;shift&#x27;</span>, <span class="string">&#x27;alt&#x27;</span>&#125;, <span class="string">&#x27;up&#x27;</span>))</span><br><span class="line">remap(&#123;<span class="string">&#x27;ctrl&#x27;</span>, <span class="string">&#x27;shift&#x27;</span>, <span class="string">&#x27;alt&#x27;</span>&#125;, <span class="string">&#x27;l&#x27;</span>, pressFn(&#123;<span class="string">&#x27;shift&#x27;</span>, <span class="string">&#x27;alt&#x27;</span>&#125;, <span class="string">&#x27;right&#x27;</span>))</span><br><span class="line"></span><br><span class="line">remap(&#123;<span class="string">&#x27;ctrl&#x27;</span>, <span class="string">&#x27;cmd&#x27;</span>, <span class="string">&#x27;alt&#x27;</span>&#125;, <span class="string">&#x27;h&#x27;</span>, pressFn(&#123;<span class="string">&#x27;cmd&#x27;</span>, <span class="string">&#x27;alt&#x27;</span>&#125;, <span class="string">&#x27;left&#x27;</span>))</span><br><span class="line">remap(&#123;<span class="string">&#x27;ctrl&#x27;</span>, <span class="string">&#x27;cmd&#x27;</span>, <span class="string">&#x27;alt&#x27;</span>&#125;, <span class="string">&#x27;j&#x27;</span>, pressFn(&#123;<span class="string">&#x27;cmd&#x27;</span>, <span class="string">&#x27;alt&#x27;</span>&#125;, <span class="string">&#x27;down&#x27;</span>))</span><br><span class="line">remap(&#123;<span class="string">&#x27;ctrl&#x27;</span>, <span class="string">&#x27;cmd&#x27;</span>, <span class="string">&#x27;alt&#x27;</span>&#125;, <span class="string">&#x27;k&#x27;</span>, pressFn(&#123;<span class="string">&#x27;cmd&#x27;</span>, <span class="string">&#x27;alt&#x27;</span>&#125;, <span class="string">&#x27;up&#x27;</span>))</span><br><span class="line">remap(&#123;<span class="string">&#x27;ctrl&#x27;</span>, <span class="string">&#x27;cmd&#x27;</span>, <span class="string">&#x27;alt&#x27;</span>&#125;, <span class="string">&#x27;l&#x27;</span>, pressFn(&#123;<span class="string">&#x27;cmd&#x27;</span>, <span class="string">&#x27;alt&#x27;</span>&#125;, <span class="string">&#x27;right&#x27;</span>))</span><br><span class="line"></span><br><span class="line">remap(&#123;<span class="string">&#x27;ctrl&#x27;</span>, <span class="string">&#x27;cmd&#x27;</span>, <span class="string">&#x27;alt&#x27;</span>, <span class="string">&#x27;shift&#x27;</span>&#125;, <span class="string">&#x27;h&#x27;</span>, pressFn(&#123;<span class="string">&#x27;cmd&#x27;</span>, <span class="string">&#x27;alt&#x27;</span>, <span class="string">&#x27;shift&#x27;</span>&#125;, <span class="string">&#x27;left&#x27;</span>))</span><br><span class="line">remap(&#123;<span class="string">&#x27;ctrl&#x27;</span>, <span class="string">&#x27;cmd&#x27;</span>, <span class="string">&#x27;alt&#x27;</span>, <span class="string">&#x27;shift&#x27;</span>&#125;, <span class="string">&#x27;j&#x27;</span>, pressFn(&#123;<span class="string">&#x27;cmd&#x27;</span>, <span class="string">&#x27;alt&#x27;</span>, <span class="string">&#x27;shift&#x27;</span>&#125;, <span class="string">&#x27;down&#x27;</span>))</span><br><span class="line">remap(&#123;<span class="string">&#x27;ctrl&#x27;</span>, <span class="string">&#x27;cmd&#x27;</span>, <span class="string">&#x27;alt&#x27;</span>, <span class="string">&#x27;shift&#x27;</span>&#125;, <span class="string">&#x27;k&#x27;</span>, pressFn(&#123;<span class="string">&#x27;cmd&#x27;</span>, <span class="string">&#x27;alt&#x27;</span>, <span class="string">&#x27;shift&#x27;</span>&#125;, <span class="string">&#x27;up&#x27;</span>))</span><br><span class="line">remap(&#123;<span class="string">&#x27;ctrl&#x27;</span>, <span class="string">&#x27;cmd&#x27;</span>, <span class="string">&#x27;alt&#x27;</span>, <span class="string">&#x27;shift&#x27;</span>&#125;, <span class="string">&#x27;l&#x27;</span>, pressFn(&#123;<span class="string">&#x27;cmd&#x27;</span>, <span class="string">&#x27;alt&#x27;</span>, <span class="string">&#x27;shift&#x27;</span>&#125;, <span class="string">&#x27;right&#x27;</span>))</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>random notes</category>
      </categories>
      <tags>
        <tag>HHKB</tag>
      </tags>
  </entry>
  <entry>
    <title>nova scheduling study on making it smart by machine learning</title>
    <url>/nova-scheduling-study-on-making-it-smart-by-machine-learning/</url>
    <content><![CDATA[<blockquote>
<p>update in 2019 June: I managed to implement it, check <a href="https://github.com/wey-gu/AutoOptCloud">here</a> ;-) will write more on how it was done…</p>
</blockquote>
<p>This note is my brain dump on getting ideas to do machine learning enabled optimized nova scheduler weighing.</p>
<h1 id="How-existing-Weighing-works"><a href="#How-existing-Weighing-works" class="headerlink" title="How existing Weighing works?"></a>How existing Weighing works?</h1><h2 id="Short-version-conclusion"><a href="#Short-version-conclusion" class="headerlink" title="Short version conclusion"></a>Short version conclusion</h2><p>By default, it simply weighted all existing weighers with weighing factor 1.0.</p>
<h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><blockquote>
<p>see ref first : <a href="https://www.slideshare.net/guptapeeyush1/presentation1-23249150">https://www.slideshare.net/guptapeeyush1/presentation1-23249150</a></p>
</blockquote>
<p>The weighing was called by:</p>
<ul>
<li><p><code>self.weight_handler.get_weighed_objects(self.weighers)</code> </p>
<ul>
<li><p><code>self.weighers </code> comes from <code>CONF.host_mgr_sched_wgt_cls_opt </code></p>
<ul>
<li><p>By default it’s all weighers</p>
<p><code>default=[&quot;nova.scheduler.weights.all_weighers&quot;]</code></p>
</li>
</ul>
</li>
<li><p><code>get_weighed_objects</code> is doing this:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i, weight <span class="keyword">in</span> <span class="built_in">enumerate</span>(weights):</span><br><span class="line">    obj = weighed_objs[i]</span><br><span class="line">    obj.weight += weigher.weight_multiplier() * weight</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Below are mentioned subroutines…</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<a id="more"></a>

<h3 id="nova-scheduler-host-manager-py"><a href="#nova-scheduler-host-manager-py" class="headerlink" title="nova/scheduler/host_manager.py"></a><code>nova/scheduler/host_manager.py</code></h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HostManager</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Base HostManager class.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Can be overridden in a subclass</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">host_state_cls</span>(<span class="params">self, host, node, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> HostState(host, node)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.host_state_map = &#123;&#125;</span><br><span class="line">        self.filter_handler = filters.HostFilterHandler()</span><br><span class="line">        filter_classes = self.filter_handler.get_matching_classes(</span><br><span class="line">                CONF.scheduler_available_filters)</span><br><span class="line">        self.filter_cls_map = &#123;cls.__name__: cls <span class="keyword">for</span> cls <span class="keyword">in</span> filter_classes&#125;</span><br><span class="line">        self.filter_obj_map = &#123;&#125;</span><br><span class="line">        self.default_filters = self._choose_host_filters(self._load_filters())</span><br><span class="line">        self.weight_handler = weights.HostWeightHandler()              &lt;--------- </span><br><span class="line">        weigher_classes = self.weight_handler.get_matching_classes(</span><br><span class="line">                CONF.scheduler_weight_classes)</span><br><span class="line">        self.weighers = [cls() <span class="keyword">for</span> cls <span class="keyword">in</span> weigher_classes]             &lt;--------- </span><br><span class="line"><span class="comment">#...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_weighed_hosts</span>(<span class="params">self, hosts, spec_obj</span>):</span>                      &lt;---------</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Weigh the hosts.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self.weight_handler.get_weighed_objects(self.weighers,</span><br><span class="line">                hosts, spec_obj)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="nova-conf-scheduler-py"><a href="#nova-conf-scheduler-py" class="headerlink" title="nova/conf/scheduler.py"></a><code>nova/conf/scheduler.py</code></h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">host_mgr_sched_wgt_cls_opt = cfg.ListOpt(<span class="string">&quot;scheduler_weight_classes&quot;</span>,</span><br><span class="line">        default=[<span class="string">&quot;nova.scheduler.weights.all_weighers&quot;</span>],</span><br><span class="line">        <span class="built_in">help</span>=<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">This is a list of weigher class names. Only hosts which pass the filters are</span></span><br><span class="line"><span class="string">weighed. The weight for any host starts at 0, and the weighers order these</span></span><br><span class="line"><span class="string">hosts by adding to or subtracting from the weight assigned by the previous</span></span><br><span class="line"><span class="string">weigher. Weights may become negative.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">An instance will be scheduled to one of the N most-weighted hosts, where N is</span></span><br><span class="line"><span class="string">&#x27;scheduler_host_subset_size&#x27;.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">By default, this is set to all weighers that are included with Nova. If you</span></span><br><span class="line"><span class="string">wish to change this, replace this with a list of strings, where each element is</span></span><br><span class="line"><span class="string">the path to a weigher.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">This option is only used by the FilterScheduler and its subclasses; if you use</span></span><br><span class="line"><span class="string">a different scheduler, this option has no effect.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">* Services that use this:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    ``nova-scheduler``</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">* Related options:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    None</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#...</span></span><br><span class="line"></span><br><span class="line">io_ops_weight_mult_opt = cfg.FloatOpt(<span class="string">&quot;io_ops_weight_multiplier&quot;</span>,</span><br><span class="line">        default=-<span class="number">1.0</span>,</span><br><span class="line">        <span class="built_in">help</span>=<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">This option determines how hosts with differing workloads are weighed. Negative</span></span><br><span class="line"><span class="string">values, such as the default, will result in the scheduler preferring hosts with</span></span><br><span class="line"><span class="string">lighter workloads whereas positive values will prefer hosts with heavier</span></span><br><span class="line"><span class="string">workloads. Another way to look at it is that positive values for this option</span></span><br><span class="line"><span class="string">will tend to schedule instances onto hosts that are already busy, while</span></span><br><span class="line"><span class="string">negative values will tend to distribute the workload across more hosts. The</span></span><br><span class="line"><span class="string">absolute value, whether positive or negative, controls how strong the io_ops</span></span><br><span class="line"><span class="string">weigher is relative to other weighers.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">This option is only used by the FilterScheduler and its subclasses; if you use</span></span><br><span class="line"><span class="string">a different scheduler, this option has no effect. Also note that this setting</span></span><br><span class="line"><span class="string">only affects scheduling if the &#x27;io_ops&#x27; weigher is enabled.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Valid values are numeric, either integer or float.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">* Services that use this:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    ``nova-scheduler``</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">* Related options:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    None</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>)</span><br></pre></td></tr></table></figure>


<p>We could get all <code>weight_mult_opt</code>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ grep _multiplier  nova/conf/scheduler.py  -A3 -B3 | grep _opts</span><br><span class="line">ram_weight_mult_opt = cfg.FloatOpt(<span class="string">&quot;ram_weight_multiplier&quot;</span>,</span><br><span class="line"></span><br><span class="line">disk_weight_mult_opt = cfg.FloatOpt(<span class="string">&quot;disk_weight_multiplier&quot;</span>,</span><br><span class="line"></span><br><span class="line">io_ops_weight_mult_opt = cfg.FloatOpt(<span class="string">&quot;io_ops_weight_multiplier&quot;</span>,</span><br><span class="line"></span><br><span class="line">metrics_weight_opts = [</span><br><span class="line">     cfg.FloatOpt(<span class="string">&quot;weight_multiplier&quot;</span>,</span><br><span class="line">     default=1.0,</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>And in <code>metrics_weight_opts</code> , check below:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">cpu.user.percent</span><br><span class="line">cpu.user.time</span><br><span class="line">cpu.iowait.percent</span><br><span class="line">cpu.iowait.time</span><br><span class="line">cpu.frequency</span><br><span class="line">cpu.idle.percent</span><br><span class="line">cpu.idle.time</span><br><span class="line">cpu.percent</span><br><span class="line">cpu.kernel.time</span><br><span class="line">cpu.kernel.percent</span><br></pre></td></tr></table></figure>
<p>example of a conf</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[metrics]</span><br><span class="line">weight_multiplier = -0.1</span><br><span class="line">weight_setting = cpu.iowait.percent=-1.0</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="existing-weighers"><a href="#existing-weighers" class="headerlink" title="existing weighers"></a>existing weighers</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">~/openstack/nova/nova/scheduler</span><br><span class="line">❯ tree weights</span><br><span class="line">weights</span><br><span class="line">├── __init__.py</span><br><span class="line">├── affinity.py</span><br><span class="line">├── cpu.py</span><br><span class="line">├── disk.py</span><br><span class="line">├── io_ops.py</span><br><span class="line">├── metrics.py</span><br><span class="line">└── ram.py</span><br></pre></td></tr></table></figure>
<h3 id="nova-weights-py"><a href="#nova-weights-py" class="headerlink" title="nova/weights.py"></a><code>nova/weights.py</code></h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Copyright (c) 2011-2012 OpenStack Foundation</span></span><br><span class="line"><span class="comment"># All Rights Reserved.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may</span></span><br><span class="line"><span class="comment">#    not use this file except in compliance with the License. You may obtain</span></span><br><span class="line"><span class="comment">#    a copy of the License at</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#         http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#    Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment">#    distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT</span></span><br><span class="line"><span class="comment">#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the</span></span><br><span class="line"><span class="comment">#    License for the specific language governing permissions and limitations</span></span><br><span class="line"><span class="comment">#    under the License.</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Pluggable Weighing support</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> abc</span><br><span class="line"><span class="keyword">import</span> six</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> nova <span class="keyword">import</span> loadables</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">normalize</span>(<span class="params">weight_list, minval=<span class="literal">None</span>, maxval=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Normalize the values in a list between 0 and 1.0.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    The normalization is made regarding the lower and upper values present in</span></span><br><span class="line"><span class="string">    weight_list. If the minval and/or maxval parameters are set, these values</span></span><br><span class="line"><span class="string">    will be used instead of the minimum and maximum from the list.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    If all the values are equal, they are normalized to 0.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> weight_list:</span><br><span class="line">        <span class="keyword">return</span> ()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> maxval <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        maxval = <span class="built_in">max</span>(weight_list)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> minval <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        minval = <span class="built_in">min</span>(weight_list)</span><br><span class="line"></span><br><span class="line">    maxval = <span class="built_in">float</span>(maxval)</span><br><span class="line">    minval = <span class="built_in">float</span>(minval)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> minval == maxval:</span><br><span class="line">        <span class="keyword">return</span> [<span class="number">0</span>] * <span class="built_in">len</span>(weight_list)</span><br><span class="line"></span><br><span class="line">    range_ = maxval - minval</span><br><span class="line">    <span class="keyword">return</span> ((i - minval) / range_ <span class="keyword">for</span> i <span class="keyword">in</span> weight_list)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WeighedObject</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Object with weight information.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, obj, weight</span>):</span></span><br><span class="line">        self.obj = obj</span><br><span class="line">        self.weight = weight</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&lt;WeighedObject &#x27;%s&#x27;: %s&gt;&quot;</span> % (self.obj, self.weight)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@six.add_metaclass(<span class="params">abc.ABCMeta</span>)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseWeigher</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Base class for pluggable weighers.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    The attributes maxval and minval can be specified to set up the maximum</span></span><br><span class="line"><span class="string">    and minimum values for the weighed objects. These values will then be</span></span><br><span class="line"><span class="string">    taken into account in the normalization step, instead of taking the values</span></span><br><span class="line"><span class="string">    from the calculated weights.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    minval = <span class="literal">None</span></span><br><span class="line">    maxval = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">weight_multiplier</span>(<span class="params">self</span>):</span>                               &lt;-------- weight <span class="keyword">for</span> weigher factor</span><br><span class="line">        <span class="string">&quot;&quot;&quot;How weighted this weigher should be.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Override this method in a subclass, so that the returned value is</span></span><br><span class="line"><span class="string">        read from a configuration option to permit operators specify a</span></span><br><span class="line"><span class="string">        multiplier for the weigher.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @abc.abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_weigh_object</span>(<span class="params">self, obj, weight_properties</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;Weigh an specific object.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">weigh_objects</span>(<span class="params">self, weighed_obj_list, weight_properties</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;Weigh multiple objects.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Override in a subclass if you need access to all objects in order</span></span><br><span class="line"><span class="string">        to calculate weights. Do not modify the weight of an object here,</span></span><br><span class="line"><span class="string">        just return a list of weights.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># Calculate the weights</span></span><br><span class="line">        weights = []</span><br><span class="line">        <span class="keyword">for</span> obj <span class="keyword">in</span> weighed_obj_list:</span><br><span class="line">            weight = self._weigh_object(obj.obj, weight_properties)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Record the min and max values if they are None. If they anything</span></span><br><span class="line">            <span class="comment"># but none we assume that the weigher has set them</span></span><br><span class="line">            <span class="keyword">if</span> self.minval <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                self.minval = weight</span><br><span class="line">            <span class="keyword">if</span> self.maxval <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                self.maxval = weight</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> weight &lt; self.minval:</span><br><span class="line">                self.minval = weight</span><br><span class="line">            <span class="keyword">elif</span> weight &gt; self.maxval:</span><br><span class="line">                self.maxval = weight</span><br><span class="line"></span><br><span class="line">            weights.append(weight)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> weights</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseWeightHandler</span>(<span class="params">loadables.BaseLoader</span>):</span></span><br><span class="line">    object_class = WeighedObject</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_weighed_objects</span>(<span class="params">self, weighers, obj_list, weighing_properties</span>):</span>  &lt;-------</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Return a sorted (descending), normalized list of WeighedObjects.&quot;&quot;&quot;</span></span><br><span class="line">        weighed_objs = [self.object_class(obj, <span class="number">0.0</span>) <span class="keyword">for</span> obj <span class="keyword">in</span> obj_list]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(weighed_objs) &lt;= <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> weighed_objs</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> weigher <span class="keyword">in</span> weighers:</span><br><span class="line">            weights = weigher.weigh_objects(weighed_objs, weighing_properties)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Normalize the weights</span></span><br><span class="line">            weights = normalize(weights,</span><br><span class="line">                                minval=weigher.minval,</span><br><span class="line">                                maxval=weigher.maxval)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> i, weight <span class="keyword">in</span> <span class="built_in">enumerate</span>(weights):</span><br><span class="line">                obj = weighed_objs[i]</span><br><span class="line">                obj.weight += weigher.weight_multiplier() * weight          &lt;--------- caculation</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">sorted</span>(weighed_objs, key=<span class="keyword">lambda</span> x: x.weight, reverse=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>


<h3 id="nova-scheduler-weights-metrics"><a href="#nova-scheduler-weights-metrics" class="headerlink" title="nova.scheduler.weights.metrics"></a><code>nova.scheduler.weights.metrics</code></h3><blockquote>
<p>ref:</p>
<ul>
<li><p><a href="https://01.org/sites/default/files/utilization_based_scheduing_in_openstack_compute_nova.pdf">https://01.org/sites/default/files/utilization_based_scheduing_in_openstack_compute_nova.pdf</a> </p>
</li>
<li><p><a href="https://docs.openstack.org/nova/mitaka/api/nova.scheduler.weights.metrics.html">https://docs.openstack.org/nova/mitaka/api/nova.scheduler.weights.metrics.html</a></p>
</li>
<li><p><a href="https://blueprints.launchpad.net/nova/+spec/utilization-aware-scheduling">https://blueprints.launchpad.net/nova/+spec/utilization-aware-scheduling</a></p>
</li>
</ul>
</blockquote>
<p>weight_setting in  <code>nova/conf/scheduler.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">     cfg.ListOpt(<span class="string">&quot;weight_setting&quot;</span>,</span><br><span class="line">            default=[],</span><br><span class="line">            <span class="built_in">help</span>=<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">This setting specifies the metrics to be weighed and the relative ratios for</span></span><br><span class="line"><span class="string">each metric. This should be a single string value, consisting of a series of</span></span><br><span class="line"><span class="string">one or more &#x27;name=ratio&#x27; pairs, separated by commas, where &#x27;name&#x27; is the name</span></span><br><span class="line"><span class="string">of the metric to be weighed, and &#x27;ratio&#x27; is the relative weight for that</span></span><br><span class="line"><span class="string">metric.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Note that if the ratio is set to 0, the metric value is ignored, and instead</span></span><br><span class="line"><span class="string">the weight will be set to the value of the &#x27;weight_of_unavailable&#x27; option.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">As an example, let&#x27;s consider the case where this option is set to:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    ``name1=1.0, name2=-1.3``</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The final weight will be:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    ``(name1.value * 1.0) + (name2.value * -1.3)``</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">This option is only used by the FilterScheduler and its subclasses; if you use</span></span><br><span class="line"><span class="string">a different scheduler, this option has no effect.</span></span><br></pre></td></tr></table></figure>
<p>Existing monitors in Mitaka, only cpu related</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">openstack/nova/nova/compute/monitors </span><br><span class="line">❯ tree</span><br><span class="line">.</span><br><span class="line">├── __init__.py</span><br><span class="line">├── base.py</span><br><span class="line">└── cpu</span><br><span class="line">    ├── __init__.py</span><br><span class="line">    └── virt_driver.py</span><br></pre></td></tr></table></figure>


<h1 id="How-What-we-could-do-something-here"><a href="#How-What-we-could-do-something-here" class="headerlink" title="How/What we could do something here?"></a>How/What we could do something here?</h1><p>I could come with two possibilities.</p>
<h2 id="Idea-one-tune-existing-weigher’s-mult-opt-or-weight-setting"><a href="#Idea-one-tune-existing-weigher’s-mult-opt-or-weight-setting" class="headerlink" title="Idea one, tune existing weigher’s mult_opt or weight_setting"></a>Idea one, tune existing weigher’s <code>mult_opt</code> or <code>weight_setting</code></h2><p>The factors are existing weighers, just tune their <code>mult_opt</code> or <code>weight_setting</code> via machine learning. Frankly the default values might not have been properly studied.</p>
<p>To do that: we need to perform edge case on massive concurent VM/VNF instantiations, define a <code>benchmark</code> to evaluate the “good” result we would like to have. Then to provide optimised tunning on existing weigher’s <code>mult_opt</code> or <code>weight_setting</code>.</p>
<ul>
<li><em>The key is to push the envrioment into limit, when, in that edge case, booting time, retry times and succefully rate may not be 100% good</em></li>
<li><em>The way to colletion data, should be well-considerred</em><ul>
<li>Could take one typical VNF as input to ensure this can benifit at least in one scenario </li>
<li>Or, take as more as possible VNFs, which could possibly have result with less bias( meanwhile maybe useless in small scale of data collections)</li>
</ul>
</li>
</ul>
<h2 id="Idea-two-introduce-new-dynamic-weigher-based-on-online-learning"><a href="#Idea-two-introduce-new-dynamic-weigher-based-on-online-learning" class="headerlink" title="Idea two, introduce new dynamic weigher based on online learning"></a>Idea two, introduce new dynamic weigher based on online learning</h2><p>This work actually is based on same work of idea one, but with two differences:</p>
<ol>
<li>Introduce more factors as input for a new weigher to co-exist with legacy ones, do exactly same thing as <code>idea one</code> to tune their weight arguments properly in lab.</li>
<li>It’s a dynamic weigher , which, let’s call it <code>learning-weigher</code>:<ul>
<li>This <code>learning-weigher</code> is with <code>arguments</code> percentent in database instead of in CONF as legacy ones do.</li>
<li>the <code>arguments</code> are being online-learning-updated by a machine learning daemon process.</li>
</ul>
</li>
</ol>
<h3 id="Find-a-working-model"><a href="#Find-a-working-model" class="headerlink" title="Find a working model"></a>Find a working model</h3><ul>
<li><input disabled="" type="checkbox"> Time</li>
<li><input disabled="" type="checkbox"> Resource</li>
<li><input disabled="" type="checkbox"> Telents # I would like to do this part. ☺</li>
</ul>
<h3 id="Define-edge-case-on-Massive-concurent-VM-VNF-instantiations"><a href="#Define-edge-case-on-Massive-concurent-VM-VNF-instantiations" class="headerlink" title="Define edge case on Massive concurent VM/VNF instantiations"></a>Define edge case on Massive concurent VM/VNF instantiations</h3><p>Two pars as below</p>
<h3 id="Defination-edge-case"><a href="#Defination-edge-case" class="headerlink" title="Defination edge case"></a>Defination edge case</h3><blockquote>
<p>The case should be designed to lead failures to ensure benchmark valid and of cource targeting to be like real work case/cases</p>
<p>Need domain knowledge and experiences from multi parties ☺</p>
</blockquote>
<ul>
<li><input disabled="" type="checkbox"> Time</li>
<li><input disabled="" type="checkbox"> Resource</li>
<li><input disabled="" type="checkbox"> Telents # I would like to do this part. ☺</li>
</ul>
<h3 id="Massive-concurent-VM-VNF-instantiations"><a href="#Massive-concurent-VM-VNF-instantiations" class="headerlink" title="Massive concurent VM/VNF instantiations"></a>Massive concurent VM/VNF instantiations</h3><blockquote>
<p>need hardware and supports, and ton of executuions for collecting data after being setup</p>
</blockquote>
<ul>
<li><input disabled="" type="checkbox"> Time</li>
<li><input disabled="" type="checkbox"> Resource</li>
<li><input disabled="" type="checkbox"> Telents # I have to do this part. ☺</li>
</ul>
<h3 id="Redesign-on-nova"><a href="#Redesign-on-nova" class="headerlink" title="Redesign on nova"></a>Redesign on nova</h3><blockquote>
<p>For idea 2, this is needed and I can do this part  ☺</p>
</blockquote>
<ul>
<li><input disabled="" type="checkbox"> Time</li>
<li><input disabled="" type="checkbox"> Resource</li>
<li><input disabled="" type="checkbox"> Telents # low priority :(</li>
</ul>
<h3 id="Envrionment-Requirement"><a href="#Envrionment-Requirement" class="headerlink" title="Envrionment Requirement"></a>Envrionment Requirement</h3><ul>
<li>A Cloud Infra allowing CPU over commitment(non-dedicated) workloads</li>
</ul>
<h1 id="Bayesian-optimization"><a href="#Bayesian-optimization" class="headerlink" title="Bayesian optimization"></a>Bayesian optimization</h1><ul>
<li><a href="https://research.fb.com/">https://research.fb.com/</a> <a href="https://research.fb.com/efficient-tuning-of-online-systems-using-bayesian-optimization/">efficient tuning of online systems using bayesian optimization</a></li>
<li><a href="http://xueshu.baidu.com/s?wd=paperuri:(79271906041a43713ec5e0df2afa73ef)&filter=sc_long_sign&sc_ks_para=q=Taking%20the%20Human%20Out%20of%20the%20Loop:%20A%20Review%20of%20Bayesian%20Optimization&sc_us=9376991681395462206&tn=SE_baiduxueshu_c1gjeupa&ie=utf-8">Taking the Human Out of the Loop: A Review of Bayesian Optimization</a></li>
</ul>
<h2 id="GPyOpt"><a href="#GPyOpt" class="headerlink" title="GPyOpt"></a>GPyOpt</h2><ul>
<li><a href="https://nbviewer.jupyter.org/github/SheffieldML/GPyOpt/blob/master/manual/index.ipynb">https://nbviewer.jupyter.org/github/SheffieldML/GPyOpt/blob/master/manual/index.ipynb</a></li>
</ul>
<h2 id="Refs"><a href="#Refs" class="headerlink" title="Refs"></a>Refs</h2><ul>
<li>local and global optimization <a href="https://web.maths.unsw.edu.au/~rsw/lgopt.pdf">https://web.maths.unsw.edu.au/~rsw/lgopt.pdf</a></li>
<li>EI(expected improvement) originally comes from:  <a href="https://link.springer.com/article/10.1023/A:1008306431147">Jones, D. R., Schonlau, M., and Welch, W. J. (1998)</a>. “Efficient Global Optimization of Expensive Black-Box Functions.” Journal of Global Optimization, 13: 455–492. MR1673460.</li>
<li>Rasmussen, Carl Edward and Williams, Christopher K. I. Gaussian processes for machine learning. Adaptive computation and machine learning. MIT Press, Cambridge, Mass, 2006. ISBN 978-0-262-18253-9. URL <a href="http://www.gaussianprocess.org/gpml/chapters/RW.pdf">http://www.gaussianprocess.org/gpml/chapters/RW.pdf</a>. OCLC: ocm61285753.</li>
<li>Optimization, fast and slow: optimally switching between local and Bayesian optimization <a href="https://arxiv.org/pdf/1805.08610.pdf">https://arxiv.org/pdf/1805.08610.pdf</a></li>
</ul>
]]></content>
      <tags>
        <tag>openstack</tag>
        <tag>cloud</tag>
        <tag>machine learning</tag>
        <tag>bayesian optimization</tag>
      </tags>
  </entry>
  <entry>
    <title>Openstack Basic for newbie</title>
    <url>/openstack-basic-for-newbie/</url>
    <content><![CDATA[<p>整理了一下2017年8月份内部做的一个training的slide，去除了不能公布的部分，放在<a href="https://github.com/wey-gu/workshops/blob/master/00-Openstack-Basic/release/Openstack_Basic_Blog.pdf">这里</a>。</p>
<p>那次的training是针对telco. engineers开始学习NFVi的知识的为期一周的，每天半天session的集中入门。前两天是讲解这个slide，后三天是hands-on的手动安装基于Ubuntu VM集群上的Openstack O。</p>
<p>hands-on的部分我写成了单独的note，也放在<a href="https://note.siwei.info/deploy-openstack-o-on-self-privisoned-virtualbox-ubuntu-vms-manually/">这里</a>。</p>
]]></content>
      <categories>
        <category>openstack</category>
      </categories>
      <tags>
        <tag>openstack</tag>
        <tag>slide</tag>
      </tags>
  </entry>
  <entry>
    <title>Performance Optimization refactor in Large Python Codebase, a note</title>
    <url>/performance-optimization-refactor-in-large-python-codebase-a-note/</url>
    <content><![CDATA[<h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p>Early this year, I had a chance to take a refactor task: one of our big downstream features doesn’t scale. Here I share some of my learning notes to potentially help you out there :-).</p>
<h2 id="Steps-to-follow"><a href="#Steps-to-follow" class="headerlink" title="Steps to follow"></a>Steps to follow</h2><h3 id="1-Runnable-Minimal-Reproduce"><a href="#1-Runnable-Minimal-Reproduce" class="headerlink" title="1. Runnable Minimal Reproduce"></a>1. Runnable Minimal Reproduce</h3><p>For a distributed system that required heavy hardware setup, or even worse, when you are trying to fix a case in the condition of a large scale, we need to have a runnable minimal reproduce(RMR) method to decouple the costly large scale of test environment/ production environment. A handy RMR is crucial as it brings us repeatability in circles of the rests steps.</p>
<p>In my case, when I started looking into this task, I found the only environment in hand was already quite expensive for the team (15+ servers, each of them is with 100+ GiB RAM and 40+ threads), yet it’s still far from the scale I am optimizing for(1000+ servers case).</p>
<blockquote>
<p>How to have a RMR?</p>
</blockquote>
<p>The answer could vary case by case:</p>
<ul>
<li>Buy/Pay-as-you-go-on-others-server 1000+ nodes cluster?<ul>
<li>This may be the best choice when you are in a cool organization working ;)</li>
</ul>
</li>
<li>Setup virtualized node cluster?<ul>
<li>In case you are dealing with the case you can semi-virtualize your environment to gain a 10/100 times scale yet with the closest to the real 1000+ node scale: use some efforts to set up 10 VMs on each bare-metal servers, that is, with 15+ servers you can reproduce the 150+ server issues. In my case, to create a virtualized environment is still very expensive as the workload we were working on depends on layers not that straightforward to be virtualized, and 150+ is still not enough for me.</li>
</ul>
</li>
<li>Mock it!<ul>
<li>I end up isolating the modular of code to be optimized, and, carefully mocking the interactions with other applications/ processes, with performance-wise mock.</li>
</ul>
</li>
</ul>
<p>With the RMR implemented, I put it in the existing UT code base with performance benchmark criteria as one of the assertions of the function I optimized. One of the reasons to trigger my putting RMR code in the codebase as UT is some of the surrounding mock utilities are there already, of course, the most important one is by doing so, these performance criteria will be always regression in every single commit merged to the codebase in future.</p>
<p>It’s worth mentioning that, during the implementation of RMR, there are some assumptions to be made, for example, the involved database, RESTful API, and RPC calls were mocked with sort of sleep in certain times, which was estimated based some experiments. The actual value may vary in different environments while values under some assumptions still can help us on some level of evaluation, yet, provide us comparison on before and after the refactoring (as of course, we use same assumptions).</p>
<h3 id="2-Profiling-and-analysis"><a href="#2-Profiling-and-analysis" class="headerlink" title="2. Profiling and analysis"></a>2. Profiling and analysis</h3><p>I started to have more of the whole-picture view of the function in two ways almost the same time: profiling and code reading.</p>
<p>Before profiling the function calls, I perceptually went through the code the feature and drew all call flows with time complexity with <a href="http://asciiflow.com/">http://asciiflow.com/</a> like this:</p>
<img data-src="/performance-optimization-refactor-in-large-python-codebase-a-note/flow_ascii_blur.png" class="flow_ascii">

<p>Or drew it in whiteboard like this:</p>
<a id="more"></a>

<img data-src="/performance-optimization-refactor-in-large-python-codebase-a-note/node_scheduler_flow_blur.jpg" class="node_scheduler_flow_blur">

<p>While we should never start making decisions on the refactoring before seeing some pieces of evidence supporting your optimization direction, there could be a hidden piece of code you were not aware of or, not executed the way you thought it should be.</p>
<p>In my case, to help understand more of the code and the performance overview of the call flow, I used two tools:</p>
<ul>
<li><a href="https://github.com/benfred/py-spy">py-spy</a></li>
<li><a href="https://pycallgraph.readthedocs.io/en/master/">pycallgraph</a></li>
</ul>
<p>I used py-spy to attach to a running process of the real environment(the 15+ node one), and the output of py-spy can be chosen to be parsed with <a href="https://www.speedscope.app/">https://www.speedscope.app</a>, which is something like:</p>
<img data-src="/performance-optimization-refactor-in-large-python-codebase-a-note/profiling_call_graph_blur.jpg" class="profiling_call_graph_blur">

<p>I added pycallgraph into the RMR, and created a utility script to enable profiling with results from code base with tox and UT functions, and created a result output like this, where I masked information in this example manually.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">&lt;foo bar&gt; Profiling Result</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">Foo Scale  (foo count): 1500</span><br><span class="line">Bar-ing Time (seconds): 1999999.999</span><br><span class="line"></span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">Top 20 Calls</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">Time                    Calls   Name</span><br><span class="line">---------------------------------------------------------------</span><br><span class="line">4.74627804756           1       foo.bar.blhablha_bar.blhablhabar._get_all_foo_states</span><br><span class="line">4.74620389938           1       foo.bar.foo_manager.fooManager.get_all_foo_states</span><br><span class="line">3.96935796738           500     foo.bar.foo_manager.fooState.run</span><br><span class="line">2.94463157654           500     foo.bar.foo_manager.fooState._locked_run</span><br><span class="line">2.76152682304           3508    joking.Logger._log</span><br><span class="line">2.40430951118           3008    joking.Logger.debug</span><br><span class="line">2.06136035919           2006    joking.KeywordArgumentAdapter.debug</span><br><span class="line">1.52482843399           3508    joking.Logger.handle</span><br><span class="line">1.42086815834           3508    joking.Logger.callHandlers</span><br><span class="line">1.05335450172           3508    foo.tests.fixtures.NullHandler.handle</span><br><span class="line">1.01028704643           3508    joking.NullHandler</span><br><span class="line">1.00268387794           4008    joking.Formatter</span><br><span class="line">0.882607698441          3508    joking.barer</span><br><span class="line">0.865972757339          500     foo.bar.foo_manager.fooState._run_from_zoo_node</span><br><span class="line">0.846918344498          4008    joking.LogRecord.getMessage</span><br><span class="line">0.784312725067          3508    joking.LogRecord.__init__</span><br><span class="line">0.669806003571          1       foo.bar.foo_manager.fooManager.get_blhablhaed_foos</span><br><span class="line">0.669651031494          1       foo.blhablhas.fooblhablhaHandler.get_blhablhaed_objects</span><br><span class="line">0.661297798157          501     foo.blhablhas.fooTestblhablha.blhablha_all</span><br><span class="line">0.653841972351          500     foo.bar.blhablhas.fooTestblhablha._blhablha_one</span><br></pre></td></tr></table></figure>
<p>With the help of the profiling output, I polished my refactoring plans, and gained more confidence to say the optimization may work. More importantly, the utility I created and the callflow chart can be rechecked/rerun anytime. It’s really to have your context persistent in a visualized fashion and again, RMR with profiling.</p>
<h3 id="3-Refactor"><a href="#3-Refactor" class="headerlink" title="3. Refactor"></a>3. Refactor</h3><p>It took much more time than I initially planned for the refactor implementation, there are always details not written in requirement/design documentation, and that involved more changes before all proposals landed eventually and brought me back the Step1 or Step2 to rework certain things. Thus I kept polishing the RMR code, the profiling code, polishing the call flow(with more details) and changed the design again and again.</p>
<p>With the help of RMR profiling, I could always quickly see the effect/ impact of every step changes, which, I consider make the refactor process even happier ;-).</p>
<p>In this project:</p>
<ul>
<li><p>DB Schema was changed, this help reduce DB calls and introduce more reasonable data structures</p>
</li>
<li><p>Many functions were refactored to:</p>
</li>
<li><ul>
<li>be decoupled with functions of other features</li>
<li>from a. centralized b. always calculated on the fly, to a. distributed to workers b. maintained and cached in an acceptable interval of loops</li>
<li>configurable cache aging policy and state change policy(from real-time consistency to eventual consistency in different polling intervals)</li>
</ul>
</li>
</ul>
<h3 id="4-Regression-Tests-CI-piped"><a href="#4-Regression-Tests-CI-piped" class="headerlink" title="4. Regression Tests, CI piped"></a>4. Regression Tests, CI piped</h3><ul>
<li>In the final phase, with the refactored codebase in a stable state, that is:<ul>
<li>All UT passed in the new design</li>
<li>Confirmed profiling utility results with expected gains</li>
</ul>
</li>
</ul>
<p>We could use as much as possible the legacy end to end regression test cases to ensure the refactor brought no surprises :-). I’m willing to bet that you will have to go back to some changes and even need to return to some of the previous steps, in that case, CI piped end to end test will save your life again and again before we call the refactor a success.</p>
]]></content>
      <tags>
        <tag>refactor</tag>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>Project Resource Board: a scalable webapp with Flask socketio and Vue.js</title>
    <url>/project-resource-board-a-scalable-webapp-with-flask-socketio-and-vue-js/</url>
    <content><![CDATA[<img data-src="/project-resource-board-a-scalable-webapp-with-flask-socketio-and-vue-js/arch_diagram_0.png" class="">

<h1 id="关于"><a href="#关于" class="headerlink" title="关于"></a>关于</h1><p>我在做一个叫做 resource board的 side project， 它是一个方便团队协作中使用共享资源的web app。</p>
<p>本文是我在写第一个发布版本之前持续更新的记录。</p>
<blockquote>
<p>updated in <code>2019-April-6</code></p>
<p>以单体架构先实现了可用的版本，部署在公司内网给项目使用上了，也公布一下代码：</p>
<p><a href="https://github.com/wey-gu/resource-board">https://github.com/wey-gu/resource-board</a></p>
<p>之后我会花时间迭代下去，不过现在课余时间在做一个机器学习调优的项目，这个优先级只能降低。</p>
</blockquote>
<h1 id="缘起"><a href="#缘起" class="headerlink" title="缘起"></a>缘起</h1><blockquote>
<p>为什么开始</p>
</blockquote>
<p>在云计算研发部门搬砖半年，一直做一些很小的feature开发，连着几个月早出晚归加上牺牲周末时间的赶进度让我内心很不平静。我需要做点什么，因为本质上我热爱的是 <code>build things</code>，做一个<code>proper side project</code> 的主意在脑子里转了好久了，我决定先做一个简单的东西出来。</p>
<p>这个东西就是一个 <code>resource board</code> 。</p>
<blockquote>
<p>学到什么</p>
</blockquote>
<p><code>resourece borard</code> 是我起的名字，其实就是一份在线的表格、面板，本质上用 <code>O365</code> / <code>onedrive for business</code> 完全可以实现类似的功效。不过我还是想造这样一个轮子，涉及一下产品开发的全生命周期的从无到有的创造、学习、实践：</p>
<ul>
<li>planning, prototyping</li>
<li>architecture</li>
<li>front end</li>
<li>back end</li>
<li>CI/ CD</li>
<li>maintenance</li>
<li>refactoring<ul>
<li>for test</li>
<li>for scale</li>
</ul>
</li>
<li>tuning</li>
</ul>
<blockquote>
<p>User story of resource board</p>
</blockquote>
<p><code>resource board</code> 主要解决异地团队协作中对共享资源使用的问题，它是一个电子化的资源使用白板。</p>
<p>试想一下没有资源占用白板的时候，团队里的人共享10个虚拟化数据中心，我们简称 <code>DC</code> ，对于它的使用分几个场景：</p>
<ul>
<li>CI <ul>
<li>被CI占用，没有再触发CI调用它的人不可以干预</li>
</ul>
</li>
<li>testing<ul>
<li>被非独占式的人使用中，特定的人可以并行使用它，（理想情况下）不会干扰到彼此</li>
</ul>
</li>
<li>occupied<ul>
<li>被人独占使用，不可与别人共享</li>
</ul>
</li>
<li>free<ul>
<li>任何人可以使用它，或者挪作其他用途</li>
</ul>
</li>
</ul>
<p>这种情况下，使用它的A同学需要站起来告诉所有人，或者群发邮件，说我要用 <code>DC123</code> 独占调试一个代码，有人在用么？ 10分钟后，在注意到没人回复的情况下，ta就在 <code>DC123</code>上开始<del>做坏事</del> 调试ta的代码了。然而刚从厕所回来的B同学，却发现ta的环境被破坏了，半天白忙活了😢。</p>
<p>如果这个资源共享的工作方式之中引入了记录资源占用情况的白板，A同学只需要看一下白板上空闲的DC，发现<code>DC125</code> 可以使用，他可以做到：</p>
<ul>
<li>无需等待确认广播信息的回复立刻使用 <code>DC125</code></li>
<li>不会破坏任何被占用的资源环境比如 <code>DC123</code> </li>
</ul>
<p>看起来比较自然。</p>
<h1 id="Planning"><a href="#Planning" class="headerlink" title="Planning"></a>Planning</h1><h2 id="关键点"><a href="#关键点" class="headerlink" title="关键点"></a>关键点</h2><ul>
<li>数字化白板应该是一个Wep App</li>
<li>它需要是实时的<ul>
<li>支持面向连接的(server —&gt; client)</li>
</ul>
</li>
<li>可扩展，可扩容<ul>
<li>后端<ul>
<li>只做api</li>
<li>分布式，可scale up</li>
</ul>
</li>
<li>前端<ul>
<li>single page client</li>
<li>websocket</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="简单原型"><a href="#简单原型" class="headerlink" title="简单原型"></a>简单原型</h2><p>我用Balsamiq Mockups 简单做了一个原型：</p>
<ul>
<li>用卡片表示每一个资源的信息</li>
<li>不同的section表示资源被使用的状态，或者分类</li>
<li>提供面向资源的历史查看页面</li>
</ul>
<p>我没有花更多时间去画更详细的原型图，只是在画这个初始的版本的过程中引导我思考我初始的数据schema，前后端最开始要做的事情，一旦雏形确定下来，我就直接进入前后端的开发，在开发中直接实现业务逻辑的进化。</p>
<blockquote>
<p> 这里是我截取的原型图的demo动画 😁</p>
</blockquote>
<a id="more"></a>

<p><video src="/project-resource-board-a-scalable-webapp-with-flask-socketio-and-vue-js/demo-board-history.mp4" controls='controls' width='100%' height='100%'></video></p>
<h2 id="前端、设计"><a href="#前端、设计" class="headerlink" title="前端、设计"></a>前端、设计</h2><h3 id="基础架子"><a href="#基础架子" class="headerlink" title="基础架子"></a>基础架子</h3><p>因为我不是一个JS guy、UI design guy，我选择了适合轻量级快速实现的方案: vue.js + material design。</p>
<p><del>一年</del>两年之前，我用：</p>
<ul>
<li>一本书(<a href="https://www.amazon.com/Non-Designers-Design-Book-4th/dp/0133966151">The Non-Designer’s Design Book (4th Edition)</a> )</li>
<li>一个框架(<a href="https://materializecss.com/getting-started.html">materialCSS</a>) </li>
</ul>
<p>做了一个遗留系统改造的Prove of Concept (<a href="https://github.com/wey-gu/yet-another-GSC-C-lighthouse">inno-search</a>)，那个过程我尝到了设计甜头，对于我这个没有任何设计经验的人，只是使用几个基本的设计 principle 就做出来明显没有设计缺陷的东西真的很有成就感，我甚至做了一个推广视频来在公司内部电视上播放 ( promo video here: <a href="https://vimeo.com/219328622">https://vimeo.com/219328622</a> )。</p>
<p>扯远了，这一次我还想使用 material design 的设计元素，来垒砌这个简单的board。</p>
<p>因为想尝试一下响应式的前端的开发，我选择 <a href="https://vuejs.org/">Vue.js</a> 和 <a href="https://vuetifyjs.com/">Vuetify.js</a> 。</p>
<ul>
<li><input disabled="" type="checkbox"> 如果我继续丰富工具的feature，我会考虑用 <a href="http://vma.isocked.com/#/dashboard">vue matierial admin</a> 堆砌更丰富的功能出来。</li>
</ul>
<blockquote>
<p>另外，<a href="https://element.eleme.io/">element-ui</a> 也是一个选择，也许我之后会用它做点什么 😝。</p>
</blockquote>
<h3 id="实时性需求"><a href="#实时性需求" class="headerlink" title="实时性需求"></a>实时性需求</h3><p>为了做到实时性，就是服务端推送实时的数据变化给连接的web客户端，我选择 <a href="https://socket.io/">Socket.IO</a>，而不是client 去pulling，这样做的好处是：</p>
<ul>
<li>WebSocket的connection的延时（ms）远比pull 的interval（s) 小，能做到 <code>真·实时</code></li>
<li>实时性要求高的pulling带来的后端的开销大于WebSocket连接</li>
</ul>
<h2 id="后端"><a href="#后端" class="headerlink" title="后端"></a>后端</h2><p>还是因为我不是 一个JS guy，没有选择更native的node.js，再来，我最熟悉的是 python，于是也就没有尝鲜 golang（以后可以试试）。</p>
<p>好久之前我在翻pycon的视频时候，注意到Miguel老师写了 <a href="https://github.com/miguelgrinberg/python-socketio">python socket-io</a>  实现，还有和他亲自基于此的 <a href="https://flask-socketio.readthedocs.io/en/latest/">Flask-socketio</a> ，一直都想要研究来试试，所以我还是选择熟悉的Flask 😁。</p>
<h3 id="消息队列"><a href="#消息队列" class="headerlink" title="消息队列"></a>消息队列</h3><p>因为可扩展架构的需求（分布式数据库、可扩展后端）：</p>
<ul>
<li>后端的 server/service instance 在分布式的情况下需要支持对所有client连接的广播</li>
<li>考虑对数据库的写操作通过基于队列的异步call规避数据并行写入做到一致性</li>
</ul>
<h3 id="任务队列"><a href="#任务队列" class="headerlink" title="任务队列"></a>任务队列</h3><p>还有两个个我没有提及的需求是：</p>
<ul>
<li>外部 API 周期性调用<ul>
<li>我们的board之中，resource应该可以通过周期性的call CI系统的API 获取它被CI调用的状态信息。这需要异步执行的周期性任务</li>
</ul>
</li>
<li>resource booking、scheduling<ul>
<li>后续提供终端用户去预约资源未来使用的功能，需要background task去监测、维护事件的触发和相关数据的读写</li>
</ul>
</li>
</ul>
<p>终于找到机会研究使用一下 <a href="http://www.celeryproject.org/">Celery</a> 了。</p>
<h2 id="生产环境部署"><a href="#生产环境部署" class="headerlink" title="生产环境部署"></a>生产环境部署</h2><p>因为兴趣原因，选择容器化，实践一下k8s的部署。</p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>Test Driven Develop，做到尽可能高coverage的单元测试。</p>
<h2 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h2><p>我简单地使用keynote.app 创建了一下架构图草稿如下。</p>
<img data-src="/project-resource-board-a-scalable-webapp-with-flask-socketio-and-vue-js/arch_diagram_0.png" class="">

<p><strong>Note:</strong></p>
<ul>
<li>通过 Nginx作为load balancer，以及外部用户的http webSocket 的tls加密解密节点，也就是说tls terminated in loadbalancer。</li>
<li>数据库的读写操作透过message queue(MQ)，这里它既是cache，又是写操作的queue，考虑使用Radis(<a href="http://python-rq.org/">rq</a>)。</li>
<li>后端为计划任务单独做一个instance，board-scheduler：<ul>
<li>用来处理resource 预约到期事件</li>
<li>周期地通过call Celery抓取 外部CI 系统的状态</li>
</ul>
</li>
<li>Celary instance处理 async call（非 cpu tense的）<ul>
<li>抓取 外部系统CI状态</li>
<li>DB call</li>
<li>socketIO broadcast</li>
</ul>
</li>
</ul>
<h1 id="Notes-during-coding"><a href="#Notes-during-coding" class="headerlink" title="Notes during coding"></a>Notes during coding</h1><p>这里放一些我在实现过程中的一点点注意的点。</p>
<h2 id="It’s-not-reactive"><a href="#It’s-not-reactive" class="headerlink" title="It’s not reactive?!"></a>It’s not reactive?!</h2><p>因为没有看完所有Vue.js的文档，就开始搞，没有意识到Vue.js对对象和数组内部变化的track是有限制的，所以做mutation的时候不可以直接假设嘴边更改都被响应式的反应到view之中，需要用Vue.set或者splice😁。</p>
<p>我写到中间发现View怎么都无法按照我的预期得到更新，debug 去print值也明明更改了（<code>vuex mutation</code>按照预期执行了），有那么半个小时我的价值观崩坍了，各种Google都无果（大家不响应变化的原因都是实际上mutation没有执行），直到我重头看了Vue.js的文档才发现我犯了最蠢的错误….</p>
<blockquote>
<p>ref:</p>
<ul>
<li><p><a href="https://vuejs.org/v2/guide/list.html#Replacing-an-Array">https://vuejs.org/v2/guide/list.html#Replacing-an-Array</a></p>
</li>
<li><p><a href="https://vuejs.org/v2/guide/list.html#Object-Change-Detection-Caveats">https://vuejs.org/v2/guide/list.html#Object-Change-Detection-Caveats</a></p>
</li>
</ul>
</blockquote>
<h2 id="Time-zone"><a href="#Time-zone" class="headerlink" title="Time zone"></a>Time zone</h2><blockquote>
<p>ref: <a href="http://momentjs.com/timezone/docs/">http://momentjs.com/timezone/docs/</a></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm install moment-timezone --save</span><br></pre></td></tr></table></figure>
<p>数据库中存储的时间戳是UTC时区的，在前端转换为浏览器中的local时区只需要用tz这方法</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">moment.tz.(timeString, timezoneString)</span><br></pre></td></tr></table></figure>
<p>我的例子:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">moment.tz(timeString, <span class="string">&#x27;UTC&#x27;</span>).local().format(<span class="string">&#x27;MMMM Do YYYY, h:mm:ss a&#x27;</span>)</span><br></pre></td></tr></table></figure>


<h2 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h2><p>在读这个小书，发现写的不错，有不会的概念去Google学清楚就好了。</p>
<blockquote>
<p>ref: <a href="https://www.openmymind.net/2012/1/23/The-Little-Redis-Book">https://www.openmymind.net/2012/1/23/The-Little-Redis-Book</a></p>
</blockquote>
<h2 id="vue-socket-io-authentication-with-flask-socket-io"><a href="#vue-socket-io-authentication-with-flask-socket-io" class="headerlink" title="vue-socket.io authentication with flask-socket.io"></a><code>vue-socket.io</code> authentication with <code>flask-socket.io</code></h2><blockquote>
<p>flask-login flask-socket.io vue-socket.io 登录鉴权的实现</p>
</blockquote>
<p>虽然server端实现了简单地<code>RESTful API</code>，用来为之后增加<code>cli-client</code>方便，我依然决定不通过 <code>http request</code>，使用<code>flask-login</code> 管理服务端状态，它把login信息记录在<code>flask-socketio</code>的<code>session</code>之中了。</p>
<h3 id="注意-需要给出-load-user-的定义"><a href="#注意-需要给出-load-user-的定义" class="headerlink" title="注意: 需要给出 load_user 的定义"></a>注意: 需要给出 <code>load_user</code> 的定义</h3><p>否则，会有如下异常:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">    <span class="string">&quot;No user_loader has been installed for this &quot;</span></span><br><span class="line">Exception: No user_loader has been installed <span class="keyword">for</span> this LoginManager. Refer tohttps://flask-login.readthedocs.io/en/latest/<span class="comment">#how-it-works for more info.</span></span><br></pre></td></tr></table></figure>
<p>实现的例子如下，另外还参考<code>flask-scoket.io</code> 官方文档糖一下 <code>authenticated_only</code> 这个装饰器，真香。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">    @login.user_loader</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">load_user</span>(<span class="params">user_id</span>):</span></span><br><span class="line">        <span class="keyword">return</span> models.Users.query.filter_by(<span class="built_in">id</span>=user_id).first()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticated_only</span>(<span class="params">f</span>):</span></span><br><span class="line"><span class="meta">        @functools.wraps(<span class="params">f</span>)</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapped</span>(<span class="params">*args, **kwargs</span>):</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> current_user.is_authenticated:</span><br><span class="line">                disconnect()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> f(*args, **kwargs)</span><br><span class="line">        <span class="keyword">return</span> wrapped</span><br><span class="line">...</span><br><span class="line"><span class="meta">    @socketio.on(<span class="params"><span class="string">&#x27;login user&#x27;</span></span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login_usr</span>(<span class="params">loginData</span>):</span></span><br><span class="line">        name, passwd = loginData[<span class="string">&#x27;username&#x27;</span>], loginData[<span class="string">&#x27;passwd&#x27;</span>]</span><br><span class="line">        user = models.Users.query.filter_by(name=name).first()</span><br><span class="line">        <span class="keyword">if</span> user <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> <span class="keyword">not</span> user.check_password(passwd):</span><br><span class="line">            response = &#123;</span><br><span class="line">                <span class="string">&quot;success&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">                <span class="string">&quot;alert_type&quot;</span>: <span class="string">&quot;error&quot;</span>,</span><br><span class="line">                <span class="string">&quot;alert_msg&quot;</span>: <span class="string">&quot;User not exist or invalid used password!&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            login_user(user)</span><br><span class="line">            response = &#123;</span><br><span class="line">                <span class="string">&quot;success&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">                <span class="string">&quot;user&quot;</span>: name</span><br><span class="line">                &#125;</span><br><span class="line">        emit(<span class="string">&#x27;loginResponse&#x27;</span>, json.dumps(response))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># socketio server handle events as below</span></span><br><span class="line"><span class="meta">    @socketio.on(<span class="params"><span class="string">&#x27;update resource&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">    @authenticated_only</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update_resource_server</span>(<span class="params">res</span>):</span></span><br><span class="line">        updated_res = modify_resource(app.config, res)</span><br><span class="line">        emit(<span class="string">&#x27;updateResource&#x27;</span>, updated_res, broadcast=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>


<h3 id="登录流程"><a href="#登录流程" class="headerlink" title="登录流程"></a>登录流程</h3><p><code>vuex</code>之中记录一个登录状态以供前端反应到view之中，<code>click</code>登录触发<code>socket.io</code> 调用，<code>flask-socket.io</code> server接收登录信息，验证，通过<code>socket.io</code> 调用返回login response，<code>vue-socket.io</code> 在vuex之中的 action hook 触发变化，<code>mutation</code> 去更新<code>login</code>状态，或者发送失败 alert。</p>
<h3 id="Vue-socket-io-amp-Vuex-例子"><a href="#Vue-socket-io-amp-Vuex-例子" class="headerlink" title="Vue-socket.io &amp; Vuex 例子"></a><code>Vue-socket.io</code> &amp; <code>Vuex</code> 例子</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> Vuex.Store(&#123;</span><br><span class="line">  state: &#123;</span><br><span class="line">    resources: [],</span><br><span class="line">    loading: <span class="literal">false</span>,</span><br><span class="line">    histories: &#123;&#125;,</span><br><span class="line">    loginInfo: &#123;</span><br><span class="line">      loggedIn: <span class="literal">false</span>,</span><br><span class="line">      userName: <span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  mutations: &#123;</span><br><span class="line">    login (state, response) &#123;</span><br><span class="line">      Vue.set(state.loginInfo, <span class="string">&#x27;loggedIn&#x27;</span>, response.success)</span><br><span class="line">      Vue.set(state.loginInfo, <span class="string">&#x27;userName&#x27;</span>, response.user)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  actions: &#123;</span><br><span class="line">    SOCKET_loginResponse ( &#123;commit&#125;, response) &#123;</span><br><span class="line">      <span class="comment">// eslint-disable-next-line</span></span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;[DEBUG] SOCKET_loginResponse:\n\t&#x27;</span> + response)</span><br><span class="line">      <span class="keyword">let</span> resp = <span class="built_in">JSON</span>.parse(response)</span><br><span class="line">      <span class="keyword">if</span> (resp.success === <span class="literal">true</span>) &#123;</span><br><span class="line">        commit(<span class="string">&#x27;login&#x27;</span>, resp)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> data = &#123;</span><br><span class="line">          type: resp.alert_type,</span><br><span class="line">          msg: resp.alert_msg,</span><br><span class="line">          dismissed: <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">        commit(<span class="string">&#x27;alerting&#x27;</span>, data)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    SOCKET_registerResponse ( &#123;commit&#125;, response) &#123;</span><br><span class="line">      <span class="comment">// eslint-disable-next-line</span></span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;[DEBUG] SOCKET_registerResponse:\n\t&#x27;</span> + response)</span><br><span class="line">      <span class="keyword">let</span> resp = <span class="built_in">JSON</span>.parse(response)</span><br><span class="line">      <span class="keyword">let</span> data = &#123;</span><br><span class="line">          type: resp.alert_type,</span><br><span class="line">          msg: resp.alert_msg,</span><br><span class="line">          dismissed: <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">      commit(<span class="string">&#x27;login&#x27;</span>, resp)</span><br><span class="line">      commit(<span class="string">&#x27;alerting&#x27;</span>, data)</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>


<h2 id="Post-build-hook-for-npm-build"><a href="#Post-build-hook-for-npm-build" class="headerlink" title="Post build hook for npm build"></a>Post build hook for <code>npm build</code></h2><p>因为要替换一下Google字体cdn到国内friendly的地方，我修改了 <code>package.json</code>中的 <code>postbuild</code>这个hook，来做cdn 的FQDN替换。</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&quot;scripts&quot;: &#123;</span><br><span class="line">  &quot;serve&quot;: &quot;vue-cli-service serve&quot;,</span><br><span class="line">  &quot;build&quot;: &quot;vue-cli-service build&quot;,</span><br><span class="line">  &quot;postbuild&quot;: &quot;./postbuild.sh&quot;,</span><br><span class="line">  &quot;lint&quot;: &quot;vue-cli-service lint&quot;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>


<blockquote>
<p>updated on 2021 Jan: 这个项目已经运行了快一整年了，因为一直稳定运行，也没有新的需求，就没抽出时间来迭代 :-P，这里放一个实际跑起来的 demo 视频:</p>
</blockquote>
<p><video src="/project-resource-board-a-scalable-webapp-with-flask-socketio-and-vue-js/resource_board_demo.mp4" controls='controls' width='100%' height='100%'></video></p>
<blockquote>
<p>And some screenshots here :-)</p>
</blockquote>
<p>Board Portal Page:</p>
<img data-src="/project-resource-board-a-scalable-webapp-with-flask-socketio-and-vue-js/screen_shot_0.png" class="">

<p>Resource History Page:</p>
<img data-src="/project-resource-board-a-scalable-webapp-with-flask-socketio-and-vue-js/screen_shot_1.png" class="">

<p>Resource Edit Card:</p>
<img data-src="/project-resource-board-a-scalable-webapp-with-flask-socketio-and-vue-js/screen_shot_2.png" class="">

]]></content>
      <categories>
        <category>build notes</category>
      </categories>
      <tags>
        <tag>fullstack</tag>
        <tag>flask</tag>
        <tag>socketio</tag>
        <tag>vue.js</tag>
        <tag>架构</tag>
      </tags>
  </entry>
  <entry>
    <title>Setup your ubuntu server in iPadOS with UTM</title>
    <url>/setup-your-ubuntu-server-in-ipados-with-utm/</url>
    <content><![CDATA[<p>This is the note on serving your Ubuntu server from iPadOS/ iOS with UTM, I am running 0.8 now.</p>
<blockquote>
<p>Download image</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget https://cloud-images.ubuntu.com/bionic/current/bionic-server-cloudimg-amd64.img</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Configure Password for the image, here we use chroot instead of config drive, the reason is at bottom.</p>
</blockquote>
<p>Use chroot to set password for the cloud image as follow:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="variable">$sudo</span> modprobe nbd max_part=1</span><br><span class="line"><span class="variable">$sudo</span> qemu-nbd --connect=/dev/nbd0 bionic-server-cloudimg-amd64.img</span><br><span class="line"><span class="variable">$mkdir</span> -p /mnt/nbd</span><br><span class="line"><span class="variable">$sudo</span> mount /dev/nbd0p1 /mnt/nbd/ -o noatime</span><br><span class="line"><span class="variable">$chroot</span> /mnt/nbd</span><br><span class="line">ubuntu<span class="comment"># passwd</span></span><br><span class="line">ubuntu<span class="comment"># exit</span></span><br><span class="line"><span class="variable">$sudo</span> qemu-nbd --disconnect /dev/nbd0</span><br><span class="line"><span class="variable">$sudo</span> umount /dev/nbd0p1</span><br></pre></td></tr></table></figure>
<a id="more"></a>

<blockquote>
<p>Use cloud drive is with ISSUES on UTM, as the nic mac address was fetched as <code>00:00:00:00</code> and it won’t proceed to configure the user data we put in the cloud drive…</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">RuntimeError Not all expected physical devices present 00:00:00:00</span><br></pre></td></tr></table></figure>
<p>In case it worked someday, you could simply do it as follow:</p>
<p>Let’s reuse the script created by Jan Walraven, ref: <a href="https://januz.nl/mac/generate-coreos-configdrive-iso-based-cloud-config-file">here</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">brew install qemu coreutils cdrtools</span><br><span class="line">./createIso.sh --cloud-config cloud-config.yml --name user-data</span><br></pre></td></tr></table></figure>
<p>Or in Debian</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt install qemu-utils cloud-utils</span><br><span class="line"></span><br><span class="line">cat &gt; user-data &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">#cloud-config</span></span><br><span class="line"><span class="string">users:</span></span><br><span class="line"><span class="string">  - default</span></span><br><span class="line"><span class="string">  - name: &lt;user&gt;</span></span><br><span class="line"><span class="string">    passwd: &lt;psw&gt;</span></span><br><span class="line"><span class="string">    ssh_pwauth: True</span></span><br><span class="line"><span class="string">    chpasswd: &#123; expire: False &#125;</span></span><br><span class="line"><span class="string">    sudo: ALL=(ALL) NOPASSWD:ALL</span></span><br><span class="line"><span class="string">    groups: users, admin</span></span><br><span class="line"><span class="string">    ssh_authorized_keys:</span></span><br><span class="line"><span class="string">      - ssh-rsa &lt;key&gt;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">cloud-localds config_drive.iso user-data</span><br></pre></td></tr></table></figure>
<p>Add above iso image to VM and mounted as a CD device, boot from your HDD device(the cloud image), it should configure yor password and ssh key as above user-data.</p>
]]></content>
      <categories>
        <category>random notes</category>
      </categories>
      <tags>
        <tag>iPadOS</tag>
        <tag>UTM</tag>
      </tags>
  </entry>
  <entry>
    <title>ML 2017 fall homework1 Linear Regression 笔记</title>
    <url>/ML-2017-fall-HW1-note/</url>
    <content><![CDATA[<h1 id="Gradient-Descent-for-linear-regression-task"><a href="#Gradient-Descent-for-linear-regression-task" class="headerlink" title="Gradient Descent for linear regression task"></a>Gradient Descent for linear regression task</h1><h2 id="Data-pre-processing"><a href="#Data-pre-processing" class="headerlink" title="Data pre processing"></a>Data pre processing</h2><ul>
<li>Load data from csv file to a list</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">trainDataList = <span class="built_in">list</span>()</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;train.csv&quot;</span>, newline=<span class="string">&quot;&quot;</span>) <span class="keyword">as</span> csvfile:</span><br><span class="line">    trainData = csv.reader(csvfile, delimiter=<span class="string">&quot;,&quot;</span>,quotechar=<span class="string">&quot;|&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> trainData:</span><br><span class="line">        trainDataList.append(line[<span class="number">3</span>:])</span><br></pre></td></tr></table></figure>
<ul>
<li><p>make all train data in one list, to enable iterating per hour of the list, thus, we have <code>(24 * days - 10 + 1)</code> training data.</p>
<p><code>trainDataIteratedPerHour: list()</code></p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># n lines to be one day</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mod_18</span>(<span class="params">n</span>):</span></span><br><span class="line">    <span class="keyword">return</span> n % <span class="number">18</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># transpose a matrix(2D list)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">T_list</span>(<span class="params">l</span>):</span></span><br><span class="line">    <span class="keyword">return</span> np.array(l).T.tolist()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line">trainDataIteratedPerHour = []</span><br><span class="line">listToAppend = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> trainDataList[<span class="number">1</span>:]:</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> mod_18(i):</span><br><span class="line">        <span class="comment"># from mod 10: 0</span></span><br><span class="line">        listToAppend = [item]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> mod_18(i) == <span class="number">10</span>:</span><br><span class="line">        <span class="comment"># rain, consider &quot;NR&quot; = 0</span></span><br><span class="line">        listToAppend.append([<span class="string">&quot;0&quot;</span> <span class="keyword">if</span> x == <span class="string">&#x27;NR&#x27;</span> <span class="keyword">else</span> x <span class="keyword">for</span> x <span class="keyword">in</span> item])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> mod_18(i) == <span class="number">17</span>:</span><br><span class="line">        <span class="comment"># all 18 lines collected, built a set of data to extend</span></span><br><span class="line">        listToAppend.append(item)</span><br><span class="line">        trainDataIteratedPerHour.extend(T_list(listToAppend))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># append other data</span></span><br><span class="line">        listToAppend.append(item)</span><br><span class="line">    i = i + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">i = <span class="number">0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>build <code>x_data</code> and <code>y_data</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">build x_data and y_data</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">x_data = [] <span class="comment"># 18*9 dimensions</span></span><br><span class="line">y_data = [] <span class="comment"># scalar, pm2.5 of next hour for x_data</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(trainDataIteratedPerHour) - <span class="number">10</span>):</span><br><span class="line">    x_data.extend(np.array(trainDataIteratedPerHour[n : n + <span class="number">9</span>]).reshape(<span class="number">1</span>,<span class="number">162</span>).tolist())</span><br><span class="line">    y_data.append(trainDataIteratedPerHour[n + <span class="number">10</span>][<span class="number">9</span>])</span><br><span class="line"></span><br><span class="line">x_data = [[<span class="built_in">float</span>(j) <span class="keyword">for</span> j <span class="keyword">in</span> i] <span class="keyword">for</span> i <span class="keyword">in</span> x_data]</span><br><span class="line">y_data = [<span class="built_in">float</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> y_data]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>draw plot (to feel the range of the data)</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># draw plot of pm2.5 range?</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> matplotlib</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">x = <span class="built_in">range</span>(<span class="built_in">len</span>(y_data))</span><br><span class="line">y = np.array(y_data)</span><br><span class="line"><span class="comment"># refer to https://matplotlib.org/2.2.2/gallery/lines_bars_and_markers/simple_plot.html</span></span><br><span class="line"></span><br><span class="line">fig, ax = plt.subplots()</span><br><span class="line">ax.plot(x, y)</span><br><span class="line"></span><br><span class="line"><span class="comment"># plt.show()</span></span><br></pre></td></tr></table></figure>


<h2 id="Loss-function"><a href="#Loss-function" class="headerlink" title="Loss function"></a>Loss function</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lossFunction</span>(<span class="params">w, x_data, y_data</span>):</span></span><br><span class="line">    w = np.array(w)</span><br><span class="line">    x_data = np.array(x_data)</span><br><span class="line">    result = <span class="number">0.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(y_data)):</span><br><span class="line">        result += (y_data[i] - <span class="built_in">sum</span>(w * x_data[i]))**<span class="number">2</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="comment"># w = [0.01] * 162</span></span><br><span class="line"><span class="comment"># L = lossFunction(w,x_data,y_data)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="Iterations-for-grident-descent"><a href="#Iterations-for-grident-descent" class="headerlink" title="Iterations for grident descent"></a>Iterations for grident descent</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Iterations</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">iterationRun</span>(<span class="params">lr,iteration,x_data,y_data</span>):</span></span><br><span class="line">    <span class="comment"># initial data</span></span><br><span class="line">    w = [<span class="number">0.01</span>] * <span class="number">162</span></span><br><span class="line">    L_history = [lossFunction(w,x_data,y_data)]</span><br><span class="line"></span><br><span class="line">    w = np.array(w)</span><br><span class="line">    x_data = np.array(x_data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> iterator <span class="keyword">in</span> <span class="built_in">range</span>(iteration):</span><br><span class="line">        <span class="comment"># initialize w_grad</span></span><br><span class="line">        w_grad = [<span class="number">0.0</span>] * <span class="number">162</span></span><br><span class="line">        <span class="comment"># sum of all training data set</span></span><br><span class="line">        <span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(y_data)):</span><br><span class="line">            <span class="comment"># per feature</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">162</span>):</span><br><span class="line">                w_grad[i] = w_grad[i] - <span class="number">2.0</span> * x_data[n][i] * ( <span class="built_in">sum</span>(w * x_data[n]) - y_data[n] )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># update w</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">162</span>):</span><br><span class="line">            w[i] = w[i] + lr * w_grad[i]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># store Loss Function hisotry for plotting</span></span><br><span class="line">        L_history.append(lossFunction(w,x_data,y_data))</span><br><span class="line">        <span class="built_in">print</span> (<span class="built_in">str</span>(iterator) + <span class="string">&quot; : &quot;</span> + <span class="built_in">str</span>(datetime.datetime.now().time()) + <span class="string">&quot; L:&quot;</span> + <span class="built_in">str</span>(L_history[-<span class="number">1</span>]))</span><br><span class="line">    <span class="keyword">return</span> L_history</span><br></pre></td></tr></table></figure>
<p>Run it for 10 iterations</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">lr = <span class="number">0.0000000000001</span> <span class="comment"># learning rate</span></span><br><span class="line">iteration = <span class="number">10</span></span><br><span class="line">iterationRun(lr,iteration,x_data,y_data)</span><br></pre></td></tr></table></figure>


<h2 id="Tunning"><a href="#Tunning" class="headerlink" title="Tunning"></a>Tunning</h2><h3 id="Find-good-initial-learning-rate"><a href="#Find-good-initial-learning-rate" class="headerlink" title="Find good initial learning rate"></a>Find good initial learning rate</h3><p>start with <code>lr = 0.0000000000001</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">19</span>]: lr = <span class="number">0.0000000000001</span> <span class="comment"># learning rate</span></span><br><span class="line">    ...: iteration = <span class="number">10</span></span><br><span class="line">    ...: iterationRun(lr,iteration,x_data,y_data)</span><br><span class="line">    ...:</span><br><span class="line"><span class="number">0</span> : <span class="number">13</span>:<span class="number">21</span>:<span class="number">22.227145</span> L:<span class="number">5897161.869645979</span></span><br><span class="line"><span class="number">1</span> : <span class="number">13</span>:<span class="number">21</span>:<span class="number">53.988814</span> L:<span class="number">5890818.193569232</span></span><br><span class="line"><span class="number">2</span> : <span class="number">13</span>:<span class="number">22</span>:<span class="number">25.639150</span> L:<span class="number">5884483.073933817</span></span><br><span class="line"><span class="number">3</span> : <span class="number">13</span>:<span class="number">22</span>:<span class="number">57.211950</span> L:<span class="number">5878156.49918669</span></span><br><span class="line"><span class="number">4</span> : <span class="number">13</span>:<span class="number">23</span>:<span class="number">28.873442</span> L:<span class="number">5871838.457790465</span></span><br><span class="line"><span class="number">5</span> : <span class="number">13</span>:<span class="number">24</span>:<span class="number">01.059230</span> L:<span class="number">5865528.93822318</span></span><br></pre></td></tr></table></figure>
<p>hmmm… try greater lr</p>
<p><code>lr = 0.00000000001</code></p>
<p>The loss function is descenting faster, like around 60000 per epoch.</p>
<a id="more"></a>



<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">21</span>]: lr = <span class="number">0.000000000001</span> <span class="comment"># learning rate</span></span><br><span class="line">    ...: iteration = <span class="number">10</span></span><br><span class="line">    ...: iterationRun(lr,iteration,x_data,y_data)</span><br><span class="line">    ...:</span><br><span class="line"><span class="number">0</span> : <span class="number">13</span>:<span class="number">35</span>:<span class="number">09.910428</span> L:<span class="number">5840184.58334736</span></span><br><span class="line"><span class="number">1</span> : <span class="number">13</span>:<span class="number">35</span>:<span class="number">41.650901</span> L:<span class="number">5777706.652466557</span></span><br><span class="line"><span class="number">2</span> : <span class="number">13</span>:<span class="number">36</span>:<span class="number">13.323090</span> L:<span class="number">5716068.8576254565</span></span><br><span class="line"><span class="number">3</span> : <span class="number">13</span>:<span class="number">36</span>:<span class="number">45.001751</span> L:<span class="number">5655259.889673614</span></span><br><span class="line"><span class="number">4</span> : <span class="number">13</span>:<span class="number">37</span>:<span class="number">16.168479</span> L:<span class="number">5595268.591697776</span></span><br><span class="line"><span class="number">5</span> : <span class="number">13</span>:<span class="number">37</span>:<span class="number">47.701241</span> L:<span class="number">5536083.956972405</span></span><br><span class="line"><span class="number">6</span> : <span class="number">13</span>:<span class="number">38</span>:<span class="number">19.216952</span> L:<span class="number">5477695.126938047</span></span><br><span class="line"><span class="number">7</span> : <span class="number">13</span>:<span class="number">38</span>:<span class="number">51.013157</span> L:<span class="number">5420091.389206737</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>our training set data is <code>5750</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">20</span>]: <span class="built_in">len</span>(y_data)</span><br><span class="line">Out[<span class="number">20</span>]: <span class="number">5750</span></span><br></pre></td></tr></table></figure>
<p>If prediected pm 2.5 value , a.k.a y data is in error range 10, the L value should be <code>5750*100=575000</code></p>
<p>With current descent speed, we will need 88 epoch:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">24</span>]: (<span class="number">5840184</span>-<span class="number">575000</span>)/<span class="number">60000</span></span><br><span class="line">Out[<span class="number">24</span>]: <span class="number">87.75306666666667</span></span><br></pre></td></tr></table></figure>
<p>let’s make it 10 times faster to see if target L could be get in 10 epoch</p>
<p><code>lr = 0.0000000001</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">27</span>]: lr = <span class="number">0.0000000001</span> <span class="comment"># learning rate</span></span><br><span class="line">    ...: iteration = <span class="number">10</span></span><br><span class="line">    ...: iterationRun(lr,iteration,x_data,y_data)</span><br><span class="line">    ...:</span><br><span class="line"><span class="number">0</span> : <span class="number">13</span>:<span class="number">49</span>:<span class="number">10.609660</span> L:<span class="number">1692576.375268496</span></span><br><span class="line"><span class="number">1</span> : <span class="number">13</span>:<span class="number">49</span>:<span class="number">42.475991</span> L:<span class="number">1242849.9101765472</span></span><br><span class="line"><span class="number">2</span> : <span class="number">13</span>:<span class="number">50</span>:<span class="number">14.660518</span> L:<span class="number">1189717.4416525147</span></span><br><span class="line"><span class="number">3</span> : <span class="number">13</span>:<span class="number">50</span>:<span class="number">46.605178</span> L:<span class="number">1178550.5080278912</span></span><br><span class="line"><span class="number">4</span> : <span class="number">13</span>:<span class="number">51</span>:<span class="number">18.416010</span> L:<span class="number">1171963.6339294983</span></span><br><span class="line"><span class="number">5</span> : <span class="number">13</span>:<span class="number">51</span>:<span class="number">50.342550</span> L:<span class="number">1166008.2433918654</span></span><br><span class="line"><span class="number">6</span> : <span class="number">13</span>:<span class="number">52</span>:<span class="number">22.022203</span> L:<span class="number">1160260.444018784</span></span><br><span class="line"><span class="number">7</span> : <span class="number">13</span>:<span class="number">52</span>:<span class="number">53.942997</span> L:<span class="number">1154668.3447938378</span></span><br><span class="line"><span class="number">8</span> : <span class="number">13</span>:<span class="number">53</span>:<span class="number">25.925997</span> L:<span class="number">1149219.7383900573</span></span><br><span class="line"><span class="number">9</span> : <span class="number">13</span>:<span class="number">53</span>:<span class="number">57.718994</span> L:<span class="number">1143907.0426408767</span></span><br><span class="line">Out[<span class="number">27</span>]:</span><br><span class="line">[<span class="number">5903514.1137326835</span>,</span><br><span class="line"> <span class="number">1692576.375268496</span>,</span><br><span class="line"> <span class="number">1242849.9101765472</span>,</span><br><span class="line"> <span class="number">1189717.4416525147</span>,</span><br><span class="line"> <span class="number">1178550.5080278912</span>,</span><br><span class="line"> <span class="number">1171963.6339294983</span>,</span><br><span class="line"> <span class="number">1166008.2433918654</span>,</span><br><span class="line"> <span class="number">1160260.444018784</span>,</span><br><span class="line"> <span class="number">1154668.3447938378</span>,</span><br><span class="line"> <span class="number">1149219.7383900573</span>,</span><br><span class="line"> <span class="number">1143907.0426408767</span>]</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># plot it </span></span><br><span class="line">x = <span class="built_in">range</span>(iteration+<span class="number">1</span>)</span><br><span class="line">y = np.array(L_history)</span><br><span class="line"><span class="comment"># refer to https://matplotlib.org/2.2.2/gallery/lines_bars_and_markers/simple_plot.html</span></span><br><span class="line"></span><br><span class="line">fig, ax = plt.subplots()</span><br><span class="line">ax.plot(x, y)</span><br></pre></td></tr></table></figure>
<img data-src="/ML-2017-fall-HW1-note/Figure_lr_tunning_1.png" class="">

<p>As we printed in first step only, we can see now the learning rate is way faster in initial step thus the first L printed is in smaller range!</p>
<p>And we also know it’s descenting slower after 10 ephoch, thus it’s not reaching our target <code>575000</code> in small steps.</p>
<p>I (for sure) know that I need to use adaptive learning rate and customised learning rate per feature(adagrade/ adam), while before that, I would like to see how it goes with smaller learning rate, while it goes to mess!</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">46</span>]: lr = <span class="number">0.000000001</span> <span class="comment"># learning rate</span></span><br><span class="line">    ...: iteration = <span class="number">10</span></span><br><span class="line">    ...: iterationRun(lr,iteration,x_data,y_data)</span><br><span class="line">    ...:</span><br><span class="line"><span class="number">0</span> : <span class="number">14</span>:09:<span class="number">17.516243</span> L:<span class="number">156704618.55348668</span></span><br><span class="line"><span class="number">1</span> : <span class="number">14</span>:09:<span class="number">49.509213</span> L:<span class="number">5150723049.19715</span></span><br><span class="line"><span class="number">2</span> : <span class="number">14</span>:<span class="number">10</span>:<span class="number">21.436315</span> L:<span class="number">170469039390.23218</span></span><br><span class="line"><span class="number">3</span> : <span class="number">14</span>:<span class="number">10</span>:<span class="number">53.396840</span> L:<span class="number">5642995478812.637</span></span><br></pre></td></tr></table></figure>
<h3 id="lr-1e-10"><a href="#lr-1e-10" class="headerlink" title="lr = 1e-10"></a>lr = <code>1e-10</code></h3><p>Then we could back to last initial learning rate, let’s get the final <code>w</code> by adding <code>print (w)</code> in <code>iterationRun()</code> , also we add initial w as an argument to enable modified initial <code>w</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">iterationRun</span>(<span class="params">lr,iteration,x_data,y_data, w = [<span class="number">0.01</span>] * <span class="number">162</span></span>):</span></span><br><span class="line">    <span class="comment"># initial data</span></span><br><span class="line">    </span><br><span class="line">    L_history = [lossFunction(w,x_data,y_data)]</span><br><span class="line"></span><br><span class="line">    w = np.array(w)</span><br><span class="line">    x_data = np.array(x_data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> iterator <span class="keyword">in</span> <span class="built_in">range</span>(iteration):</span><br><span class="line">        <span class="comment"># initialize w_grad</span></span><br><span class="line">        w_grad = [<span class="number">0.0</span>] * <span class="number">162</span></span><br><span class="line">        <span class="comment"># sum of all training data set</span></span><br><span class="line">        <span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(y_data)):</span><br><span class="line">            <span class="comment"># per feature</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">162</span>):</span><br><span class="line">                w_grad[i] = w_grad[i] - <span class="number">2.0</span> * x_data[n][i] * ( <span class="built_in">sum</span>(w * x_data[n]) - y_data[n] )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># update w</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">162</span>):</span><br><span class="line">            w[i] = w[i] + lr * w_grad[i]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># store Loss Function hisotry for plotting</span></span><br><span class="line">        L_history.append(lossFunction(w,x_data,y_data))</span><br><span class="line">        <span class="built_in">print</span> (<span class="built_in">str</span>(iterator) + <span class="string">&quot; : &quot;</span> + <span class="built_in">str</span>(datetime.datetime.now().time()) + <span class="string">&quot; L:&quot;</span> + <span class="built_in">str</span>(L_history[-<span class="number">1</span>]))</span><br><span class="line">    <span class="built_in">print</span> (w)</span><br><span class="line">    <span class="keyword">return</span> L_history</span><br></pre></td></tr></table></figure>
<p>Then after re-run, we got the <code>w</code>:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">49</span>]: lr = <span class="number">0.0000000001</span> <span class="comment"># learning rate</span></span><br><span class="line">    ...: iteration = <span class="number">10</span></span><br><span class="line">    ...: iterationRun(lr,iteration,x_data,y_data)</span><br><span class="line">    ...:</span><br><span class="line"><span class="number">0</span> : <span class="number">14</span>:<span class="number">24</span>:<span class="number">45.664141</span> L:<span class="number">1692576.375268496</span></span><br><span class="line"><span class="number">1</span> : <span class="number">14</span>:<span class="number">25</span>:<span class="number">17.259352</span> L:<span class="number">1242849.9101765472</span></span><br><span class="line"><span class="number">2</span> : <span class="number">14</span>:<span class="number">25</span>:<span class="number">49.273630</span> L:<span class="number">1189717.4416525147</span></span><br><span class="line"><span class="number">3</span> : <span class="number">14</span>:<span class="number">26</span>:<span class="number">20.965149</span> L:<span class="number">1178550.5080278912</span></span><br><span class="line"><span class="number">4</span> : <span class="number">14</span>:<span class="number">26</span>:<span class="number">52.781849</span> L:<span class="number">1171963.6339294983</span></span><br><span class="line"><span class="number">5</span> : <span class="number">14</span>:<span class="number">27</span>:<span class="number">24.309887</span> L:<span class="number">1166008.2433918654</span></span><br><span class="line"><span class="number">6</span> : <span class="number">14</span>:<span class="number">27</span>:<span class="number">56.071350</span> L:<span class="number">1160260.444018784</span></span><br><span class="line"><span class="number">7</span> : <span class="number">14</span>:<span class="number">28</span>:<span class="number">27.729255</span> L:<span class="number">1154668.3447938378</span></span><br><span class="line"><span class="number">8</span> : <span class="number">14</span>:<span class="number">28</span>:<span class="number">59.185918</span> L:<span class="number">1149219.7383900573</span></span><br><span class="line"><span class="number">9</span> : <span class="number">14</span>:<span class="number">29</span>:<span class="number">31.678511</span> L:<span class="number">1143907.0426408767</span></span><br><span class="line">[<span class="number">0.00865451</span> <span class="number">0.00992088</span> <span class="number">0.00998412</span> <span class="number">0.00999356</span> <span class="number">0.00989859</span> <span class="number">0.00958899</span></span><br><span class="line"> <span class="number">0.00949017</span> <span class="number">0.00853832</span> <span class="number">0.00886119</span> <span class="number">0.00971015</span> <span class="number">0.00996496</span> <span class="number">0.00622562</span></span><br><span class="line"> <span class="number">0.00986532</span> <span class="number">0.00991454</span> <span class="number">0.00047019</span> <span class="number">0.0002918</span>  <span class="number">0.00985504</span> <span class="number">0.009888</span></span><br><span class="line"> <span class="number">0.00866327</span> <span class="number">0.00992104</span> <span class="number">0.00998492</span> <span class="number">0.00999403</span> <span class="number">0.00990841</span> <span class="number">0.00960856</span></span><br><span class="line"> <span class="number">0.00951873</span> <span class="number">0.00854217</span> <span class="number">0.00888944</span> <span class="number">0.00973543</span> <span class="number">0.00996355</span> <span class="number">0.00618855</span></span><br><span class="line"> <span class="number">0.00987026</span> <span class="number">0.00991514</span> <span class="number">0.00064165</span> <span class="number">0.00051266</span> <span class="number">0.00985705</span> <span class="number">0.00988871</span></span><br><span class="line"> <span class="number">0.00867558</span> <span class="number">0.00992112</span> <span class="number">0.00998615</span> <span class="number">0.00999456</span> <span class="number">0.00991583</span> <span class="number">0.00962887</span></span><br><span class="line"> <span class="number">0.00954697</span> <span class="number">0.00857636</span> <span class="number">0.00896101</span> <span class="number">0.00978193</span> <span class="number">0.00996072</span> <span class="number">0.00613156</span></span><br><span class="line"> <span class="number">0.00987708</span> <span class="number">0.0099157</span>  <span class="number">0.00089779</span> <span class="number">0.00075592</span> <span class="number">0.00985905</span> <span class="number">0.00988954</span></span><br><span class="line"> <span class="number">0.00869251</span> <span class="number">0.0099212</span>  <span class="number">0.00998776</span> <span class="number">0.00999517</span> <span class="number">0.009925</span>   <span class="number">0.00965916</span></span><br><span class="line"> <span class="number">0.00958656</span> <span class="number">0.00863933</span> <span class="number">0.00905468</span> <span class="number">0.00984584</span> <span class="number">0.00995951</span> <span class="number">0.00605779</span></span><br><span class="line"> <span class="number">0.00988265</span> <span class="number">0.00991644</span> <span class="number">0.0011024</span>  <span class="number">0.00105049</span> <span class="number">0.00986111</span> <span class="number">0.00989001</span></span><br><span class="line"> <span class="number">0.00871203</span> <span class="number">0.00992131</span> <span class="number">0.00998925</span> <span class="number">0.00999581</span> <span class="number">0.0099313</span>  <span class="number">0.00969443</span></span><br><span class="line"> <span class="number">0.00962812</span> <span class="number">0.00874158</span> <span class="number">0.00919581</span> <span class="number">0.00993813</span> <span class="number">0.00996109</span> <span class="number">0.00597563</span></span><br><span class="line"> <span class="number">0.00989311</span> <span class="number">0.00991724</span> <span class="number">0.00152071</span> <span class="number">0.00139776</span> <span class="number">0.00986338</span> <span class="number">0.00989169</span></span><br><span class="line"> <span class="number">0.00873482</span> <span class="number">0.00992151</span> <span class="number">0.00999107</span> <span class="number">0.00999641</span> <span class="number">0.00993875</span> <span class="number">0.00973362</span></span><br><span class="line"> <span class="number">0.00967406</span> <span class="number">0.00888077</span> <span class="number">0.00938529</span> <span class="number">0.01006057</span> <span class="number">0.00996181</span> <span class="number">0.00589041</span></span><br><span class="line"> <span class="number">0.00990578</span> <span class="number">0.00991814</span> <span class="number">0.00187297</span> <span class="number">0.00190307</span> <span class="number">0.00986629</span> <span class="number">0.00989357</span></span><br><span class="line"> <span class="number">0.00875685</span> <span class="number">0.00992174</span> <span class="number">0.00999275</span> <span class="number">0.00999693</span> <span class="number">0.0099442</span>  <span class="number">0.00977445</span></span><br><span class="line"> <span class="number">0.00972014</span> <span class="number">0.00904638</span> <span class="number">0.00964319</span> <span class="number">0.01023079</span> <span class="number">0.00996201</span> <span class="number">0.00581055</span></span><br><span class="line"> <span class="number">0.00992017</span> <span class="number">0.00991885</span> <span class="number">0.0023883</span>  <span class="number">0.0023404</span>  <span class="number">0.00986947</span> <span class="number">0.00989559</span></span><br><span class="line"> <span class="number">0.0087768</span>  <span class="number">0.009922</span>   <span class="number">0.00999477</span> <span class="number">0.00999745</span> <span class="number">0.00994748</span> <span class="number">0.00981834</span></span><br><span class="line"> <span class="number">0.0097673</span>  <span class="number">0.00922359</span> <span class="number">0.00995879</span> <span class="number">0.01041849</span> <span class="number">0.00995968</span> <span class="number">0.00574316</span></span><br><span class="line"> <span class="number">0.00993535</span> <span class="number">0.00991957</span> <span class="number">0.00290124</span> <span class="number">0.00287465</span> <span class="number">0.00987295</span> <span class="number">0.0098975</span></span><br><span class="line"> <span class="number">0.00879132</span> <span class="number">0.0099223</span>  <span class="number">0.00999638</span> <span class="number">0.00999786</span> <span class="number">0.00994411</span> <span class="number">0.00986186</span></span><br><span class="line"> <span class="number">0.0098075</span>  <span class="number">0.00938749</span> <span class="number">0.0103109</span>  <span class="number">0.0108169</span>  <span class="number">0.00995914</span> <span class="number">0.00570475</span></span><br><span class="line"> <span class="number">0.00995173</span> <span class="number">0.00992029</span> <span class="number">0.0036527</span>  <span class="number">0.00347423</span> <span class="number">0.00987645</span> <span class="number">0.00990038</span>]</span><br><span class="line">Out[<span class="number">49</span>]:</span><br><span class="line">[<span class="number">5903514.1137326835</span>,</span><br><span class="line"> <span class="number">1692576.375268496</span>,</span><br><span class="line"> <span class="number">1242849.9101765472</span>,</span><br><span class="line"> <span class="number">1189717.4416525147</span>,</span><br><span class="line"> <span class="number">1178550.5080278912</span>,</span><br><span class="line"> <span class="number">1171963.6339294983</span>,</span><br><span class="line"> <span class="number">1166008.2433918654</span>,</span><br><span class="line"> <span class="number">1160260.444018784</span>,</span><br><span class="line"> <span class="number">1154668.3447938378</span>,</span><br><span class="line"> <span class="number">1149219.7383900573</span>,</span><br><span class="line"> <span class="number">1143907.0426408767</span>]</span><br></pre></td></tr></table></figure>
<h3 id="Run-10-20-epoch-lr-1e-10"><a href="#Run-10-20-epoch-lr-1e-10" class="headerlink" title="Run 10~20 epoch, lr=1e-10"></a>Run 10~20 epoch, lr=<code>1e-10</code></h3><p>Another 10 epoch( continued from first 10 epoch):</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#w = [] output value in initial 10 epoch</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">59</span>]: lr = <span class="number">0.0000000001</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">60</span>]: iteration = <span class="number">10</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">61</span>]: iterationRun(lr,iteration,x_data,y_data,w)</span><br><span class="line">    ...:</span><br><span class="line"><span class="number">0</span> : <span class="number">14</span>:<span class="number">41</span>:<span class="number">55.554137</span> L:<span class="number">1138723.54416636</span></span><br><span class="line"><span class="number">1</span> : <span class="number">14</span>:<span class="number">42</span>:<span class="number">27.844246</span> L:<span class="number">1133663.0986562215</span></span><br><span class="line"><span class="number">2</span> : <span class="number">14</span>:<span class="number">42</span>:<span class="number">59.894751</span> L:<span class="number">1128719.8759725974</span></span><br><span class="line"><span class="number">3</span> : <span class="number">14</span>:<span class="number">43</span>:<span class="number">32.401907</span> L:<span class="number">1123888.4508929225</span></span><br><span class="line"><span class="number">4</span> : <span class="number">14</span>:<span class="number">44</span>:<span class="number">04.728092</span> L:<span class="number">1119163.74563917</span></span><br><span class="line"><span class="number">5</span> : <span class="number">14</span>:<span class="number">44</span>:<span class="number">36.823878</span> L:<span class="number">1114541.0056141382</span></span><br><span class="line"><span class="number">6</span> : <span class="number">14</span>:<span class="number">45</span>:<span class="number">08.958169</span> L:<span class="number">1110015.776899496</span></span><br><span class="line"><span class="number">7</span> : <span class="number">14</span>:<span class="number">45</span>:<span class="number">41.079041</span> L:<span class="number">1105583.8853543748</span></span><br><span class="line"><span class="number">8</span> : <span class="number">14</span>:<span class="number">46</span>:<span class="number">13.182146</span> L:<span class="number">1101241.4171967693</span></span><br><span class="line"><span class="number">9</span> : <span class="number">14</span>:<span class="number">46</span>:<span class="number">45.360379</span> L:<span class="number">1096984.7009616988</span></span><br><span class="line">[ <span class="number">8.39928810e-03</span>  <span class="number">9.92018594e-03</span>  <span class="number">9.98672249e-03</span>  <span class="number">9.99395695e-03</span></span><br><span class="line">  <span class="number">9.90650252e-03</span>  <span class="number">9.66028161e-03</span>  <span class="number">9.57133059e-03</span>  <span class="number">8.59024624e-03</span></span><br><span class="line">  <span class="number">9.70063031e-03</span>  <span class="number">1.04003048e-02</span>  <span class="number">9.94007211e-03</span>  <span class="number">5.82092975e-03</span></span><br><span class="line">  <span class="number">9.86818613e-03</span>  <span class="number">9.91420797e-03</span> -<span class="number">7.30043313e-04</span> -<span class="number">9.74984684e-04</span></span><br><span class="line">  <span class="number">9.81897077e-03</span>  <span class="number">9.85914945e-03</span>  <span class="number">8.42038505e-03</span>  <span class="number">9.92049552e-03</span></span><br><span class="line">  <span class="number">9.98824144e-03</span>  <span class="number">9.99488279e-03</span>  <span class="number">9.92479021e-03</span>  <span class="number">9.70246400e-03</span></span><br><span class="line">  <span class="number">9.63010828e-03</span>  <span class="number">8.61918398e-03</span>  <span class="number">9.77660141e-03</span>  <span class="number">1.04616680e-02</span></span><br><span class="line">  <span class="number">9.93740891e-03</span>  <span class="number">5.73728090e-03</span>  <span class="number">9.87953143e-03</span>  <span class="number">9.91540645e-03</span></span><br><span class="line"> -<span class="number">2.36708203e-04</span> -<span class="number">4.46497772e-04</span>  <span class="number">9.82369317e-03</span>  <span class="number">9.86089703e-03</span></span><br><span class="line">  <span class="number">8.44699272e-03</span>  <span class="number">9.92063613e-03</span>  <span class="number">9.99060846e-03</span>  <span class="number">9.99592360e-03</span></span><br><span class="line">  <span class="number">9.93769384e-03</span>  <span class="number">9.74480356e-03</span>  <span class="number">9.68631482e-03</span>  <span class="number">8.69975569e-03</span></span><br><span class="line">  <span class="number">9.93568798e-03</span>  <span class="number">1.05632875e-02</span>  <span class="number">9.93195597e-03</span>  <span class="number">5.62070493e-03</span></span><br><span class="line">  <span class="number">9.89358966e-03</span>  <span class="number">9.91648735e-03</span>  <span class="number">3.09727865e-04</span>  <span class="number">3.32769386e-05</span></span><br><span class="line">  <span class="number">9.82806229e-03</span>  <span class="number">9.86271172e-03</span>  <span class="number">8.48109217e-03</span>  <span class="number">9.92078753e-03</span></span><br><span class="line">  <span class="number">9.99374187e-03</span>  <span class="number">9.99713322e-03</span>  <span class="number">9.95409819e-03</span>  <span class="number">9.80638186e-03</span></span><br><span class="line">  <span class="number">9.76454663e-03</span>  <span class="number">8.82732248e-03</span>  <span class="number">1.01321537e-02</span>  <span class="number">1.06964648e-02</span></span><br><span class="line">  <span class="number">9.92985319e-03</span>  <span class="number">5.47712005e-03</span>  <span class="number">9.90438972e-03</span>  <span class="number">9.91794789e-03</span></span><br><span class="line">  <span class="number">6.73973650e-04</span>  <span class="number">5.44360035e-04</span>  <span class="number">9.83218649e-03</span>  <span class="number">9.86359313e-03</span></span><br><span class="line">  <span class="number">8.51878100e-03</span>  <span class="number">9.92099916e-03</span>  <span class="number">9.99667211e-03</span>  <span class="number">9.99839142e-03</span></span><br><span class="line">  <span class="number">9.96501744e-03</span>  <span class="number">9.87773770e-03</span>  <span class="number">9.84678838e-03</span>  <span class="number">9.02306858e-03</span></span><br><span class="line">  <span class="number">1.04158946e-02</span>  <span class="number">1.08835903e-02</span>  <span class="number">9.93324622e-03</span>  <span class="number">5.32255768e-03</span></span><br><span class="line">  <span class="number">9.92446485e-03</span>  <span class="number">9.91952209e-03</span>  <span class="number">1.38594142e-03</span>  <span class="number">1.10724366e-03</span></span><br><span class="line">  <span class="number">9.83633504e-03</span>  <span class="number">9.86671984e-03</span>  <span class="number">8.56162962e-03</span>  <span class="number">9.92140609e-03</span></span><br><span class="line">  <span class="number">1.00002676e-02</span>  <span class="number">9.99958471e-03</span>  <span class="number">9.97874755e-03</span>  <span class="number">9.95697261e-03</span></span><br><span class="line">  <span class="number">9.93834450e-03</span>  <span class="number">9.28329913e-03</span>  <span class="number">1.07901635e-02</span>  <span class="number">1.11284264e-02</span></span><br><span class="line">  <span class="number">9.93483699e-03</span>  <span class="number">5.16636435e-03</span>  <span class="number">9.94860271e-03</span>  <span class="number">9.92131553e-03</span></span><br><span class="line">  <span class="number">1.92598395e-03</span>  <span class="number">1.94810223e-03</span>  <span class="number">9.84148301e-03</span>  <span class="number">9.87004892e-03</span></span><br><span class="line">  <span class="number">8.60192082e-03</span>  <span class="number">9.92187479e-03</span>  <span class="number">1.00036215e-02</span>  <span class="number">1.00006191e-02</span></span><br><span class="line">  <span class="number">9.98884103e-03</span>  <span class="number">1.00394245e-02</span>  <span class="number">1.00304865e-02</span>  <span class="number">9.58954906e-03</span></span><br><span class="line">  <span class="number">1.12961891e-02</span>  <span class="number">1.14662940e-02</span>  <span class="number">9.93528449e-03</span>  <span class="number">5.02390839e-03</span></span><br><span class="line">  <span class="number">9.97597866e-03</span>  <span class="number">9.92274238e-03</span>  <span class="number">2.75467811e-03</span>  <span class="number">2.63288432e-03</span></span><br><span class="line">  <span class="number">9.84692043e-03</span>  <span class="number">9.87360657e-03</span>  <span class="number">8.63756441e-03</span>  <span class="number">9.92241075e-03</span></span><br><span class="line">  <span class="number">1.00076795e-02</span>  <span class="number">1.00016598e-02</span>  <span class="number">9.99478393e-03</span>  <span class="number">1.01275708e-02</span></span><br><span class="line">  <span class="number">1.01245597e-02</span>  <span class="number">9.91586834e-03</span>  <span class="number">1.19162061e-02</span>  <span class="number">1.18375866e-02</span></span><br><span class="line">  <span class="number">9.93069923e-03</span>  <span class="number">4.90773511e-03</span>  <span class="number">1.00047837e-02</span>  <span class="number">9.92420129e-03</span></span><br><span class="line">  <span class="number">3.57134262e-03</span>  <span class="number">3.51203380e-03</span>  <span class="number">9.85289824e-03</span>  <span class="number">9.87690267e-03</span></span><br><span class="line">  <span class="number">8.66241404e-03</span>  <span class="number">9.92304041e-03</span>  <span class="number">1.00109440e-02</span>  <span class="number">1.00024858e-02</span></span><br><span class="line">  <span class="number">9.98759482e-03</span>  <span class="number">1.02142033e-02</span>  <span class="number">1.02041105e-02</span>  <span class="number">1.02157481e-02</span></span><br><span class="line">  <span class="number">1.26087041e-02</span>  <span class="number">1.26296733e-02</span>  <span class="number">9.92961546e-03</span>  <span class="number">4.84886429e-03</span></span><br><span class="line">  <span class="number">1.00360505e-02</span>  <span class="number">9.92566063e-03</span>  <span class="number">4.87428673e-03</span>  <span class="number">4.54246885e-03</span></span><br><span class="line">  <span class="number">9.85895437e-03</span>  <span class="number">9.88225200e-03</span>]</span><br><span class="line">Out[<span class="number">61</span>]:</span><br><span class="line">[<span class="number">1143907.0116957787</span>,</span><br><span class="line"> <span class="number">1138723.54416636</span>,</span><br><span class="line"> <span class="number">1133663.0986562215</span>,</span><br><span class="line"> <span class="number">1128719.8759725974</span>,</span><br><span class="line"> <span class="number">1123888.4508929225</span>,</span><br><span class="line"> <span class="number">1119163.74563917</span>,</span><br><span class="line"> <span class="number">1114541.0056141382</span>,</span><br><span class="line"> <span class="number">1110015.776899496</span>,</span><br><span class="line"> <span class="number">1105583.8853543748</span>,</span><br><span class="line"> <span class="number">1101241.4171967693</span>,</span><br><span class="line"> <span class="number">1096984.7009616988</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="number">62</span>]: L_history = [<span class="number">1143907.0116957787</span>,</span><br><span class="line">    ...:  <span class="number">1138723.54416636</span>,</span><br><span class="line">    ...:  <span class="number">1133663.0986562215</span>,</span><br><span class="line">    ...:  <span class="number">1128719.8759725974</span>,</span><br><span class="line">    ...:  <span class="number">1123888.4508929225</span>,</span><br><span class="line">    ...:  <span class="number">1119163.74563917</span>,</span><br><span class="line">    ...:  <span class="number">1114541.0056141382</span>,</span><br><span class="line">    ...:  <span class="number">1110015.776899496</span>,</span><br><span class="line">    ...:  <span class="number">1105583.8853543748</span>,</span><br><span class="line">    ...:  <span class="number">1101241.4171967693</span>,</span><br><span class="line">    ...:  <span class="number">1096984.7009616988</span>]</span><br><span class="line">    ...:</span><br><span class="line"></span><br><span class="line">In [<span class="number">63</span>]: x = <span class="built_in">range</span>(iteration+<span class="number">1</span>)</span><br><span class="line">    ...: y = np.array(L_history)</span><br><span class="line">    ...:</span><br><span class="line"></span><br><span class="line">In [<span class="number">64</span>]: fig, ax = plt.subplots()</span><br><span class="line">    ...: ax.plot(x, y)</span><br><span class="line">    ...:</span><br><span class="line">Out[<span class="number">64</span>]: [&lt;matplotlib.lines.Line2D at <span class="number">0x1098122e8</span>&gt;]</span><br><span class="line"></span><br><span class="line">In [<span class="number">65</span>]: plt.show()</span><br></pre></td></tr></table></figure>
<img data-src="/ML-2017-fall-HW1-note/Figure_lr_tunning_2_10to20.png" class="">

<p>The result is not bad! let’s continue</p>
<h3 id="Run-20-30-epoch-lr-1e-10"><a href="#Run-20-30-epoch-lr-1e-10" class="headerlink" title="Run 20-30 epoch, lr=1e-10"></a>Run 20-30 epoch, lr=<code>1e-10</code></h3><p>another 10 epoch</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">lr = <span class="number">1e-10</span> <span class="comment"># learning rate</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Out[<span class="number">69</span>]:</span><br><span class="line">[<span class="number">1096984.7010237887</span>,</span><br><span class="line"> <span class="number">1092810.2907994157</span>,</span><br><span class="line"> <span class="number">1088714.9506539872</span>,</span><br><span class="line"> <span class="number">1084695.6401611501</span>,</span><br><span class="line"> <span class="number">1080749.50095292</span>,</span><br><span class="line"> <span class="number">1076873.8442235377</span>,</span><br><span class="line"> <span class="number">1073066.1391172102</span>,</span><br><span class="line"> <span class="number">1069324.0019368476</span>,</span><br><span class="line"> <span class="number">1065645.186115302</span>,</span><br><span class="line"> <span class="number">1062027.5728949562</span>,</span><br><span class="line"> <span class="number">1058469.162665172</span>]</span><br></pre></td></tr></table></figure>
<img data-src="/ML-2017-fall-HW1-note/Figure_lr_tunning_2_0to32.png" class="">

<p>Let’s zoom to last 25 epoch</p>
<img data-src="/ML-2017-fall-HW1-note/Figure_lr_tunning_2_last25_after_33.png" class="">

<p>We still have 1060000-575000 = 485000, and now te speed is like 3000 descent per epoch, which means we could reach target in 160 epoch if it keeps the same speed :-) (for sure it won’t).</p>
<h3 id="30-200-epoch-lr-1e-10"><a href="#30-200-epoch-lr-1e-10" class="headerlink" title="30~200 epoch, lr=1e-10"></a>30~200 epoch, lr=<code>1e-10</code></h3><p>When it run to 200 epoch, the L reached <code>809150.2256672443</code></p>
<img data-src="/ML-2017-fall-HW1-note/Figure_lr_tunning_2_after_33_to200.png" class="">

<h3 id="207-388-epoch-lr-2e-10"><a href="#207-388-epoch-lr-2e-10" class="headerlink" title="207~388 epoch, lr=2e-10"></a>207~388 epoch, lr=<code>2e-10</code></h3><p>This time let’s give lr as doubled, the initial speed is faster while it will end up with very slow, and after 180 epoch, L is <code>703824.3536660115</code>.</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">105</span>]: <span class="function"><span class="keyword">def</span> <span class="title">iterationRun</span>(<span class="params">lr,iteration,x_data,y_data, w = [<span class="number">0.01</span>] * <span class="number">162</span></span>):</span></span><br><span class="line">     ...:     <span class="comment"># initial data</span></span><br><span class="line">     ...:</span><br><span class="line">     ...:     L_history = [lossFunction(w,x_data,y_data)]</span><br><span class="line">     ...:     W_history = [w]</span><br><span class="line">     ...:     w = np.array(w)</span><br><span class="line">     ...:     x_data = np.array(x_data)</span><br><span class="line">     ...:</span><br><span class="line">     ...:     <span class="keyword">for</span> iterator <span class="keyword">in</span> <span class="built_in">range</span>(iteration):</span><br><span class="line">     ...:         <span class="comment"># initialize w_grad</span></span><br><span class="line">     ...:         w_grad = [<span class="number">0.0</span>] * <span class="number">162</span></span><br><span class="line">     ...:         <span class="comment"># sum of all training data set</span></span><br><span class="line">     ...:         <span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(y_data)):</span><br><span class="line">     ...:             <span class="comment"># per feature</span></span><br><span class="line">     ...:             <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">162</span>):</span><br><span class="line">     ...:                 w_grad[i] = w_grad[i] - <span class="number">2.0</span> * x_data[n][i] * ( <span class="built_in">sum</span>(w * x_data[n]) - y_data[n] )</span><br><span class="line">     ...:</span><br><span class="line">     ...:         <span class="comment"># update w</span></span><br><span class="line">     ...:         <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">162</span>):</span><br><span class="line">     ...:             w[i] = w[i] + lr * w_grad[i]</span><br><span class="line">     ...:</span><br><span class="line">     ...:         <span class="comment"># store Loss Function hisotry for plotting</span></span><br><span class="line">     ...:         L_history.append(lossFunction(w,x_data,y_data))</span><br><span class="line">     ...:         W_history.append(w[<span class="number">0</span>:])</span><br><span class="line">     ...:         <span class="built_in">print</span> (<span class="built_in">str</span>(iterator) + <span class="string">&quot; : &quot;</span> + <span class="built_in">str</span>(datetime.datetime.now().time()) + <span class="string">&quot; L:&quot;</span> + <span class="built_in">str</span>(L_history[-<span class="number">1</span>]))</span><br><span class="line">     ...:     <span class="built_in">print</span> (w)</span><br><span class="line">     ...:     <span class="keyword">return</span> L_history, W_history</span><br><span class="line">     ...:</span><br><span class="line"></span><br><span class="line">In [<span class="number">106</span>]: lr = <span class="number">2e-10</span> <span class="comment"># learning rate</span></span><br><span class="line">     ...: iteration = <span class="number">180</span></span><br><span class="line">     ...: <span class="comment">#iterationRun(lr,iteration,x_data,y_data)</span></span><br><span class="line">     ...: <span class="comment">#w= &lt;last time&gt;</span></span><br><span class="line">     ...: L, W = iterationRun(lr,iteration,x_data,y_data,w)</span><br><span class="line">     ...: <span class="built_in">print</span> (<span class="built_in">str</span>(L))</span><br><span class="line">     ...:</span><br></pre></td></tr></table></figure>


<img data-src="/ML-2017-fall-HW1-note/Figure_lr_tunning_207_388_doubleLR.png" class="">

<h3 id="388-391-epoch-lr-1e-8"><a href="#388-391-epoch-lr-1e-8" class="headerlink" title="388~ 391 epoch, lr =1e-8"></a>388~ 391 epoch, lr =<code>1e-8</code></h3><p>By tunning lr as we did in begining, it’s found <code>1e-8</code> can descent the L faster while <code>1e-7</code> will lead the value go mess:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">135</span>]: lr = <span class="number">1e-8</span> <span class="comment"># learning rate</span></span><br><span class="line">     ...: iteration = <span class="number">3</span></span><br><span class="line">     ...: <span class="comment">#iterationRun(lr,iteration,x_data,y_data)</span></span><br><span class="line">     ...: <span class="comment">#w= &lt;last time&gt;</span></span><br><span class="line">     ...: L, W = iterationRun(lr,iteration,x_data,y_data,w)</span><br><span class="line">     ...: <span class="built_in">print</span> (<span class="built_in">str</span>(L))</span><br><span class="line">     ...:</span><br><span class="line"><span class="number">0</span> : <span class="number">20</span>:<span class="number">36</span>:<span class="number">21.318040</span> L:<span class="number">688000.4130500836</span></span><br><span class="line"><span class="number">1</span> : <span class="number">20</span>:<span class="number">36</span>:<span class="number">50.809668</span> L:<span class="number">674508.5537428795</span></span><br><span class="line"><span class="number">2</span> : <span class="number">20</span>:<span class="number">37</span>:<span class="number">20.181931</span> L:<span class="number">662770.7844944517</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">136</span>]: lr = <span class="number">1e-7</span> <span class="comment"># learning rate</span></span><br><span class="line">     ...: iteration = <span class="number">3</span></span><br><span class="line">     ...: <span class="comment">#iterationRun(lr,iteration,x_data,y_data)</span></span><br><span class="line">     ...: <span class="comment">#w= &lt;last time&gt;</span></span><br><span class="line">     ...: L, W = iterationRun(lr,iteration,x_data,y_data,w)</span><br><span class="line">     ...: <span class="built_in">print</span> (<span class="built_in">str</span>(L))</span><br><span class="line">     ...:</span><br><span class="line"><span class="number">0</span> : <span class="number">20</span>:<span class="number">39</span>:<span class="number">52.192365</span> L:<span class="number">608540.3895276675</span></span><br><span class="line"><span class="number">1</span> : <span class="number">20</span>:<span class="number">40</span>:<span class="number">20.381015</span> L:<span class="number">784689.7603969924</span></span><br><span class="line"><span class="number">2</span> : <span class="number">20</span>:<span class="number">40</span>:<span class="number">49.856693</span> L:<span class="number">7013862.489781529</span></span><br></pre></td></tr></table></figure>
<p>Let’s do it with lr=<code>1e-8</code>, for another 20 epoch:</p>
<p>In the 0th~7th , L was normal while after from 4th epoch, the L goes crazy…</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">144</span>]: lr = <span class="number">1e-8</span> <span class="comment"># learning rate</span></span><br><span class="line">     ...: iteration = <span class="number">7</span></span><br><span class="line">     ...: <span class="comment">#iterationRun(lr,iteration,x_data,y_data)</span></span><br><span class="line">     ...: <span class="comment">#w= &lt;last time&gt;</span></span><br><span class="line">     ...: L, W = iterationRun(lr,iteration,x_data,y_data,w)</span><br><span class="line">     ...: <span class="built_in">print</span> (<span class="built_in">str</span>(L))</span><br><span class="line">     ...:</span><br><span class="line"><span class="number">0</span> : <span class="number">21</span>:05:<span class="number">33.350228</span> L:<span class="number">688000.4130783302</span></span><br><span class="line"><span class="number">1</span> : <span class="number">21</span>:06:<span class="number">02.751233</span> L:<span class="number">674508.5537976791</span></span><br><span class="line"><span class="number">2</span> : <span class="number">21</span>:06:<span class="number">32.191330</span> L:<span class="number">662770.9045613626</span></span><br><span class="line"><span class="number">3</span> : <span class="number">21</span>:07:<span class="number">01.596806</span> L:<span class="number">652980.2949830776</span></span><br><span class="line"><span class="number">4</span> : <span class="number">21</span>:07:<span class="number">30.931137</span> L:<span class="number">2995810.210193815</span></span><br><span class="line"><span class="number">5</span> : <span class="number">21</span>:07:<span class="number">58.316067</span> L:<span class="number">10415063655.932451</span></span><br><span class="line"><span class="number">6</span> : <span class="number">21</span>:08:<span class="number">27.808302</span> L:<span class="number">46103934331702.31</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>below is a record for <em>w</em> in epoch 391 </p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">171</span>]: lr = <span class="number">1e-8</span> <span class="comment"># learning rate</span></span><br><span class="line">     ...: iteration = <span class="number">3</span></span><br><span class="line">     ...: <span class="comment">#iterationRun(lr,iteration,x_data,y_data)</span></span><br><span class="line">     ...: <span class="comment">#w= &lt;last time&gt;</span></span><br><span class="line">     ...: L, W = iterationRun(lr,iteration,x_data,y_data,w)</span><br><span class="line">     ...: <span class="built_in">print</span> (<span class="built_in">str</span>(L))</span><br><span class="line">     ...:</span><br><span class="line"><span class="number">0</span> : <span class="number">21</span>:<span class="number">37</span>:<span class="number">21.649233</span> L:<span class="number">688000.4130783302</span></span><br><span class="line"><span class="number">1</span> : <span class="number">21</span>:<span class="number">37</span>:<span class="number">51.147582</span> L:<span class="number">674508.5537976791</span></span><br><span class="line"><span class="number">2</span> : <span class="number">21</span>:<span class="number">38</span>:<span class="number">21.861637</span> L:<span class="number">662770.9045613626</span></span><br><span class="line">[-<span class="number">0.00138578</span>  <span class="number">0.00996187</span>  <span class="number">0.00992188</span>  <span class="number">0.00993515</span>  <span class="number">0.00986949</span>  <span class="number">0.00805936</span></span><br><span class="line">  <span class="number">0.0080644</span>   <span class="number">0.00106609</span>  <span class="number">0.01072566</span>  <span class="number">0.02052564</span>  <span class="number">0.00912203</span>  <span class="number">0.00516551</span></span><br><span class="line">  <span class="number">0.00908692</span>  <span class="number">0.00989289</span> -<span class="number">0.00494451</span> -<span class="number">0.00553225</span>  <span class="number">0.00835639</span>  <span class="number">0.00869886</span></span><br><span class="line"> -<span class="number">0.00098925</span>  <span class="number">0.00997357</span>  <span class="number">0.00992211</span>  <span class="number">0.00995052</span>  <span class="number">0.01018278</span>  <span class="number">0.0086643</span></span><br><span class="line">  <span class="number">0.00890506</span>  <span class="number">0.00047888</span>  <span class="number">0.00890631</span>  <span class="number">0.02018968</span>  <span class="number">0.00904637</span>  <span class="number">0.00401723</span></span><br><span class="line">  <span class="number">0.00933431</span>  <span class="number">0.00991875</span>  <span class="number">0.00064744</span> -<span class="number">0.0033074</span>   <span class="number">0.00849263</span>  <span class="number">0.00874045</span></span><br><span class="line"> -<span class="number">0.00051749</span>  <span class="number">0.00997629</span>  <span class="number">0.00995735</span>  <span class="number">0.00997091</span>  <span class="number">0.01031358</span>  <span class="number">0.00907041</span></span><br><span class="line">  <span class="number">0.00948262</span>  <span class="number">0.00029924</span>  <span class="number">0.00947152</span>  <span class="number">0.02093619</span>  <span class="number">0.00880021</span>  <span class="number">0.00215371</span></span><br><span class="line">  <span class="number">0.00952237</span>  <span class="number">0.0099359</span>   <span class="number">0.00232706</span> -<span class="number">0.00298543</span>  <span class="number">0.00857945</span>  <span class="number">0.0087675</span></span><br><span class="line">  <span class="number">0.00012513</span>  <span class="number">0.00998106</span>  <span class="number">0.01003116</span>  <span class="number">0.01000607</span>  <span class="number">0.01077548</span>  <span class="number">0.01044418</span></span><br><span class="line">  <span class="number">0.01133557</span>  <span class="number">0.00046847</span>  <span class="number">0.01040126</span>  <span class="number">0.02224197</span>  <span class="number">0.00872205</span> -<span class="number">0.00046986</span></span><br><span class="line">  <span class="number">0.00953514</span>  <span class="number">0.0099784</span>   <span class="number">0.00020964</span> -<span class="number">0.00338643</span>  <span class="number">0.00863159</span>  <span class="number">0.0087242</span></span><br><span class="line">  <span class="number">0.00086619</span>  <span class="number">0.00999047</span>  <span class="number">0.01011715</span>  <span class="number">0.0100483</span>   <span class="number">0.0111914</span>   <span class="number">0.01258666</span></span><br><span class="line">  <span class="number">0.01390036</span>  <span class="number">0.00246372</span>  <span class="number">0.01393081</span>  <span class="number">0.02545522</span>  <span class="number">0.00884365</span> -<span class="number">0.00351077</span></span><br><span class="line">  <span class="number">0.00998476</span>  <span class="number">0.01003383</span>  <span class="number">0.00191473</span> -<span class="number">0.00361946</span>  <span class="number">0.0086276</span>   <span class="number">0.0087466</span></span><br><span class="line">  <span class="number">0.00184757</span>  <span class="number">0.01000815</span>  <span class="number">0.01025325</span>  <span class="number">0.01009751</span>  <span class="number">0.01193828</span>  <span class="number">0.0155177</span></span><br><span class="line">  <span class="number">0.01751577</span>  <span class="number">0.00667147</span>  <span class="number">0.02101305</span>  <span class="number">0.03113944</span>  <span class="number">0.00889165</span> -<span class="number">0.00695875</span></span><br><span class="line">  <span class="number">0.0106579</span>   <span class="number">0.01010881</span> -<span class="number">0.00077711</span> -<span class="number">0.00135554</span>  <span class="number">0.00866196</span>  <span class="number">0.00875398</span></span><br><span class="line">  <span class="number">0.00287227</span>  <span class="number">0.01003138</span>  <span class="number">0.01041372</span>  <span class="number">0.01014875</span>  <span class="number">0.01271766</span>  <span class="number">0.01906602</span></span><br><span class="line">  <span class="number">0.02182703</span>  <span class="number">0.01341795</span>  <span class="number">0.03354977</span>  <span class="number">0.0410597</span>   <span class="number">0.00883776</span> -<span class="number">0.01065909</span></span><br><span class="line">  <span class="number">0.01155844</span>  <span class="number">0.01017867</span>  <span class="number">0.00019663</span> -<span class="number">0.00158868</span>  <span class="number">0.0087129</span>   <span class="number">0.00877181</span></span><br><span class="line">  <span class="number">0.00398101</span>  <span class="number">0.01006115</span>  <span class="number">0.01063675</span>  <span class="number">0.01021088</span>  <span class="number">0.01347817</span>  <span class="number">0.02330813</span></span><br><span class="line">  <span class="number">0.02683348</span>  <span class="number">0.02287656</span>  <span class="number">0.05497111</span>  <span class="number">0.05429585</span>  <span class="number">0.00857217</span> -<span class="number">0.01436562</span></span><br><span class="line">  <span class="number">0.01264097</span>  <span class="number">0.01026398</span>  <span class="number">0.00019394</span>  <span class="number">0.00094537</span>  <span class="number">0.00884171</span>  <span class="number">0.00880042</span></span><br><span class="line">  <span class="number">0.00505424</span>  <span class="number">0.01009949</span>  <span class="number">0.01085199</span>  <span class="number">0.01027042</span>  <span class="number">0.01374666</span>  <span class="number">0.02776093</span></span><br><span class="line">  <span class="number">0.03155206</span>  <span class="number">0.03391963</span>  <span class="number">0.08474549</span>  <span class="number">0.08799973</span>  <span class="number">0.0083985</span>  -<span class="number">0.01724419</span></span><br><span class="line">  <span class="number">0.01399544</span>  <span class="number">0.01035839</span>  <span class="number">0.01004393</span>  <span class="number">0.0089306</span>   <span class="number">0.00902356</span>  <span class="number">0.00898983</span>]</span><br><span class="line">[<span class="number">703824.353689585</span>, <span class="number">688000.4130783302</span>, <span class="number">674508.5537976791</span>, <span class="number">662770.9045613626</span>]</span><br></pre></td></tr></table></figure>


<h3 id="392-395-epoch-lr-12-9"><a href="#392-395-epoch-lr-12-9" class="headerlink" title="392~395 epoch, lr=12-9"></a>392~395 epoch, lr=<code>12-9</code></h3><p>Let’s make w as the 3th epoch, and try tunning the lr smaller to <code>1e-9</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">174</span>]: w = W[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="number">175</span>]: lr = <span class="number">1e-9</span> <span class="comment"># learning rate</span></span><br><span class="line">     ...: iteration = <span class="number">5</span></span><br><span class="line">     ...: <span class="comment">#iterationRun(lr,iteration,x_data,y_data)</span></span><br><span class="line">     ...: <span class="comment">#w= &lt;last time&gt;</span></span><br><span class="line">     ...: L, W = iterationRun(lr,iteration,x_data,y_data,w)</span><br><span class="line">     ...: <span class="built_in">print</span> (<span class="built_in">str</span>(L))</span><br><span class="line">     ...:</span><br><span class="line"><span class="number">0</span> : <span class="number">21</span>:<span class="number">41</span>:<span class="number">46.601560</span> L:<span class="number">661713.7975718635</span></span><br><span class="line"><span class="number">1</span> : <span class="number">21</span>:<span class="number">42</span>:<span class="number">16.607766</span> L:<span class="number">660793.0750887658</span></span><br><span class="line"><span class="number">2</span> : <span class="number">21</span>:<span class="number">42</span>:<span class="number">46.034783</span> L:<span class="number">663980.0848216356</span></span><br><span class="line"><span class="number">3</span> : <span class="number">21</span>:<span class="number">43</span>:<span class="number">15.439357</span> L:<span class="number">802745.540277066</span></span><br><span class="line"><span class="number">4</span> : <span class="number">21</span>:<span class="number">43</span>:<span class="number">45.015877</span> L:<span class="number">5429166.075156927</span></span><br><span class="line">[-<span class="number">6.16727255e-04</span>  <span class="number">1.00484493e-02</span>  <span class="number">9.93535744e-03</span>  <span class="number">9.93784427e-03</span></span><br><span class="line">  <span class="number">9.95911130e-03</span>  <span class="number">8.35499858e-03</span>  <span class="number">8.45588760e-03</span>  <span class="number">2.26448667e-03</span></span><br><span class="line">  <span class="number">1.22987564e-02</span>  <span class="number">2.16546844e-02</span>  <span class="number">9.10083843e-03</span>  <span class="number">9.03077135e-03</span></span><br><span class="line">  <span class="number">9.17185566e-03</span>  <span class="number">9.98181751e-03</span>  <span class="number">3.16708342e-03</span>  <span class="number">2.67366966e-03</span></span><br><span class="line">  <span class="number">8.41072713e-03</span>  <span class="number">8.73860126e-03</span> -<span class="number">2.03925361e-04</span>  <span class="number">1.00607272e-02</span></span><br><span class="line">  <span class="number">9.93460928e-03</span>  <span class="number">9.95365455e-03</span>  <span class="number">1.02829207e-02</span>  <span class="number">8.97031177e-03</span></span><br><span class="line">  <span class="number">9.31315565e-03</span>  <span class="number">1.65178857e-03</span>  <span class="number">1.03485940e-02</span>  <span class="number">2.12659601e-02</span></span><br><span class="line">  <span class="number">9.02198751e-03</span>  <span class="number">7.84152744e-03</span>  <span class="number">9.43025959e-03</span>  <span class="number">1.00085885e-02</span></span><br><span class="line">  <span class="number">8.87651196e-03</span>  <span class="number">4.98782391e-03</span>  <span class="number">8.55433776e-03</span>  <span class="number">8.78302430e-03</span></span><br><span class="line">  <span class="number">2.85369965e-04</span>  <span class="number">1.00635072e-02</span>  <span class="number">9.97046563e-03</span>  <span class="number">9.97461093e-03</span></span><br><span class="line">  <span class="number">1.04114813e-02</span>  <span class="number">9.36603695e-03</span>  <span class="number">9.88070916e-03</span>  <span class="number">1.43617060e-03</span></span><br><span class="line">  <span class="number">1.08629084e-02</span>  <span class="number">2.19977200e-02</span>  <span class="number">8.76197799e-03</span>  <span class="number">5.90977003e-03</span></span><br><span class="line">  <span class="number">9.62326853e-03</span>  <span class="number">1.00259754e-02</span>  <span class="number">1.06493535e-02</span>  <span class="number">5.41048668e-03</span></span><br><span class="line">  <span class="number">8.64521541e-03</span>  <span class="number">8.81179281e-03</span>  <span class="number">9.52186844e-04</span>  <span class="number">1.00684226e-02</span></span><br><span class="line">  <span class="number">1.00466367e-02</span>  <span class="number">1.00111076e-02</span>  <span class="number">1.08903525e-02</span>  <span class="number">1.07802435e-02</span></span><br><span class="line">  <span class="number">1.17922921e-02</span>  <span class="number">1.54851313e-03</span>  <span class="number">1.16898484e-02</span>  <span class="number">2.32874554e-02</span></span><br><span class="line">  <span class="number">8.68029225e-03</span>  <span class="number">3.18757813e-03</span>  <span class="number">9.62848850e-03</span>  <span class="number">1.00700956e-02</span></span><br><span class="line">  <span class="number">8.57625809e-03</span>  <span class="number">5.04569062e-03</span>  <span class="number">8.69887254e-03</span>  <span class="number">8.76585679e-03</span></span><br><span class="line">  <span class="number">1.72083560e-03</span>  <span class="number">1.00782383e-02</span>  <span class="number">1.01355162e-02</span>  <span class="number">1.00550971e-02</span></span><br><span class="line">  <span class="number">1.13226458e-02</span>  <span class="number">1.30078273e-02</span>  <span class="number">1.44589394e-02</span>  <span class="number">3.55086273e-03</span></span><br><span class="line">  <span class="number">1.51943562e-02</span>  <span class="number">2.65530997e-02</span>  <span class="number">8.80986381e-03</span>  <span class="number">3.28409285e-05</span></span><br><span class="line">  <span class="number">1.00950294e-02</span>  <span class="number">1.01279151e-02</span>  <span class="number">1.03012885e-02</span>  <span class="number">4.78865750e-03</span></span><br><span class="line">  <span class="number">8.69208729e-03</span>  <span class="number">8.78851492e-03</span>  <span class="number">2.74314457e-03</span>  <span class="number">1.00968105e-02</span></span><br><span class="line">  <span class="number">1.02776366e-02</span>  <span class="number">1.01066204e-02</span>  <span class="number">1.21105528e-02</span>  <span class="number">1.60772456e-02</span></span><br><span class="line">  <span class="number">1.82501496e-02</span>  <span class="number">7.85988030e-03</span>  <span class="number">2.23833884e-02</span>  <span class="number">3.24013740e-02</span></span><br><span class="line">  <span class="number">8.86125894e-03</span> -<span class="number">3.55036887e-03</span>  <span class="number">1.07979166e-02</span>  <span class="number">1.02065963e-02</span></span><br><span class="line">  <span class="number">7.53541740e-03</span>  <span class="number">6.99336995e-03</span>  <span class="number">8.72485483e-03</span>  <span class="number">8.79427710e-03</span></span><br><span class="line">  <span class="number">3.81308226e-03</span>  <span class="number">1.01212778e-02</span>  <span class="number">1.04463732e-02</span>  <span class="number">1.01606057e-02</span></span><br><span class="line">  <span class="number">1.29396336e-02</span>  <span class="number">1.98142376e-02</span>  <span class="number">2.27987403e-02</span>  <span class="number">1.48422348e-02</span></span><br><span class="line">  <span class="number">3.52605997e-02</span>  <span class="number">4.27051700e-02</span>  <span class="number">8.80287292e-03</span> -<span class="number">7.40948634e-03</span></span><br><span class="line">  <span class="number">1.17432739e-02</span>  <span class="number">1.02801699e-02</span>  <span class="number">8.42208402e-03</span>  <span class="number">6.63868882e-03</span></span><br><span class="line">  <span class="number">8.77476129e-03</span>  <span class="number">8.80978944e-03</span>  <span class="number">4.97591884e-03</span>  <span class="number">1.01527778e-02</span></span><br><span class="line">  <span class="number">1.06827453e-02</span>  <span class="number">1.02266089e-02</span>  <span class="number">1.37564839e-02</span>  <span class="number">2.43105168e-02</span></span><br><span class="line">  <span class="number">2.81161272e-02</span>  <span class="number">2.47089034e-02</span>  <span class="number">5.76241338e-02</span>  <span class="number">5.65673784e-02</span></span><br><span class="line">  <span class="number">8.51926553e-03</span> -<span class="number">1.12891688e-02</span>  <span class="number">1.28863403e-02</span>  <span class="number">1.03706768e-02</span></span><br><span class="line">  <span class="number">8.26939165e-03</span>  <span class="number">9.02047482e-03</span>  <span class="number">8.90751118e-03</span>  <span class="number">8.83629524e-03</span></span><br><span class="line">  <span class="number">6.10712791e-03</span>  <span class="number">1.01935224e-02</span>  <span class="number">1.09119304e-02</span>  <span class="number">1.02902353e-02</span></span><br><span class="line">  <span class="number">1.40567097e-02</span>  <span class="number">2.90486692e-02</span>  <span class="number">3.31514523e-02</span>  <span class="number">3.63020625e-02</span></span><br><span class="line">  <span class="number">8.90002712e-02</span>  <span class="number">9.21841280e-02</span>  <span class="number">8.33254748e-03</span> -<span class="number">1.43156605e-02</span></span><br><span class="line">  <span class="number">1.43210918e-02</span>  <span class="number">1.04713307e-02</span>  <span class="number">1.79200559e-02</span>  <span class="number">1.67676281e-02</span></span><br><span class="line">  <span class="number">9.09731287e-03</span>  <span class="number">9.03380699e-03</span>]</span><br><span class="line">[<span class="number">662770.9045613626</span>, <span class="number">661713.7975718635</span>, <span class="number">660793.0750887658</span>, <span class="number">663980.0848216356</span>, <span class="number">802745.540277066</span>, <span class="number">5429166.075156927</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="number">176</span>]: lossFunction(W[<span class="number">3</span>],x_data,y_data)</span><br><span class="line">Out[<span class="number">176</span>]: <span class="number">5429166.075156927</span></span><br></pre></td></tr></table></figure>
<p>This is really strange, while we got the w with L = <code>5429166.075156927</code> which looks overfitting( I guess ).</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">190</span>]: lossFunction(w391,x_data,y_data)</span><br><span class="line">Out[<span class="number">190</span>]: <span class="number">662770.9037767164</span></span><br><span class="line">    </span><br><span class="line">In [<span class="number">192</span>]: lossFunction(w395,x_data,y_data)</span><br><span class="line">Out[<span class="number">192</span>]: <span class="number">5429166.071876905</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>We could verify both w391 and w395 with public test data.</p>
<h2 id="Verify-w391-and-w395-with-testdata"><a href="#Verify-w391-and-w395-with-testdata" class="headerlink" title="Verify w391 and w395 with testdata"></a>Verify w391 and w395 with testdata</h2><h3 id="Processing-test-data"><a href="#Processing-test-data" class="headerlink" title="Processing test data"></a>Processing test data</h3><h4 id="test-csv"><a href="#test-csv" class="headerlink" title="test.csv"></a>test.csv</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># verify with test data test.csv</span></span><br><span class="line"><span class="comment"># preprocessing</span></span><br><span class="line"></span><br><span class="line">testDataList = <span class="built_in">list</span>()</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;test.csv&quot;</span>, newline=<span class="string">&quot;&quot;</span>) <span class="keyword">as</span> csvfile:</span><br><span class="line">    testData = csv.reader(csvfile, delimiter=<span class="string">&quot;,&quot;</span>,quotechar=<span class="string">&quot;|&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> testData:</span><br><span class="line">        testDataList.append(line[<span class="number">2</span>:])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">x_data_test = [] <span class="comment"># 18*9 dimensions</span></span><br><span class="line"></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line">listToAppend = <span class="built_in">list</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> testDataList:</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> mod_18(i):</span><br><span class="line">        <span class="comment"># from mod 18: 0</span></span><br><span class="line">        listToAppend = [item]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> mod_18(i) == <span class="number">10</span>:</span><br><span class="line">        <span class="comment"># rain, consider &quot;NR&quot; = 0</span></span><br><span class="line">        listToAppend.append([<span class="string">&quot;0&quot;</span> <span class="keyword">if</span> x == <span class="string">&#x27;NR&#x27;</span> <span class="keyword">else</span> x <span class="keyword">for</span> x <span class="keyword">in</span> item])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> mod_18(i) == <span class="number">17</span>:</span><br><span class="line">        <span class="comment"># all 18 lines collected, built a set of data to extend</span></span><br><span class="line">        listToAppend.append(item)</span><br><span class="line">        x_data_test.append(T_list(listToAppend))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># append other data</span></span><br><span class="line">        listToAppend.append(item)</span><br><span class="line">    i = i + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">x_data_test = [np.array(X).reshape(<span class="number">1</span>,<span class="number">162</span>).astype(np.<span class="built_in">float</span>).tolist()[<span class="number">0</span>] <span class="keyword">for</span> X <span class="keyword">in</span> x_data_test]</span><br><span class="line"></span><br><span class="line"><span class="comment">#x_data_test = [[float(j) for j in i[:18*9]] for i in x_data_test]</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">y</span>(<span class="params">w,x</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sum</span>(w * x)</span><br><span class="line"></span><br><span class="line">y_data_w391 = [y(w391,x) <span class="keyword">for</span> x <span class="keyword">in</span> x_data_test ]</span><br><span class="line">y_data_w396 = [y(w396,x) <span class="keyword">for</span> x <span class="keyword">in</span> x_data_test ]</span><br></pre></td></tr></table></figure>
<h4 id="ans-csv"><a href="#ans-csv" class="headerlink" title="ans.csv"></a>ans.csv</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ans.csv</span></span><br><span class="line">answerTestDataList = <span class="built_in">list</span>()</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;ans.csv&quot;</span>, newline=<span class="string">&quot;&quot;</span>) <span class="keyword">as</span> csvfile:</span><br><span class="line">    testData = csv.reader(csvfile, delimiter=<span class="string">&quot;,&quot;</span>,quotechar=<span class="string">&quot;|&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> testData:</span><br><span class="line">        answerTestDataList.append(line[<span class="number">1</span>])</span><br></pre></td></tr></table></figure>


<h3 id="Verify-data"><a href="#Verify-data" class="headerlink" title="Verify data"></a>Verify data</h3><p>It looks like the w391 is our best output :-) for now, and the w396 is overfitting!</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">86</span>]: lossFunction(w391,x_data_test,y_answer)</span><br><span class="line">Out[<span class="number">86</span>]: <span class="number">40678.24250669469</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">87</span>]: lossFunction(w396,x_data_test,y_answer)</span><br><span class="line">Out[<span class="number">87</span>]: <span class="number">241252.78309255745</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">In [<span class="number">90</span>]: lossFunction(w388,x_data_test,y_answer)</span><br><span class="line">Out[<span class="number">90</span>]: <span class="number">45347.799286792215</span></span><br></pre></td></tr></table></figure>
<p>Draw the plot</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">y_w391 = np.array(y_data_w391)</span><br><span class="line">y_w396 = np.array(y_data_w396)</span><br><span class="line">y_answer = np.array(answerTestDataList[<span class="number">1</span>:]).astype(np.<span class="built_in">float</span>)</span><br><span class="line">x = <span class="built_in">range</span>(<span class="built_in">len</span>(y_answer))</span><br><span class="line"></span><br><span class="line"><span class="comment"># refer to https://matplotlib.org/2.2.2/tutorials/introductory/usage.html#sphx-glr-tutorials-introductory-usage-py</span></span><br><span class="line"></span><br><span class="line">plt.plot(x, y_w391, label=<span class="string">&quot;w391&quot;</span>)</span><br><span class="line">plt.plot(x, y_w396, label=<span class="string">&quot;w396&quot;</span>)</span><br><span class="line">plt.plot(x, y_answer, label=<span class="string">&quot;answer&quot;</span>)</span><br><span class="line"></span><br><span class="line">plt.xlabel(<span class="string">&#x27;240 test set&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;PM2.5&#x27;</span>)</span><br><span class="line"></span><br><span class="line">plt.title(<span class="string">&quot;y_w391, y_w396 and y_answer&quot;</span>)</span><br><span class="line"></span><br><span class="line">plt.legend()</span><br><span class="line">plt.show()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>The plot is as below</p>
<img data-src="/ML-2017-fall-HW1-note/Figure_yW391_yW396_yAnswer.png" class="">



<h1 id="Start-studying-all-other-gradient-descent-alogrithm"><a href="#Start-studying-all-other-gradient-descent-alogrithm" class="headerlink" title="Start studying all other gradient descent alogrithm"></a>Start studying all other gradient descent alogrithm</h1><p>ref:<a href="http://ruder.io/optimizing-gradient-descent">http://ruder.io/optimizing-gradient-descent</a></p>
<p>ref:<a href="https://www.slideshare.net/SebastianRuder/optimization-for-deep-learning">https://www.slideshare.net/SebastianRuder/optimization-for-deep-learning</a></p>
<p>ref:<a href="https://zhuanlan.zhihu.com/p/22252270">https://zhuanlan.zhihu.com/p/22252270</a></p>
<h2 id="Adagrad"><a href="#Adagrad" class="headerlink" title="Adagrad"></a>Adagrad</h2><h3 id="Descent-speed"><a href="#Descent-speed" class="headerlink" title="Descent speed"></a>Descent speed</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> matplotlib</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">y_L_adagrad = np.array(L_adagrad[:<span class="number">391</span>])</span><br><span class="line">y_L_bgd = np.array(L_bgd[:<span class="number">391</span>])</span><br><span class="line">x = <span class="built_in">range</span>(<span class="number">391</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># refer to https://matplotlib.org/2.2.2/tutorials/introductory/usage.html#sphx-glr-tutorials-introductory-usage-py</span></span><br><span class="line"></span><br><span class="line">plt.plot(x, y_L_adagrad, label=<span class="string">&quot;Adagrade&quot;</span>)</span><br><span class="line">plt.plot(x, y_L_bgd, label=<span class="string">&quot;Batch Gradient Descent&quot;</span>)</span><br><span class="line"></span><br><span class="line">plt.xlabel(<span class="string">&#x27;390 epoch&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;Loss Function Value&#x27;</span>)</span><br><span class="line"></span><br><span class="line">plt.title(<span class="string">&quot;Batch GD and ADAGRAD&quot;</span>)</span><br><span class="line"></span><br><span class="line">plt.legend()</span><br><span class="line">plt.show()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<img data-src="/ML-2017-fall-HW1-note/Figure_L_adagrad_vs_BGD_390.png" class="">

<p>It’s basically the same, the difference is only:</p>
<ul>
<li>in the very begining, ADAGRAD went to crazy field, while it self corrected to normal path soon</li>
<li>ADAGRAD will be converging slower than BGD …</li>
<li>our BGD was actually human tunned one, which means ADAGRAD is easier to find themself the correct path (no need for human invention)</li>
</ul>
<p>Also we could see the initial 30 epoch:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">8</span>]: initialN = <span class="number">30</span></span><br><span class="line">   ...: y_L_adagrad = np.array(L_adagrad[:initialN])</span><br><span class="line">   ...: y_L_bgd = np.array(L_bgd[:initialN])</span><br><span class="line">   ...: x = <span class="built_in">range</span>(initialN)</span><br><span class="line">   ...:</span><br><span class="line">   ...:</span><br><span class="line">   ...: plt.plot(x, y_L_adagrad, label=<span class="string">&quot;Adagrade&quot;</span>)</span><br><span class="line">   ...: plt.plot(x, y_L_bgd, label=<span class="string">&quot;Batch Gradient Descent&quot;</span>)</span><br><span class="line">   ...:</span><br><span class="line">   ...: plt.xlabel(<span class="string">&#x27;390 epoch&#x27;</span>)</span><br><span class="line">   ...: plt.ylabel(<span class="string">&#x27;Loss Function Value&#x27;</span>)</span><br><span class="line">   ...:</span><br><span class="line">   ...: plt.title(<span class="string">&quot;Batch GD and ADAGRAD&quot;</span>)</span><br><span class="line">   ...:</span><br><span class="line">   ...: plt.legend()</span><br><span class="line">   ...: plt.show()</span><br><span class="line">   ...:</span><br></pre></td></tr></table></figure>
<img data-src="/ML-2017-fall-HW1-note/Figure_L_adagrad_vs_BGD_30.png" class="">

<h3 id="Verify-the-result"><a href="#Verify-the-result" class="headerlink" title="Verify the result"></a>Verify the result</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># loss function compare</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">12</span>]: lossFunction(w391,x_data_test,y_answer)</span><br><span class="line">Out[<span class="number">12</span>]: <span class="number">40678.24250669469</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">13</span>]: lossFunction(w_adagrad,x_data_test,y_answer)</span><br><span class="line">Out[<span class="number">13</span>]: <span class="number">50976.42462103875</span></span><br></pre></td></tr></table></figure>
<p>Check the prediction result figure</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">y_data_w391 = [y(w391,x) <span class="keyword">for</span> x <span class="keyword">in</span> x_data_test ]</span><br><span class="line">y_data_adagrad = [y(w_adagrad,x) <span class="keyword">for</span> x <span class="keyword">in</span> x_data_test ]</span><br><span class="line"></span><br><span class="line">y_w391 = np.array(y_data_w391)</span><br><span class="line">y_w_adagrad = np.array(y_data_adagrad)</span><br><span class="line">y_answer = np.array(answerTestDataList[<span class="number">1</span>:]).astype(np.<span class="built_in">float</span>)</span><br><span class="line">x = <span class="built_in">range</span>(<span class="built_in">len</span>(y_answer))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">plt.plot(x, y_w391, label=<span class="string">&quot;BGD&quot;</span>)</span><br><span class="line">plt.plot(x, y_w_adagrad, label=<span class="string">&quot;adagrad&quot;</span>)</span><br><span class="line">plt.plot(x, y_answer, label=<span class="string">&quot;answer&quot;</span>)</span><br><span class="line"></span><br><span class="line">plt.xlabel(<span class="string">&#x27;240 test set&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;PM2.5&#x27;</span>)</span><br><span class="line"></span><br><span class="line">plt.title(<span class="string">&quot;BGD, adagrad and Answer&quot;</span>)</span><br><span class="line"></span><br><span class="line">plt.legend()</span><br><span class="line">plt.show()</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<img data-src="/ML-2017-fall-HW1-note/Figure_yBGD_yADAGRAD_yAnswer.png" class="">]]></content>
      <categories>
        <category>random notes</category>
      </categories>
      <tags>
        <tag>machine learning</tag>
        <tag>homework</tag>
      </tags>
  </entry>
  <entry>
    <title>Cobbler provisioning via L3 and DHCP Relay, a PoC</title>
    <url>/cobbler-provisioning-via-l3-and-dhcp-relay-a-poc/</url>
    <content><![CDATA[<h2 id="Enable-cobbler-provisioning-via-L3-DHCP-relay"><a href="#Enable-cobbler-provisioning-via-L3-DHCP-relay" class="headerlink" title="Enable cobbler provisioning via L3 DHCP relay"></a>Enable cobbler provisioning via L3 DHCP relay</h2><p>I would like to setup a minimal PoC for Cobbler provisioning via DHCP relay, I will use virtualbox to spawn:</p>
<p>Three VMs:</p>
<ul>
<li>Cobbler server in subnet A, let’s call it cobbler_server.</li>
<li>A machine to be provisioned in subnet B, it’s named as machine_0.</li>
<li>vRouter wired above machines in two subnets, it’s named as vrouter.</li>
</ul>
<p>To create two subnets:</p>
<ul>
<li>subnet_A, vboxnet0: <code>192.168.56.0/24</code></li>
<li>subnet_B, vboxnet1: <code>192.168.57.0/24</code></li>
</ul>
<p>And it should be like this:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">+-------------+        +-------------+        +-------------+</span><br><span class="line">|             |        |     vRouter |        |   machine_0 |</span><br><span class="line">|             |        |192.168.56.10|        |             |</span><br><span class="line">|           +-+        +-+           |        |             |</span><br><span class="line">|           | |00000000| rr          |        |             |</span><br><span class="line">|           +-+        +-+r          |        |             |</span><br><span class="line">|192.168.56.11|        |  r          |        |             |</span><br><span class="line">|             |        |  r          |        |             |</span><br><span class="line">|             |        |  r          |        |             |</span><br><span class="line">|             |        |  r        +-+        +-+           |</span><br><span class="line">| Cobbler     |        |  rrrrrrrrr| |11111111| |           |</span><br><span class="line">| Server      |        |           +-+        +-+           |</span><br><span class="line">|             |        |192.168.57.10|        |             |</span><br><span class="line">+-------------+        +-------------+        +-------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">0000000 subnet A: vboxnet0     +-+</span><br><span class="line">                               | | network interface</span><br><span class="line">1111111 subnet B: vboxnet1     +-+</span><br><span class="line"></span><br><span class="line">rrrrrrr DHCP Relay</span><br></pre></td></tr></table></figure>
<p>Then we could use cobbler_server to provision a OS to machine_0.</p>
<a id="more"></a>

<h3 id="Setup-minimal-env"><a href="#Setup-minimal-env" class="headerlink" title="Setup minimal env"></a>Setup minimal env</h3><h4 id="Download-a-ubuntu-bionic-image-for-virtualbox"><a href="#Download-a-ubuntu-bionic-image-for-virtualbox" class="headerlink" title="Download a ubuntu bionic image for virtualbox"></a>Download a ubuntu bionic image for virtualbox</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget https://cloud-images.ubuntu.com/bionic/current/bionic-server-cloudimg-amd64.ova</span><br></pre></td></tr></table></figure>
<h4 id="Create-three-VMs"><a href="#Create-three-VMs" class="headerlink" title="Create three VMs"></a>Create three VMs</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">❯ VBoxManage list vms</span><br><span class="line"><span class="string">&quot;cobbler_server&quot;</span> &#123;aa4c06ba-139d-4e1e-a248-33d5cb4763bd&#125;</span><br><span class="line"><span class="string">&quot;vrouter&quot;</span> &#123;092add9c-0b03-4230-adf9-465f18bafde1&#125;</span><br><span class="line"><span class="string">&quot;machine_0&quot;</span> &#123;97041fe8-a547-4f84-a9fe-1190664100b7&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Create-vNICs-for-all-VMs"><a href="#Create-vNICs-for-all-VMs" class="headerlink" title="Create vNICs for all VMs"></a>Create vNICs for all VMs</h4><blockquote>
<p>Note to enable tftp working in virtualbox in default configuration, use nic type:</p>
<p>  <code>PCnet-PCI II(Am79C970A)</code></p>
<p>reference: <a href="https://www.webscalability.com/blog/2013/03/testing-out-cobbler-with-virtuabox/">https://www.webscalability.com/blog/2013/03/testing-out-cobbler-with-virtuabox/</a></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">❯ VBoxManage showvminfo cobbler_server | grep NIC | grep -v disabled</span><br><span class="line">NIC 1:  MAC: 0800270CCFBD, Attachment: Bridged Interface <span class="string">&#x27;en1: Wi-Fi (AirPort)&#x27;</span></span><br><span class="line">NIC 2:  MAC: 0800275425ED, Attachment: Host-only Interface <span class="string">&#x27;vboxnet0&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">❯ VBoxManage showvminfo vrouter | grep NIC | grep -v disabled</span><br><span class="line">NIC 1:  MAC: 0800274A2FAB, Attachment: Bridged Interface <span class="string">&#x27;en1: Wi-Fi (AirPort)&#x27;</span></span><br><span class="line">NIC 2:  MAC: 080027381AB1, Attachment: Host-only Interface <span class="string">&#x27;vboxnet0&#x27;</span></span><br><span class="line">NIC 3:  MAC: 08002736BD7E, Attachment: Host-only Interface <span class="string">&#x27;vboxnet1&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">❯ VBoxManage showvminfo machine_0 | grep NIC | grep -v disabled</span><br><span class="line">NIC 1:  MAC: 08002715BD34, Attachment: Host-only Interface <span class="string">&#x27;vboxnet1&#x27;</span>, Cable connected: on, Trace: off (file: none), Type: Am79C970A, Reported speed: 0 Mbps, Boot priority: 0, Promisc Policy: deny, Bandwidth group: none</span><br></pre></td></tr></table></figure>
<h4 id="Configure-machine-0-boot-order-as-Network-first"><a href="#Configure-machine-0-boot-order-as-Network-first" class="headerlink" title="Configure machine_0 boot order as Network first"></a>Configure machine_0 boot order as Network first</h4><p>Change it here: (System -&gt; Motherboard -&gt; Boot Order) in virtualbox if you don’t like to get into BIOS.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">❯ VBoxManage showvminfo machine_0 | grep <span class="string">&quot;Boot &quot;</span></span><br><span class="line">Boot menu mode:              message and menu</span><br><span class="line">Boot Device 1:               Network</span><br><span class="line">Boot Device 2:               HardDisk</span><br><span class="line">Boot Device 3:               Not Assigned</span><br><span class="line">Boot Device 4:               Not Assigned</span><br></pre></td></tr></table></figure>
<h3 id="Configure-Cobbler-vRouter-and-DHCP-Relay"><a href="#Configure-Cobbler-vRouter-and-DHCP-Relay" class="headerlink" title="Configure Cobbler, vRouter and DHCP Relay"></a>Configure Cobbler, vRouter and DHCP Relay</h3><h4 id="Install-cobbler-in-cobbler-server-and-install-dhcprelay-in-vrouter"><a href="#Install-cobbler-in-cobbler-server-and-install-dhcprelay-in-vrouter" class="headerlink" title="Install cobbler in cobbler_server and install dhcprelay in vrouter"></a>Install cobbler in cobbler_server and install dhcprelay in vrouter</h4><p><del>We have to complie it ourselves :(</del> </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ubuntu@cobbler_server:~$ wget https://github.com/cobbler/cobbler/archive/v3.0.1.tar.gz</span><br><span class="line">ubuntu@cobbler_server:~$ wget tar -xzvf *.tar.gz</span><br><span class="line">ubuntu@cobbler_server:~$ <span class="built_in">cd</span> cobbler-3*</span><br><span class="line">ubuntu@cobbler_server:~$ sudo apt install python3-pip apache2 apache2-dev -y</span><br><span class="line">ubuntu@cobbler_server:~$ sudo python3 -m pip install -r requirements.txt</span><br><span class="line">ubuntu@cobbler_server:~$ sudo make install</span><br><span class="line">ubuntu@cobbler_server:~$ sudo apt-get install xinetd python-pykickstart rsync</span><br></pre></td></tr></table></figure>
<p>There are issues on Ubuntu 18.04, switched to CentOS epel-release stock cobbler instead…</p>
<p>Install Cobbler following <a href="https://cobbler.github.io/quickstart">https://cobbler.github.io/quickstart</a></p>
<p>Enable vrouter dhcp relay to forward dhcp</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ubuntu@vrouter:~$ sudo apt install isc-dhcp-relay</span><br><span class="line"></span><br><span class="line">ubuntu@vrouter:~$ ps -ef | grep dhcrelay</span><br><span class="line">root      1483     1  0 00:59 ?        00:00:00 dhcrelay -i enp0s8 192.168.56.11</span><br><span class="line">root      1485     1  0 00:59 ?        00:00:00 dhcrelay -i enp0s9 192.168.56.11</span><br></pre></td></tr></table></figure>
<h4 id="configure-networks"><a href="#configure-networks" class="headerlink" title="configure networks"></a>configure networks</h4><ul>
<li>configure nics IP for cobbler_server and vrouter</li>
<li>in cobbler: add route for vboxnet1 via vrouter</li>
<li>in vrouter: enable ipv4 forwarding</li>
</ul>
<blockquote>
<p>cobbler_server</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@cobbler_server:/home/ubuntu/<span class="comment"># cat /etc/netplan/50-cloud-init.yaml</span></span><br><span class="line">network:</span><br><span class="line">    ethernets:</span><br><span class="line">        enp0s3:</span><br><span class="line">            dhcp4: <span class="literal">true</span></span><br><span class="line">        enp0s8:</span><br><span class="line">            dhcp4: <span class="literal">false</span></span><br><span class="line">            addresses:</span><br><span class="line">              - 192.168.56.11/24</span><br><span class="line">    version: 2</span><br><span class="line">root@cobbler_server:/home/ubuntu/<span class="comment"># netplan apply</span></span><br><span class="line">root@cobbler_server:/home/ubuntu/<span class="comment"># ip route add 192.168.57.0/24 via 192.168.56.10 </span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>vrouter</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@vrouter:/home/ubuntu<span class="comment"># cat /etc/netplan/50-cloud-init.yaml</span></span><br><span class="line"></span><br><span class="line">network:</span><br><span class="line">    ethernets:</span><br><span class="line">        enp0s3:</span><br><span class="line">            dhcp4: <span class="literal">true</span></span><br><span class="line">        enp0s8:</span><br><span class="line">            dhcp4: <span class="literal">false</span></span><br><span class="line">            addresses:</span><br><span class="line">              - 192.168.56.10/24</span><br><span class="line">        enp0s9:</span><br><span class="line">            dhcp4: <span class="literal">false</span></span><br><span class="line">            addresses:</span><br><span class="line">              - 192.168.57.10/24</span><br><span class="line">    version: 2</span><br><span class="line"></span><br><span class="line">root@vrouter:/home/ubuntu/<span class="comment"># netplan apply</span></span><br><span class="line"></span><br><span class="line">root@vrouter:/home/ubuntu<span class="comment"># grep forward /etc/sysctl.conf</span></span><br><span class="line"><span class="comment"># Uncomment the next line to enable packet forwarding for IPv4</span></span><br><span class="line">net.ipv4.ip_forward=1</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Ping test from cobbler_server to vrouter</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@cobbler_server:/home/ubuntu<span class="comment"># ping 192.168.57.10 -c 1</span></span><br><span class="line">PING 192.168.57.10 (192.168.57.10) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.57.10: icmp_seq=1 ttl=64 time=0.437 ms</span><br><span class="line"></span><br><span class="line">--- 192.168.57.10 ping statistics ---</span><br><span class="line">1 packets transmitted, 1 received, 0% packet loss, time 0ms</span><br><span class="line">rtt min/avg/max/mdev = 0.437/0.437/0.437/0.000 ms</span><br></pre></td></tr></table></figure>
<h4 id="Configure-cobbler-server"><a href="#Configure-cobbler-server" class="headerlink" title="Configure cobbler_server"></a>Configure cobbler_server</h4><blockquote>
<p>I switched OS for cobbler_server from Ubuntu 18.04 to CentOS 7 as cobbler worked fine in CentOS out-of-box</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@cobbler-server ~]<span class="comment"># grep &quot;server: 192&quot; /etc/cobbler/settings</span></span><br><span class="line">next_server: 192.168.56.11</span><br><span class="line">server: 192.168.56.11</span><br><span class="line"></span><br><span class="line">[root@cobbler-server ~]<span class="comment"># openssl passwd -1 -salt &#x27;passwd&#x27; &#x27;cobbler&#x27;</span></span><br><span class="line">$1$passwd<span class="variable">$uNhicNpING2yTBiLmcMOY</span>.</span><br><span class="line"></span><br><span class="line">[root@cobbler-server ~]<span class="comment"># grep ^default_pass /etc/cobbler/settings</span></span><br><span class="line">default_password_crypted: <span class="string">&quot;$1$passwd<span class="variable">$uNhicNpING2yTBiLmcMOY</span>.&quot;</span></span><br><span class="line"></span><br><span class="line">[root@cobbler-server ~]<span class="comment"># grep manage_dhcp /etc/cobbler/settings</span></span><br><span class="line">manage_dhcp: 1</span><br><span class="line"></span><br><span class="line">[root@cobbler-server ~]<span class="comment"># cobbler check</span></span><br><span class="line">The following are potential configuration items that you may want to fix:</span><br><span class="line"></span><br><span class="line">1 : debmirror package is not installed, it will be required to manage debian deployments and repositories</span><br><span class="line">2 : fencing tools were not found, and are required to use the (optional) power management features. install cman or fence-agents to use them</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>enable cobbler to dhcp subnet B</p>
</blockquote>
<p>reference: <a href="https://docs.cumulusnetworks.com/cumulus-linux-31/Configuring-and-Managing-Network-Interfaces/Configuring-DHCP-Relays-and-Servers/">https://docs.cumulusnetworks.com/cumulus-linux-31/Configuring-and-Managing-Network-Interfaces/Configuring-DHCP-Relays-and-Servers/</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@cobbler-server ~]<span class="comment"># vi /etc/cobbler/dhcp.template</span></span><br><span class="line"></span><br><span class="line">shared-network Combined-pools &#123;</span><br><span class="line"></span><br><span class="line">   subnet 192.168.56.0 netmask 255.255.255.0 &#123;</span><br><span class="line">       <span class="comment"># subnet A</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   subnet 192.168.57.0 netmask 255.255.255.0 &#123;</span><br><span class="line">       <span class="comment"># subnet B</span></span><br><span class="line">        option routers             192.168.57.10;</span><br><span class="line">        option subnet-mask         255.255.255.0;</span><br><span class="line">        range dynamic-bootp        192.168.57.100 192.168.57.254;</span><br><span class="line">        default-lease-time         21600;</span><br><span class="line">        max-lease-time             43200;</span><br><span class="line">        next-server                <span class="variable">$next_server</span>;</span><br><span class="line">        class <span class="string">&quot;pxeclients&quot;</span> &#123;</span><br><span class="line">             match <span class="keyword">if</span> substring (option vendor-class-identifier, 0, 9) = <span class="string">&quot;PXEClient&quot;</span>;</span><br><span class="line">             <span class="keyword">if</span> option pxe-system-type = 00:02 &#123;</span><br><span class="line">                     filename <span class="string">&quot;ia64/elilo.efi&quot;</span>;</span><br><span class="line">             &#125; <span class="keyword">else</span> <span class="keyword">if</span> option pxe-system-type = 00:06 &#123;</span><br><span class="line">                     filename <span class="string">&quot;grub/grub-x86.efi&quot;</span>;</span><br><span class="line">             &#125; <span class="keyword">else</span> <span class="keyword">if</span> option pxe-system-type = 00:07 &#123;</span><br><span class="line">                     filename <span class="string">&quot;grub/grub-x86_64.efi&quot;</span>;</span><br><span class="line">             &#125; <span class="keyword">else</span> <span class="keyword">if</span> option pxe-system-type = 00:09 &#123;</span><br><span class="line">                     filename <span class="string">&quot;grub/grub-x86_64.efi&quot;</span>;</span><br><span class="line">             &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                     filename <span class="string">&quot;pxelinux.0&quot;</span>;</span><br><span class="line">             &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>import an image</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@cobbler-server ~]<span class="comment"># mount -o loop CentOS-7-x86_64-Minimal-1908.iso /mnt/CentOS-7</span></span><br><span class="line">mount: /dev/loop0 is write-protected, mounting read-only</span><br><span class="line"></span><br><span class="line">[root@cobbler-server ~]<span class="comment"># cobbler import --arch=x86_64 --path=/mnt/CentOS-7/ --name=CentOS7</span></span><br><span class="line">task started: 2020-03-26_144343_import</span><br><span class="line">task started (id=Media import, time=Thu Mar 26 14:43:43 2020)</span><br><span class="line">Found a candidate signature: breed=suse, version=opensuse15.0</span><br><span class="line">Found a candidate signature: breed=suse, version=opensuse15.1</span><br><span class="line">Found a candidate signature: breed=redhat, version=rhel6</span><br><span class="line">Found a candidate signature: breed=redhat, version=rhel7</span><br><span class="line">Found a matching signature: breed=redhat, version=rhel7</span><br><span class="line">Adding distros from path /var/www/cobbler/ks_mirror/CentOS7-x86_64:</span><br><span class="line">creating new distro: CentOS7-x86_64</span><br><span class="line">trying symlink: /var/www/cobbler/ks_mirror/CentOS7-x86_64 -&gt; /var/www/cobbler/links/CentOS7-x86_64</span><br><span class="line">creating new profile: CentOS7-x86_64</span><br><span class="line">associating repos</span><br><span class="line">checking <span class="keyword">for</span> rsync repo(s)</span><br><span class="line">checking <span class="keyword">for</span> rhn repo(s)</span><br><span class="line">checking <span class="keyword">for</span> yum repo(s)</span><br><span class="line">starting descent into /var/www/cobbler/ks_mirror/CentOS7-x86_64 <span class="keyword">for</span> CentOS7-x86_64</span><br><span class="line">processing repo at : /var/www/cobbler/ks_mirror/CentOS7-x86_64</span><br><span class="line">need to process repo/comps: /var/www/cobbler/ks_mirror/CentOS7-x86_64</span><br><span class="line">looking <span class="keyword">for</span> /var/www/cobbler/ks_mirror/CentOS7-x86_64/repodata/*comps*.xml</span><br><span class="line">Keeping repodata as-is :/var/www/cobbler/ks_mirror/CentOS7-x86_64/repodata</span><br><span class="line">*** TASK COMPLETE ***</span><br><span class="line">[root@cobbler-server ~]<span class="comment"># cobbler signature update</span></span><br><span class="line">task started: 2020-03-26_144402_sigupdate</span><br><span class="line">task started (id=Updating Signatures, time=Thu Mar 26 14:44:02 2020)</span><br><span class="line">Successfully got file from https://cobbler.github.io/signatures/2.8.x/latest.json</span><br><span class="line">*** TASK COMPLETE ***</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@cobbler-server ~]<span class="comment"># cobbler distro list</span></span><br><span class="line">   CentOS7-x86_64</span><br><span class="line"></span><br><span class="line">[root@cobbler-server ~]<span class="comment"># cobbler distro report --name=CentOS7-x86_64</span></span><br><span class="line">Name                           : CentOS7-x86_64</span><br><span class="line">Architecture                   : x86_64</span><br><span class="line">TFTP Boot Files                : &#123;&#125;</span><br><span class="line">Breed                          : redhat</span><br><span class="line">Comment                        :</span><br><span class="line">Fetchable Files                : &#123;&#125;</span><br><span class="line">Initrd                         : /var/www/cobbler/ks_mirror/CentOS7-x86_64/images/pxeboot/initrd.img</span><br><span class="line">Kernel                         : /var/www/cobbler/ks_mirror/CentOS7-x86_64/images/pxeboot/vmlinuz</span><br><span class="line">Kernel Options                 : &#123;&#125;</span><br><span class="line">Kernel Options (Post Install)  : &#123;&#125;</span><br><span class="line">Kickstart Metadata             : &#123;<span class="string">&#x27;tree&#x27;</span>: <span class="string">&#x27;http://@@http_server@@/cblr/links/CentOS7-x86_64&#x27;</span>&#125;</span><br><span class="line">Management Classes             : []</span><br><span class="line">OS Version                     : rhel7</span><br><span class="line">Owners                         : [<span class="string">&#x27;admin&#x27;</span>]</span><br><span class="line">Red Hat Management Key         : &lt;&lt;<span class="string">inherit&gt;&gt;</span></span><br><span class="line"><span class="string">Red Hat Management Server      : &lt;&lt;inherit</span>&gt;&gt;</span><br><span class="line">Template Files                 : &#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@cobbler-server ~]<span class="comment"># cobbler system add --name=test --profile=CentOS7-x86_64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@cobbler-server ~]<span class="comment"># cobbler system report --name=test</span></span><br><span class="line">Name                           : <span class="built_in">test</span></span><br><span class="line">TFTP Boot Files                : &#123;&#125;</span><br><span class="line">Comment                        :</span><br><span class="line">Enable gPXE?                   : &lt;&lt;<span class="string">inherit&gt;&gt;</span></span><br><span class="line"><span class="string">Fetchable Files                : &#123;&#125;</span></span><br><span class="line"><span class="string">Gateway                        :</span></span><br><span class="line"><span class="string">Hostname                       :</span></span><br><span class="line"><span class="string">Image                          :</span></span><br><span class="line"><span class="string">IPv6 Autoconfiguration         : False</span></span><br><span class="line"><span class="string">IPv6 Default Device            :</span></span><br><span class="line"><span class="string">Kernel Options                 : &#123;&#125;</span></span><br><span class="line"><span class="string">Kernel Options (Post Install)  : &#123;&#125;</span></span><br><span class="line"><span class="string">Kickstart                      : &lt;&lt;inherit</span>&gt;&gt;</span><br><span class="line">Kickstart Metadata             : &#123;&#125;</span><br><span class="line">LDAP Enabled                   : False</span><br><span class="line">LDAP Management Type           : authconfig</span><br><span class="line">Management Classes             : &lt;&lt;<span class="string">inherit&gt;&gt;</span></span><br><span class="line"><span class="string">Management Parameters          : &lt;&lt;inherit</span>&gt;&gt;</span><br><span class="line">Monit Enabled                  : False</span><br><span class="line">Name Servers                   : []</span><br><span class="line">Name Servers Search Path       : []</span><br><span class="line">Netboot Enabled                : True</span><br><span class="line">Owners                         : &lt;&lt;<span class="string">inherit&gt;&gt;</span></span><br><span class="line"><span class="string">Power Management Address       :</span></span><br><span class="line"><span class="string">Power Management ID            :</span></span><br><span class="line"><span class="string">Power Management Password      :</span></span><br><span class="line"><span class="string">Power Management Type          : ipmitool</span></span><br><span class="line"><span class="string">Power Management Username      :</span></span><br><span class="line"><span class="string">Profile                        : CentOS7-x86_64</span></span><br><span class="line"><span class="string">Internal proxy                 : &lt;&lt;inherit</span>&gt;&gt;</span><br><span class="line">Red Hat Management Key         : &lt;&lt;<span class="string">inherit&gt;&gt;</span></span><br><span class="line"><span class="string">Red Hat Management Server      : &lt;&lt;inherit</span>&gt;&gt;</span><br><span class="line">Repos Enabled                  : False</span><br><span class="line">Server Override                : &lt;&lt;<span class="string">inherit&gt;&gt;</span></span><br><span class="line"><span class="string">Status                         : production</span></span><br><span class="line"><span class="string">Template Files                 : &#123;&#125;</span></span><br><span class="line"><span class="string">Virt Auto Boot                 : &lt;&lt;inherit</span>&gt;&gt;</span><br><span class="line">Virt CPUs                      : &lt;&lt;<span class="string">inherit&gt;&gt;</span></span><br><span class="line"><span class="string">Virt Disk Driver Type          : &lt;&lt;inherit</span>&gt;&gt;</span><br><span class="line">Virt File Size(GB)             : &lt;&lt;<span class="string">inherit&gt;&gt;</span></span><br><span class="line"><span class="string">Virt Path                      : &lt;&lt;inherit</span>&gt;&gt;</span><br><span class="line">Virt PXE Boot                  : 0</span><br><span class="line">Virt RAM (MB)                  : &lt;&lt;<span class="string">inherit&gt;&gt;</span></span><br><span class="line"><span class="string">Virt Type                      : &lt;&lt;inherit</span>&gt;&gt;</span><br></pre></td></tr></table></figure>


<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@cobbler-server ~]<span class="comment"># cobbler system edit --name=test --gateway=192.168.57.10 --hostname=machine_0</span></span><br><span class="line"></span><br><span class="line">[root@cobbler-server ~]<span class="comment"># cobbler system report</span></span><br><span class="line">Name                           : <span class="built_in">test</span></span><br><span class="line">TFTP Boot Files                : &#123;&#125;</span><br><span class="line">Comment                        :</span><br><span class="line">Enable gPXE?                   : &lt;&lt;<span class="string">inherit&gt;&gt;</span></span><br><span class="line"><span class="string">Fetchable Files                : &#123;&#125;</span></span><br><span class="line"><span class="string">Gateway                        : 192.168.57.10</span></span><br><span class="line"><span class="string">Hostname                       : machine_0</span></span><br><span class="line"><span class="string">Image                          :</span></span><br><span class="line"><span class="string">IPv6 Autoconfiguration         : False</span></span><br><span class="line"><span class="string">IPv6 Default Device            :</span></span><br><span class="line"><span class="string">Kernel Options                 : &#123;&#125;</span></span><br><span class="line"><span class="string">Kernel Options (Post Install)  : &#123;&#125;</span></span><br><span class="line"><span class="string">Kickstart                      : &lt;&lt;inherit</span>&gt;&gt;</span><br><span class="line">Kickstart Metadata             : &#123;&#125;</span><br><span class="line">LDAP Enabled                   : False</span><br><span class="line">LDAP Management Type           : authconfig</span><br><span class="line">Management Classes             : &lt;&lt;<span class="string">inherit&gt;&gt;</span></span><br><span class="line"><span class="string">Management Parameters          : &lt;&lt;inherit</span>&gt;&gt;</span><br><span class="line">Monit Enabled                  : False</span><br><span class="line">Name Servers                   : []</span><br><span class="line">Name Servers Search Path       : []</span><br><span class="line">Netboot Enabled                : True</span><br><span class="line">Owners                         : &lt;&lt;<span class="string">inherit&gt;&gt;</span></span><br><span class="line"><span class="string">Power Management Address       :</span></span><br><span class="line"><span class="string">Power Management ID            :</span></span><br><span class="line"><span class="string">Power Management Password      :</span></span><br><span class="line"><span class="string">Power Management Type          : ipmitool</span></span><br><span class="line"><span class="string">Power Management Username      :</span></span><br><span class="line"><span class="string">Profile                        : CentOS7-x86_64</span></span><br><span class="line"><span class="string">Internal proxy                 : &lt;&lt;inherit</span>&gt;&gt;</span><br><span class="line">Red Hat Management Key         : &lt;&lt;<span class="string">inherit&gt;&gt;</span></span><br><span class="line"><span class="string">Red Hat Management Server      : &lt;&lt;inherit</span>&gt;&gt;</span><br><span class="line">Repos Enabled                  : False</span><br><span class="line">Server Override                : &lt;&lt;<span class="string">inherit&gt;&gt;</span></span><br><span class="line"><span class="string">Status                         : production</span></span><br><span class="line"><span class="string">Template Files                 : &#123;&#125;</span></span><br><span class="line"><span class="string">Virt Auto Boot                 : &lt;&lt;inherit</span>&gt;&gt;</span><br><span class="line">Virt CPUs                      : &lt;&lt;<span class="string">inherit&gt;&gt;</span></span><br><span class="line"><span class="string">Virt Disk Driver Type          : &lt;&lt;inherit</span>&gt;&gt;</span><br><span class="line">Virt File Size(GB)             : &lt;&lt;<span class="string">inherit&gt;&gt;</span></span><br><span class="line"><span class="string">Virt Path                      : &lt;&lt;inherit</span>&gt;&gt;</span><br><span class="line">Virt PXE Boot                  : 0</span><br><span class="line">Virt RAM (MB)                  : &lt;&lt;<span class="string">inherit&gt;&gt;</span></span><br><span class="line"><span class="string">Virt Type                      : &lt;&lt;inherit</span>&gt;&gt;</span><br></pre></td></tr></table></figure>


<blockquote>
<p>lines to debug/verify tftp and dhcp</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">tftp -m binary <span class="string">&quot;192.168.56.11&quot;</span> -c get <span class="string">&quot;pxelinux.0&quot;</span></span><br><span class="line">dhclient</span><br></pre></td></tr></table></figure>
<h3 id="Verify-the-PXE-boot-via-L3-DHCP-Relay"><a href="#Verify-the-PXE-boot-via-L3-DHCP-Relay" class="headerlink" title="Verify the PXE boot via L3, DHCP Relay"></a>Verify the PXE boot via L3, DHCP Relay</h3><blockquote>
<p>Start machine_0, and it worked ;-). </p>
</blockquote>
<p>Start machine_0, and it worked ;-).</p>
<p>From log we could see machine_0 PXE nic got its DHCP IP and default route asssigned in subnet B (<code>192.168.57.0/24</code>) via cobbler-server in subnet A (<code>192.168.56.0/24</code>).</p>
<p>Then the PXE boot succeeded in L3 network routed via our v_router.</p>
<blockquote>
<p>cobbler_server</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@cobbler-server ~]<span class="comment"># tail /var/log/messages</span></span><br><span class="line"></span><br><span class="line">Mar 29 02:16:01 cobbler-server dhcpd: DHCPDISCOVER from 08:00:27:15:bd:34 via 192.168.57.10</span><br><span class="line">Mar 29 02:16:02 cobbler-server dhcpd: DHCPOFFER on 192.168.57.101 to 08:00:27:15:bd:34 via 192.168.57.10</span><br><span class="line">Mar 29 02:16:02 cobbler-server dhcpd: DHCPREQUEST <span class="keyword">for</span> 192.168.57.101 (192.168.56.11) from 08:00:27:15:bd:34 via 192.168.57.10</span><br><span class="line">Mar 29 02:16:02 cobbler-server dhcpd: DHCPACK on 192.168.57.101 to 08:00:27:15:bd:34 via 192.168.57.10</span><br><span class="line">Mar 29 02:18:58 cobbler-server in.tftpd[12800]: Client ::ffff:192.168.56.10 finished pxelinux.0</span><br><span class="line"></span><br><span class="line">[root@cobbler-server ~]<span class="comment"># tail /var/log/cobbler/cobbler.log</span></span><br><span class="line"></span><br><span class="line">Sun Mar 29 02:16:07 2020 - INFO | REMOTE generate_kickstart; user(?)</span><br><span class="line">Sun Mar 29 02:16:07 2020 - INFO | generate_kickstart</span><br></pre></td></tr></table></figure>
<blockquote>
<p>vrouter</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@vrouter:/home/ubuntu<span class="comment"># tcpdump -i enp0s8 -n port 67 and port 68 and -i enp0s9 -n port 67 and port 68</span></span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on enp0s9, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">06:43:21.321035 IP 0.0.0.0.68 &gt; 255.255.255.255.67: BOOTP/DHCP, Request from 08:00:27:15:bd:34, length 380</span><br><span class="line">06:43:22.305331 IP 0.0.0.0.68 &gt; 255.255.255.255.67: BOOTP/DHCP, Request from 08:00:27:15:bd:34, length 380</span><br><span class="line">06:43:22.323428 IP 192.168.57.10.67 &gt; 192.168.57.100.68: BOOTP/DHCP, Reply, length 300</span><br><span class="line">06:43:24.282418 IP 0.0.0.0.68 &gt; 255.255.255.255.67: BOOTP/DHCP, Request from 08:00:27:15:bd:34, length 392</span><br><span class="line">06:43:24.297630 IP 192.168.57.10.67 &gt; 192.168.57.100.68: BOOTP/DHCP, Reply, length 300</span><br></pre></td></tr></table></figure>
<blockquote>
<p>screen captured for machine_0</p>
</blockquote>






<h3 id="Issue-notes"><a href="#Issue-notes" class="headerlink" title="Issue notes"></a>Issue notes</h3><ol>
<li><p>I tried to complie cobbler in Ubuntu 18.04 while failed in several phases, to save time switched to epel-release build Cobbler binary package in CentOS 7</p>
</li>
<li><p>default vNIC type not working properly on tftp, corrected for machine_0</p>
</li>
<li><p>dhcp server configuration, I shouldn’t have put DHCP for subnet A(was removed already), in which case,  machine_0 will be with IP address from subnet A while gateway in subnet B and it led L3 network failure, see below failure:</p>


</li>
</ol>
]]></content>
      <categories>
        <category>experiment notes</category>
      </categories>
      <tags>
        <tag>cloud</tag>
        <tag>DHCP Relay</tag>
        <tag>cobbler</tag>
      </tags>
  </entry>
  <entry>
    <title>notes after creating a fuel plugin</title>
    <url>/notes-after-creating-a-fuel-plugin/</url>
    <content><![CDATA[<h1 id="关于"><a href="#关于" class="headerlink" title="关于"></a>关于</h1><p>这篇文章是我做一个内部 knowledge sharing准备的文档，介绍了如何基于MIranis fuel的平台开发一个fuel plugin，我用了一个死了的项目 nova-docker作为实际的例子。</p>
<h1 id="Build-a-fuel-plugin-from-scrash"><a href="#Build-a-fuel-plugin-from-scrash" class="headerlink" title="Build a fuel plugin from scrash"></a>Build a fuel plugin from scrash</h1><blockquote>
<p><strong>Live demo:</strong></p>
<p>Let’s try to build a fuel plugin enables nova-docker</p>
<p>Code put here: <a href="https://github.com/wey-gu/fuel-plugin-nova-docker">https://github.com/wey-gu/fuel-plugin-nova-docker</a></p>
</blockquote>
<h2 id="Create-fuel-plugin-for-nova-docker"><a href="#Create-fuel-plugin-for-nova-docker" class="headerlink" title="Create fuel plugin for nova-docker"></a>Create fuel plugin for <code>nova-docker</code></h2><p><strong>Steps needed:</strong></p>
<ul>
<li>Step 1 Installation packages<ul>
<li>install nova-docker</li>
<li>install dependency (docker)</li>
</ul>
</li>
<li>Step 2 configuration<ul>
<li>configuration on nova compute</li>
<li>configuration on nova controller</li>
</ul>
</li>
</ul>
<a id="more"></a>

<h3 id="Step-0-Initiate-the-project"><a href="#Step-0-Initiate-the-project" class="headerlink" title="[Step 0] Initiate the project"></a>[Step 0] Initiate the project</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ~ fpb --create nova_docker</span><br><span class="line">Plugin is created</span><br><span class="line">$ ~ fpb --build nova_docker</span><br><span class="line">Plugin is built</span><br><span class="line">$ ~ <span class="built_in">cd</span> nova_docker</span><br><span class="line">$ nova_docker ls</span><br><span class="line">bond_config.yaml         network_roles.yaml     node_roles.yaml                     tasks.yaml</span><br><span class="line">components.yaml          metadata.yaml          pre_build_hook                      volumes.yaml</span><br><span class="line">deployment_scripts       LICENSE  <span class="comment">#pack buit--&gt; nova_docker-1.0-1.0.0-1.noarch.rpm</span></span><br><span class="line">$ nova_docker git init</span><br><span class="line">Initialized empty Git repository <span class="keyword">in</span> ~/nova_docker/.git/</span><br></pre></td></tr></table></figure>
<p>Let’s exclude the nova-docker binary file from our git base.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ nova_docker git:(master) cat .gitignore</span><br><span class="line">.tox</span><br><span class="line">.build</span><br><span class="line">*.pyc</span><br><span class="line">*.rpm</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ nova_docker git:(master) tree -L 2</span><br><span class="line">.</span><br><span class="line">├── bond_config.yaml</span><br><span class="line">├── components.yaml</span><br><span class="line">├── deployment_scripts</span><br><span class="line">│   └── deploy.sh</span><br><span class="line">├── deployment_tasks.yaml</span><br><span class="line">├── environment_config.yaml</span><br><span class="line">├── LICENSE</span><br><span class="line">├── metadata.yaml</span><br><span class="line">├── network_roles.yaml</span><br><span class="line">├── nic_config.yaml</span><br><span class="line">├── node_config.yaml</span><br><span class="line">├── node_roles.yaml</span><br><span class="line">├── pre_build_hook</span><br><span class="line">├── README.md</span><br><span class="line">├── repositories</span><br><span class="line">│   ├── centos</span><br><span class="line">│   └── ubuntu</span><br><span class="line">├── tasks.yaml</span><br><span class="line">└── volumes.yaml</span><br></pre></td></tr></table></figure>


<h3 id="Step-1-Installation-packages"><a href="#Step-1-Installation-packages" class="headerlink" title="[Step 1] Installation packages"></a>[Step 1] Installation packages</h3><h4 id="nova-docker"><a href="#nova-docker" class="headerlink" title="nova-docker"></a><code>nova-docker</code></h4><ul>
<li>ensure needed packages included in plugin</li>
<li>code to install packages</li>
</ul>
<h5 id="gt-gt-Fetch-the-nova-docker-source-code"><a href="#gt-gt-Fetch-the-nova-docker-source-code" class="headerlink" title="&gt;&gt; Fetch the nova-docker source code"></a>&gt;&gt; Fetch the <code>nova-docker</code> source code</h5><blockquote>
<p>fetch the file from github: <a href="https://github.com/openstack/nova-docker">url</a></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mkdir -p repositories/python &amp;&amp; <span class="built_in">cd</span> repositories/python</span><br><span class="line">$ git <span class="built_in">clone</span> git@github.com:openstack/nova-docker.git &amp;&amp; <span class="built_in">cd</span> nova-docker</span><br><span class="line"><span class="comment"># project was removed, have to checkout to the previous commit of the last master head</span></span><br><span class="line">$ git checkout HEAD^1</span><br><span class="line">$ git <span class="built_in">log</span></span><br><span class="line">commit 034a4842fc1ebba5912e02cff8cd197ae81eb0c3 (HEAD, origin/stable/ocata)</span><br><span class="line">$ git checkout stable/mitaka</span><br></pre></td></tr></table></figure>
<h5 id="gt-gt-Build-nova-docker"><a href="#gt-gt-Build-nova-docker" class="headerlink" title="&gt;&gt; Build nova-docker"></a>&gt;&gt; Build <code>nova-docker</code></h5><ul>
<li><strong>option one</strong>, build a python sdist <code>tar</code> file</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">setup.py sdist</span><br></pre></td></tr></table></figure>
<blockquote>
<p>An example of option one</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ python setup.py sdist</span><br><span class="line">$ tree dist</span><br><span class="line">dist</span><br><span class="line">└── nova-docker-0.0.1.dev275.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># easy_install instead of pip to install this source dist tar file will do the job</span></span><br><span class="line">$ easy_install dist/nova-docker-0.0.1.dev275.tar.gz</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>option two</strong>, build a <code>deb</code> file</li>
</ul>
<blockquote>
<p>ref: <a href="https://fpm.readthedocs.io/en/latest/">https://fpm.readthedocs.io/en/latest/</a></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">fpm -v <span class="string">&quot;1:0.0.1&quot;</span> -s python -t deb -n fuel-plugin-nova-docker \</span><br><span class="line">  --python-install-bin /usr/bin \</span><br><span class="line">  --python-install-lib /usr/lib/python2.7/dist-packages/ \</span><br><span class="line">  nova-docker/setup.py</span><br></pre></td></tr></table></figure>
<blockquote>
<p>An example of option two</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ fpm -v <span class="string">&quot;1:0.0.1&quot;</span> -s python -t deb -n fuel-plugin-nova-docker \</span><br><span class="line">  --python-install-bin /usr/bin \</span><br><span class="line">  --python-install-lib /usr/lib/python2.7/dist-packages/ \</span><br><span class="line">  nova-docker/setup.py</span><br><span class="line"></span><br><span class="line">Created package &#123;:path=&gt;<span class="string">&quot;fuel-plugin-nova-docker_1:0.0.1_all.deb&quot;</span>&#125;</span><br><span class="line">$ ls</span><br><span class="line">fuel-plugin-nova-docker_1:0.0.1_all.deb  nova-docker</span><br></pre></td></tr></table></figure>
<h5 id="gt-gt-Install-nova-docker"><a href="#gt-gt-Install-nova-docker" class="headerlink" title="&gt;&gt; Install nova-docker"></a>&gt;&gt; Install <code>nova-docker</code></h5><blockquote>
<p>with above two options, we could do like this</p>
</blockquote>
<p>either <code>install.pp</code> with <strong>option one</strong>:</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">exec &#123;<span class="string">&#x27;install nova-docker&#x27;</span><span class="symbol">:</span></span><br><span class="line">  command =&gt; <span class="string">&#x27;easy_install /temp/nova-docker*.tar.gz&#x27;</span>,</span><br><span class="line">  path    =&gt; <span class="string">&#x27;/bin:/usr/bin:/usr/local/bin&#x27;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>or <code>install.pp</code> with <strong>option two</strong>:</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">package &#123;<span class="string">&#x27;fuel-plugin-nova-docker&#x27;</span><span class="symbol">:</span></span><br><span class="line">  <span class="keyword">ensure</span>  =&gt; <span class="string">&#x27;installed&#x27;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="gt-gt-Include-nova-docker"><a href="#gt-gt-Include-nova-docker" class="headerlink" title="&gt;&gt; Include nova-docker"></a>&gt;&gt; Include <code>nova-docker</code></h5><p>Let’s add <code>nova-docker</code> as a <code>submodule</code> as upstream project instead of putting a binary package.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git submodule add git@github.com:openstack/nova-docker.git repositories/python/nova-docker</span><br></pre></td></tr></table></figure>
<p>To ensure this package being built during <code>fpb --build nova-docker</code> we should do this via <code>pre_build_hook</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add here any the actions which are required before plugin build</span></span><br><span class="line"><span class="comment"># like packages building, packages downloading from mirrors and so on.</span></span><br><span class="line"><span class="comment"># The script should return 0 if there were no errors.</span></span><br><span class="line"><span class="built_in">cd</span> repositories/python</span><br><span class="line">git submodule update --init --recursive</span><br><span class="line"><span class="built_in">cd</span> nova-docker; git checkout stable/mitaka; <span class="built_in">cd</span> ..</span><br><span class="line">fpm -v <span class="string">&quot;1:0.0.1&quot;</span> -s python \</span><br><span class="line">  -t deb \</span><br><span class="line">  -n fuel-plugin-nova-docker \</span><br><span class="line">  --python-install-bin /usr/bin \</span><br><span class="line">  --python-install-lib /usr/lib/python2.7/dist-packages/ \</span><br><span class="line">  nova-docker/setup.py</span><br><span class="line">mv *.deb ../ubuntu</span><br></pre></td></tr></table></figure>
<p>Verify it via a plugin build.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ~ fpb --build nova_docker</span><br><span class="line">Plugin is built</span><br><span class="line">$ ~ <span class="built_in">cd</span> nova_docker</span><br><span class="line">$ nova_docker git:(master) ls repositories/ubuntu</span><br><span class="line">fuel-plugin-nova-docker_1:0.0.1_all.deb</span><br></pre></td></tr></table></figure>
<p>Let’s exclude the nova-docker binary file from the repository.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ nova_docker git:(master) cat .gitignore</span><br><span class="line">.tox</span><br><span class="line">.build</span><br><span class="line">*.pyc</span><br><span class="line">*.rpm</span><br><span class="line">repositories/ubuntu/fuel-plugin-nova-docker*.deb</span><br></pre></td></tr></table></figure>
<h4 id="docker"><a href="#docker" class="headerlink" title="docker"></a><code>docker</code></h4><blockquote>
<p>As we are working on mos 9.0, which is Ubuntu 14.04, the ubuntu build docker is named <code>docker.io</code> in repository.</p>
</blockquote>
<p>below lines could be enough:</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">package &#123;<span class="string">&#x27;docker.io&#x27;</span><span class="symbol">:</span></span><br><span class="line">  <span class="keyword">ensure</span>  =&gt; <span class="string">&#x27;installed&#x27;</span>,</span><br><span class="line">&#125; -&gt;</span><br><span class="line">exec &#123;<span class="string">&#x27;add nova to docker group&#x27;</span><span class="symbol">:</span></span><br><span class="line">  command =&gt; <span class="string">&#x27;usermod -aG docker nova&#x27;</span>,</span><br><span class="line">  path    =&gt; <span class="string">&#x27;/bin:/usr/bin:/usr/local/bin&#x27;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="gt-gt-debugging-puppet-code"><a href="#gt-gt-debugging-puppet-code" class="headerlink" title="&gt;&gt; debugging puppet code"></a>&gt;&gt; debugging puppet code</h5><p>Save it as <code>install.pp</code> , let’s verify it like this:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@node-1:~<span class="comment"># puppet apply --debug ./install.pp</span></span><br><span class="line">Error: Could not find <span class="built_in">command</span> <span class="string">&#x27;usermod&#x27;</span></span><br><span class="line">Error: /Stage[main]/Main/Exec[add nova to docker group]/returns: change from notrun to 0 failed: Could not find <span class="built_in">command</span> <span class="string">&#x27;usermod&#x27;</span></span><br><span class="line"></span><br><span class="line">root@node-1:~<span class="comment"># which usermod</span></span><br><span class="line">/usr/sbin/usermod</span><br></pre></td></tr></table></figure>
<p>Then we come to know path need to be put with <code>/usr/sbin</code>.</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">package &#123;<span class="string">&#x27;docker.io&#x27;</span><span class="symbol">:</span></span><br><span class="line">  <span class="keyword">ensure</span>  =&gt; <span class="string">&#x27;installed&#x27;</span>,</span><br><span class="line">&#125; -&gt;</span><br><span class="line">exec &#123;<span class="string">&#x27;add nova to docker group&#x27;</span><span class="symbol">:</span></span><br><span class="line">  command =&gt; <span class="string">&#x27;usermod -aG docker nova&#x27;</span>,</span><br><span class="line">  path    =&gt; <span class="string">&#x27;/bin:/usr/bin:/usr/local/bin:/usr/sbin&#x27;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>And now we have a verified <code>install.pp</code> :</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">package &#123;<span class="string">&#x27;fuel-plugin-nova-docker&#x27;</span>:</span><br><span class="line">  ensure  =&gt; <span class="string">&#x27;installed&#x27;</span>,</span><br><span class="line">&#125; -&gt;</span><br><span class="line">package &#123;<span class="string">&#x27;docker.io&#x27;</span>:</span><br><span class="line">  ensure  =&gt; <span class="string">&#x27;installed&#x27;</span>,</span><br><span class="line">&#125; -&gt;</span><br><span class="line"><span class="built_in">exec</span> &#123;<span class="string">&#x27;add nova to docker group&#x27;</span>:</span><br><span class="line">  <span class="built_in">command</span> =&gt; <span class="string">&#x27;usermod -aG docker nova&#x27;</span>,</span><br><span class="line">  path    =&gt; <span class="string">&#x27;/bin:/usr/bin:/usr/local/bin:/usr/sbin&#x27;</span>,</span><br><span class="line">&#125; -&gt;</span><br><span class="line"><span class="built_in">exec</span> &#123;<span class="string">&#x27;verify docker installation&#x27;</span>:</span><br><span class="line">  <span class="built_in">command</span> =&gt; <span class="string">&#x27;su nova -c docker ps&#x27;</span>,</span><br><span class="line">  path    =&gt; <span class="string">&#x27;/bin:/usr/bin:/usr/local/bin:/usr/sbin&#x27;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="Step-2-Configuration"><a href="#Step-2-Configuration" class="headerlink" title="[Step 2] Configuration"></a>[Step 2] Configuration</h3><blockquote>
<p>referring to <code>nova-docker</code> README here:  <a href="https://github.com/openstack/nova-docker/blob/4923a7d53024e0d476befe3a8b6dd841537569b6/README.rst">README.rst</a>, we need to do below configuration change:</p>
</blockquote>
<ul>
<li><p>In <code>nova.conf</code> for <code>nova-compute</code>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">compute_driver=novadocker.virt.docker.DockerDriver</span><br></pre></td></tr></table></figure></li>
<li><p>In <code>glance-api.conf</code>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">container_formats=ami,ari,aki,bare,ovf,ova,docker</span><br></pre></td></tr></table></figure>
<p>Then it could be done like below, where <code>roles_include</code> is a function from <code>fuel-library</code> on ruby function : <code>library/deployment/puppet/osnailyfacter/spec/functions/roles_include_spec.rb</code> (source code –&gt; <a href="https://github.com/openstack/fuel-library/blob/master/deployment/puppet/osnailyfacter/spec/functions/roles_include_spec.rb">url</a>)</p>
</li>
</ul>
<blockquote>
<p>referring to project: <code>fuel-library</code> <a href="https://github.com/openstack/fuel-library">https://github.com/openstack/fuel-library</a></p>
</blockquote>
<p>Let’s name it as <code>configure.pp</code></p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> roles_include([<span class="string">&#x27;compute&#x27;</span>])&#123;</span><br><span class="line">    nova_config &#123;</span><br><span class="line">      <span class="string">&#x27;default/compute_driver&#x27;</span>:     value =&gt; <span class="string">&quot;novadocker.virt.docker.DockerDriver&quot;</span>;</span><br><span class="line">    &#125; -&gt;</span><br><span class="line">    exec&#123;<span class="string">&quot;restart nova compute service&quot;</span><span class="symbol">:</span></span><br><span class="line">      command =&gt; <span class="string">&quot;/usr/sbin/service nova-compute restart&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (roles_include([<span class="string">&#x27;controller&#x27;</span>]) <span class="keyword">or</span> roles_include([<span class="string">&#x27;primary-controller&#x27;</span>]))&#123;</span><br><span class="line">    glance_api_config &#123;</span><br><span class="line">      <span class="string">&#x27;default/container_formats&#x27;</span>:  value =&gt; <span class="string">&quot;ami,ari,aki,bare,ovf,ova,docker&quot;</span>;</span><br><span class="line">    &#125; -&gt;</span><br><span class="line">    exec&#123;<span class="string">&quot;restart Glance api service&quot;</span><span class="symbol">:</span></span><br><span class="line">      command =&gt; <span class="string">&quot;/usr/sbin/service glance-api restart&quot;</span>,</span><br><span class="line">    &#125; -&gt;</span><br><span class="line">    exec&#123;<span class="string">&quot;restart Glance glare service&quot;</span><span class="symbol">:</span></span><br><span class="line">      command =&gt; <span class="string">&quot;/usr/sbin/service glance-glare restart&quot;</span>,</span><br><span class="line">    &#125; -&gt;</span><br><span class="line">    exec&#123;<span class="string">&quot;restart Glance registry service&quot;</span><span class="symbol">:</span></span><br><span class="line">      command =&gt; <span class="string">&quot;/usr/sbin/service glance-registry restart&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Let’s add this condition check on <code>install.pp</code> as well.</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> roles_include([<span class="string">&#x27;compute&#x27;</span>])&#123;</span><br><span class="line">    package &#123;<span class="string">&#x27;fuel-plugin-nova-docker&#x27;</span><span class="symbol">:</span></span><br><span class="line">      <span class="keyword">ensure</span>  =&gt; <span class="string">&#x27;installed&#x27;</span>,</span><br><span class="line">    &#125; -&gt;</span><br><span class="line">    package &#123;<span class="string">&#x27;docker.io&#x27;</span><span class="symbol">:</span></span><br><span class="line">      <span class="keyword">ensure</span>  =&gt; <span class="string">&#x27;installed&#x27;</span>,</span><br><span class="line">    &#125; -&gt;</span><br><span class="line">    exec &#123;<span class="string">&#x27;add nova to docker group&#x27;</span><span class="symbol">:</span></span><br><span class="line">      command =&gt; <span class="string">&#x27;usermod -aG docker nova&#x27;</span>,</span><br><span class="line">      path    =&gt; <span class="string">&#x27;/bin:/usr/bin:/usr/local/bin:/usr/sbin&#x27;</span>,</span><br><span class="line">    &#125; -&gt;</span><br><span class="line">    exec &#123;<span class="string">&#x27;verify docker installation&#x27;</span><span class="symbol">:</span></span><br><span class="line">      command =&gt; <span class="string">&#x27;su nova -c docker ps&#x27;</span>,</span><br><span class="line">      path    =&gt; <span class="string">&#x27;/bin:/usr/bin:/usr/local/bin:/usr/sbin&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Fuel-plugin-file-structure"><a href="#Fuel-plugin-file-structure" class="headerlink" title="Fuel plugin [file structure]"></a>Fuel plugin [file structure]</h3><p>The scripts entry path is <code>deployment_scripts</code>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ nova_docker git:(master) mkdir -p deployment_scripts/puppet/manifests</span><br><span class="line">$ nova_docker git:(master) tree deployment_scripts</span><br><span class="line">deployment_scripts</span><br><span class="line">├── deploy.sh     <span class="comment"># dummy script from the fpb template</span></span><br><span class="line">└── puppet        <span class="comment"># we create puppet files here</span></span><br><span class="line">    └── manifests</span><br></pre></td></tr></table></figure>
<p>The scripts were called via tasks in <code>deployment_tasks.yml</code> in the whole graph.</p>
<h5 id="gt-gt-Entry-for-nova-docker-install"><a href="#gt-gt-Entry-for-nova-docker-install" class="headerlink" title="&gt;&gt; Entry for nova_docker-install"></a>&gt;&gt; Entry for <code>nova_docker-install</code></h5><p>Let’s compse the  <code>deployment_tasks.yml</code>, where we would like our <code>install.pp</code> being called during <code>post_deployment</code> on <code>role: compute</code>:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># If you do not want to use task-based deployment that is introduced as experimental</span></span><br><span class="line"><span class="comment"># in fuel v8.0 comment code section below this comment, uncomment two lines below it</span></span><br><span class="line"><span class="comment"># and do the same for tasks below.</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">nova_docker-install</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">puppet</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">2.0</span><span class="number">.0</span></span><br><span class="line">  <span class="attr">role:</span> [<span class="string">compute</span>]</span><br><span class="line">  <span class="attr">requires:</span> [<span class="string">post_deployment_start</span>]</span><br><span class="line">  <span class="attr">required_for:</span> [<span class="string">post_deployment_end</span>]</span><br><span class="line">  <span class="attr">parameters:</span></span><br><span class="line">    <span class="attr">puppet_manifest:</span> <span class="string">puppet/manifests/install.pp</span></span><br><span class="line">    <span class="attr">puppet_modules:</span> <span class="string">puppet/modules:/etc/puppet/modules</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">600</span></span><br><span class="line">    <span class="attr">retries:</span> <span class="number">3</span></span><br><span class="line">    <span class="attr">interval:</span> <span class="number">20</span></span><br></pre></td></tr></table></figure>
<h5 id="gt-gt-Entry-for-nova-docker-configure"><a href="#gt-gt-Entry-for-nova-docker-configure" class="headerlink" title="&gt;&gt; Entry for nova_docker-configure"></a>&gt;&gt; Entry for <code>nova_docker-configure</code></h5><p>Add this part to  <code>deployment_tasks.yml</code> for <code>configure.pp</code>.</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">nova_docker-configure</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">puppet</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">2.0</span><span class="number">.0</span></span><br><span class="line">  <span class="attr">role:</span> [<span class="string">primary-controller</span>, <span class="string">controller</span>, <span class="string">compute</span>]</span><br><span class="line">  <span class="attr">requires:</span> [<span class="string">post_deployment_start</span>, <span class="string">nova_docker-install</span>]</span><br><span class="line">  <span class="attr">cross-depends:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nova_docker-install</span></span><br><span class="line">      <span class="attr">role:</span> [<span class="string">primary-controller</span>, <span class="string">controller</span>, <span class="string">compute</span>]</span><br><span class="line">  <span class="attr">required_for:</span> [<span class="string">post_deployment_end</span>]</span><br><span class="line">  <span class="attr">parameters:</span></span><br><span class="line">    <span class="attr">puppet_manifest:</span> <span class="string">puppet/manifests/configure.pp</span></span><br><span class="line">    <span class="attr">puppet_modules:</span> <span class="string">puppet/modules:/etc/puppet/modules</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">600</span></span><br><span class="line">    <span class="attr">retries:</span> <span class="number">3</span></span><br><span class="line">    <span class="attr">interval:</span> <span class="number">20</span></span><br></pre></td></tr></table></figure>


<h3 id="Metadata-change"><a href="#Metadata-change" class="headerlink" title="Metadata change"></a>Metadata change</h3><p><code>metadata.yaml</code> are changed accordingly</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">homepage:</span> <span class="string">&#x27;https://github.com/wey-gu/fuel-plugin-nova-docker&#x27;</span></span><br><span class="line"><span class="attr">is_hotpluggable:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h3 id="Debug-fuel-plugin-deployment"><a href="#Debug-fuel-plugin-deployment" class="headerlink" title="Debug fuel plugin deployment"></a>Debug fuel plugin deployment</h3><h3 id="Install-plugin"><a href="#Install-plugin" class="headerlink" title="Install plugin"></a>Install plugin</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ scp ./nova_docker-1.0-1.0.0-1.noarch.rpm fuel:/root/</span><br><span class="line"></span><br><span class="line">$ fuel plugins --install /root/nova_docker-1.0-1.0.0-1.noarch.rpm</span><br><span class="line"></span><br><span class="line">$ fuel plugins --sync</span><br></pre></td></tr></table></figure>
<h3 id="Check-status"><a href="#Check-status" class="headerlink" title="Check status"></a>Check status</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@fuel ~]<span class="comment"># fuel2 task history show 21 --node 1 2 3 --status ready</span></span><br><span class="line">+----------------------+----+--------+----------------------------+----------------------------+</span><br><span class="line">| task_name            | id | status | time_start                 | time_end                   |</span><br><span class="line">+----------------------+----+--------+----------------------------+----------------------------+</span><br><span class="line">| upload_configuration | 1  | ready  | 2019-01-20T14:32:42.823654 | 2019-01-20T14:32:43.150434 |</span><br><span class="line">| upload_configuration | 3  | ready  | 2019-01-20T14:32:43.057490 | 2019-01-20T14:32:43.175740 |</span><br><span class="line">| upload_configuration | 2  | ready  | 2019-01-20T14:32:43.125496 | 2019-01-20T14:32:43.201964 |</span><br><span class="line">| setup_repositories   | 3  | ready  | 2019-01-20T14:32:44.480248 | 2019-01-20T14:32:50.491014 |</span><br><span class="line">| setup_repositories   | 2  | ready  | 2019-01-20T14:32:44.548006 | 2019-01-20T14:32:50.522656 |</span><br><span class="line">| setup_repositories   | 1  | ready  | 2019-01-20T14:32:44.409323 | 2019-01-20T14:32:54.502436 |</span><br><span class="line">+----------------------+----+--------+----------------------------+----------------------------+</span><br><span class="line"></span><br><span class="line">[root@fuel ~]<span class="comment"># fuel plugins</span></span><br><span class="line">id | name        | version | package_version | releases</span><br><span class="line">---+-------------+---------+-----------------+---------------------------------</span><br><span class="line">1  | nova_docker | 1.0.0   | 5.0.0           | ubuntu (mitaka-9.0, newton-10.0)</span><br><span class="line"></span><br><span class="line">[root@fuel ~]<span class="comment"># ls -l /var/www/nailgun/plugins/</span></span><br><span class="line">total 4</span><br><span class="line">drwxr-xr-x. 4 root root 4096 Jan 20 14:32 nova_docker-1.0</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="Deploy-Plugin"><a href="#Deploy-Plugin" class="headerlink" title="Deploy Plugin"></a>Deploy Plugin</h3><p>Let’s do it!</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@fuel ~]<span class="comment"># fuel node --node 1 2 --task nova_docker-install nova_docker-configure</span></span><br><span class="line">400 Client Error: Bad Request <span class="keyword">for</span> url: http://10.20.0.2:8000/api/v1/clusters/1/deploy_tasks/?nodes=1,2 (Tasks nova_docker-install,nova_docker-configure are not present <span class="keyword">in</span> deployment graph)</span><br></pre></td></tr></table></figure>
<p>fuel deployment’s entry is the deployement graph, simply install the plugin is not enough, we still need to update the graph:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@fuel ~]<span class="comment"># fuel2 graph download -e 1 -a</span></span><br><span class="line">Tasks were downloaded to /root/cluster_graph.yaml</span><br><span class="line">[root@fuel ~]<span class="comment"># vim cluster_graph.yaml</span></span><br><span class="line"></span><br><span class="line">// <span class="keyword">do</span> changes here</span><br><span class="line"></span><br><span class="line">[root@fuel ~]<span class="comment"># fuel2 graph upload -e 1  -t default -f cluster_graph.yaml</span></span><br><span class="line">Deployment graph was uploaded from cluster_graph.yaml</span><br></pre></td></tr></table></figure>
<p><code>diff /root/cluster_graph.yaml.backup /root/cluster_graph.yaml</code></p>
<figure class="highlight diff"><table><tr><td class="code"><pre><span class="line">4988a4989,5015</span><br><span class="line">&gt; - id: nova_docker-install</span><br><span class="line">&gt;   type: puppet</span><br><span class="line">&gt;   version: 2.0.0</span><br><span class="line">&gt;   role: [compute]</span><br><span class="line">&gt;   requires: [post_deployment_start]</span><br><span class="line">&gt;   required_for: [post_deployment_end]</span><br><span class="line">&gt;   parameters:</span><br><span class="line">&gt;     puppet_manifest: puppet/manifests/install.pp</span><br><span class="line">&gt;     puppet_modules: puppet/modules:/etc/puppet/modules</span><br><span class="line">&gt;     timeout: 600</span><br><span class="line">&gt;     retries: 3</span><br><span class="line">&gt;     interval: 20</span><br><span class="line">&gt; - id: nova_docker-configure</span><br><span class="line">&gt;   type: puppet</span><br><span class="line">&gt;   version: 2.0.0</span><br><span class="line">&gt;   role: [primary-controller, controller, compute]</span><br><span class="line">&gt;   requires: [post_deployment_start, nova_docker-install]</span><br><span class="line">&gt;   cross-depends:</span><br><span class="line">&gt;     - name: nova_docker-install</span><br><span class="line">&gt;       role: [primary-controller, controller, compute]</span><br><span class="line">&gt;   required_for: [post_deployment_end]</span><br><span class="line">&gt;   parameters:</span><br><span class="line">&gt;     puppet_manifest: puppet/manifests/configure.pp</span><br><span class="line">&gt;     puppet_modules: puppet/modules:/etc/puppet/modules</span><br><span class="line">&gt;     retries: 3</span><br><span class="line">&gt;     interval: 20</span><br><span class="line">&gt;     timeout: 600</span><br></pre></td></tr></table></figure>
<p>Let’s retry!</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@fuel ~]<span class="comment"># fuel node --node 1 2 --task nova_docker-install nova_docker-configure</span></span><br><span class="line">Started tasks [<span class="string">&#x27;nova_docker-install&#x27;</span>, <span class="string">&#x27;nova_docker-configure&#x27;</span>] <span class="keyword">for</span> nodes nodes [1, 2].</span><br></pre></td></tr></table></figure>
<p>Error occuered</p>
<h3 id="gt-gt-debugging-plugin-deployment"><a href="#gt-gt-debugging-plugin-deployment" class="headerlink" title="&gt;&gt; debugging plugin deployment"></a>&gt;&gt; debugging plugin deployment</h3><p>Narrow down the error node: node-2</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@fuel ~]<span class="comment"># fuel2 task history show 23 --status error</span></span><br><span class="line">+---------------------+---------+--------+----------------------------+...</span><br><span class="line">| task_name           | node_id | status | time_start                 |...</span><br><span class="line">+---------------------+---------+--------+----------------------------+...</span><br><span class="line">| nova_docker-install | 2       | error  | 2019-01-20T14:56:03.262103 |...</span><br><span class="line">+---------------------+---------+--------+----------------------------+...</span><br><span class="line"></span><br><span class="line">[root@fuel ~]<span class="comment"># fuel2 node list -c id -c status -c name -c online</span></span><br><span class="line">+----+------------+--------+--------+</span><br><span class="line">| id | name       | status | online |</span><br><span class="line">+----+------------+--------+--------+</span><br><span class="line">|  3 | cinder     | ready  | True   |</span><br><span class="line">|  1 | controller | ready  | True   |</span><br><span class="line">|  2 | compute    | error  | True   | &lt;----</span><br><span class="line">+----+------------+--------+--------+</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Get the err from puppet log, this means the plugin was not</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@fuel ~]<span class="comment"># ssh node-2 &quot;egrep &#x27;(err)&#x27; /var/log/puppet.log  -A2 | tail&quot;</span></span><br><span class="line"></span><br><span class="line">2019-01-20 14:56:02 +0000 Puppet (err): Could not run: Could not find file puppet/manifests/install.pp</span><br><span class="line">/usr/lib/ruby/vendor_ruby/puppet/application/apply.rb:179:<span class="keyword">in</span> `main<span class="string">&#x27;</span></span><br><span class="line"><span class="string">/usr/lib/ruby/vendor_ruby/puppet/application/apply.rb:159:in `run_command&#x27;</span></span><br><span class="line">--</span><br><span class="line">2019-01-20 14:56:04 +0000 Puppet (err): Could not run: Could not find file puppet/manifests/install.pp</span><br><span class="line">/usr/lib/ruby/vendor_ruby/puppet/application/apply.rb:179:<span class="keyword">in</span> `main<span class="string">&#x27;</span></span><br><span class="line"><span class="string">/usr/lib/ruby/vendor_ruby/puppet/application/apply.rb:159:in `run_command&#x27;</span></span><br></pre></td></tr></table></figure>
<p>The plugin was not placed</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ fuel node --node 1 2 3 --tasks upload_configuration plugins_rsync setup_repositories --force</span><br></pre></td></tr></table></figure>


<h1 id="Debug-tips"><a href="#Debug-tips" class="headerlink" title="Debug tips"></a>Debug tips</h1><blockquote>
<p>Some tips were got from days of painful practice…</p>
</blockquote>
<h2 id="fuel-plugin-update-distribute"><a href="#fuel-plugin-update-distribute" class="headerlink" title="fuel plugin update/ distribute"></a>fuel plugin update/ distribute</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># not always working</span></span><br><span class="line">yum -y reinstall --disablerepo=<span class="string">&#x27;*&#x27;</span> /var/www/nailgun/&lt;path&gt;/fuel-plugins/plugin_foo.rpm</span><br><span class="line">yum -y install --disablerepo=<span class="string">&#x27;*&#x27;</span> /var/www/nailgun/&lt;path&gt;/fuel-plugins/plugin_foo.rpm</span><br><span class="line"><span class="comment"># obvirously you could do so</span></span><br><span class="line">rpm -i /var/www/nailgun/&lt;path&gt;/fuel-plugins/plugin_foo.rpm --force</span><br><span class="line">[root@fuel ~]<span class="comment"># fuel plugins --sync</span></span><br><span class="line"></span><br><span class="line">[root@fuel ~]<span class="comment"># fuel node --node &lt;nodes-id&gt; --tasks upload_configuration setup_repositories plugins_rsync --force</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>directly calling a <code>.pp</code> file on target node</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[node-0]<span class="comment"># cd /etc/fuel/plugins/&lt;plugin_foo-1.0&gt;</span></span><br><span class="line">[node-0]<span class="comment"># puppet apply --debug \</span></span><br><span class="line">    --modulepath=puppet/modules:/etc/puppet/modules:&lt;path_plugin_bar-1.0&gt;/puppet/modules \</span><br><span class="line">    puppet/manifests/plugin_foo_task_01.pp</span><br><span class="line"></span><br><span class="line">// or sanity <span class="built_in">test</span> only without actually executing changes with --noop</span><br><span class="line">[node-0]<span class="comment"># puppet apply --debug --noop \</span></span><br><span class="line">    --modulepath=puppet/modules:/etc/puppet/modules:&lt;path_plugin_bar-1.0&gt;/puppet/modules \</span><br><span class="line">    puppet/manifests/plugin_foo_task_01.pp</span><br></pre></td></tr></table></figure>
<h2 id="task-order-debugging"><a href="#task-order-debugging" class="headerlink" title="task order debugging"></a>task order debugging</h2><p>The deployment process is a graph.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@fuel ~]<span class="comment"># grep &quot;.dot&quot; /var/log/astute/astute.log</span></span><br><span class="line">:graph_dot_dir: /var/lib/astute/graphs</span><br><span class="line">:graph_dot_dir: /var/lib/astute/graphs</span><br><span class="line">2019-01-18 03:33:46 INFO [26377] Check graph into file /var/lib/astute/graphs/graph-7395c5dc-bd42-40ab-9367-9ec5dc29ff05.dot</span><br><span class="line"><span class="comment"># or generate yourself</span></span><br><span class="line"></span><br><span class="line">[root@fuel ~]<span class="comment"># fuel graph --env 1 --download &gt; graph.dot</span></span><br></pre></td></tr></table></figure>
<p>Use <code>graphviz</code> to read it or even render it as picture file.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ brew install graphviz <span class="comment"># or apt-get install graphviz</span></span><br><span class="line">$ dot -Tpng graph.dot -o graph.png</span><br><span class="line">$ brew reinstall graphviz --with-app <span class="comment"># mac with GUI</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Modify, debug and dry run tasks graph</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@fuel ~]<span class="comment"># fuel2 graph download -e 1 -a</span></span><br><span class="line">Tasks were downloaded to /root/cluster_graph.yaml</span><br><span class="line">[root@fuel ~]<span class="comment"># vim cluster_graph.yaml</span></span><br><span class="line"></span><br><span class="line">// <span class="keyword">do</span> changes here</span><br><span class="line"></span><br><span class="line">[root@fuel ~]<span class="comment"># fuel2 graph upload -e 1  -t default -f cluster_graph.yaml</span></span><br><span class="line"></span><br><span class="line">// quickly check <span class="keyword">if</span> loop detected --noop is doing the magic</span><br><span class="line">[root@fuel ~]<span class="comment"># fuel2 graph execute -e 1 -t default --noop --force</span></span><br><span class="line"></span><br><span class="line">// error example see `foo_task` below: </span><br><span class="line"><span class="string">&quot;Method task_deploy. Cluster[]: Loop detected! Path: Task[audit_logging_configuration/1], Task[deploy_end/virtual_sync_node], Task[post_deployment_start/virtual_sync_node], Task[foo_task/3], Task[bar_task_0/1], Task[bar_task_2/3], Task[foo_task/3].\nInspect Astute logs for the details&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Tip: Run a range of tasks</strong></p>
<p>For testing purposes you might want to run not one task, but a range of them. To do this use the following form of command <code>fuel node</code>:</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">fuel node --node &lt;node-id&gt; \</span><br><span class="line">  --start &lt;name of the first task&gt; \</span><br><span class="line">  --end &lt;name of the last task&gt; \</span><br><span class="line">[ --skip &lt;list of the tasks that should be skipped&gt; ]</span><br></pre></td></tr></table></figure>
<h2 id="yaql"><a href="#yaql" class="headerlink" title="yaql"></a>yaql</h2><blockquote>
<p>ref: </p>
<ul>
<li><a href="https://github.com/openstack/yaql">https://github.com/openstack/yaql</a></li>
<li><a href="https://github.com/openstack/fuel-web/tree/master/nailgun/nailgun/fuyaql">https://github.com/openstack/fuel-web/tree/master/nailgun/nailgun/fuyaql</a></li>
</ul>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@fuel ~]<span class="comment"># manage.py yaql -c 1</span></span><br></pre></td></tr></table></figure>


<p>#Reference</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[0]: https://docs.openstack.org/fuel-docs/mitaka/devdocs/develop.html   <span class="string">&quot;Fuel Develop Guide&quot;</span></span><br><span class="line">[1]: https://docs.openstack.org/fuel-docs/newton/plugindocs/fuel-plugin-sdk-guide.html  <span class="string">&quot;F.P. SDK Guide&quot;</span></span><br><span class="line">[2]: https://wiki.openstack.org/wiki/Fuel_CLI   <span class="string">&quot;Fuel CLI cheatsheet&quot;</span></span><br><span class="line">[3]: https://goo.gl/BRB6vR  <span class="string">&quot;Fuel plugin handbook&quot;</span></span><br><span class="line">[4]: https://docs.openstack.org/fuel-docs/mitaka/devdocs/develop/sequence.html  <span class="string">&quot;Fuel Sequence Diagrams&quot;</span></span><br><span class="line">[5]: https://github.com/openstack/nova-docker/blob/4923a7d53024e0d476befe3a8b6dd841537569b6/README.rst  <span class="string">&quot;nova-docker&quot;</span></span><br><span class="line">[6]: http://docs.ocselected.org/openstack-manuals/juno/fuel-docs/reference-architecture.html    <span class="string">&quot;Fuel 中文&quot;</span></span><br><span class="line">[7]: https://docs.mirantis.com/fuel-docs/mitaka/devdocs/develop/modular-architecture.html   <span class="string">&quot;Modular Arch&quot;</span></span><br><span class="line">[8]: https://wiki.openstack.org/wiki/Fuel/Plugins   <span class="string">&quot;Fuel Plugins Wiki&quot;</span></span><br><span class="line">[9]: https://wiki.opnfv.org/display/ds/Build+fuel-plugin-opendaylight   <span class="string">&quot;Another Example&quot;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>openstack</category>
      </categories>
      <tags>
        <tag>openstack</tag>
        <tag>fuel-plugin</tag>
        <tag>puppet</tag>
      </tags>
  </entry>
  <entry>
    <title>Setup Kolla-ansible OpenStack Cluster in Vagrant 2020</title>
    <url>/setup-kolla-ansible-openstack-cluster-in-vagrant-2020/</url>
    <content><![CDATA[<p>This is a note on setting up kolla ansible openstack develop envrionment in your working machine.</p>
<p>I referred to this document: <a href="https://docs.openstack.org/kolla-ansible/latest/contributor/vagrant-dev-env.html">https://docs.openstack.org/kolla-ansible/latest/contributor/vagrant-dev-env.html</a></p>
<p>I had done this in 2020 May on my old mac mini with Catalina ;-). With 20 GiB disk and 6GiB RAM assigned to one Vagrant spawned (virtualbox), the OpenStack Cluster is running pretty well, comparing to my previous setups ( multi-VMs based manually deployment and VM based Mirantis Fuel 9.0 deployment), it’s obviously more reponsive with the help of the single node setup.</p>
<p>Here I leave the notes as a reference for you to have a playground easier.</p>
<h2 id="Preparation"><a href="#Preparation" class="headerlink" title="Preparation"></a>Preparation</h2><h3 id="Install-vagrant-and-plugins-needed"><a href="#Install-vagrant-and-plugins-needed" class="headerlink" title="Install vagrant and plugins needed"></a>Install vagrant and plugins needed</h3><p>Below is an example to do this on a macOS machine, to do that from other OS, refer to <a href="https://www.vagrantup.com/docs/installation/">here</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">brew cask install virtualbox vagrant</span><br><span class="line"></span><br><span class="line">vagrant plugin install vagrant-hostmanager vagrant-vbguest</span><br><span class="line"></span><br><span class="line"><span class="comment"># if we need to resize disks after vagrant up</span></span><br><span class="line">vagrant plugin install vagrant-disksize</span><br><span class="line"><span class="comment"># if we need to make vagrant VM behind a proxy</span></span><br><span class="line">vagrant plugin install vagrant-proxyconf</span><br></pre></td></tr></table></figure>
<h3 id="Clone-kolla-repo"><a href="#Clone-kolla-repo" class="headerlink" title="Clone kolla repo"></a>Clone kolla repo</h3><p>We need to clone below three repositories.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://opendev.org/openstack/kolla-cli</span><br><span class="line">git <span class="built_in">clone</span> https://opendev.org/openstack/kolla-ansible</span><br><span class="line">git <span class="built_in">clone</span> https://opendev.org/openstack/kolla</span><br></pre></td></tr></table></figure>
<h3 id="Customise-Vagrant-scripts"><a href="#Customise-Vagrant-scripts" class="headerlink" title="Customise Vagrant scripts"></a>Customise Vagrant scripts</h3><p>I found the configuration file out-of-box is no longer working/ out of repair for some time, below changes on <code>Vagrantfile</code>, <code>Vagrantfile.custom</code>,  and <code>bootstrap.sh</code> are needed.</p>
<p>For Vagrantfile.custom, we need to use Ubuntu 18.04 instead of 16.04, which comes with python3.6+ in apt repo.</p>
<a id="more"></a>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> kolla-ansible/contrib/dev/vagrant</span><br><span class="line">cp Vagrantfile.custom.example Vagrantfile.custom</span><br><span class="line"></span><br><span class="line">cat Vagrantfile.custom | grep -v <span class="string">&quot;^#&quot;</span></span><br><span class="line">PROVIDER = <span class="string">&quot;virtualbox&quot;</span></span><br><span class="line"></span><br><span class="line">DISTRO = <span class="string">&quot;ubuntu&quot;</span></span><br><span class="line"></span><br><span class="line">PROVIDER_DEFAULTS = &#123;</span><br><span class="line">  virtualbox: &#123;</span><br><span class="line">    ubuntu: &#123;</span><br><span class="line">      base_image: <span class="string">&quot;ubuntu/bionic64&quot;</span>,</span><br><span class="line">      bridge_interface: <span class="string">&quot;en0&quot;</span>,</span><br><span class="line">      vagrant_shared_folder: <span class="string">&quot;/home/vagrant/sync&quot;</span>,</span><br><span class="line">      sync_method: <span class="string">&quot;virtualbox&quot;</span>,</span><br><span class="line">      username: <span class="string">&quot;ubuntu&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">WIFI = <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>git diff</code></p>
</blockquote>
<p><code>VagrantFile</code> was also changed to increase operator VM root disk spec and RAM size.</p>
<figure class="highlight diff"><table><tr><td class="code"><pre><span class="line"><span class="comment">diff --git a/contrib/dev/vagrant/Vagrantfile b/contrib/dev/vagrant/Vagrantfile</span></span><br><span class="line"><span class="comment">index 26b6294da..d248b302d 100644</span></span><br><span class="line"><span class="comment">--- a/contrib/dev/vagrant/Vagrantfile</span></span><br><span class="line"><span class="comment">+++ b/contrib/dev/vagrant/Vagrantfile</span></span><br><span class="line"><span class="meta">@@ -234,6 +234,10 @@</span> Vagrant.configure(2) do |config|</span><br><span class="line">     end</span><br><span class="line">   end</span><br><span class="line"></span><br><span class="line"><span class="addition">+  # Resize the spec of operator and config proxy</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  config.disksize.size = &#x27;50GB&#x27;</span></span><br><span class="line"><span class="addition">+  config.apt_proxy.http = &quot;&quot;</span></span><br><span class="line"><span class="addition">+  config.apt_proxy.https = &quot;&quot;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line">   # The operator controls the deployment</span><br><span class="line">   config.vm.define &quot;operator&quot;, primary: true do |admin|</span><br><span class="line">     admin.vm.hostname = &quot;operator.local&quot;</span><br><span class="line"><span class="meta">@@ -251,6 +255,7 @@</span> Vagrant.configure(2) do |config|</span><br><span class="line">         vm.graphics_ip = GRAPHICSIP</span><br><span class="line">       end</span><br><span class="line">       configure_wifi_if_enabled(vm)</span><br><span class="line"><span class="addition">+      vm.customize [&quot;modifyvm&quot;, :id, &quot;--memory&quot;, 6144]</span></span><br><span class="line">     end</span><br><span class="line">     admin.hostmanager.aliases = &quot;operator&quot;</span><br><span class="line">   end</span><br></pre></td></tr></table></figure>
<p><code>bootstrap.sh</code>  was modified for adaptations on ubuntu 18.04 with docker and python3 configured.</p>
<figure class="highlight diff"><table><tr><td class="code"><pre><span class="line"><span class="comment">diff --git a/contrib/dev/vagrant/bootstrap.sh b/contrib/dev/vagrant/bootstrap.sh</span></span><br><span class="line"><span class="comment">index d7260a323..d4f8b7baf 100644</span></span><br><span class="line"><span class="comment">--- a/contrib/dev/vagrant/bootstrap.sh</span></span><br><span class="line"><span class="comment">+++ b/contrib/dev/vagrant/bootstrap.sh</span></span><br><span class="line"><span class="meta">@@ -80,13 +80,15 @@</span> function prep_work &#123;</span><br><span class="line">             systemctl disable ufw</span><br><span class="line">         fi</span><br><span class="line">         apt-get update</span><br><span class="line"><span class="deletion">-        apt-get -y install python-mysqldb python-pip python-dev build-essential libssl-dev libffi-dev libxml2-dev libxslt-dev</span></span><br><span class="line"><span class="addition">+        apt-get -y install python3-mysqldb python3-pip python3-dev build-essential libssl-dev libffi-dev libxml2-dev libxslt-dev</span></span><br><span class="line"><span class="addition">+        update-alternatives --install /usr/bin/python python /usr/bin/python3.6 10</span></span><br><span class="line"><span class="addition">+        update-alternatives --install /usr/bin/pip pip /usr/bin/pip3 10</span></span><br><span class="line">     else</span><br><span class="line">         echo &quot;Unsupported Distro: $DISTRO&quot; 1&gt;&amp;2</span><br><span class="line">         exit 1</span><br><span class="line">     fi</span><br><span class="line"></span><br><span class="line"><span class="deletion">-    pip install --upgrade docker</span></span><br><span class="line"><span class="addition">+    pip install --upgrade pip docker</span></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> # Do some cleanup after the installation of kolla</span><br><span class="line"><span class="meta">@@ -124,11 +126,9 @@</span> EOF</span><br><span class="line"></span><br><span class="line">         usermod -aG docker vagrant</span><br><span class="line">     elif is_ubuntu; then</span><br><span class="line"><span class="deletion">-        apt-key adv --keyserver hkp://pgp.mit.edu:80 --recv-keys 58118E89F3A912897C070ADBF76221572C52609D</span></span><br><span class="line"><span class="deletion">-        echo &quot;deb https://apt.dockerproject.org/repo ubuntu-xenial main&quot; &gt; /etc/apt/sources.list.d/docker.list</span></span><br><span class="line">         apt-get update</span><br><span class="line"><span class="deletion">-        apt-get -y install docker-engine</span></span><br><span class="line"><span class="deletion">-        sed -i -r &quot;s|(ExecStart)=(.+)|\1=/usr/bin/docker daemon --insecure-registry $&#123;REGISTRY&#125; --registry-mirror=http://$&#123;REGISTRY&#125;|&quot; /lib/systemd/system/docker.service</span></span><br><span class="line"><span class="addition">+        apt-get -y install docker.io</span></span><br><span class="line"><span class="addition">+        sed -i -r &quot;s|(ExecStart)=(.+)|\1=/usr/bin/dockerd --insecure-registry $&#123;REGISTRY&#125; --registry-mirror=http://$&#123;REGISTRY&#125; --host fd:// --containerd=/run/containerd/containerd.sock|&quot; /lib/systemd/system/docker.service</span></span><br><span class="line">     else</span><br><span class="line">         echo &quot;Unsupported Distro: $DISTRO&quot; 1&gt;&amp;2</span><br><span class="line">         exit 1</span><br></pre></td></tr></table></figure>
<h3 id="Configure-virtual-networks-in-VirtualBox"><a href="#Configure-virtual-networks-in-VirtualBox" class="headerlink" title="Configure virtual networks in VirtualBox"></a>Configure virtual networks in VirtualBox</h3><p>Note, below are lines in <code>Vagrantfile</code>, it comes with nic name in <code>eth*</code>, we will change them accordingly later on this to <code>en*</code>.</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">configure_wifi_vbox_networking</span><span class="params">(vm)</span></span></span><br><span class="line">  <span class="comment"># Even if adapters 1 &amp; 2 don&#x27;t need to be modified, if the order is to be</span></span><br><span class="line">  <span class="comment"># maintained, some modification has to be done to them. This will maintain</span></span><br><span class="line">  <span class="comment"># the association inside the guest OS: NIC1 -&gt; eth0, NIC2 -&gt; eth1, NIC3 -&gt;</span></span><br><span class="line">  <span class="comment"># eht2. The modifications for adapters 1 &amp; 2 only change optional properties.</span></span><br><span class="line">  <span class="comment"># Adapter 3 is enabled and connected to the NAT-Network named &quot;OSNetwork&quot;,</span></span><br><span class="line">  <span class="comment"># while also changing its optional properties. Since adapter 3 is used by</span></span><br><span class="line">  <span class="comment"># Neutron for the external network, promiscuous mode is set to &quot;allow-all&quot;.</span></span><br><span class="line">  <span class="comment"># Also, use virtio as the adapter type, for better performance.</span></span><br><span class="line">  vm.customize [<span class="string">&quot;modifyvm&quot;</span>, <span class="symbol">:id</span>, <span class="string">&quot;--nictype1&quot;</span>, <span class="string">&quot;virtio&quot;</span>]</span><br><span class="line">  vm.customize [<span class="string">&quot;modifyvm&quot;</span>, <span class="symbol">:id</span>, <span class="string">&quot;--cableconnected1&quot;</span>, <span class="string">&quot;on&quot;</span>]</span><br><span class="line">  vm.customize [<span class="string">&quot;modifyvm&quot;</span>, <span class="symbol">:id</span>, <span class="string">&quot;--nicpromisc2&quot;</span>, <span class="string">&quot;deny&quot;</span>]</span><br><span class="line">  vm.customize [<span class="string">&quot;modifyvm&quot;</span>, <span class="symbol">:id</span>, <span class="string">&quot;--nictype2&quot;</span>, <span class="string">&quot;virtio&quot;</span>]</span><br><span class="line">  vm.customize [<span class="string">&quot;modifyvm&quot;</span>, <span class="symbol">:id</span>, <span class="string">&quot;--cableconnected2&quot;</span>, <span class="string">&quot;on&quot;</span>]</span><br><span class="line">  vm.customize [<span class="string">&quot;modifyvm&quot;</span>, <span class="symbol">:id</span>, <span class="string">&quot;--nic3&quot;</span>, <span class="string">&quot;natnetwork&quot;</span>]</span><br><span class="line">  vm.customize [<span class="string">&quot;modifyvm&quot;</span>, <span class="symbol">:id</span>, <span class="string">&quot;--nat-network3&quot;</span>, <span class="string">&quot;OSNetwork&quot;</span>] <span class="comment"># &lt;------ this one</span></span><br><span class="line">  vm.customize [<span class="string">&quot;modifyvm&quot;</span>, <span class="symbol">:id</span>, <span class="string">&quot;--nicpromisc3&quot;</span>, <span class="string">&quot;allow-all&quot;</span>]</span><br><span class="line">  vm.customize [<span class="string">&quot;modifyvm&quot;</span>, <span class="symbol">:id</span>, <span class="string">&quot;--nictype3&quot;</span>, <span class="string">&quot;virtio&quot;</span>]</span><br><span class="line">  vm.customize [<span class="string">&quot;modifyvm&quot;</span>, <span class="symbol">:id</span>, <span class="string">&quot;--cableconnected3&quot;</span>, <span class="string">&quot;on&quot;</span>]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>Thus a NAT network named <code>OSNetwork</code> should be created, we can create it manually before next steps.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">VBoxManage natnetwork list</span><br><span class="line">NAT Networks:</span><br><span class="line"></span><br><span class="line">Name:        OSNetwork</span><br><span class="line">Network:     100.0.0.0/24</span><br><span class="line">Gateway:     100.0.0.1</span><br><span class="line">IPv6:        No</span><br><span class="line">Enabled:     Yes</span><br><span class="line"></span><br><span class="line">1 network found</span><br></pre></td></tr></table></figure>
<h2 id="Vagrant-Up-and-access-to-Operator-node"><a href="#Vagrant-Up-and-access-to-Operator-node" class="headerlink" title="Vagrant Up and access to Operator node"></a>Vagrant Up and access to Operator node</h2><p>A VM named <code>operator</code> will be spawned by <code>vagrant up</code> under <code>kolla-ansible/contrib/dev/vagrant</code>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vagrant up</span><br><span class="line">vagrant ssh operator  <span class="comment"># to access &quot;operator&quot; VM</span></span><br></pre></td></tr></table></figure>
<h2 id="Build-Kolla-Docker-Images"><a href="#Build-Kolla-Docker-Images" class="headerlink" title="Build Kolla Docker Images"></a>Build Kolla Docker Images</h2><p>In this VM, if the <code>bootstrap.sh</code> went well, we should have kolla-build usable out of box.</p>
<p>We could refer to <a href="https://docs.openstack.org/kolla/latest/admin/image-building.html">this doc</a> on <code>kolla-build</code>, and to enable minimal usable OpenStack cluster, you could use the profile <code>default</code> or even define your own profiles.</p>
<p>Also, here we are using ubuntu as linux distro type and openstack release in Train cycle a.k.a. <code>9.1.0</code>.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kolla-build --base ubuntu --profile default --openstack-release <span class="string">&quot;9.1.0&quot;</span> --skip-existing</span><br></pre></td></tr></table></figure>
<blockquote>
<p>logs for building images</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">INFO:kolla.common.utils:=========================</span><br><span class="line">INFO:kolla.common.utils:Successfully built images</span><br><span class="line">INFO:kolla.common.utils:=========================</span><br><span class="line">INFO:kolla.common.utils:barbican-base</span><br><span class="line">INFO:kolla.common.utils:barbican-keystone-listener</span><br><span class="line">INFO:kolla.common.utils:base</span><br><span class="line">INFO:kolla.common.utils:chrony</span><br><span class="line">INFO:kolla.common.utils:cron</span><br><span class="line">INFO:kolla.common.utils:fluentd</span><br><span class="line">INFO:kolla.common.utils:glance-api</span><br><span class="line">INFO:kolla.common.utils:glance-base</span><br><span class="line">INFO:kolla.common.utils:glance-registry</span><br><span class="line">INFO:kolla.common.utils:haproxy</span><br><span class="line">INFO:kolla.common.utils:heat-api</span><br><span class="line">INFO:kolla.common.utils:heat-api-cfn</span><br><span class="line">INFO:kolla.common.utils:heat-base</span><br><span class="line">INFO:kolla.common.utils:heat-engine</span><br><span class="line">INFO:kolla.common.utils:horizon</span><br><span class="line">INFO:kolla.common.utils:keepalived</span><br><span class="line">INFO:kolla.common.utils:keystone</span><br><span class="line">INFO:kolla.common.utils:keystone-base</span><br><span class="line">INFO:kolla.common.utils:keystone-fernet</span><br><span class="line">INFO:kolla.common.utils:keystone-ssh</span><br><span class="line">INFO:kolla.common.utils:kolla-toolbox</span><br><span class="line">INFO:kolla.common.utils:mariadb</span><br><span class="line">INFO:kolla.common.utils:mariadb-base</span><br><span class="line">INFO:kolla.common.utils:mariadb-clustercheck</span><br><span class="line">INFO:kolla.common.utils:mariadb-server</span><br><span class="line">INFO:kolla.common.utils:memcached</span><br><span class="line">INFO:kolla.common.utils:neutron-base</span><br><span class="line">INFO:kolla.common.utils:neutron-bgp-dragent</span><br><span class="line">INFO:kolla.common.utils:neutron-dhcp-agent</span><br><span class="line">INFO:kolla.common.utils:neutron-infoblox-ipam-agent</span><br><span class="line">INFO:kolla.common.utils:neutron-l3-agent</span><br><span class="line">INFO:kolla.common.utils:neutron-linuxbridge-agent</span><br><span class="line">INFO:kolla.common.utils:neutron-metadata-agent</span><br><span class="line">INFO:kolla.common.utils:neutron-metadata-agent-ovn</span><br><span class="line">INFO:kolla.common.utils:neutron-metering-agent</span><br><span class="line">INFO:kolla.common.utils:neutron-openvswitch-agent</span><br><span class="line">INFO:kolla.common.utils:neutron-server</span><br><span class="line">INFO:kolla.common.utils:neutron-server-opendaylight</span><br><span class="line">INFO:kolla.common.utils:neutron-server-ovn</span><br><span class="line">INFO:kolla.common.utils:neutron-sriov-agent</span><br><span class="line">INFO:kolla.common.utils:nova-api</span><br><span class="line">INFO:kolla.common.utils:nova-base</span><br><span class="line">INFO:kolla.common.utils:nova-compute</span><br><span class="line">INFO:kolla.common.utils:nova-compute-ironic</span><br><span class="line">INFO:kolla.common.utils:nova-conductor</span><br><span class="line">INFO:kolla.common.utils:nova-libvirt</span><br><span class="line">INFO:kolla.common.utils:nova-novncproxy</span><br><span class="line">INFO:kolla.common.utils:nova-scheduler</span><br><span class="line">INFO:kolla.common.utils:nova-serialproxy</span><br><span class="line">INFO:kolla.common.utils:nova-spicehtml5proxy</span><br><span class="line">INFO:kolla.common.utils:nova-ssh</span><br><span class="line">INFO:kolla.common.utils:openstack-base</span><br><span class="line">INFO:kolla.common.utils:openvswitch-base</span><br><span class="line">INFO:kolla.common.utils:openvswitch-db-server</span><br><span class="line">INFO:kolla.common.utils:openvswitch-vswitchd</span><br><span class="line">INFO:kolla.common.utils:placement-api</span><br><span class="line">INFO:kolla.common.utils:placement-base</span><br><span class="line">INFO:kolla.common.utils:prometheus-base</span><br><span class="line">INFO:kolla.common.utils:prometheus-haproxy-exporter</span><br><span class="line">INFO:kolla.common.utils:prometheus-memcached-exporter</span><br><span class="line">INFO:kolla.common.utils:rabbitmq</span><br></pre></td></tr></table></figure>
<p>This will take a while and it depends on your network situation and CPU ;-), then we could have needed images being built</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@operator: <span class="comment"># docker images</span></span><br><span class="line">REPOSITORY                                                                TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-nova-compute                    9.1.0               9977333ea15b        9 days ago          921MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-horizon                         9.1.0               0941e5ae7d17        9 days ago          619MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-neutron-server-opendaylight     9.1.0               c8e56fa7cd1f        9 days ago          669MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-nova-compute-ironic             9.1.0               3a8e3df9a0f0        9 days ago          764MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-nova-api                        9.1.0               ac54264a362a        9 days ago          634MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-nova-novncproxy                 9.1.0               5aa3c338d32e        9 days ago          645MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-nova-serialproxy                9.1.0               7215c20ad3f3        9 days ago          621MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-neutron-server-ovn              9.1.0               37e94257a188        9 days ago          561MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-nova-ssh                        9.1.0               cf17afc42b35        9 days ago          623MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-neutron-infoblox-ipam-agent     9.1.0               ecb358c6737e        9 days ago          561MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-nova-spicehtml5proxy            9.1.0               d31423b9ba82        9 days ago          621MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-nova-conductor                  9.1.0               2c94a0f01bb5        9 days ago          621MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-nova-scheduler                  9.1.0               5c02b566ab17        9 days ago          621MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-neutron-openvswitch-agent       9.1.0               b33f0acd2837        9 days ago          555MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-neutron-metering-agent          9.1.0               f454ed7952f5        9 days ago          555MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-neutron-metadata-agent          9.1.0               2725dd9625f7        9 days ago          557MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-neutron-server                  9.1.0               d6cf6dd854b8        9 days ago          561MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-neutron-linuxbridge-agent       9.1.0               98b7d2516b36        9 days ago          555MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-nova-base                       9.1.0               a6927b74ce5f        9 days ago          618MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-heat-engine                     9.1.0               dd468972a5db        9 days ago          513MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-neutron-sriov-agent             9.1.0               f060e2b828c3        9 days ago          555MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-heat-api                        9.1.0               62e36e9c42a5        9 days ago          513MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-neutron-l3-agent                9.1.0               fc4e3f30a385        9 days ago          561MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-neutron-dhcp-agent              9.1.0               0ba2190cf331        9 days ago          558MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-neutron-bgp-dragent             9.1.0               bcd7e971ed94        9 days ago          556MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-glance-api                      9.1.0               c3e7869f6699        9 days ago          519MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-keystone-fernet                 9.1.0               1b1f533bb04f        9 days ago          494MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-neutron-metadata-agent-ovn      9.1.0               24ce264a051c        9 days ago          552MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-glance-registry                 9.1.0               af21156994b5        9 days ago          503MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-placement-api                   9.1.0               98f72efcee88        9 days ago          532MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-keystone                        9.1.0               a9e16ba897c7        9 days ago          490MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-keystone-ssh                    9.1.0               3d21db1b5ec5        9 days ago          496MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-neutron-base                    9.1.0               660e301b004a        9 days ago          552MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-heat-api-cfn                    9.1.0               104f841db4fa        9 days ago          513MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-kolla-toolbox                   9.1.0               4c3902489674        9 days ago          933MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-glance-base                     9.1.0               4023044bafab        9 days ago          503MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-keystone-base                   9.1.0               ff5441d42802        9 days ago          487MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-barbican-keystone-listener      9.1.0               b1528a8d4e5b        9 days ago          459MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-placement-base                  9.1.0               00df0fe7ff13        9 days ago          494MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-heat-base                       9.1.0               743f6a651c8f        9 days ago          435MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-barbican-base                   9.1.0               8435e7bb5a8c        9 days ago          424MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-openstack-base                  9.1.0               9a7befd0cc64        9 days ago          422MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-nova-libvirt                    9.1.0               a414aa4d1512        9 days ago          883MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-mariadb-server                  9.1.0               c8f1254995ea        9 days ago          536MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-fluentd                         9.1.0               a3e62fa48f3e        10 days ago         537MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-openvswitch-db-server           9.1.0               d5280ad49720        10 days ago         224MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-openvswitch-vswitchd            9.1.0               026b50773723        10 days ago         224MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-prometheus-haproxy-exporter     9.1.0               7920e8c72603        10 days ago         219MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-prometheus-memcached-exporter   9.1.0               076e0eded872        10 days ago         220MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-mariadb-clustercheck            9.1.0               317d9e7365be        10 days ago         241MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-openvswitch-base                9.1.0               ea128655d138        10 days ago         224MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-memcached                       9.1.0               b6af2f329240        10 days ago         208MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-mariadb                         9.1.0               2c2fe1fbf961        10 days ago         535MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-rabbitmq                        9.1.0               d1b1aaacc73a        10 days ago         249MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-cron                            9.1.0               d084f268e0dc        10 days ago         208MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-chrony                          9.1.0               43fc123294e3        10 days ago         213MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-prometheus-base                 9.1.0               a36c132b3c48        10 days ago         206MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-haproxy                         9.1.0               507836be5c42        10 days ago         214MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-mariadb-base                    9.1.0               3b2ea2e71fae        10 days ago         240MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-keepalived                      9.1.0               5970aa989513        10 days ago         216MB</span><br><span class="line">operator.local:4000/lokolla/ubuntu-binary-base                            9.1.0               d4bed93756bc        10 days ago         206MB</span><br><span class="line">ubuntu                                                                    18.04               c3c304cb4f22        4 weeks ago         64.2MB</span><br><span class="line">registry                                                                  2                   708bc6af7e5e        4 months ago        25.8MB</span><br></pre></td></tr></table></figure>


<h2 id="Deploy-Kolla-Openstack-Cluster"><a href="#Deploy-Kolla-Openstack-Cluster" class="headerlink" title="Deploy Kolla Openstack Cluster"></a>Deploy Kolla Openstack Cluster</h2><blockquote>
<p>Generate password</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kolla-genpwd</span><br></pre></td></tr></table></figure>
<h3 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo su</span><br><span class="line">cp /etc/kolla/globals.yml /etc/kolla/globals.yml.original</span><br><span class="line">vim /etc/kolla/globals.yml</span><br></pre></td></tr></table></figure>
<blockquote>
<p>changed configurations</p>
</blockquote>
<p><code>root@operator:/etc/kolla# diff -u globals.yml.original globals.yml </code></p>
<figure class="highlight diff"><table><tr><td class="code"><pre><span class="line"><span class="meta">@@ -684,7 +684,9 @@</span></span><br><span class="line"> docker_registry: &quot;operator.local:4000&quot;</span><br><span class="line"> docker_namespace: &quot;lokolla&quot;</span><br><span class="line"> docker_insecure_registry: &quot;True&quot;</span><br><span class="line"><span class="deletion">-network_interface: &quot;eth1&quot;</span></span><br><span class="line"><span class="deletion">-neutron_external_interface: &quot;eth2&quot;</span></span><br><span class="line"><span class="deletion">-kolla_internal_vip_address: &quot;172.28.128.254&quot;</span></span><br><span class="line"><span class="deletion">-</span></span><br><span class="line"><span class="addition">+network_interface: &quot;enp0s3&quot;</span></span><br><span class="line"><span class="addition">+neutron_external_interface: &quot;enp0s8&quot;</span></span><br><span class="line"><span class="addition">+kolla_internal_vip_address: &quot;10.0.2.254&quot;</span></span><br><span class="line"><span class="addition">+kolla_base_distro: &quot;ubuntu&quot;</span></span><br><span class="line"><span class="addition">+neutron_plugin_agent: &quot;linuxbridge&quot;</span></span><br><span class="line"><span class="addition">+openstack_release: &quot;9.1.0&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@operator:/etc/kolla<span class="comment"># ll /usr/share/kolla-ansible/ansible/inventory/all-in-one</span></span><br><span class="line">-rw-r--r-- 1 vagrant vagrant 9620 May 14 14:52 /usr/share/kolla-ansible/ansible/inventory/all-in-one</span><br></pre></td></tr></table></figure>


<blockquote>
<p>Let’s deploy it</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kolla-ansible deploy -vvv</span><br><span class="line">kolla-ansible post-deploy</span><br></pre></td></tr></table></figure>


<h3 id="Issues-and-workarounds"><a href="#Issues-and-workarounds" class="headerlink" title="Issues and workarounds"></a>Issues and workarounds</h3><ol>
<li><p>rabbitmq cannot restart</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@operator:/etc/kolla<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID        IMAGE                                                           COMMAND                  CREATED              STATUS                          PORTS                    NAMES</span><br><span class="line">e8f160fbd3fd        operator.local:4000/lokolla/ubuntu-binary-rabbitmq:9.1.0        <span class="string">&quot;dumb-init --single-…&quot;</span>   About a minute ago   Restarting (1) 28 seconds ago</span><br><span class="line"></span><br><span class="line">root@operator:/etc/kolla<span class="comment"># cat /var/log/kolla/rabbitmq/startup_log</span></span><br><span class="line"></span><br><span class="line">ERROR: epmd error <span class="keyword">for</span> host: operator address (cannot connect to host/port) kolla</span><br></pre></td></tr></table></figure>
<p>This was caused by <code>/etc/hosts</code> not properly handled <a href="https://ask.openstack.org/en/question/124223/kolla-ansible-deploy-fail-for-rabbitmq/">ref</a>.</p>
<p>We need to modify <code>/etc/hosts</code> and ensure operator to be resolved as <code>10.0.2.15</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@operator:<span class="comment"># cat /etc/hosts</span></span><br><span class="line">127.0.0.1	localhost	localhost.localdomain	localhost4	localhost4.localdomain4</span><br><span class="line"></span><br><span class="line"><span class="comment"># The following lines are desirable for IPv6 capable hosts</span></span><br><span class="line">::1	ip6-localhost	ip6-loopback</span><br><span class="line">fe00::0	ip6-localnet</span><br><span class="line">ff00::0	ip6-mcastprefix</span><br><span class="line">ff02::1	ip6-allnodes</span><br><span class="line">ff02::2	ip6-allrouters</span><br><span class="line">ff02::3	ip6-allhosts</span><br><span class="line"></span><br><span class="line"><span class="comment">## vagrant-hostmanager-start</span></span><br><span class="line">172.28.128.9	operator.local</span><br><span class="line"><span class="comment">#172.28.128.9	operator</span></span><br><span class="line"><span class="comment">## vagrant-hostmanager-end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#127.0.1.1	operator.local	operator</span></span><br><span class="line">127.0.1.1	ubuntu-bionic	ubuntu-bionic</span><br><span class="line"></span><br><span class="line">10.0.2.15 operator</span><br></pre></td></tr></table></figure>


</li>
</ol>
<h2 id="Verify-the-openstack-cluster"><a href="#Verify-the-openstack-cluster" class="headerlink" title="Verify the openstack cluster"></a>Verify the openstack cluster</h2><p>All running containers are there ;-).</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@operator:/etc/kolla<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID        IMAGE                                                                       COMMAND                  CREATED             STATUS              PORTS                    NAMES</span><br><span class="line">7cfde211e496        operator.local:4000/lokolla/ubuntu-binary-horizon:9.1.0                     <span class="string">&quot;dumb-init --single-…&quot;</span>   4 days ago          Up 4 days                                    horizon</span><br><span class="line">2e3ada5b2cdc        operator.local:4000/lokolla/ubuntu-binary-heat-engine:9.1.0                 <span class="string">&quot;dumb-init --single-…&quot;</span>   4 days ago          Up 4 days                                    heat_engine</span><br><span class="line">eadd81997eef        operator.local:4000/lokolla/ubuntu-binary-heat-api-cfn:9.1.0                <span class="string">&quot;dumb-init --single-…&quot;</span>   4 days ago          Up 4 days                                    heat_api_cfn</span><br><span class="line">f672776e5016        operator.local:4000/lokolla/ubuntu-binary-heat-api:9.1.0                    <span class="string">&quot;dumb-init --single-…&quot;</span>   4 days ago          Up 4 days                                    heat_api</span><br><span class="line">306e2ea602ca        operator.local:4000/lokolla/ubuntu-binary-neutron-metadata-agent:9.1.0      <span class="string">&quot;dumb-init --single-…&quot;</span>   4 days ago          Up 4 days                                    neutron_metadata_agent</span><br><span class="line">fec8dd1a453e        operator.local:4000/lokolla/ubuntu-binary-neutron-l3-agent:9.1.0            <span class="string">&quot;dumb-init --single-…&quot;</span>   4 days ago          Up 4 days                                    neutron_l3_agent</span><br><span class="line">61ea63284f97        operator.local:4000/lokolla/ubuntu-binary-neutron-dhcp-agent:9.1.0          <span class="string">&quot;dumb-init --single-…&quot;</span>   4 days ago          Up 4 days                                    neutron_dhcp_agent</span><br><span class="line">8fa34d62a754        operator.local:4000/lokolla/ubuntu-binary-neutron-linuxbridge-agent:9.1.0   <span class="string">&quot;dumb-init --single-…&quot;</span>   4 days ago          Up 4 days                                    neutron_linuxbridge_agent</span><br><span class="line">de7ed9268b49        operator.local:4000/lokolla/ubuntu-binary-neutron-server:9.1.0              <span class="string">&quot;dumb-init --single-…&quot;</span>   4 days ago          Up 4 days                                    neutron_server</span><br><span class="line">e49be1d477cb        operator.local:4000/lokolla/ubuntu-binary-nova-compute:9.1.0                <span class="string">&quot;dumb-init --single-…&quot;</span>   4 days ago          Up 4 days                                    nova_compute</span><br><span class="line">cbc188c0a8a1        operator.local:4000/lokolla/ubuntu-binary-nova-libvirt:9.1.0                <span class="string">&quot;dumb-init --single-…&quot;</span>   4 days ago          Up 4 days                                    nova_libvirt</span><br><span class="line">af34d5d17a15        operator.local:4000/lokolla/ubuntu-binary-nova-ssh:9.1.0                    <span class="string">&quot;dumb-init --single-…&quot;</span>   4 days ago          Up 4 days                                    nova_ssh</span><br><span class="line">9125b5301adc        operator.local:4000/lokolla/ubuntu-binary-nova-novncproxy:9.1.0             <span class="string">&quot;dumb-init --single-…&quot;</span>   4 days ago          Up 4 days                                    nova_novncproxy</span><br><span class="line">aa7f19fc8079        operator.local:4000/lokolla/ubuntu-binary-nova-conductor:9.1.0              <span class="string">&quot;dumb-init --single-…&quot;</span>   4 days ago          Up 4 days                                    nova_conductor</span><br><span class="line">43269b434d5c        operator.local:4000/lokolla/ubuntu-binary-nova-api:9.1.0                    <span class="string">&quot;dumb-init --single-…&quot;</span>   4 days ago          Up 4 days                                    nova_api</span><br><span class="line">650dbf084fa7        operator.local:4000/lokolla/ubuntu-binary-nova-scheduler:9.1.0              <span class="string">&quot;dumb-init --single-…&quot;</span>   4 days ago          Up 4 days                                    nova_scheduler</span><br><span class="line">f84e5f5443ec        operator.local:4000/lokolla/ubuntu-binary-placement-api:9.1.0               <span class="string">&quot;dumb-init --single-…&quot;</span>   4 days ago          Up 4 days                                    placement_api</span><br><span class="line">34af2bc9124e        operator.local:4000/lokolla/ubuntu-binary-glance-api:9.1.0                  <span class="string">&quot;dumb-init --single-…&quot;</span>   4 days ago          Up 4 days                                    glance_api</span><br><span class="line">1ed48ba03c97        operator.local:4000/lokolla/ubuntu-binary-keystone-fernet:9.1.0             <span class="string">&quot;dumb-init --single-…&quot;</span>   4 days ago          Up 4 days                                    keystone_fernet</span><br><span class="line">a7a3b569ae2f        operator.local:4000/lokolla/ubuntu-binary-keystone-ssh:9.1.0                <span class="string">&quot;dumb-init --single-…&quot;</span>   4 days ago          Up 4 days                                    keystone_ssh</span><br><span class="line">e5d4b0e94e2e        operator.local:4000/lokolla/ubuntu-binary-keystone:9.1.0                    <span class="string">&quot;dumb-init --single-…&quot;</span>   4 days ago          Up 4 days                                    keystone</span><br><span class="line">820e8bf1c713        operator.local:4000/lokolla/ubuntu-binary-rabbitmq:9.1.0                    <span class="string">&quot;dumb-init --single-…&quot;</span>   9 days ago          Up 4 days                                    rabbitmq</span><br><span class="line">87d818f7aee9        operator.local:4000/lokolla/ubuntu-binary-memcached:9.1.0                   <span class="string">&quot;dumb-init --single-…&quot;</span>   9 days ago          Up 4 days                                    memcached</span><br><span class="line">36c9d3b5ec48        operator.local:4000/lokolla/ubuntu-binary-mariadb:9.1.0                     <span class="string">&quot;dumb-init -- kolla_…&quot;</span>   9 days ago          Up 4 days                                    mariadb</span><br><span class="line">f34118e04e65        operator.local:4000/lokolla/ubuntu-binary-keepalived:9.1.0                  <span class="string">&quot;dumb-init --single-…&quot;</span>   9 days ago          Up 4 days                                    keepalived</span><br><span class="line">4a835502bbc6        operator.local:4000/lokolla/ubuntu-binary-haproxy:9.1.0                     <span class="string">&quot;dumb-init --single-…&quot;</span>   9 days ago          Up 4 days                                    haproxy</span><br><span class="line">6048403886a0        operator.local:4000/lokolla/ubuntu-binary-chrony:9.1.0                      <span class="string">&quot;dumb-init --single-…&quot;</span>   9 days ago          Up 4 days                                    chrony</span><br><span class="line">20c995a51ddd        operator.local:4000/lokolla/ubuntu-binary-cron:9.1.0                        <span class="string">&quot;dumb-init --single-…&quot;</span>   9 days ago          Up 4 days                                    cron</span><br><span class="line">77670d8cafe8        operator.local:4000/lokolla/ubuntu-binary-kolla-toolbox:9.1.0               <span class="string">&quot;dumb-init --single-…&quot;</span>   9 days ago          Up 4 days                                    kolla_toolbox</span><br><span class="line">93426ea2dae4        operator.local:4000/lokolla/ubuntu-binary-fluentd:9.1.0                     <span class="string">&quot;dumb-init --single-…&quot;</span>   9 days ago          Up 4 days                                    fluentd</span><br><span class="line">f9208a01d0ec        registry:2                                                                  <span class="string">&quot;/entrypoint.sh /etc…&quot;</span>   10 days ago         Up 4 days           0.0.0.0:4000-&gt;5000/tcp   registry</span><br></pre></td></tr></table></figure>
<p>And we could try openstack client calls:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@operator:/etc/kolla<span class="comment"># . /etc/kolla/admin-openrc.sh</span></span><br><span class="line">root@operator:/etc/kolla<span class="comment"># openstack service list</span></span><br><span class="line">+----------------------------------+-------------+----------------+</span><br><span class="line">| ID                               | Name        | Type           |</span><br><span class="line">+----------------------------------+-------------+----------------+</span><br><span class="line">| 16c0c5e034a145f4815fb3d242d393bf | keystone    | identity       |</span><br><span class="line">| 4adf583360da4e5a95f091efd1fd9343 | placement   | placement      |</span><br><span class="line">| 837d588b2f6f41c7a1d41d85e99e8906 | nova_legacy | compute_legacy |</span><br><span class="line">| 88807288c83b445e8a03fccbc8453cc0 | heat-cfn    | cloudformation |</span><br><span class="line">| b74e3c61de794de3a0bc34a3fdf86ab7 | nova        | compute        |</span><br><span class="line">| d975a75ca12b4b44b5c8423783e47b76 | neutron     | network        |</span><br><span class="line">| e4860fe43a624f19a1001801d6eec511 | glance      | image          |</span><br><span class="line">| f776a802710840ee9003c1b91fa91a41 | heat        | orchestration  |</span><br><span class="line">+----------------------------------+-------------+----------------+</span><br><span class="line"></span><br><span class="line">root@operator:/etc/kolla<span class="comment"># openstack network agent list</span></span><br><span class="line">+--------------------------------------+--------------------+----------+-------------------+-------+-------+---------------------------+</span><br><span class="line">| ID                                   | Agent Type         | Host     | Availability Zone | Alive | State | Binary                    |</span><br><span class="line">+--------------------------------------+--------------------+----------+-------------------+-------+-------+---------------------------+</span><br><span class="line">| 05a9fcb8-14a5-46a8-b6b7-1430153d7246 | Linux bridge agent | operator | None              | :-)   | UP    | neutron-linuxbridge-agent |</span><br><span class="line">| 16a0abce-a33c-4dda-b13b-d74523ed9b3b | L3 agent           | operator | nova              | :-)   | UP    | neutron-l3-agent          |</span><br><span class="line">| 8e7f251e-243f-4721-97a7-7cb4060ffa18 | Metadata agent     | operator | None              | :-)   | UP    | neutron-metadata-agent    |</span><br><span class="line">| e4e7c5f0-6c79-40ea-9d8c-1da7673e80a5 | DHCP agent         | operator | nova              | :-)   | UP    | neutron-dhcp-agent        |</span><br><span class="line">+--------------------------------------+--------------------+----------+-------------------+-------+-------+---------------------------+</span><br><span class="line"></span><br><span class="line">root@operator:/etc/kolla<span class="comment"># openstack compute service list</span></span><br><span class="line">+----+----------------+----------+----------+---------+-------+----------------------------+</span><br><span class="line">| ID | Binary         | Host     | Zone     | Status  | State | Updated At                 |</span><br><span class="line">+----+----------------+----------+----------+---------+-------+----------------------------+</span><br><span class="line">|  4 | nova-scheduler | operator | internal | enabled | up    | 2020-05-21T15:34:28.000000 |</span><br><span class="line">|  1 | nova-conductor | operator | internal | enabled | up    | 2020-05-21T15:34:35.000000 |</span><br><span class="line">|  2 | nova-compute   | operator | nova     | enabled | up    | 2020-05-21T15:34:36.000000 |</span><br><span class="line">+----+----------------+----------+----------+---------+-------+----------------------------+</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>openstack</category>
      </categories>
      <tags>
        <tag>openstack</tag>
        <tag>vagrant</tag>
      </tags>
  </entry>
  <entry>
    <title>deploy Openstack O on self privisoned virtualbox Ubuntu VMs manually</title>
    <url>/deploy-openstack-o-on-self-privisoned-virtualbox-ubuntu-vms-manually/</url>
    <content><![CDATA[<blockquote>
<p>今天，把我之前在公司内部给同事们培训Openstack 介绍的note放到这里，是一年多之前基于当时的O版本的Ubuntu的部署，对于初学的同学也许有一些帮助，不过其实整个过程无非就是参照官方安装的guide而已。</p>
</blockquote>
<h1 id="Installation-Guide"><a href="#Installation-Guide" class="headerlink" title="Installation Guide"></a>Installation Guide</h1><p>Latest version: <a href="https://github.com/wey-gu/workshops/blob/master/00-Openstack-Basic/installation-openstack-ubuntu-note.md">installation-openstack-ubuntu-note.md</a> hosted on <em>Github.com/wey-gu</em></p>
<blockquote>
<p>ref: <a href="https://docs.openstack.org/install-guide">https://docs.openstack.org/install-guide</a></p>
</blockquote>
<p>Ubuntu was chosen as host OS.</p>
<blockquote>
<p>“It’s a good way to learn by installing it manually for as many services as you could :-) .”</p>
<p>​                                                                                                           Wey Gu </p>
</blockquote>
<h2 id="Host-networking"><a href="#Host-networking" class="headerlink" title="Host networking"></a>Host networking</h2><blockquote>
<p>ref: <a href="https://docs.openstack.org/install-guide/environment-networking.html">https://docs.openstack.org/install-guide/environment-networking.html</a></p>
</blockquote>
<blockquote>
<p>ref: <a href="https://help.ubuntu.com/lts/serverguide/network-configuration.html">https://help.ubuntu.com/lts/serverguide/network-configuration.html</a></p>
</blockquote>
<p>The example architectures assume use of the following networks:</p>
<ul>
<li><p>Management on 10.0.0.0/24 with gateway 10.0.0.1</p>
<p>This network requires a gateway to provide Internet access to all nodes for administrative purposes such as package installation, security updates, DNS, and NTP.</p>
</li>
<li><p>Provider on 203.0.113.0/24 with gateway 203.0.113.1</p>
<p>This network requires a gateway to provide Internet access to instances in your OpenStack environment.</p>
</li>
</ul>
<h3 id="My-network-solution"><a href="#My-network-solution" class="headerlink" title="My network solution"></a>My network solution</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Net0:</span><br><span class="line">	Network name: VirtualBox  host-only Ethernet Adapter</span><br><span class="line">	Purpose: administrator / management network</span><br><span class="line">	IP block: 10.20.0.0/24</span><br><span class="line">	DHCP: <span class="built_in">disable</span></span><br><span class="line">	Linux device: eth0</span><br><span class="line"></span><br><span class="line">Net1:</span><br><span class="line">	Network name: VirtualBox  host-only Ethernet Adapter<span class="comment">#2</span></span><br><span class="line">	Purpose: Provider network</span><br><span class="line">	DHCP: <span class="built_in">disable</span></span><br><span class="line">	IP block: 172.16.0.0/24</span><br><span class="line">	Linux device: eth1</span><br><span class="line"></span><br><span class="line">Net2：</span><br><span class="line">	Network name: VirtualBox  host-only Ethernet Adapter<span class="comment">#3</span></span><br><span class="line">	Purpose: Storage network</span><br><span class="line">	DHCP: <span class="built_in">disable</span></span><br><span class="line">	IP block: 192.168.99.0/24</span><br><span class="line">	Linux device: eth2</span><br><span class="line"></span><br><span class="line">Net3：</span><br><span class="line">	Network name: VirtualBox  Bridged or NAT // <span class="keyword">for</span> accessing network or remote access purpose</span><br><span class="line">	Purpose: Internet</span><br><span class="line">	DHCP: <span class="built_in">enable</span></span><br><span class="line">	IP block: &lt;depend on your network&gt;</span><br><span class="line">	Linux device: eth3</span><br></pre></td></tr></table></figure>




<p>Edit the <code>/etc/network/interfaces</code> file to contain the following:</p>
<p>Replace <code>INTERFACE_NAME</code> with the actual interface name. For example, <em>eth1</em> or <em>ens224</em>.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># The provider network interface</span></span><br><span class="line">auto INTERFACE_NAME</span><br><span class="line">iface INTERFACE_NAME inet manual</span><br><span class="line">up ip link <span class="built_in">set</span> dev <span class="variable">$IFACE</span> up</span><br><span class="line">down ip link <span class="built_in">set</span> dev <span class="variable">$IFACE</span> down</span><br></pre></td></tr></table></figure>
<a id="more"></a>

<h2 id="Base-Machine"><a href="#Base-Machine" class="headerlink" title="Base Machine"></a>Base Machine</h2><ul>
<li>download image from <a href="https://launchpad.net/ubuntu/+mirror/mirrors.neusoft.edu.cn-release">https://launchpad.net/ubuntu/+mirror/mirrors.neusoft.edu.cn-release</a></li>
</ul>
<ul>
<li><p>Change root password</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo su</span><br><span class="line"><span class="comment"># passwd</span></span><br></pre></td></tr></table></figure>


</li>
</ul>
<ul>
<li><p>Allow root ssh with password</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vi /etc/ssh/sshd_config </span></span><br><span class="line"></span><br><span class="line">PermitRootLogin yes</span><br></pre></td></tr></table></figure></li>
<li><p>Check nic names</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@ubuntu:~<span class="comment"># dmesg | grep rename</span></span><br><span class="line">[    2.799294] e1000 0000:00:09.0 enp0s9: renamed from eth2</span><br><span class="line">[    2.800192] e1000 0000:00:0a.0 enp0s10: renamed from eth3</span><br><span class="line">[    2.801072] e1000 0000:00:08.0 enp0s8: renamed from eth1</span><br><span class="line">[    2.804067] e1000 0000:00:03.0 enp0s3: renamed from eth0</span><br></pre></td></tr></table></figure></li>
<li><p>configure management network as a dummy one</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vi /etc/network/interfaces</span></span><br><span class="line">auto enp0s3</span><br><span class="line">iface enp0s3 inet static</span><br><span class="line">address 10.20.0.11</span><br><span class="line">netmask 255.255.255.0</span><br></pre></td></tr></table></figure></li>
<li><p>NTP</p>
<ul>
<li><p>install chrony</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">install chrony</span><br></pre></td></tr></table></figure></li>
<li><p>Edit the <code>/etc/chrony/chrony.conf</code> file and add, change, or remove these keys as necessary for your environment:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">allow 10.20.0.0/24</span><br></pre></td></tr></table></figure></li>
<li><p>restart service</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># service chrony restart</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>Install OpenStack packages</p>
<blockquote>
<p>ref : <a href="https://docs.openstack.org/install-guide/environment-packages.html">https://docs.openstack.org/install-guide/environment-packages.html</a></p>
</blockquote>
<p>Enable the OpenStack repository</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># apt install software-properties-common</span></span><br><span class="line"><span class="comment"># add-apt-repository cloud-archive:ocata</span></span><br></pre></td></tr></table></figure>
<p>Upgrade the packages on all nodes:</p>
<blockquote>
<p>Set apt proxy before doing that will help save your life</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vi /etc/apt/apt.conf.d/90proxy</span></span><br><span class="line">Acquire::http::Proxy <span class="string">&quot;http://&lt;&gt;:8080&quot;</span>;</span><br><span class="line">Acquire::https::Proxy <span class="string">&quot;http://&lt;&gt;:8080&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># sed -i -e &#x27;s/cn/us/g&#x27; /etc/apt/sources.list</span></span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># apt update &amp;&amp; apt dist-upgrade -y</span></span><br></pre></td></tr></table></figure>
<p>Install the OpenStack client:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># apt install python-openstackclient -y</span></span><br></pre></td></tr></table></figure>



</li>
</ul>
<h2 id="Controller-node-actions"><a href="#Controller-node-actions" class="headerlink" title="Controller node actions"></a>Controller node actions</h2><h3 id="management-network-eth0-enp0s3"><a href="#management-network-eth0-enp0s3" class="headerlink" title="management network eth0 (enp0s3)"></a>management network eth0 (enp0s3)</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vi /etc/network/interfaces</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">auto enp0s3</span><br><span class="line">iface enp0s3 inet static</span><br><span class="line">address 10.20.0.10</span><br><span class="line">netmask 255.255.255.0</span><br><span class="line"><span class="comment"># gateway 10.20.0.1  &lt;--- comment out this line</span></span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ifup enp0s3</span></span><br></pre></td></tr></table></figure>
<h3 id="hostname-and-hosts"><a href="#hostname-and-hosts" class="headerlink" title="hostname and hosts"></a>hostname and hosts</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># echo controller &gt; /etc/hostname</span></span><br><span class="line"><span class="comment"># echo 10.20.0.10    controller &gt;&gt; /etc/hosts</span></span><br><span class="line"><span class="comment"># echo 10.20.0.20    compute &gt;&gt; /etc/hosts</span></span><br><span class="line"><span class="comment"># hostname controller</span></span><br></pre></td></tr></table></figure>


<h3 id="SQL-database"><a href="#SQL-database" class="headerlink" title="SQL database"></a>SQL database</h3><p>Install package</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># apt install mariadb-server python-pymysql -y</span></span><br></pre></td></tr></table></figure>
<p>Create and edit the <code>/etc/mysql/mariadb.conf.d/99-openstack.cnf</code> file and complete the following actions:</p>
<blockquote>
<p>Create a <code>[mysqld]</code> section, and set the <code>bind-address</code> key to the management IP address of the controller node to enable access by other nodes via the management network. Set additional keys to enable useful options and the UTF-8 character set:</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">bind-address = 10.20.0.10</span><br><span class="line"></span><br><span class="line">default-storage-engine = innodb</span><br><span class="line">innodb_file_per_table = on</span><br><span class="line">max_connections = 4096</span><br><span class="line">collation-server = utf8_general_ci</span><br><span class="line">character-set-server = utf8</span><br></pre></td></tr></table></figure>
<p>restart database service</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># service mysql restart</span></span><br></pre></td></tr></table></figure>
<p>Secure the database service by running the <code>mysql_secure_installation</code> script. In particular, choose a suitable password for the database <code>root</code> account:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mysql_secure_installation</span></span><br></pre></td></tr></table></figure>
<h3 id="Message-queue"><a href="#Message-queue" class="headerlink" title="Message queue"></a>Message queue</h3><p>Install the package:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># apt install rabbitmq-server</span></span><br></pre></td></tr></table></figure>
<p>Add the <code>openstack</code> user:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># rabbitmqctl add_user openstack RABBIT_PASS</span></span><br><span class="line"></span><br><span class="line">Creating user <span class="string">&quot;openstack&quot;</span> ...</span><br></pre></td></tr></table></figure>
<p>Replace <code>RABBIT_PASS</code> with a suitable password.</p>
<p>Permit configuration, write, and read access for the <code>openstack</code> user:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># rabbitmqctl set_permissions openstack &quot;.*&quot; &quot;.*&quot; &quot;.*&quot;</span></span><br><span class="line"></span><br><span class="line">Setting permissions <span class="keyword">for</span> user <span class="string">&quot;openstack&quot;</span> <span class="keyword">in</span> vhost <span class="string">&quot;/&quot;</span> ...</span><br></pre></td></tr></table></figure>
<h3 id="Memcached"><a href="#Memcached" class="headerlink" title="Memcached"></a>Memcached</h3><p>Install the packages:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># apt install memcached python-memcache</span></span><br></pre></td></tr></table></figure>
<p>Edit the <code>/etc/memcached.conf</code> file and configure the service to use the management IP address of the controller node. This is to enable access by other nodes via the management network:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">-l 10.20.0.10</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Change the existing line that had <code>-l 127.0.0.1</code>.</p>
</blockquote>
<p>Restart the Memcached service:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># service memcached restart</span></span><br></pre></td></tr></table></figure>
<h2 id="Compute-node-actions"><a href="#Compute-node-actions" class="headerlink" title="Compute node actions"></a>Compute node actions</h2><h3 id="management-network-eth0-enp0s3-1"><a href="#management-network-eth0-enp0s3-1" class="headerlink" title="management network eth0 (enp0s3)"></a>management network eth0 (enp0s3)</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vi /etc/network/interfaces</span></span><br><span class="line"></span><br><span class="line">auto enp0s3</span><br><span class="line">iface enp0s3 inet static</span><br><span class="line">address 10.20.0.20</span><br><span class="line">netmask 255.255.255.0</span><br><span class="line"><span class="comment"># comment out gateway</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ifup enp0s3</span></span><br></pre></td></tr></table></figure>
<h3 id="configure-NTP-by-editing-etc-chrony-chrony-conf"><a href="#configure-NTP-by-editing-etc-chrony-chrony-conf" class="headerlink" title="configure NTP by editing /etc/chrony/chrony.conf"></a>configure NTP by editing <code>/etc/chrony/chrony.conf</code></h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server 10.20.0.10 iburst</span><br></pre></td></tr></table></figure>
<p>change hostname and hosts</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># echo compute &gt; /etc/hostname</span></span><br><span class="line"><span class="comment"># echo 10.20.0.10    controller &gt;&gt; /etc/hosts</span></span><br><span class="line"><span class="comment"># echo 10.20.0.20    compute &gt;&gt; /etc/hosts</span></span><br><span class="line"><span class="comment"># hostname compute</span></span><br></pre></td></tr></table></figure>


<h2 id="Keystone-installation"><a href="#Keystone-installation" class="headerlink" title="Keystone installation"></a>Keystone installation</h2><blockquote>
<p>ref: <a href="https://docs.openstack.org/newton/install-guide-ubuntu/keystone.html">https://docs.openstack.org/newton/install-guide-ubuntu/keystone.html</a></p>
</blockquote>
<blockquote>
<p>Keystone will be installed in <code>controller node</code></p>
</blockquote>
<p>Before you configure the OpenStack Identity service, you must create a database and an administration token.</p>
<p>To create the database, complete the following actions:</p>
<ul>
<li><p>Use the database access client to connect to the database server as the <code>root</code> user:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mysql -u root -p</span><br></pre></td></tr></table></figure>
<p>In 16.04 LTS local access need no user/psw</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mysql</span></span><br></pre></td></tr></table></figure>


</li>
</ul>
<ul>
<li><p>Create the <code>keystone</code> database:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; CREATE DATABASE keystone;</span><br></pre></td></tr></table></figure></li>
<li><p>Grant proper access to the <code>keystone</code> database:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; GRANT ALL PRIVILEGES ON keystone.* TO &#39;keystone&#39;@&#39;localhost&#39; \</span><br><span class="line">  IDENTIFIED BY &#39;KEYSTONE_DBPASS&#39;;</span><br><span class="line">mysql&gt; GRANT ALL PRIVILEGES ON keystone.* TO &#39;keystone&#39;@&#39;%&#39; \</span><br><span class="line">  IDENTIFIED BY &#39;KEYSTONE_DBPASS&#39;;</span><br></pre></td></tr></table></figure>
<p>Replace <code>KEYSTONE_DBPASS</code> with a suitable password.</p>
</li>
<li><p>Exit the database access client.</p>
</li>
</ul>
<p>Run the following command to install the packages:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># apt install keystone -y</span></span><br></pre></td></tr></table></figure>
<ol>
<li><p>Edit the <code>/etc/keystone/keystone.conf</code> file and complete the following actions:</p>
<ul>
<li><p>In the <code>[database]</code> section, configure database access:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[database]</span><br><span class="line">...</span><br><span class="line">connection = mysql+pymysql://keystone:KEYSTONE_DBPASS@controller/keystone</span><br></pre></td></tr></table></figure>
<p>Replace <code>KEYSTONE_DBPASS</code> with the password you chose for the database.</p>
<p>Comment out or remove any other <code>connection</code> options in the <code>[database]</code> section.</p>
</li>
<li><p>In the <code>[token]</code> section, configure the Fernet token provider:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[token]</span><br><span class="line">...</span><br><span class="line">provider = fernet</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>Populate the Identity service database:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># su -s /bin/sh -c &quot;keystone-manage db_sync&quot; keystone</span></span><br></pre></td></tr></table></figure></li>
<li><p>Initialize Fernet key repositories:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># keystone-manage fernet_setup --keystone-user keystone --keystone-group keystone</span></span><br><span class="line"><span class="comment"># keystone-manage credential_setup --keystone-user keystone --keystone-group keystone</span></span><br></pre></td></tr></table></figure></li>
<li><p>Bootstrap the Identity service:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># keystone-manage bootstrap --bootstrap-password ADMIN_PASS \</span></span><br><span class="line">  --bootstrap-admin-url http://controller:35357/v3/ \</span><br><span class="line">  --bootstrap-internal-url http://controller:35357/v3/ \</span><br><span class="line">  --bootstrap-public-url http://controller:5000/v3/ \</span><br><span class="line">  --bootstrap-region-id RegionOne</span><br></pre></td></tr></table></figure>
<p>Replace <code>ADMIN_PASS</code> with a suitable password for an administrative user.</p>
</li>
</ol>
<h3 id="Configure-the-Apache-HTTP-server"><a href="#Configure-the-Apache-HTTP-server" class="headerlink" title="Configure the Apache HTTP server"></a>Configure the Apache HTTP server</h3><ol>
<li><p>Edit the <code>/etc/apache2/apache2.conf</code> file and configure the <code>ServerName</code> option to reference the controller node:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ServerName controller</span><br></pre></td></tr></table></figure>
<h3 id="Finalize-the-installation"><a href="#Finalize-the-installation" class="headerlink" title="Finalize the installation"></a>Finalize the installation</h3></li>
<li><p>Restart the Apache service and remove the default SQLite database:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># service apache2 restart</span></span><br><span class="line"><span class="comment"># rm -f /var/lib/keystone/keystone.db</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Configure the administrative account</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">export</span> OS_USERNAME=admin</span><br><span class="line">$ <span class="built_in">export</span> OS_PASSWORD=ADMIN_PASS</span><br><span class="line">$ <span class="built_in">export</span> OS_PROJECT_NAME=admin</span><br><span class="line">$ <span class="built_in">export</span> OS_USER_DOMAIN_NAME=Default</span><br><span class="line">$ <span class="built_in">export</span> OS_PROJECT_DOMAIN_NAME=Default</span><br><span class="line">$ <span class="built_in">export</span> OS_AUTH_URL=http://controller:35357/v3</span><br><span class="line">$ <span class="built_in">export</span> OS_IDENTITY_API_VERSION=3</span><br></pre></td></tr></table></figure>
<p>Replace <code>ADMIN_PASS</code> with the password used in the <code>keystone-manage bootstrap</code> command from the section called <a href="https://docs.openstack.org/newton/install-guide-ubuntu/keystone-install.html#keystone-install">Install and configure</a>.</p>
</li>
</ol>
<h3 id="Create-a-domain-projects-users-and-roles"><a href="#Create-a-domain-projects-users-and-roles" class="headerlink" title="Create a domain, projects, users, and roles"></a>Create a domain, projects, users, and roles</h3><p>The Identity service provides authentication services for each OpenStack service. The authentication service uses a combination of <a href="https://docs.openstack.org/newton/install-guide-ubuntu/common/glossary.html#term-domain">domains</a>, <a href="https://docs.openstack.org/newton/install-guide-ubuntu/common/glossary.html#term-project">projects</a>, <a href="https://docs.openstack.org/newton/install-guide-ubuntu/common/glossary.html#term-user">users</a>, and <a href="https://docs.openstack.org/newton/install-guide-ubuntu/common/glossary.html#term-role">roles</a>.</p>
<ol>
<li><p>This guide uses a service project that contains a unique user for each service that you add to your environment. Create the <code>service</code> project:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack project create --domain default \</span><br><span class="line">  --description <span class="string">&quot;Service Project&quot;</span> service</span><br><span class="line"></span><br><span class="line">+-------------+----------------------------------+</span><br><span class="line">| Field       | Value                            |</span><br><span class="line">+-------------+----------------------------------+</span><br><span class="line">| description | Service Project                  |</span><br><span class="line">| domain_id   | default                          |</span><br><span class="line">| enabled     | True                             |</span><br><span class="line">| id          | 24ac7f19cd944f4cba1d77469b2a73ed |</span><br><span class="line">| is_domain   | False                            |</span><br><span class="line">| name        | service                          |</span><br><span class="line">| parent_id   | default                          |</span><br><span class="line">+-------------+----------------------------------+</span><br></pre></td></tr></table></figure></li>
<li><p>Regular (non-admin) tasks should use an unprivileged project and user. As an example, this guide creates the <code>demo</code> project and user.</p>
<ul>
<li><p>Create the <code>demo</code> project:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack project create --domain default \</span><br><span class="line">  --description <span class="string">&quot;Demo Project&quot;</span> demo</span><br><span class="line"></span><br><span class="line">+-------------+----------------------------------+</span><br><span class="line">| Field       | Value                            |</span><br><span class="line">+-------------+----------------------------------+</span><br><span class="line">| description | Demo Project                     |</span><br><span class="line">| domain_id   | default                          |</span><br><span class="line">| enabled     | True                             |</span><br><span class="line">| id          | 231ad6e7ebba47d6a1e57e1cc07ae446 |</span><br><span class="line">| is_domain   | False                            |</span><br><span class="line">| name        | demo                             |</span><br><span class="line">| parent_id   | default                          |</span><br><span class="line">+-------------+----------------------------------+</span><br></pre></td></tr></table></figure>
<p>Do not repeat this step when creating additional users for this project.</p>
</li>
<li><p>Create the <code>demo</code> user:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack user create --domain default \</span><br><span class="line">  --password-prompt demo</span><br><span class="line"></span><br><span class="line">User Password:</span><br><span class="line">Repeat User Password:</span><br><span class="line">+---------------------+----------------------------------+</span><br><span class="line">| Field               | Value                            |</span><br><span class="line">+---------------------+----------------------------------+</span><br><span class="line">| domain_id           | default                          |</span><br><span class="line">| enabled             | True                             |</span><br><span class="line">| id                  | aeda23aa78f44e859900e22c24817832 |</span><br><span class="line">| name                | demo                             |</span><br><span class="line">| password_expires_at | None                             |</span><br><span class="line">+---------------------+----------------------------------+</span><br></pre></td></tr></table></figure></li>
<li><p>Create the <code>user</code> role:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack role create user</span><br><span class="line"></span><br><span class="line">+-----------+----------------------------------+</span><br><span class="line">| Field     | Value                            |</span><br><span class="line">+-----------+----------------------------------+</span><br><span class="line">| domain_id | None                             |</span><br><span class="line">| id        | 997ce8d05fc143ac97d83fdfb5998552 |</span><br><span class="line">| name      | user                             |</span><br><span class="line">+-----------+----------------------------------+</span><br></pre></td></tr></table></figure></li>
<li><p>Add the <code>user</code> role to the <code>demo</code> project and user:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack role add --project demo --user demo user</span><br></pre></td></tr></table></figure>
<h3 id="Verify-operation"><a href="#Verify-operation" class="headerlink" title="Verify operation"></a>Verify operation</h3></li>
</ul>
</li>
</ol>
<p>For security reasons, disable the temporary authentication token mechanism:</p>
<p>Edit the <code>/etc/keystone/keystone-paste.ini</code> file and remove <code>admin_token_auth</code> from the <code>[pipeline:public_api]</code>, <code>[pipeline:admin_api]</code>, and <code>[pipeline:api_v3]</code> sections.</p>
<p>Unset the temporary <code>OS_AUTH_URL</code> and <code>OS_PASSWORD</code> environment variable:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">unset</span> OS_AUTH_URL OS_PASSWORD</span><br></pre></td></tr></table></figure>
<p>As the <code>admin</code> user, request an authentication token:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack --os-auth-url http://controller:35357/v3 \</span><br><span class="line">  --os-project-domain-name Default --os-user-domain-name Default \</span><br><span class="line">  --os-project-name admin --os-username admin token issue</span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line">+------------+-----------------------------------------------------------------+</span><br><span class="line">| Field      | Value                                                           |</span><br><span class="line">+------------+-----------------------------------------------------------------+</span><br><span class="line">| expires    | 2017-08-12T20:14:07.056119Z                                     |</span><br><span class="line">| id         | gAAAAABWvi7_B8kKQD9wdXac8MoZiQldmjEO643d-e_j-XXq9AmIegIbA7UHGPv |</span><br><span class="line">|            | atnN21qtOMjCFWX7BReJEQnVOAj3nclRQgAYRsfSU_MrsuWb4EDtnjU7HEpoBb4 |</span><br><span class="line">|            | o6ozsA_NmFWEpLeKy0uNn_WeKbAhYygrsmQGA49dclHVnz-OMVLiyM9ws       |</span><br><span class="line">| project_id | 343d245e850143a096806dfaefa9afdc                                |</span><br><span class="line">| user_id    | ac3377633149401296f6c0d92d79dc16                                |</span><br><span class="line">+------------+-----------------------------------------------------------------+</span><br></pre></td></tr></table></figure>


<p>This command uses the password for the <code>admin</code> user. As we gave above it’s <code>ADMIN_PASS</code>.</p>
<p>As the <code>demo</code> user, request an authentication token:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack --os-auth-url http://controller:5000/v3 \</span><br><span class="line">  --os-project-domain-name Default --os-user-domain-name Default \</span><br><span class="line">  --os-project-name demo --os-username demo token issue</span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line">+------------+-----------------------------------------------------------------+</span><br><span class="line">| Field      | Value                                                           |</span><br><span class="line">+------------+-----------------------------------------------------------------+</span><br><span class="line">| expires    | 2017-08-12T20:15:39.014479Z                                     |</span><br><span class="line">| id         | gAAAAABWvi9bsh7vkiby5BpCCnc-JkbGhm9wH3fabS_cY7uabOubesi-Me6IGWW |</span><br><span class="line">|            | yQqNegDDZ5jw7grI26vvgy1J5nCVwZ_zFRqPiz_qhbq29mgbQLglbkq6FQvzBRQ |</span><br><span class="line">|            | JcOzq3uwhzNxszJWmzGC7rJE_H0A_a3UFhqv8M4zMRYSbS2YF0MyFmp_U       |</span><br><span class="line">| project_id | ed0b60bf607743088218b0a533d5943f                                |</span><br><span class="line">| user_id    | 58126687cbcc4888bfa9ab73a2256f27                                |</span><br><span class="line">+------------+-----------------------------------------------------------------+</span><br></pre></td></tr></table></figure>


<blockquote>
<p>This command uses the password for the <code>demo</code> user and API port 5000 which only allows regular (non-admin) access to the Identity service API.</p>
</blockquote>
<h3 id="Create-OpenStack-client-environment-scripts"><a href="#Create-OpenStack-client-environment-scripts" class="headerlink" title="Create OpenStack client environment scripts"></a>Create OpenStack client environment scripts</h3><p>The previous section used a combination of environment variables and command options to interact with the Identity service via the<code>openstack</code> client. To increase efficiency of client operations, OpenStack supports simple client environment scripts also known as OpenRC files. These scripts typically contain common options for all clients, but also support unique options. For more information, see the <a href="http://docs.openstack.org/user-guide/common/cli_set_environment_variables_using_openstack_rc.html">OpenStack End User Guide</a>.</p>
<h4 id="Creating-the-scripts"><a href="#Creating-the-scripts" class="headerlink" title="Creating the scripts"></a>Creating the scripts</h4><p>Create client environment scripts for the <code>admin</code> and <code>demo</code> projects and users. Future portions of this guide reference these scripts to load appropriate credentials for client operations.</p>
<ol>
<li><p>Edit the <code>admin-openrc</code> file and add the following content:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> OS_PROJECT_DOMAIN_NAME=Default</span><br><span class="line"><span class="built_in">export</span> OS_USER_DOMAIN_NAME=Default</span><br><span class="line"><span class="built_in">export</span> OS_PROJECT_NAME=admin</span><br><span class="line"><span class="built_in">export</span> OS_USERNAME=admin</span><br><span class="line"><span class="built_in">export</span> OS_PASSWORD=ADMIN_PASS</span><br><span class="line"><span class="built_in">export</span> OS_AUTH_URL=http://controller:35357/v3</span><br><span class="line"><span class="built_in">export</span> OS_IDENTITY_API_VERSION=3</span><br><span class="line"><span class="built_in">export</span> OS_IMAGE_API_VERSION=2</span><br></pre></td></tr></table></figure>
<p>Replace <code>ADMIN_PASS</code> with the password you chose for the <code>admin</code> user in the Identity service.</p>
</li>
<li><p>Edit the <code>demo-openrc</code> file and add the following content:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> OS_PROJECT_DOMAIN_NAME=Default</span><br><span class="line"><span class="built_in">export</span> OS_USER_DOMAIN_NAME=Default</span><br><span class="line"><span class="built_in">export</span> OS_PROJECT_NAME=demo</span><br><span class="line"><span class="built_in">export</span> OS_USERNAME=demo</span><br><span class="line"><span class="built_in">export</span> OS_PASSWORD=demo</span><br><span class="line"><span class="built_in">export</span> OS_AUTH_URL=http://controller:5000/v3</span><br><span class="line"><span class="built_in">export</span> OS_IDENTITY_API_VERSION=3</span><br><span class="line"><span class="built_in">export</span> OS_IMAGE_API_VERSION=2</span><br></pre></td></tr></table></figure>
<p>Replace <code>OS_PASSWORD=demo</code> with the password you chose for the <code>demo</code> user in the Identity service.</p>
</li>
</ol>
<h4 id="Using-the-scripts"><a href="#Using-the-scripts" class="headerlink" title="Using the scripts"></a>Using the scripts</h4><p>To run clients as a specific project and user, you can simply load the associated client environment script prior to running them. For example:</p>
<ol>
<li><p>Load the <code>admin-openrc</code> file to populate environment variables with the location of the Identity service and the <code>admin</code> project and user credentials:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ . admin-openrc</span><br></pre></td></tr></table></figure></li>
<li><p>Request an authentication token:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@ubuntu:~<span class="comment"># openstack token issue --max-width 70</span></span><br><span class="line">+------------+-------------------------------------------------------+</span><br><span class="line">| Field      | Value                                                 |</span><br><span class="line">+------------+-------------------------------------------------------+</span><br><span class="line">| expires    | 2017-08-23T14:00:10+0000                              |</span><br><span class="line">| id         | gAAAAABZnXxaKuuwh9Kw-dbY1mSn8LeNNQMKmIj2EW8jyjO0NSy5H |</span><br><span class="line">|            | QPno4Tj6NqqSkumKhRZW8lPS1nZC2pm5fCuH5XMtVfJTu89RX6Sba |</span><br><span class="line">|            | -vSv-OZl5uHvRY4KOK03WH15Dnp1XbWN97xY8tR_kAhc-69       |</span><br><span class="line">|            | -WvDe1DLS6vKr-bKbYDVXLqlLshE8E                        |</span><br><span class="line">| project_id | 78c9c849237649a3a8c4526167427589                      |</span><br><span class="line">| user_id    | d8efd16c30904a7992010abe4bdb9a2b                      |</span><br><span class="line">+------------+-------------------------------------------------------+</span><br></pre></td></tr></table></figure>
<h2 id="Glance-installation"><a href="#Glance-installation" class="headerlink" title="Glance installation"></a>Glance installation</h2></li>
</ol>
<p>ref: <a href="https://docs.openstack.org/newton/install-guide-ubuntu/glance.html">https://docs.openstack.org/newton/install-guide-ubuntu/glance.html</a></p>
<p>For simplicity, this guide describes configuring the Image service to use the <code>file</code> back end, which uploads and stores in a directory on the controller node hosting the Image service. By default, this directory is <code>/var/lib/glance/images/</code>.</p>
<p>Before you proceed, ensure that the controller node has at least several gigabytes of space available in this directory. Keep in mind that since the <code>file</code> back end is often local to a controller node, it is not typically suitable for a multi-node glance deployment.</p>
<p>For information on requirements for other back ends, see <a href="http://docs.openstack.org/newton/config-reference/image.html">Configuration Reference</a>.</p>
<h3 id="Install-and-configure"><a href="#Install-and-configure" class="headerlink" title="Install and configure"></a>Install and configure</h3><p>This section describes how to install and configure the Image service, code-named glance, on the controller node. For simplicity, this configuration stores images on the local file system.</p>
<h3 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h3><p>Before you install and configure the Image service, you must create a database, service credentials, and API endpoints.</p>
<ol>
<li><p>To create the database, complete these steps:</p>
<ul>
<li><p>Use the database access client to connect to the database server as the <code>root</code> user:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mysql</span><br></pre></td></tr></table></figure></li>
<li><p>Create the <code>glance</code> database:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql&gt; CREATE DATABASE glance;</span><br></pre></td></tr></table></figure></li>
<li><p>Grant proper access to the <code>glance</code> database:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql&gt; GRANT ALL PRIVILEGES ON glance.* TO <span class="string">&#x27;glance&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> \</span><br><span class="line">  IDENTIFIED BY <span class="string">&#x27;GLANCE_DBPASS&#x27;</span>;</span><br><span class="line">mysql&gt; GRANT ALL PRIVILEGES ON glance.* TO <span class="string">&#x27;glance&#x27;</span>@<span class="string">&#x27;%&#x27;</span> \</span><br><span class="line">  IDENTIFIED BY <span class="string">&#x27;GLANCE_DBPASS&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>Replace <code>GLANCE_DBPASS</code> with a suitable password.</p>
</li>
<li><p>Exit the database access client.</p>
</li>
</ul>
</li>
<li><p>Source the <code>admin</code> credentials to gain access to admin-only CLI commands:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ . admin-openrc</span><br></pre></td></tr></table></figure></li>
<li><p>To create the service credentials, complete these steps:</p>
<ul>
<li><p>Create the <code>glance</code> user:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack user create --domain default --password-prompt glance</span><br><span class="line"></span><br><span class="line">User Password:</span><br><span class="line">Repeat User Password:</span><br><span class="line">+---------------------+----------------------------------+</span><br><span class="line">| Field               | Value                            |</span><br><span class="line">+---------------------+----------------------------------+</span><br><span class="line">| domain_id           | default                          |</span><br><span class="line">| enabled             | True                             |</span><br><span class="line">| id                  | 3f4e777c4062483ab8d9edd7dff829df |</span><br><span class="line">| name                | glance                           |</span><br><span class="line">| password_expires_at | None                             |</span><br><span class="line">+---------------------+----------------------------------+</span><br></pre></td></tr></table></figure></li>
<li><p>Add the <code>admin</code> role to the <code>glance</code> user and <code>service</code> project:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack role add --project service --user glance admin</span><br></pre></td></tr></table></figure>
<p>This command provides no output.</p>
</li>
<li><p>Create the <code>glance</code> service entity:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack service create --name glance \</span><br><span class="line">  --description <span class="string">&quot;OpenStack Image&quot;</span> image</span><br><span class="line"></span><br><span class="line">+-------------+----------------------------------+</span><br><span class="line">| Field       | Value                            |</span><br><span class="line">+-------------+----------------------------------+</span><br><span class="line">| description | OpenStack Image                  |</span><br><span class="line">| enabled     | True                             |</span><br><span class="line">| id          | 8c2c7f1b9b5049ea9e63757b5533e6d2 |</span><br><span class="line">| name        | glance                           |</span><br><span class="line">| <span class="built_in">type</span>        | image                            |</span><br><span class="line">+-------------+----------------------------------+</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>Create the Image service API endpoints:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack endpoint create --region RegionOne \</span><br><span class="line">  image public http://controller:9292</span><br><span class="line"></span><br><span class="line">+--------------+----------------------------------+</span><br><span class="line">| Field        | Value                            |</span><br><span class="line">+--------------+----------------------------------+</span><br><span class="line">| enabled      | True                             |</span><br><span class="line">| id           | 340be3625e9b4239a6415d034e98aace |</span><br><span class="line">| interface    | public                           |</span><br><span class="line">| region       | RegionOne                        |</span><br><span class="line">| region_id    | RegionOne                        |</span><br><span class="line">| service_id   | 8c2c7f1b9b5049ea9e63757b5533e6d2 |</span><br><span class="line">| service_name | glance                           |</span><br><span class="line">| service_type | image                            |</span><br><span class="line">| url          | http://controller:9292           |</span><br><span class="line">+--------------+----------------------------------+</span><br><span class="line"></span><br><span class="line">$ openstack endpoint create --region RegionOne \</span><br><span class="line">  image internal http://controller:9292</span><br><span class="line"></span><br><span class="line">+--------------+----------------------------------+</span><br><span class="line">| Field        | Value                            |</span><br><span class="line">+--------------+----------------------------------+</span><br><span class="line">| enabled      | True                             |</span><br><span class="line">| id           | a6e4b153c2ae4c919eccfdbb7dceb5d2 |</span><br><span class="line">| interface    | internal                         |</span><br><span class="line">| region       | RegionOne                        |</span><br><span class="line">| region_id    | RegionOne                        |</span><br><span class="line">| service_id   | 8c2c7f1b9b5049ea9e63757b5533e6d2 |</span><br><span class="line">| service_name | glance                           |</span><br><span class="line">| service_type | image                            |</span><br><span class="line">| url          | http://controller:9292           |</span><br><span class="line">+--------------+----------------------------------+</span><br><span class="line"></span><br><span class="line">$ openstack endpoint create --region RegionOne \</span><br><span class="line">  image admin http://controller:9292</span><br><span class="line"></span><br><span class="line">+--------------+----------------------------------+</span><br><span class="line">| Field        | Value                            |</span><br><span class="line">+--------------+----------------------------------+</span><br><span class="line">| enabled      | True                             |</span><br><span class="line">| id           | 0c37ed58103f4300a84ff125a539032d |</span><br><span class="line">| interface    | admin                            |</span><br><span class="line">| region       | RegionOne                        |</span><br><span class="line">| region_id    | RegionOne                        |</span><br><span class="line">| service_id   | 8c2c7f1b9b5049ea9e63757b5533e6d2 |</span><br><span class="line">| service_name | glance                           |</span><br><span class="line">| service_type | image                            |</span><br><span class="line">| url          | http://controller:9292           |</span><br><span class="line">+--------------+----------------------------------+</span><br></pre></td></tr></table></figure>
<h3 id="Install-and-configure-components"><a href="#Install-and-configure-components" class="headerlink" title="Install and configure components"></a>Install and configure components</h3></li>
</ol>
<p>Install the packages:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># apt install glance -y</span></span><br></pre></td></tr></table></figure>
<ol>
<li><p>Edit the <code>/etc/glance/glance-api.conf</code> file and complete the following actions:</p>
<ul>
<li><p>In the <code>[database]</code> section, configure database access:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[database]</span><br><span class="line">...</span><br><span class="line">connection = mysql+pymysql://glance:GLANCE_DBPASS@controller/glance</span><br></pre></td></tr></table></figure>
<p>Replace <code>GLANCE_DBPASS</code> with the password you chose for the Image service database.</p>
</li>
<li><p>In the <code>[keystone_authtoken]</code> and <code>[paste_deploy]</code> sections, configure Identity service access:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[keystone_authtoken]</span><br><span class="line">...</span><br><span class="line">auth_uri = http://controller:5000</span><br><span class="line">auth_url = http://controller:35357</span><br><span class="line">memcached_servers = controller:11211</span><br><span class="line">auth_type = password</span><br><span class="line">project_domain_name = Default</span><br><span class="line">user_domain_name = Default</span><br><span class="line">project_name = service</span><br><span class="line">username = glance</span><br><span class="line">password = glance</span><br><span class="line"></span><br><span class="line">[paste_deploy]</span><br><span class="line">...</span><br><span class="line">flavor = keystone</span><br></pre></td></tr></table></figure>
<p>Replace <code>password = glance</code> with the password you chose for the <code>glance</code> user in the Identity service.</p>
</li>
</ul>
</li>
</ol>
<pre><code> Comment out or remove any other options in the `[keystone_authtoken]` section.</code></pre>
<ul>
<li><p>In the <code>[glance_store]</code> section, configure the local file system store and location of image files:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[glance_store]</span><br><span class="line">...</span><br><span class="line">stores = file,http</span><br><span class="line">default_store = file</span><br><span class="line">filesystem_store_datadir = /var/lib/glance/images/</span><br></pre></td></tr></table></figure></li>
</ul>
<ol start="2">
<li><p>Edit the <code>/etc/glance/glance-registry.conf</code> file and complete the following actions:</p>
<ul>
<li><p>In the <code>[database]</code> section, configure database access:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[database]</span><br><span class="line">...</span><br><span class="line">connection = mysql+pymysql://glance:GLANCE_DBPASS@controller/glance</span><br></pre></td></tr></table></figure>
<p>Replace <code>GLANCE_DBPASS</code> with the password you chose for the Image service database.</p>
</li>
<li><p>In the <code>[keystone_authtoken]</code> and <code>[paste_deploy]</code> sections, configure Identity service access:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[keystone_authtoken]</span><br><span class="line">...</span><br><span class="line">auth_uri = http://controller:5000</span><br><span class="line">auth_url = http://controller:35357</span><br><span class="line">memcached_servers = controller:11211</span><br><span class="line">auth_type = password</span><br><span class="line">project_domain_name = Default</span><br><span class="line">user_domain_name = Default</span><br><span class="line">project_name = service</span><br><span class="line">username = glance</span><br><span class="line">password = glance</span><br><span class="line"></span><br><span class="line">[paste_deploy]</span><br><span class="line">...</span><br><span class="line">flavor = keystone</span><br></pre></td></tr></table></figure>
<p>Replace <code>password = glance</code> with the password you chose for the <code>glance</code> user in the Identity service.</p>
<p>Comment out or remove any other options in the <code>[keystone_authtoken]</code> section.</p>
</li>
</ul>
</li>
</ol>
<p>Populate the Image service database:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># su -s /bin/sh -c &quot;glance-manage db_sync&quot; glance</span></span><br></pre></td></tr></table></figure>
<p>Ignore any deprecation messages in this output.</p>
<h3 id="Finalize-installation"><a href="#Finalize-installation" class="headerlink" title="Finalize installation"></a>Finalize installation</h3><p>Restart the Image services:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># service glance-registry restart</span></span><br><span class="line"><span class="comment"># service glance-api restart</span></span><br></pre></td></tr></table></figure>
<h3 id="Verify-operation-1"><a href="#Verify-operation-1" class="headerlink" title="Verify operation"></a>Verify operation</h3><p>Verify operation of the Image service using <a href="http://launchpad.net/cirros">CirrOS</a>, a small Linux image that helps you test your OpenStack deployment.</p>
<p>For more information about how to download and build images, see <a href="http://docs.openstack.org/image-guide/">OpenStack Virtual Machine Image Guide</a>. For information about how to manage images, see the <a href="http://docs.openstack.org/user-guide/common/cli-manage-images.html">OpenStack End User Guide</a>.</p>
<ol>
<li><p>Source the <code>admin</code> credentials to gain access to admin-only CLI commands:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ . admin-openrc</span><br></pre></td></tr></table></figure></li>
<li><p>Download the source image:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ wget http://download.cirros-cloud.net/0.3.4/cirros-0.3.4-x86_64-disk.img</span><br></pre></td></tr></table></figure>
<blockquote>
<p>tip: add proxy to improve speed in office network</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ export http_proxy&#x3D;http:&#x2F;&#x2F;&lt;&gt;:8080</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; after wget</span><br><span class="line"></span><br><span class="line">$ unset http_proxy</span><br></pre></td></tr></table></figure>
<p>Install <code>wget</code> if your distribution does not include it.</p>
</blockquote>
</li>
<li><p>Upload the image to the Image service using the <a href="https://docs.openstack.org/newton/install-guide-ubuntu/common/glossary.html#term-qemu-copy-on-write-2-qcow2">QCOW2</a> disk format, <a href="https://docs.openstack.org/newton/install-guide-ubuntu/common/glossary.html#term-bare">bare</a> container format, and public visibility so all projects can access it:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack image create <span class="string">&quot;cirros&quot;</span> \</span><br><span class="line">  --file cirros-0.3.5-x86_64-disk.img \</span><br><span class="line">  --disk-format qcow2 --container-format bare \</span><br><span class="line">  --public</span><br><span class="line"></span><br><span class="line">+------------------+------------------------------------------------------+</span><br><span class="line">| Field            | Value                                                |</span><br><span class="line">+------------------+------------------------------------------------------+</span><br><span class="line">| checksum         | 133eae9fb1c98f45894a4e60d8736619                     |</span><br><span class="line">| container_format | bare                                                 |</span><br><span class="line">| created_at       | 2015-03-26T16:52:10Z                                 |</span><br><span class="line">| disk_format      | qcow2                                                |</span><br><span class="line">| file             | /v2/images/cc5c6982-4910-471e-b864-1098015901b5/file |</span><br><span class="line">| id               | cc5c6982-4910-471e-b864-1098015901b5                 |</span><br><span class="line">| min_disk         | 0                                                    |</span><br><span class="line">| min_ram          | 0                                                    |</span><br><span class="line">| name             | cirros                                               |</span><br><span class="line">| owner            | ae7a98326b9c455588edd2656d723b9d                     |</span><br><span class="line">| protected        | False                                                |</span><br><span class="line">| schema           | /v2/schemas/image                                    |</span><br><span class="line">| size             | 13200896                                             |</span><br><span class="line">| status           | active                                               |</span><br><span class="line">| tags             |                                                      |</span><br><span class="line">| updated_at       | 2015-03-26T16:52:10Z                                 |</span><br><span class="line">| virtual_size     | None                                                 |</span><br><span class="line">| visibility       | public                                               |</span><br><span class="line">+------------------+------------------------------------------------------+</span><br></pre></td></tr></table></figure>
<p>For information about the <strong>openstack image create</strong> parameters, see <a href="http://docs.openstack.org/user-guide/common/cli-manage-images.html#create-or-update-an-image-glance">Create or update an image (glance)</a> in the <code>OpenStack UserGuide</code>.</p>
<p>For information about disk and container formats for images, see <a href="http://docs.openstack.org/image-guide/image-formats.html">Disk and container formats for images</a> in the <code>OpenStack VirtualMachine Image Guide</code>.</p>
</li>
</ol>
<p>   OpenStack generates IDs dynamically, so you will see different values in the example command output.</p>
<ol start="4">
<li><p>Confirm upload of the image and validate attributes:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack image list</span><br><span class="line"></span><br><span class="line">+--------------------------------------+--------+--------+</span><br><span class="line">| ID                                   | Name   | Status |</span><br><span class="line">+--------------------------------------+--------+--------+</span><br><span class="line">| 38047887-61a7-41ea-9b49-27987d5e8bb9 | cirros | active |</span><br><span class="line">+--------------------------------------+--------+--------+</span><br></pre></td></tr></table></figure>
<h2 id="Nova-installation"><a href="#Nova-installation" class="headerlink" title="Nova installation"></a>Nova installation</h2></li>
</ol>
<blockquote>
<p> ref: <a href="https://docs.openstack.org/newton/install-guide-ubuntu/nova.html">https://docs.openstack.org/newton/install-guide-ubuntu/nova.html</a></p>
</blockquote>
<h2 id="Nova-install-and-configure-controller-node"><a href="#Nova-install-and-configure-controller-node" class="headerlink" title="Nova install and configure controller node"></a>Nova install and configure controller node</h2><h3 id="Prerequisites-1"><a href="#Prerequisites-1" class="headerlink" title="Prerequisites"></a>Prerequisites</h3><p>Before you install and configure the Compute service, you must create databases, service credentials, and API endpoints.</p>
<ol>
<li><p>To create the databases, complete these steps:</p>
<ul>
<li><p>Use the database access client to connect to the database server as the <code>root</code> user:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mysql</span></span><br><span class="line"></span><br><span class="line">​```bash</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ol>
<ul>
<li><p>Create the <code>nova_api</code>, <code>nova</code>, and <code>nova_cell0</code> databases:</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; CREATE DATABASE nova_api;</span><br><span class="line">MariaDB [(none)]&gt; CREATE DATABASE nova;</span><br><span class="line">MariaDB [(none)]&gt; CREATE DATABASE nova_cell0;</span><br><span class="line"></span><br><span class="line">​```bash</span><br></pre></td></tr></table></figure></li>
<li><p>Grant proper access to the databases:</p>
<pre><code> ​```
 MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON nova_api.* TO &#39;nova&#39;@&#39;localhost&#39; \
   IDENTIFIED BY &#39;NOVA_DBPASS&#39;;
 MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON nova_api.* TO &#39;nova&#39;@&#39;%&#39; \
   IDENTIFIED BY &#39;NOVA_DBPASS&#39;;

 MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON nova.* TO &#39;nova&#39;@&#39;localhost&#39; \
   IDENTIFIED BY &#39;NOVA_DBPASS&#39;;
 MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON nova.* TO &#39;nova&#39;@&#39;%&#39; \
   IDENTIFIED BY &#39;NOVA_DBPASS&#39;;

 MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON nova_cell0.* TO &#39;nova&#39;@&#39;localhost&#39; \
   IDENTIFIED BY &#39;NOVA_DBPASS&#39;;
 MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON nova_cell0.* TO &#39;nova&#39;@&#39;%&#39; \
   IDENTIFIED BY &#39;NOVA_DBPASS&#39;;

 ​```

 Replace `NOVA_DBPASS` with a suitable password.</code></pre>
<ul>
<li>Exit the database access client.</li>
</ul>
</li>
</ul>
<ol>
<li><p>Source the <code>admin</code> credentials to gain access to admin-only CLI commands:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ . admin-openrc</span><br><span class="line"></span><br><span class="line">​```bash</span><br></pre></td></tr></table></figure></li>
<li><p>Create the Compute service credentials:</p>
<ul>
<li><p>Create the <code>nova</code> user:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack user create --domain default --password-prompt nova</span><br><span class="line"></span><br><span class="line">User Password:</span><br><span class="line">Repeat User Password:</span><br><span class="line">+---------------------+----------------------------------+</span><br><span class="line">| Field               | Value                            |</span><br><span class="line">+---------------------+----------------------------------+</span><br><span class="line">| domain_id           | default                          |</span><br><span class="line">| enabled             | True                             |</span><br><span class="line">| id                  | 8a7dbf5279404537b1c7b86c033620fe |</span><br><span class="line">| name                | nova                             |</span><br><span class="line">| options             | &#123;&#125;                               |</span><br><span class="line">| password_expires_at | None                             |</span><br><span class="line">+---------------------+----------------------------------+</span><br></pre></td></tr></table></figure></li>
<li><p>Add the <code>admin</code> role to the <code>nova</code> user:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack role add --project service --user nova admin</span><br></pre></td></tr></table></figure>
<p>This command provides no output.</p>
</li>
<li><p>Create the <code>nova</code> service entity:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack service create --name nova \</span><br><span class="line">  --description <span class="string">&quot;OpenStack Compute&quot;</span> compute</span><br><span class="line"></span><br><span class="line">+-------------+----------------------------------+</span><br><span class="line">| Field       | Value                            |</span><br><span class="line">+-------------+----------------------------------+</span><br><span class="line">| description | OpenStack Compute                |</span><br><span class="line">| enabled     | True                             |</span><br><span class="line">| id          | 060d59eac51b4594815603d75a00aba2 |</span><br><span class="line">| name        | nova                             |</span><br><span class="line">| <span class="built_in">type</span>        | compute                          |</span><br><span class="line">+-------------+----------------------------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>Create the Compute API service endpoints:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack endpoint create --region RegionOne \</span><br><span class="line">  compute public http://controller:8774/v2.1</span><br><span class="line"></span><br><span class="line">+--------------+-------------------------------------------+</span><br><span class="line">| Field        | Value                                     |</span><br><span class="line">+--------------+-------------------------------------------+</span><br><span class="line">| enabled      | True                                      |</span><br><span class="line">| id           | 3c1caa473bfe4390a11e7177894bcc7b          |</span><br><span class="line">| interface    | public                                    |</span><br><span class="line">| region       | RegionOne                                 |</span><br><span class="line">| region_id    | RegionOne                                 |</span><br><span class="line">| service_id   | 060d59eac51b4594815603d75a00aba2          |</span><br><span class="line">| service_name | nova                                      |</span><br><span class="line">| service_type | compute                                   |</span><br><span class="line">| url          | http://controller:8774/v2.1               |</span><br><span class="line">+--------------+-------------------------------------------+</span><br><span class="line"></span><br><span class="line">$ openstack endpoint create --region RegionOne \</span><br><span class="line">  compute internal http://controller:8774/v2.1</span><br><span class="line"></span><br><span class="line">+--------------+-------------------------------------------+</span><br><span class="line">| Field        | Value                                     |</span><br><span class="line">+--------------+-------------------------------------------+</span><br><span class="line">| enabled      | True                                      |</span><br><span class="line">| id           | e3c918de680746a586eac1f2d9bc10ab          |</span><br><span class="line">| interface    | internal                                  |</span><br><span class="line">| region       | RegionOne                                 |</span><br><span class="line">| region_id    | RegionOne                                 |</span><br><span class="line">| service_id   | 060d59eac51b4594815603d75a00aba2          |</span><br><span class="line">| service_name | nova                                      |</span><br><span class="line">| service_type | compute                                   |</span><br><span class="line">| url          | http://controller:8774/v2.1               |</span><br><span class="line">+--------------+-------------------------------------------+</span><br><span class="line"></span><br><span class="line">$ openstack endpoint create --region RegionOne \</span><br><span class="line">  compute admin http://controller:8774/v2.1</span><br><span class="line"></span><br><span class="line">+--------------+-------------------------------------------+</span><br><span class="line">| Field        | Value                                     |</span><br><span class="line">+--------------+-------------------------------------------+</span><br><span class="line">| enabled      | True                                      |</span><br><span class="line">| id           | 38f7af91666a47cfb97b4dc790b94424          |</span><br><span class="line">| interface    | admin                                     |</span><br><span class="line">| region       | RegionOne                                 |</span><br><span class="line">| region_id    | RegionOne                                 |</span><br><span class="line">| service_id   | 060d59eac51b4594815603d75a00aba2          |</span><br><span class="line">| service_name | nova                                      |</span><br><span class="line">| service_type | compute                                   |</span><br><span class="line">| url          | http://controller:8774/v2.1               |</span><br><span class="line">+--------------+-------------------------------------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>Create a Placement service user using your chosen <code>PLACEMENT_PASS</code>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack user create --domain default --password-prompt placement</span><br><span class="line"></span><br><span class="line">User Password:</span><br><span class="line">Repeat User Password:</span><br><span class="line">+---------------------+----------------------------------+</span><br><span class="line">| Field               | Value                            |</span><br><span class="line">+---------------------+----------------------------------+</span><br><span class="line">| domain_id           | default                          |</span><br><span class="line">| enabled             | True                             |</span><br><span class="line">| id                  | fa742015a6494a949f67629884fc7ec8 |</span><br><span class="line">| name                | placement                        |</span><br><span class="line">| options             | &#123;&#125;                               |</span><br><span class="line">| password_expires_at | None                             |</span><br><span class="line">+---------------------+----------------------------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>Add the Placement user to the service project with the admin role:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack role add --project service --user placement admin</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>This command provides no output.</p>
</li>
<li><p>Create the Placement API entry in the service catalog:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack service create --name placement --description <span class="string">&quot;Placement API&quot;</span> placement</span><br><span class="line">+-------------+----------------------------------+</span><br><span class="line">| Field       | Value                            |</span><br><span class="line">+-------------+----------------------------------+</span><br><span class="line">| description | Placement API                    |</span><br><span class="line">| enabled     | True                             |</span><br><span class="line">| id          | 2d1a27022e6e4185b86adac4444c495f |</span><br><span class="line">| name        | placement                        |</span><br><span class="line">| <span class="built_in">type</span>        | placement                        |</span><br><span class="line">+-------------+----------------------------------+</span><br></pre></td></tr></table></figure></li>
<li><p>Create the Placement API service endpoints:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack endpoint create --region RegionOne placement public http://controller:8778</span><br><span class="line">+--------------+----------------------------------+</span><br><span class="line">| Field        | Value                            |</span><br><span class="line">+--------------+----------------------------------+</span><br><span class="line">| enabled      | True                             |</span><br><span class="line">| id           | 2b1b2637908b4137a9c2e0470487cbc0 |</span><br><span class="line">| interface    | public                           |</span><br><span class="line">| region       | RegionOne                        |</span><br><span class="line">| region_id    | RegionOne                        |</span><br><span class="line">| service_id   | 2d1a27022e6e4185b86adac4444c495f |</span><br><span class="line">| service_name | placement                        |</span><br><span class="line">| service_type | placement                        |</span><br><span class="line">| url          | http://controller:8778           |</span><br><span class="line">+--------------+----------------------------------+</span><br><span class="line"></span><br><span class="line">$ openstack endpoint create --region RegionOne placement internal http://controller:8778</span><br><span class="line">+--------------+----------------------------------+</span><br><span class="line">| Field        | Value                            |</span><br><span class="line">+--------------+----------------------------------+</span><br><span class="line">| enabled      | True                             |</span><br><span class="line">| id           | 02bcda9a150a4bd7993ff4879df971ab |</span><br><span class="line">| interface    | internal                         |</span><br><span class="line">| region       | RegionOne                        |</span><br><span class="line">| region_id    | RegionOne                        |</span><br><span class="line">| service_id   | 2d1a27022e6e4185b86adac4444c495f |</span><br><span class="line">| service_name | placement                        |</span><br><span class="line">| service_type | placement                        |</span><br><span class="line">| url          | http://controller:8778           |</span><br><span class="line">+--------------+----------------------------------+</span><br><span class="line"></span><br><span class="line">$ openstack endpoint create --region RegionOne placement admin http://controller:8778</span><br><span class="line">+--------------+----------------------------------+</span><br><span class="line">| Field        | Value                            |</span><br><span class="line">+--------------+----------------------------------+</span><br><span class="line">| enabled      | True                             |</span><br><span class="line">| id           | 3d71177b9e0f406f98cbff198d74b182 |</span><br><span class="line">| interface    | admin                            |</span><br><span class="line">| region       | RegionOne                        |</span><br><span class="line">| region_id    | RegionOne                        |</span><br><span class="line">| service_id   | 2d1a27022e6e4185b86adac4444c495f |</span><br><span class="line">| service_name | placement                        |</span><br><span class="line">| service_type | placement                        |</span><br><span class="line">| url          | http://controller:8778           |</span><br><span class="line">+--------------+----------------------------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="Install-and-configure-components-1"><a href="#Install-and-configure-components-1" class="headerlink" title="Install and configure components"></a>Install and configure components</h3></li>
</ol>
<p>Default configuration files vary by distribution. You might need to add these sections and options rather than modifying existing sections and options. Also, an ellipsis (<code>...</code>) in the configuration snippets indicates potential default configuration options that you should retain.</p>
<ol>
<li><p>Install the packages:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># apt install nova-api nova-conductor nova-consoleauth \</span></span><br><span class="line">  nova-novncproxy nova-scheduler nova-placement-api</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>Edit the <code>/etc/nova/nova.conf</code> file and complete the following actions:</p>
<ul>
<li><p>In the <code>[api_database]</code> and <code>[database]</code> sections, configure database access:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[api_database]</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">connection = mysql+pymysql://nova:NOVA_DBPASS@controller/nova_api</span><br><span class="line"></span><br><span class="line">[database]</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">connection = mysql+pymysql://nova:NOVA_DBPASS@controller/nova</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Replace <code>NOVA_DBPASS</code> with the password you chose for the Compute databases.</p>
</li>
<li><p>In the <code>[DEFAULT]</code> section, configure <code>RabbitMQ</code> message queue access:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">transport_url = rabbit://openstack:RABBIT_PASS@controller</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Replace <code>RABBIT_PASS</code> with the password you chose for the <code>openstack</code> account in <code>RabbitMQ</code>.</p>
</li>
<li><p>In the <code>[api]</code> and <code>[keystone_authtoken]</code> sections, configure Identity service access:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[api]</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">auth_strategy = keystone</span><br><span class="line"></span><br><span class="line">[keystone_authtoken]</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">auth_uri = http://controller:5000</span><br><span class="line">auth_url = http://controller:35357</span><br><span class="line">memcached_servers = controller:11211</span><br><span class="line">auth_type = password</span><br><span class="line">project_domain_name = default</span><br><span class="line">user_domain_name = default</span><br><span class="line">project_name = service</span><br><span class="line">username = nova</span><br><span class="line">password = nova</span><br></pre></td></tr></table></figure>
<p>Replace <code>nova</code> with the password you chose for the <code>nova</code> user in the Identity service.</p>
<p>Comment out or remove any other options in the <code>[keystone_authtoken]</code> section.</p>
</li>
<li><p>In the <code>[DEFAULT]</code> section, configure the <code>my_ip</code> option to use the management interface IP address of the controller node:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">my_ip = 10.20.0.10</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
<ul>
<li><p>In the <code>[DEFAULT]</code> section, enable support for the Networking service:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">use_neutron = True</span><br><span class="line">firewall_driver = nova.virt.firewall.NoopFirewallDriver</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>By default, Compute uses an internal firewall driver. Since the Networking service includes a firewall driver, you must disable the Compute firewall driver by using the <code>nova.virt.firewall.NoopFirewallDriver</code> firewall driver.</p>
</li>
</ul>
<ul>
<li><p>In the <code>[vnc]</code> section, configure the VNC proxy to use the management interface IP address of the controller node:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[vnc]</span><br><span class="line">enabled = <span class="literal">true</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">vncserver_listen = <span class="variable">$my_ip</span></span><br><span class="line">vncserver_proxyclient_address = <span class="variable">$my_ip</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>In the <code>[glance]</code> section, configure the location of the Image service API:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[glance]</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">api_servers = http://controller:9292</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>In the <code>[oslo_concurrency]</code> section, configure the lock path:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[oslo_concurrency]</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">lock_path = /var/lib/nova/tmp</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>Due to a packaging bug, remove the <code>log_dir</code> option from the <code>[DEFAULT]</code> section.</p>
</li>
</ul>
<ul>
<li><p>In the <code>[placement]</code> section, configure the Placement API:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[placement]</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">os_region_name = RegionOne</span><br><span class="line">project_domain_name = Default</span><br><span class="line">project_name = service</span><br><span class="line">auth_type = password</span><br><span class="line">user_domain_name = Default</span><br><span class="line">auth_url = http://controller:35357/v3</span><br><span class="line">username = placement</span><br><span class="line">password = PLACEMENT_PASS</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Replace <code>PLACEMENT_PASS</code> with the password you choose for the <code>placement</code> user in the Identity service. Comment out any other options in the <code>[placement]</code> section.</p>
</li>
</ul>
<ol>
<li><p>Populate the nova-api database:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># su -s /bin/sh -c &quot;nova-manage api_db sync&quot; nova</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Ignore any deprecation messages in this output.</p>
</li>
<li><p>Register the <code>cell0</code> database:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># su -s /bin/sh -c &quot;nova-manage cell_v2 map_cell0&quot; nova</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>Create the <code>cell1</code> cell:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># su -s /bin/sh -c &quot;nova-manage cell_v2 create_cell --name=cell1 --verbose&quot; nova</span></span><br><span class="line">109e1d4b-536a-40d0-83c6-5f121b82b650</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>Populate the nova database:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># su -s /bin/sh -c &quot;nova-manage db sync&quot; nova</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>Verify nova cell0 and cell1 are registered correctly:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># nova-manage cell_v2 list_cells</span></span><br><span class="line">+-------+--------------------------------------+</span><br><span class="line">| Name  | UUID                                 |</span><br><span class="line">+-------+--------------------------------------+</span><br><span class="line">| cell1 | 109e1d4b-536a-40d0-83c6-5f121b82b650 |</span><br><span class="line">| cell0 | 00000000-0000-0000-0000-000000000000 |</span><br><span class="line">+-------+--------------------------------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="Finalize-installation-1"><a href="#Finalize-installation-1" class="headerlink" title="Finalize installation"></a>Finalize installation</h3></li>
</ol>
<ul>
<li><p>Restart the Compute services:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># service nova-api restart</span></span><br><span class="line"><span class="comment"># service nova-consoleauth restart</span></span><br><span class="line"><span class="comment"># service nova-scheduler restart</span></span><br><span class="line"><span class="comment"># service nova-conductor restart</span></span><br><span class="line"><span class="comment"># service nova-novncproxy restart</span></span><br></pre></td></tr></table></figure>
<h2 id="Nova-Install-and-configure-a-compute-node"><a href="#Nova-Install-and-configure-a-compute-node" class="headerlink" title="Nova Install and configure a compute node"></a>Nova Install and configure a compute node</h2></li>
</ul>
<p>This section describes how to install and configure the Compute service on a compute node. The service supports several <a href="https://docs.openstack.org/newton/install-guide-ubuntu/common/glossary.html#term-hypervisor">hypervisors</a> to deploy <a href="https://docs.openstack.org/newton/install-guide-ubuntu/common/glossary.html#term-instance">instances</a> or <a href="https://docs.openstack.org/newton/install-guide-ubuntu/common/glossary.html#term-virtual-machine-vm">VMs</a>. For simplicity, this configuration uses the <a href="https://docs.openstack.org/newton/install-guide-ubuntu/common/glossary.html#term-quick-emulator-qemu">QEMU</a> hyper visor with the <a href="https://docs.openstack.org/newton/install-guide-ubuntu/common/glossary.html#term-kernel-based-vm-kvm">KVM</a> extension on compute nodes that support hardware acceleration for virtual machines. </p>
<h3 id="Install-and-configure-components-2"><a href="#Install-and-configure-components-2" class="headerlink" title="Install and configure components"></a>Install and configure components</h3><ol>
<li><p>Install the packages:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># apt install nova-compute</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Edit the <code>/etc/nova/nova.conf</code> file and complete the following actions:</p>
<ul>
<li><p>In the <code>[DEFAULT]</code> section, configure <code>RabbitMQ</code> message queue access:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line">...</span><br><span class="line">transport_url = rabbit://openstack:RABBIT_PASS@controller</span><br></pre></td></tr></table></figure>
<p>Replace <code>RABBIT_PASS</code> with the password you chose for the <code>openstack</code> account in <code>RabbitMQ</code>.</p>
</li>
<li><p>In the <code>[DEFAULT]</code> and <code>[keystone_authtoken]</code> sections, configure Identity service access:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line">...</span><br><span class="line">auth_strategy = keystone</span><br><span class="line"></span><br><span class="line">[keystone_authtoken]</span><br><span class="line">...</span><br><span class="line">auth_uri = http://controller:5000</span><br><span class="line">auth_url = http://controller:35357</span><br><span class="line">memcached_servers = controller:11211</span><br><span class="line">auth_type = password</span><br><span class="line">project_domain_name = Default</span><br><span class="line">user_domain_name = Default</span><br><span class="line">project_name = service</span><br><span class="line">username = nova</span><br><span class="line">password = nova</span><br></pre></td></tr></table></figure>
<p>Replace <code>password = nova</code> with the password you chose for the <code>nova</code> user in the Identity service.</p>
<p>Comment out or remove any other options in the <code>[keystone_authtoken]</code> section.</p>
</li>
</ul>
</li>
</ol>
<ul>
<li><p> In the <code>[DEFAULT]</code> section, configure the <code>my_ip</code> option:</p>
   <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line">...</span><br><span class="line">my_ip = MANAGEMENT_INTERFACE_IP_ADDRESS</span><br></pre></td></tr></table></figure>
<p>   Replace <code>MANAGEMENT_INTERFACE_IP_ADDRESS</code> with the IP address of the management network interface on your compute node, typically 10.0.0.31 for the first node in the <a href="https://docs.openstack.org/newton/install-guide-ubuntu/overview.html#overview-example-architectures">example architecture</a>.</p>
<blockquote>
<p> here our compute is 10.20.0.20</p>
</blockquote>
</li>
<li><p> In the <code>[DEFAULT]</code> section, enable support for the Networking service:</p>
<pre><code>     <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line">...</span><br><span class="line">use_neutron &#x3D; True</span><br><span class="line">firewall_driver &#x3D; nova.virt.firewall.NoopFirewallDriver</span><br></pre></td></tr></table></figure>

     By default, Compute uses an internal firewall service. Since Networking includes a firewall service, you must disable the Compute firewall service by using the `nova.virt.firewall.NoopFirewallDriver` firewall driver.</code></pre>
</li>
</ul>
<ul>
<li><p>In the <code>[vnc]</code> section, enable and configure remote console access:</p>
   <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[vnc]</span><br><span class="line">...</span><br><span class="line">enabled = True</span><br><span class="line">vncserver_listen = 0.0.0.0</span><br><span class="line">vncserver_proxyclient_address = <span class="variable">$my_ip</span></span><br><span class="line">novncproxy_base_url = http://controller:6080/vnc_auto.html</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>   The server component listens on all IP addresses and the proxy component only listens on the management interface IP address of the compute node. </p>
<p>   The base URL indicates the location where you can use a web browser to access remote consoles of instances on this compute node.</p>
<p>   If the web browser to access remote consoles resides on a host that cannot resolve the <code>controller</code> hostname, you must replace <code>controller</code> with the management interface IP address of the controller node.</p>
</li>
<li><p>In the <code>[glance]</code> section, configure the location of the Image service API:</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[glance]</span><br><span class="line">...</span><br><span class="line">api_servers = http://controller:9292</span><br><span class="line">​```</span><br></pre></td></tr></table></figure></li>
<li><p>In the <code>[oslo_concurrency]</code> section, configure the lock path:</p>
   <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[oslo_concurrency]</span><br><span class="line">...</span><br><span class="line">lock_path = /var/lib/nova/tmp</span><br></pre></td></tr></table></figure>
</li>
<li><p>Due to a packaging bug, remove the <code>log-dir</code> option from the <code>[DEFAULT]</code> section.</p>
</li>
<li><p>In the <code>[placement]</code> section, configure the Placement API:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[placement]</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">os_region_name = RegionOne</span><br><span class="line">project_domain_name = Default</span><br><span class="line">project_name = service</span><br><span class="line">auth_type = password</span><br><span class="line">user_domain_name = Default</span><br><span class="line">auth_url = http://controller:35357/v3</span><br><span class="line">username = placement</span><br><span class="line">password = placement</span><br><span class="line">​```</span><br><span class="line"></span><br><span class="line">Replace `placement` with the password you choose <span class="keyword">for</span> the `placement` user <span class="keyword">in</span> the Identity service. Comment out any other options <span class="keyword">in</span> the `[placement]` section.</span><br></pre></td></tr></table></figure>


</li>
</ul>
<h3 id="Finalize-installation-2"><a href="#Finalize-installation-2" class="headerlink" title="Finalize installation"></a>Finalize installation</h3><p>Determine whether your compute node supports hardware acceleration for virtual machines:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ egrep -c <span class="string">&#x27;(vmx|svm)&#x27;</span> /proc/cpuinfo</span><br></pre></td></tr></table></figure>
<p>If this command returns a value of <code>one or greater</code>, your compute node supports hardware acceleration which typically requires no additional configuration.</p>
<p>If this command returns a value of <code>zero</code>, your compute node does not support hardware acceleration and you must configure <code>libvirt</code> to use QEMU instead of KVM.</p>
<ul>
<li><p>Edit the <code>[libvirt]</code> section in the <code>/etc/nova/nova-compute.conf</code> file as follows:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[libvirt]</span><br><span class="line">...</span><br><span class="line">virt_type = qemu</span><br></pre></td></tr></table></figure>
<p>Restart the Compute service:</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># service nova-compute restart</span></span><br></pre></td></tr></table></figure>
<h3 id="Add-the-compute-node-to-the-cell-database"><a href="#Add-the-compute-node-to-the-cell-database" class="headerlink" title="Add the compute node to the cell database"></a>Add the compute node to the cell database</h3><p>Run the following commands on the <strong>controller</strong> node.</p>
<ol>
<li><p>Source the admin credentials to enable admin-only CLI commands, then confirm there are compute hosts in the database:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ . admin-openrc</span><br><span class="line"></span><br><span class="line">$ openstack hypervisor list</span><br><span class="line">+----+---------------------+-----------------+-----------+-------+</span><br><span class="line">| ID | Hypervisor Hostname | Hypervisor Type | Host IP   | State |</span><br><span class="line">+----+---------------------+-----------------+-----------+-------+</span><br><span class="line">|  1 | compute1            | QEMU            | 10.0.0.31 | up    |</span><br><span class="line">+----+---------------------+-----------------+-----------+-------+</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>Discover compute hosts:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># su -s /bin/sh -c &quot;nova-manage cell_v2 discover_hosts --verbose&quot; nova</span></span><br><span class="line"></span><br><span class="line">Found 2 cell mappings.</span><br><span class="line">Skipping cell0 since it does not contain hosts.</span><br><span class="line">Getting compute nodes from cell <span class="string">&#x27;cell1&#x27;</span>: ad5a5985-a719-4567-98d8-8d148aaae4bc</span><br><span class="line">Found 1 computes <span class="keyword">in</span> cell: ad5a5985-a719-4567-98d8-8d148aaae4bc</span><br><span class="line">Checking host mapping <span class="keyword">for</span> compute host <span class="string">&#x27;compute&#x27;</span>: fe58ddc1-1d65-4f87-9456-bc040dc106b3</span><br><span class="line">Creating host mapping <span class="keyword">for</span> compute host <span class="string">&#x27;compute&#x27;</span>: fe58ddc1-1d65-4f87-9456-bc040dc106b3</span><br></pre></td></tr></table></figure>


</li>
</ol>
<p>   When you add new compute nodes, you must run <code>nova-manage cell_v2 discover_hosts</code> on the controller node to register those new compute nodes. Alternatively, you can set an appropriate interval in <code>/etc/nova/nova.conf</code>:</p>
   <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[scheduler]</span><br><span class="line">discover_hosts_in_cells_interval = 300</span><br></pre></td></tr></table></figure>
<h2 id="Neutron-installation"><a href="#Neutron-installation" class="headerlink" title="Neutron installation"></a>Neutron installation</h2><blockquote>
<p>ref: <a href="https://docs.openstack.org/newton/install-guide-ubuntu/neutron.html">https://docs.openstack.org/newton/install-guide-ubuntu/neutron.html</a></p>
</blockquote>
<p>This chapter explains how to install and configure the Networking service (neutron) using the <a href="https://docs.openstack.org/newton/install-guide-ubuntu/overview.html#network1">provider networks</a>. </p>
<p>For more information about the Networking service including virtual networking components, layout, and traffic flows, see the <a href="http://docs.openstack.org/newton/networking-guide/">OpenStack Networking Guide</a>.</p>
<h2 id="Tenant-Project-network-configuration"><a href="#Tenant-Project-network-configuration" class="headerlink" title="Tenant/Project network configuration"></a>Tenant/Project network configuration</h2><p>On both Controller and Compute node, Tenant/Project network (eth1 in our design) need to be configured:</p>
<p><code># vi /etc/network/interfaces</code></p>
<p>Add below lines accordingly:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">## provider network</span></span><br><span class="line">auto enp0s8</span><br><span class="line">iface enp0s8 inet static</span><br><span class="line">address 172.16.0.x (10 <span class="keyword">for</span> controller 20 <span class="keyword">for</span> compute)</span><br><span class="line">netmask 255.255.255.0</span><br></pre></td></tr></table></figure>
<h2 id="Neutron-Install-and-configure-controller-node"><a href="#Neutron-Install-and-configure-controller-node" class="headerlink" title="Neutron Install and configure controller node"></a>Neutron Install and configure controller node</h2><h3 id="Prerequisites-2"><a href="#Prerequisites-2" class="headerlink" title="Prerequisites"></a>Prerequisites</h3><p>Before you configure the OpenStack Networking (neutron) service, you must create a database, service credentials, and API endpoints.</p>
<ol>
<li><p>To create the database, complete these steps:</p>
<ul>
<li><p>Use the database access client to connect to the database server as the <code>root</code> user:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mysql -u root -p</span><br></pre></td></tr></table></figure></li>
<li><p>Create the <code>neutron</code> database:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; CREATE DATABASE neutron;</span><br></pre></td></tr></table></figure></li>
<li><p>Grant proper access to the <code>neutron</code> database, replacing <code>NEUTRON_DBPASS</code> with a suitable password:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; GRANT ALL PRIVILEGES ON neutron.* TO &#39;neutron&#39;@&#39;localhost&#39; \</span><br><span class="line">  IDENTIFIED BY &#39;NEUTRON_DBPASS&#39;;</span><br><span class="line">mysql&gt; GRANT ALL PRIVILEGES ON neutron.* TO &#39;neutron&#39;@&#39;%&#39; \</span><br><span class="line">  IDENTIFIED BY &#39;NEUTRON_DBPASS&#39;;</span><br></pre></td></tr></table></figure></li>
<li><p>Exit the database access client.</p>
</li>
</ul>
</li>
<li><p>Source the <code>admin</code> credentials to gain access to admin-only CLI commands:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ . admin-openrc</span><br></pre></td></tr></table></figure></li>
<li><p>To create the service credentials, complete these steps:</p>
<ul>
<li><p>Create the <code>neutron</code> user:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack user create --domain default --password-prompt neutron</span><br><span class="line"></span><br><span class="line">User Password:</span><br><span class="line">Repeat User Password:</span><br><span class="line">+---------------------+----------------------------------+</span><br><span class="line">| Field               | Value                            |</span><br><span class="line">+---------------------+----------------------------------+</span><br><span class="line">| domain_id           | default                          |</span><br><span class="line">| enabled             | True                             |</span><br><span class="line">| id                  | 319f34694728440eb8ffcb27b6dd8b8a |</span><br><span class="line">| name                | neutron                          |</span><br><span class="line">| password_expires_at | None                             |</span><br><span class="line">+---------------------+----------------------------------+</span><br></pre></td></tr></table></figure></li>
<li><p>Add the <code>admin</code> role to the <code>neutron</code> user:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack role add --project service --user neutron admin</span><br></pre></td></tr></table></figure>
<p>This command provides no output.</p>
</li>
<li><p>Create the <code>neutron</code> service entity:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack service create --name neutron \</span><br><span class="line">  --description <span class="string">&quot;OpenStack Networking&quot;</span> network</span><br><span class="line"></span><br><span class="line">+-------------+----------------------------------+</span><br><span class="line">| Field       | Value                            |</span><br><span class="line">+-------------+----------------------------------+</span><br><span class="line">| description | OpenStack Networking             |</span><br><span class="line">| enabled     | True                             |</span><br><span class="line">| id          | f71529314dab4a4d8eca427e701d209e |</span><br><span class="line">| name        | neutron                          |</span><br><span class="line">| <span class="built_in">type</span>        | network                          |</span><br><span class="line">+-------------+----------------------------------+</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>Create the Networking service API endpoints:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack endpoint create --region RegionOne \</span><br><span class="line">  network public http://controller:9696</span><br><span class="line"></span><br><span class="line">+--------------+----------------------------------+</span><br><span class="line">| Field        | Value                            |</span><br><span class="line">+--------------+----------------------------------+</span><br><span class="line">| enabled      | True                             |</span><br><span class="line">| id           | 85d80a6d02fc4b7683f611d7fc1493a3 |</span><br><span class="line">| interface    | public                           |</span><br><span class="line">| region       | RegionOne                        |</span><br><span class="line">| region_id    | RegionOne                        |</span><br><span class="line">| service_id   | f71529314dab4a4d8eca427e701d209e |</span><br><span class="line">| service_name | neutron                          |</span><br><span class="line">| service_type | network                          |</span><br><span class="line">| url          | http://controller:9696           |</span><br><span class="line">+--------------+----------------------------------+</span><br><span class="line"></span><br><span class="line">$ openstack endpoint create --region RegionOne \</span><br><span class="line">  network internal http://controller:9696</span><br><span class="line"></span><br><span class="line">+--------------+----------------------------------+</span><br><span class="line">| Field        | Value                            |</span><br><span class="line">+--------------+----------------------------------+</span><br><span class="line">| enabled      | True                             |</span><br><span class="line">| id           | 09753b537ac74422a68d2d791cf3714f |</span><br><span class="line">| interface    | internal                         |</span><br><span class="line">| region       | RegionOne                        |</span><br><span class="line">| region_id    | RegionOne                        |</span><br><span class="line">| service_id   | f71529314dab4a4d8eca427e701d209e |</span><br><span class="line">| service_name | neutron                          |</span><br><span class="line">| service_type | network                          |</span><br><span class="line">| url          | http://controller:9696           |</span><br><span class="line">+--------------+----------------------------------+</span><br><span class="line"></span><br><span class="line">$ openstack endpoint create --region RegionOne \</span><br><span class="line">  network admin http://controller:9696</span><br><span class="line"></span><br><span class="line">+--------------+----------------------------------+</span><br><span class="line">| Field        | Value                            |</span><br><span class="line">+--------------+----------------------------------+</span><br><span class="line">| enabled      | True                             |</span><br><span class="line">| id           | 1ee14289c9374dffb5db92a5c112fc4e |</span><br><span class="line">| interface    | admin                            |</span><br><span class="line">| region       | RegionOne                        |</span><br><span class="line">| region_id    | RegionOne                        |</span><br><span class="line">| service_id   | f71529314dab4a4d8eca427e701d209e |</span><br><span class="line">| service_name | neutron                          |</span><br><span class="line">| service_type | network                          |</span><br><span class="line">| url          | http://controller:9696           |</span><br><span class="line">+--------------+----------------------------------+</span><br></pre></td></tr></table></figure>
<h3 id="Configure-networking-options"><a href="#Configure-networking-options" class="headerlink" title="Configure networking options"></a>Configure networking options</h3></li>
</ol>
<p>You can deploy the Networking service using one of two architectures represented by options 1 and 2.</p>
<p>Option 1 deploys the simplest possible architecture that only supports attaching instances to provider (external) networks. No self-service (private) networks, routers, or floating IP addresses. Only the <code>admin</code> or other privileged user can manage provider networks.</p>
<ul>
<li><a href="https://docs.openstack.org/newton/install-guide-ubuntu/neutron-controller-install-option1.html">Networking Option 1: Provider networks</a></li>
</ul>
<p>Here we choose Option 1.</p>
<h3 id="Networking-Option-1-Provider-networks"><a href="#Networking-Option-1-Provider-networks" class="headerlink" title="Networking Option 1: Provider networks"></a>Networking Option 1: Provider networks</h3><p>Install and configure the Networking components on the <em>controller</em> node.</p>
<h3 id="Install-the-components"><a href="#Install-the-components" class="headerlink" title="Install the components"></a>Install the components</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># apt install neutron-server neutron-plugin-ml2 \</span></span><br><span class="line">  neutron-linuxbridge-agent neutron-dhcp-agent \</span><br><span class="line">  neutron-metadata-agent -y</span><br></pre></td></tr></table></figure>
<h3 id="Configure-the-server-component"><a href="#Configure-the-server-component" class="headerlink" title="Configure the server component"></a>Configure the server component</h3><p>The Networking server component configuration includes the database, authentication mechanism, message queue, topology change notifications, and plug-in.</p>
<ul>
<li><p>Edit the <code>/etc/neutron/neutron.conf</code> file and complete the following actions:</p>
<ul>
<li><p>In the <code>[database]</code> section, configure database access:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[database]</span><br><span class="line">...</span><br><span class="line">connection = mysql+pymysql://neutron:NEUTRON_DBPASS@controller/neutron</span><br></pre></td></tr></table></figure>
<p>Replace <code>NEUTRON_DBPASS</code> with the password you chose for the database.</p>
<p>Comment out or remove any other <code>connection</code> options in the <code>[database]</code> section.</p>
</li>
<li><p>In the <code>[DEFAULT]</code> section, enable the Modular Layer 2 (ML2) plug-in and disable additional plug-ins:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line">...</span><br><span class="line">core_plugin = ml2</span><br><span class="line">service_plugins =</span><br></pre></td></tr></table></figure></li>
<li><p>In the <code>[DEFAULT]</code> section, configure <code>RabbitMQ</code> message queue access:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line">...</span><br><span class="line">transport_url = rabbit://openstack:RABBIT_PASS@controller</span><br></pre></td></tr></table></figure>
<p>Replace <code>RABBIT_PASS</code> with the password you chose for the <code>openstack</code> account in RabbitMQ.</p>
</li>
<li><p>In the <code>[DEFAULT]</code> and <code>[keystone_authtoken]</code> sections, configure Identity service access:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line">...</span><br><span class="line">auth_strategy = keystone</span><br><span class="line"></span><br><span class="line">[keystone_authtoken]</span><br><span class="line">...</span><br><span class="line">auth_uri = http://controller:5000</span><br><span class="line">auth_url = http://controller:35357</span><br><span class="line">memcached_servers = controller:11211</span><br><span class="line">auth_type = password</span><br><span class="line">project_domain_name = Default</span><br><span class="line">user_domain_name = Default</span><br><span class="line">project_name = service</span><br><span class="line">username = neutron</span><br><span class="line">password = neutron</span><br></pre></td></tr></table></figure>
<p>Replace <code>password = neutron</code> with the password you chose for the <code>neutron</code> user in the Identity service.</p>
<p>Comment out or remove any other options in the <code>[keystone_authtoken]</code> section.</p>
</li>
<li><p>In the <code>[DEFAULT]</code> and <code>[nova]</code> sections, configure Networking to notify Compute of network topology changes:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line">...</span><br><span class="line">notify_nova_on_port_status_changes = True</span><br><span class="line">notify_nova_on_port_data_changes = True</span><br><span class="line"></span><br><span class="line">[nova]</span><br><span class="line">...</span><br><span class="line">auth_url = http://controller:35357</span><br><span class="line">auth_type = password</span><br><span class="line">project_domain_name = Default</span><br><span class="line">user_domain_name = Default</span><br><span class="line">region_name = RegionOne</span><br><span class="line">project_name = service</span><br><span class="line">username = nova</span><br><span class="line">password = nova</span><br></pre></td></tr></table></figure>
<p>Replace <code>password = nova</code> with the password you chose for the <code>nova</code> user in the Identity service.</p>
</li>
</ul>
</li>
</ul>
<h3 id="Configure-the-Modular-Layer-2-ML2-plug-in"><a href="#Configure-the-Modular-Layer-2-ML2-plug-in" class="headerlink" title="Configure the Modular Layer 2 (ML2) plug-in"></a>Configure the Modular Layer 2 (ML2) plug-in</h3><p>The ML2 plug-in uses the Linux bridge mechanism to build layer-2 (bridging and switching) virtual networking infrastructure for instances.</p>
<ul>
<li><p>Edit the <code>/etc/neutron/plugins/ml2/ml2_conf.ini</code> file and complete the following actions:</p>
<ul>
<li><p>In the <code>[ml2]</code> section, enable flat and VLAN networks:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[ml2]</span><br><span class="line">...</span><br><span class="line">type_drivers = flat,vlan</span><br></pre></td></tr></table></figure></li>
<li><p>In the <code>[ml2]</code> section, disable self-service networks:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[ml2]</span><br><span class="line">...</span><br><span class="line">tenant_network_types =</span><br><span class="line"></span><br><span class="line">​```bash</span><br></pre></td></tr></table></figure></li>
<li><p>In the <code>[ml2]</code> section, enable the Linux bridge mechanism:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[ml2]</span><br><span class="line">...</span><br><span class="line">mechanism_drivers = linuxbridge</span><br></pre></td></tr></table></figure>
<p>After you configure the ML2 plug-in, removing values in the <code>type_drivers</code> option can lead to database inconsistency.</p>
</li>
<li><p>In the <code>[ml2]</code> section, enable the port security extension driver:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[ml2]</span><br><span class="line">...</span><br><span class="line">extension_drivers = port_security</span><br></pre></td></tr></table></figure></li>
<li><p>In the <code>[ml2_type_flat]</code> section, configure the provider virtual network as a flat network:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[ml2_type_flat]</span><br><span class="line">...</span><br><span class="line">flat_networks = provider</span><br><span class="line"></span><br><span class="line">​```bash</span><br></pre></td></tr></table></figure></li>
<li><p>In the <code>[securitygroup]</code> section, enable <a href="https://docs.openstack.org/newton/install-guide-ubuntu/common/glossary.html#term-ipset">ipset</a> to increase efficiency of security group rules:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[securitygroup]</span><br><span class="line">...</span><br><span class="line">enable_ipset = True</span><br></pre></td></tr></table></figure>
<h3 id="Configure-the-Linux-bridge-agent"><a href="#Configure-the-Linux-bridge-agent" class="headerlink" title="Configure the Linux bridge agent"></a>Configure the Linux bridge agent</h3></li>
</ul>
</li>
</ul>
<p>The Linux bridge agent builds layer-2 (bridging and switching) virtual networking infrastructure for instances and handles security groups.</p>
<ul>
<li><p>Edit the <code>/etc/neutron/plugins/ml2/linuxbridge_</code> file and complete the following actions:</p>
<ul>
<li><p>In the <code>[linux_bridge]</code> section, map the provider virtual network to the provider physical network interface:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[linux_bridge]</span><br><span class="line">physical_interface_mappings = provider:PROVIDER_INTERFACE_NAME</span><br></pre></td></tr></table></figure>
<p>Replace <code>PROVIDER_INTERFACE_NAME</code> with the name of the underlying provider physical network interface. See <a href="https://docs.openstack.org/newton/install-guide-ubuntu/environment-networking.html#environment-networking">Host networking</a> for more information.</p>
<p>in our case it is: enp0s10, the bridged nic of controller network.</p>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>In the <code>[vxlan]</code> section, disable VXLAN overlay networks:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[vxlan]</span><br><span class="line">enable_vxlan = False</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>In the <code>[securitygroup]</code> section, enable security groups and configure the Linux bridge <a href="https://docs.openstack.org/newton/install-guide-ubuntu/common/glossary.html#term-iptables">iptables</a> firewall driver:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[securitygroup]</span><br><span class="line">...</span><br><span class="line">enable_security_group = True</span><br><span class="line">firewall_driver = neutron.agent.linux.iptables_firewall.IptablesFirewallDriver</span><br></pre></td></tr></table></figure>
<h3 id="Configure-the-DHCP-agent"><a href="#Configure-the-DHCP-agent" class="headerlink" title="Configure the DHCP agent"></a>Configure the DHCP agent</h3></li>
</ul>
<p>The <a href="https://docs.openstack.org/newton/install-guide-ubuntu/common/glossary.html#term-dhcp-agent">DHCP agent</a> provides DHCP services for virtual networks.</p>
<ul>
<li><p>Edit the <code>/etc/neutron/dhcp_agent.ini</code> file and complete the following actions:</p>
<ul>
<li><p>In the <code>[DEFAULT]</code> section, configure the Linux bridge interface driver, Dnsmasq DHCP driver, and enable isolated metadata so instances on provider networks can access metadata over the network:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line">...</span><br><span class="line">interface_driver = neutron.agent.linux.interface.BridgeInterfaceDriver</span><br><span class="line">dhcp_driver = neutron.agent.linux.dhcp.Dnsmasq</span><br><span class="line">enable_isolated_metadata = True</span><br></pre></td></tr></table></figure>
<p>Return to <a href="https://docs.openstack.org/newton/install-guide-ubuntu/neutron-controller-install.html#neutron-controller-metadata-agent">Networking controller node configuration</a>.</p>
</li>
</ul>
</li>
</ul>
<h3 id="Configure-the-metadata-agent"><a href="#Configure-the-metadata-agent" class="headerlink" title="Configure the metadata agent"></a>Configure the metadata agent</h3><p>The <a href="https://docs.openstack.org/newton/install-guide-ubuntu/common/glossary.html#term-metadata-agent">metadata agent</a> provides configuration information such as credentials to instances.</p>
<ul>
<li><p>Edit the <code>/etc/neutron/metadata_agent.ini</code> file and complete the following actions:</p>
<ul>
<li><p>In the <code>[DEFAULT]</code> section, configure the metadata host and shared secret:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line">...</span><br><span class="line">nova_metadata_ip = controller</span><br><span class="line">metadata_proxy_shared_secret = METADATA_SECRET</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Replace <code>METADATA_SECRET</code> with a suitable secret for the metadata proxy.</p>
</li>
</ul>
</li>
</ul>
<h3 id="Configure-the-Compute-service-to-use-the-Networking-service"><a href="#Configure-the-Compute-service-to-use-the-Networking-service" class="headerlink" title="Configure the Compute service to use the Networking service"></a>Configure the Compute service to use the Networking service</h3><ul>
<li><p>Edit the <code>/etc/nova/nova.conf</code> file and perform the following actions:</p>
<ul>
<li><p>In the <code>[neutron]</code> section, configure access parameters, enable the metadata proxy, and configure the secret:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[neutron]</span><br><span class="line">...</span><br><span class="line">url = http://controller:9696</span><br><span class="line">auth_url = http://controller:35357</span><br><span class="line">auth_type = password</span><br><span class="line">project_domain_name = Default</span><br><span class="line">user_domain_name = Default</span><br><span class="line">region_name = RegionOne</span><br><span class="line">project_name = service</span><br><span class="line">username = neutron</span><br><span class="line">password = neutron</span><br><span class="line">service_metadata_proxy = True</span><br><span class="line">metadata_proxy_shared_secret = METADATA_SECRET</span><br></pre></td></tr></table></figure>
<p>Replace <code>password = neutron</code> with the password you chose for the <code>neutron</code> user in the Identity service.</p>
<p>Replace <code>METADATA_SECRET</code> with the secret you chose for the metadata proxy.</p>
</li>
</ul>
</li>
</ul>
<h3 id="Finalize-installation-3"><a href="#Finalize-installation-3" class="headerlink" title="Finalize installation"></a>Finalize installation</h3><ol>
<li><p>Populate the database:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># su -s /bin/sh -c &quot;neutron-db-manage --config-file /etc/neutron/neutron.conf \</span></span><br><span class="line">  --config-file /etc/neutron/plugins/ml2/ml2_conf.ini upgrade head<span class="string">&quot; neutron</span></span><br></pre></td></tr></table></figure>
<p>Database population occurs later for Networking because the script requires complete server and plug-in configuration files.</p>
</li>
<li><p>Restart the Compute API service:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># service nova-api restart</span></span><br></pre></td></tr></table></figure></li>
<li><p>Restart the Networking services.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># service neutron-server restart</span></span><br><span class="line"><span class="comment"># service neutron-linuxbridge-agent restart</span></span><br><span class="line"><span class="comment"># service neutron-dhcp-agent restart</span></span><br><span class="line"><span class="comment"># service neutron-metadata-agent restart</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="Verify-operation-2"><a href="#Verify-operation-2" class="headerlink" title="Verify operation"></a>Verify operation</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@controller:~<span class="comment"># openstack network agent list --max-width 50</span></span><br><span class="line">+----------+------------+----------+-------------------+-------+-------+----------+</span><br><span class="line">| ID       | Agent Type | Host     | Availability Zone | Alive | State | Binary   |</span><br><span class="line">+----------+------------+----------+-------------------+-------+-------+----------+</span><br><span class="line">| 1d661145 | Linux      | controll | None              | True  | UP    | neutron- |</span><br><span class="line">| -0941    | bridge     | er       |                   |       |       | linuxbri |</span><br><span class="line">| -411d-9b | agent      |          |                   |       |       | dge-     |</span><br><span class="line">| 18-b3371 |            |          |                   |       |       | agent    |</span><br><span class="line">| fe57c4b  |            |          |                   |       |       |          |</span><br><span class="line">| 7502e1a3 | DHCP agent | controll | nova              | True  | UP    | neutron- |</span><br><span class="line">| -998d-   |            | er       |                   |       |       | dhcp-    |</span><br><span class="line">| 4aca-91e |            |          |                   |       |       | agent    |</span><br><span class="line">| 4-ca17e1 |            |          |                   |       |       |          |</span><br><span class="line">| b10c82   |            |          |                   |       |       |          |</span><br><span class="line">| 7c47ac70 | Metadata   | controll | None              | True  | UP    | neutron- |</span><br><span class="line">| -5de2-44 | agent      | er       |                   |       |       | metadata |</span><br><span class="line">| 42-8fc1- |            |          |                   |       |       | -agent   |</span><br><span class="line">| 91fe97ae |            |          |                   |       |       |          |</span><br><span class="line">| 120f     |            |          |                   |       |       |          |</span><br><span class="line">+----------+------------+----------+-------------------+-------+-------+----------+</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="Neutron-Install-and-configure-compute-node"><a href="#Neutron-Install-and-configure-compute-node" class="headerlink" title="Neutron Install and configure compute node"></a>Neutron Install and configure compute node</h2><p>The compute node handles connectivity and <a href="https://docs.openstack.org/newton/install-guide-ubuntu/common/glossary.html#term-security-group">security groups</a> for instances.</p>
<h3 id="Install-the-components-1"><a href="#Install-the-components-1" class="headerlink" title="Install the components"></a>Install the components</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># apt install neutron-linuxbridge-agent -y</span></span><br></pre></td></tr></table></figure>
<h3 id="Configure-the-common-component"><a href="#Configure-the-common-component" class="headerlink" title="Configure the common component"></a>Configure the common component</h3><p>The Networking common component configuration includes the authentication mechanism, message queue, and plug-in.</p>
<ul>
<li><p>Edit the <code>/etc/neutron/neutron.conf</code> file and complete the following actions:</p>
<ul>
<li><p>In the <code>[database]</code> section, comment out any <code>connection</code> options because compute nodes do not directly access the database.</p>
</li>
<li><p>In the <code>[DEFAULT]</code> section, configure <code>RabbitMQ</code> message queue access:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line">...</span><br><span class="line">transport_url = rabbit://openstack:RABBIT_PASS@controller</span><br></pre></td></tr></table></figure>
<p>Replace <code>RABBIT_PASS</code> with the password you chose for the <code>openstack</code> account in RabbitMQ.</p>
</li>
<li><p>In the <code>[DEFAULT]</code> and <code>[keystone_authtoken]</code> sections, configure Identity service access:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line">...</span><br><span class="line">auth_strategy = keystone</span><br><span class="line"></span><br><span class="line">[keystone_authtoken]</span><br><span class="line">...</span><br><span class="line">auth_uri = http://controller:5000</span><br><span class="line">auth_url = http://controller:35357</span><br><span class="line">memcached_servers = controller:11211</span><br><span class="line">auth_type = password</span><br><span class="line">project_domain_name = Default</span><br><span class="line">user_domain_name = Default</span><br><span class="line">project_name = service</span><br><span class="line">username = neutron</span><br><span class="line">password = neutron</span><br></pre></td></tr></table></figure>
<p>Replace <code>password = neutron</code> with the password you chose for the <code>neutron</code> user in the Identity service.</p>
<p>Comment out or remove any other options in the <code>[keystone_authtoken]</code> section.</p>
</li>
</ul>
</li>
</ul>
<h3 id="Configure-networking-options-1"><a href="#Configure-networking-options-1" class="headerlink" title="Configure networking options"></a>Configure networking options</h3><p>Choose the same networking option that you chose for the controller node to configure services specific to it. Afterwards, return here and proceed to <a href="https://docs.openstack.org/newton/install-guide-ubuntu/neutron-compute-install.html#neutron-compute-compute">Configure the Compute service to use the Networking service</a>.</p>
<ul>
<li><a href="https://docs.openstack.org/newton/install-guide-ubuntu/neutron-compute-install-option1.html">Networking Option 1: Provider networks</a></li>
</ul>
<h3 id="Configure-the-Linux-bridge-agent-1"><a href="#Configure-the-Linux-bridge-agent-1" class="headerlink" title="Configure the Linux bridge agent"></a>Configure the Linux bridge agent</h3><p>The Linux bridge agent builds layer-2 (bridging and switching) virtual networking infrastructure for instances and handles security groups.</p>
<ul>
<li><p>Edit the <code>/etc/neutron/plugins/ml2/linuxbridge_agent.ini</code> file and complete the following actions:</p>
<ul>
<li><p>In the <code>[linux_bridge]</code> section, map the provider virtual network to the provider physical network interface:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[linux_bridge]</span><br><span class="line">physical_interface_mappings = provider:PROVIDER_INTERFACE_NAME</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Replace <code>PROVIDER_INTERFACE_NAME</code> with the name of the underlying provider physical network interface. See <a href="https://docs.openstack.org/newton/install-guide-ubuntu/environment-networking.html#environment-networking">Host networking</a> for more information.</p>
</li>
<li><p>In the <code>[vxlan]</code> section, disable VXLAN overlay networks:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[vxlan]</span><br><span class="line">enable_vxlan = False</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>In the <code>[securitygroup]</code> section, enable security groups and configure the Linux bridge <a href="https://docs.openstack.org/newton/install-guide-ubuntu/common/glossary.html#term-iptables">iptables</a> firewall driver:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[securitygroup]</span><br><span class="line">...</span><br><span class="line">enable_security_group = True</span><br><span class="line">firewall_driver = neutron.agent.linux.iptables_firewall.IptablesFirewallDriver</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Return to <a href="https://docs.openstack.org/newton/install-guide-ubuntu/neutron-compute-install.html#neutron-compute-compute">Networking compute node configuration</a>.</p>
</li>
</ul>
</li>
</ul>
<h3 id="Configure-the-Compute-service-to-use-the-Networking-service-1"><a href="#Configure-the-Compute-service-to-use-the-Networking-service-1" class="headerlink" title="Configure the Compute service to use the Networking service"></a>Configure the Compute service to use the Networking service</h3><ul>
<li><p>Edit the <code>/etc/nova/nova.conf</code> file and complete the following actions:</p>
<ul>
<li><p>In the <code>[neutron]</code> section, configure access parameters:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[neutron]</span><br><span class="line">...</span><br><span class="line">url = http://controller:9696</span><br><span class="line">auth_url = http://controller:35357</span><br><span class="line">auth_type = password</span><br><span class="line">project_domain_name = Default</span><br><span class="line">user_domain_name = Default</span><br><span class="line">region_name = RegionOne</span><br><span class="line">project_name = service</span><br><span class="line">username = neutron</span><br><span class="line">password = neutron</span><br></pre></td></tr></table></figure>
<p>Replace <code>password = neutron</code> with the password you chose for the <code>neutron</code> user in the Identity service.</p>
</li>
</ul>
</li>
</ul>
<h3 id="Finalize-installation-4"><a href="#Finalize-installation-4" class="headerlink" title="Finalize installation"></a>Finalize installation</h3><ol>
<li><p>Restart the Compute service:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># service nova-compute restart</span></span><br></pre></td></tr></table></figure></li>
<li><p>Restart the Linux bridge agent:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># service neutron-linuxbridge-agent restart</span></span><br></pre></td></tr></table></figure>
<h3 id="Verify-operation-3"><a href="#Verify-operation-3" class="headerlink" title="Verify operation"></a>Verify operation</h3></li>
</ol>
<p>Perform these commands on the controller node.</p>
<ol>
<li><p>Source the <code>admin</code> credentials to gain access to admin-only CLI commands:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ . admin-openrc</span><br></pre></td></tr></table></figure></li>
<li><p>List loaded extensions to verify successful launch of the <code>neutron-server</code> process:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ neutron ext-list</span><br><span class="line"></span><br><span class="line">+---------------------------+-----------------------------------------------+</span><br><span class="line">| <span class="built_in">alias</span>                     | name                                          |</span><br><span class="line">+---------------------------+-----------------------------------------------+</span><br><span class="line">| default-subnetpools       | Default Subnetpools                           |</span><br><span class="line">| network-ip-availability   | Network IP Availability                       |</span><br><span class="line">| network_availability_zone | Network Availability Zone                     |</span><br><span class="line">| auto-allocated-topology   | Auto Allocated Topology Services              |</span><br><span class="line">| ext-gw-mode               | Neutron L3 Configurable external gateway mode |</span><br><span class="line">| binding                   | Port Binding                                  |</span><br><span class="line">| agent                     | agent                                         |</span><br><span class="line">| subnet_allocation         | Subnet Allocation                             |</span><br><span class="line">| l3_agent_scheduler        | L3 Agent Scheduler                            |</span><br><span class="line">| tag                       | Tag support                                   |</span><br><span class="line">| external-net              | Neutron external network                      |</span><br><span class="line">| net-mtu                   | Network MTU                                   |</span><br><span class="line">| availability_zone         | Availability Zone                             |</span><br><span class="line">| quotas                    | Quota management support                      |</span><br><span class="line">| l3-ha                     | HA Router extension                           |</span><br><span class="line">| flavors                   | Neutron Service Flavors                       |</span><br><span class="line">| provider                  | Provider Network                              |</span><br><span class="line">| multi-provider            | Multi Provider Network                        |</span><br><span class="line">| address-scope             | Address scope                                 |</span><br><span class="line">| extraroute                | Neutron Extra Route                           |</span><br><span class="line">| timestamp_core            | Time Stamp Fields addition <span class="keyword">for</span> core resources |</span><br><span class="line">| router                    | Neutron L3 Router                             |</span><br><span class="line">| extra_dhcp_opt            | Neutron Extra DHCP opts                       |</span><br><span class="line">| dns-integration           | DNS Integration                               |</span><br><span class="line">| security-group            | security-group                                |</span><br><span class="line">| dhcp_agent_scheduler      | DHCP Agent Scheduler                          |</span><br><span class="line">| router_availability_zone  | Router Availability Zone                      |</span><br><span class="line">| rbac-policies             | RBAC Policies                                 |</span><br><span class="line">| standard-attr-description | standard-attr-description                     |</span><br><span class="line">| port-security             | Port Security                                 |</span><br><span class="line">| allowed-address-pairs     | Allowed Address Pairs                         |</span><br><span class="line">| dvr                       | Distributed Virtual Router                    |</span><br><span class="line">+---------------------------+-----------------------------------------------+</span><br></pre></td></tr></table></figure></li>
<li><p>List agents to verify successful launch of the neutron agents:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack network agent list</span><br><span class="line"></span><br><span class="line">root@controller:~<span class="comment"># openstack network agent list --max-width 70</span></span><br><span class="line">+----------+------------+----------+-------------------+-------+-------+------------+</span><br><span class="line">| ID       | Agent Type | Host     | Availability Zone | Alive | State | Binary     |</span><br><span class="line">+----------+------------+----------+-------------------+-------+-------+------------+</span><br><span class="line">| 143d7731 | Linux      | compute  | None              | True  | UP    | neutron-li |</span><br><span class="line">| -9227-4b | bridge     |          |                   |       |       | nuxbridge- |</span><br><span class="line">| af-9052- | agent      |          |                   |       |       | agent      |</span><br><span class="line">| 292d7aea |            |          |                   |       |       |            |</span><br><span class="line">| 6992     |            |          |                   |       |       |            |</span><br><span class="line">| 1d661145 | Linux      | controll | None              | True  | UP    | neutron-li |</span><br><span class="line">| -0941    | bridge     | er       |                   |       |       | nuxbridge- |</span><br><span class="line">| -411d-9b | agent      |          |                   |       |       | agent      |</span><br><span class="line">| 18-b3371 |            |          |                   |       |       |            |</span><br><span class="line">| fe57c4b  |            |          |                   |       |       |            |</span><br><span class="line">| 7502e1a3 | DHCP agent | controll | nova              | True  | UP    | neutron-   |</span><br><span class="line">| -998d-   |            | er       |                   |       |       | dhcp-agent |</span><br><span class="line">| 4aca-91e |            |          |                   |       |       |            |</span><br><span class="line">| 4-ca17e1 |            |          |                   |       |       |            |</span><br><span class="line">| b10c82   |            |          |                   |       |       |            |</span><br><span class="line">| 7c47ac70 | Metadata   | controll | None              | True  | UP    | neutron-   |</span><br><span class="line">| -5de2-44 | agent      | er       |                   |       |       | metadata-  |</span><br><span class="line">| 42-8fc1- |            |          |                   |       |       | agent      |</span><br><span class="line">| 91fe97ae |            |          |                   |       |       |            |</span><br><span class="line">| 120f     |            |          |                   |       |       |            |</span><br><span class="line">+----------+------------+----------+-------------------+-------+-------+------------+</span><br></pre></td></tr></table></figure>
<p>The output should indicate three agents on the controller node and one agent on each compute node.</p>
</li>
</ol>
<h2 id="Congratulations-Let’s-try-booting-an-instance"><a href="#Congratulations-Let’s-try-booting-an-instance" class="headerlink" title="Congratulations! Let’s try booting an instance"></a>Congratulations! Let’s try booting an instance</h2><h3 id="Create-provider-network-subnetwork"><a href="#Create-provider-network-subnetwork" class="headerlink" title="Create provider network/subnetwork"></a>Create provider network/subnetwork</h3><blockquote>
<p> ref: <a href="https://docs.openstack.org/newton/install-guide-ubuntu/launch-instance-networks-provider.html">https://docs.openstack.org/newton/install-guide-ubuntu/launch-instance-networks-provider.html</a></p>
</blockquote>
<blockquote>
<p>The –provider:physical_network provider and –provider:network_type flat options connect the flat virtual network to the flat (native/untagged) physical network on the eth1 interface on the host</p>
</blockquote>
<p>标注: 下边的创建网络里 ，参数:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">--provider-network-type flat \</span><br><span class="line">--provider-physical-network provider</span><br></pre></td></tr></table></figure>
<p>对应的是:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">/etc/neutron/plugins/ml2/ml2_conf.ini</span><br><span class="line">[ml2_type_flat]</span><br><span class="line">flat_networks = provider</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/etc/neutron/plugins/ml2/linuxbridge_agent.ini</span><br><span class="line">[linux_bridge]</span><br><span class="line">physical_interface_mappings = provider:enp0s8</span><br></pre></td></tr></table></figure>


<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@controller:~<span class="comment"># . admin-openrc</span></span><br><span class="line">root@controller:~<span class="comment"># openstack network create  --share --external \</span></span><br><span class="line">&gt;   --provider-physical-network provider \</span><br><span class="line">&gt;   --provider-network-type flat provider</span><br><span class="line">+---------------------------+--------------------------------------+</span><br><span class="line">| Field                     | Value                                |</span><br><span class="line">+---------------------------+--------------------------------------+</span><br><span class="line">| admin_state_up            | UP                                   |</span><br><span class="line">| availability_zone_hints   |                                      |</span><br><span class="line">| availability_zones        |                                      |</span><br><span class="line">| created_at                | 2017-08-23T17:14:21Z                 |</span><br><span class="line">| description               |                                      |</span><br><span class="line">| dns_domain                | None                                 |</span><br><span class="line">| id                        | 2a33434f-ba29-4645-9b5d-24f1509066f1 |</span><br><span class="line">| ipv4_address_scope        | None                                 |</span><br><span class="line">| ipv6_address_scope        | None                                 |</span><br><span class="line">| is_default                | None                                 |</span><br><span class="line">| mtu                       | 1500                                 |</span><br><span class="line">| name                      | provider                             |</span><br><span class="line">| port_security_enabled     | True                                 |</span><br><span class="line">| project_id                | 78c9c849237649a3a8c4526167427589     |</span><br><span class="line">| provider:network_type     | flat                                 |</span><br><span class="line">| provider:physical_network | provider                             |</span><br><span class="line">| provider:segmentation_id  | None                                 |</span><br><span class="line">| qos_policy_id             | None                                 |</span><br><span class="line">| revision_number           | 4                                    |</span><br><span class="line">| router:external           | External                             |</span><br><span class="line">| segments                  | None                                 |</span><br><span class="line">| shared                    | True                                 |</span><br><span class="line">| status                    | ACTIVE                               |</span><br><span class="line">| subnets                   |                                      |</span><br><span class="line">| updated_at                | 2017-08-23T17:14:21Z                 |</span><br><span class="line">+---------------------------+--------------------------------------+</span><br><span class="line">root@controller:~<span class="comment"># neutron net-list</span></span><br><span class="line">neutron CLI is deprecated and will be removed <span class="keyword">in</span> the future. Use openstack CLI instead.</span><br><span class="line">+--------------------------------------+----------+----------------------------------+---------+</span><br><span class="line">| id                                   | name     | tenant_id                        | subnets |</span><br><span class="line">+--------------------------------------+----------+----------------------------------+---------+</span><br><span class="line">| 2a33434f-ba29-4645-9b5d-24f1509066f1 | provider | 78c9c849237649a3a8c4526167427589 |         |</span><br><span class="line">+--------------------------------------+----------+----------------------------------+---------+</span><br><span class="line">root@controller:~<span class="comment"># openstack network list</span></span><br><span class="line">+--------------------------------------+----------+---------+</span><br><span class="line">| ID                                   | Name     | Subnets |</span><br><span class="line">+--------------------------------------+----------+---------+</span><br><span class="line">| 2a33434f-ba29-4645-9b5d-24f1509066f1 | provider |         |</span><br><span class="line">+--------------------------------------+----------+---------+</span><br><span class="line"></span><br><span class="line">root@controller:~<span class="comment"># openstack subnet create --network provider \</span></span><br><span class="line">&gt;   --allocation-pool start=172.16.0.100,end=172.16.0.200 \</span><br><span class="line">&gt;   --gateway 172.16.0.1 \</span><br><span class="line">&gt;   --subnet-range 172.16.0.1/24 provider</span><br><span class="line">+-------------------+--------------------------------------+</span><br><span class="line">| Field             | Value                                |</span><br><span class="line">+-------------------+--------------------------------------+</span><br><span class="line">| allocation_pools  | 172.16.0.100-172.16.0.200            |</span><br><span class="line">| cidr              | 172.16.0.1/24                        |</span><br><span class="line">| created_at        | 2017-08-23T17:17:54Z                 |</span><br><span class="line">| description       |                                      |</span><br><span class="line">| enable_dhcp       | True                                 |</span><br><span class="line">| gateway_ip        | 172.16.0.1                           |</span><br><span class="line">| host_routes       |                                      |</span><br><span class="line">| id                | 9b118521-59b5-40ee-a439-9d59c3b392ea |</span><br><span class="line">| ip_version        | 4                                    |</span><br><span class="line">| ipv6_address_mode | None                                 |</span><br><span class="line">| ipv6_ra_mode      | None                                 |</span><br><span class="line">| name              | provider                             |</span><br><span class="line">| network_id        | 2a33434f-ba29-4645-9b5d-24f1509066f1 |</span><br><span class="line">| project_id        | 78c9c849237649a3a8c4526167427589     |</span><br><span class="line">| revision_number   | 2                                    |</span><br><span class="line">| segment_id        | None                                 |</span><br><span class="line">| service_types     |                                      |</span><br><span class="line">| subnetpool_id     | None                                 |</span><br><span class="line">| updated_at        | 2017-08-23T17:17:54Z                 |</span><br><span class="line">+-------------------+--------------------------------------+</span><br></pre></td></tr></table></figure>


<h3 id="Create-flavor"><a href="#Create-flavor" class="headerlink" title="Create flavor"></a>Create flavor</h3><p>The smallest default flavor consumes 512 MB memory per instance. For environments with compute nodes containing less than 4 GB memory, we recommend creating the <code>m1.nano</code> flavor that only requires 64 MB per instance. Only use this flavor with the CirrOS image for testing purposes.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack flavor create --id 0 --vcpus 1 --ram 64 --disk 1 m1.nano</span><br><span class="line"></span><br><span class="line">+----------------------------+---------+</span><br><span class="line">| Field                      | Value   |</span><br><span class="line">+----------------------------+---------+</span><br><span class="line">| OS-FLV-DISABLED:disabled   | False   |</span><br><span class="line">| OS-FLV-EXT-DATA:ephemeral  | 0       |</span><br><span class="line">| disk                       | 1       |</span><br><span class="line">| id                         | 0       |</span><br><span class="line">| name                       | m1.nano |</span><br><span class="line">| os-flavor-access:is_public | True    |</span><br><span class="line">| ram                        | 64      |</span><br><span class="line">| rxtx_factor                | 1.0     |</span><br><span class="line">| swap                       |         |</span><br><span class="line">| vcpus                      | 1       |</span><br><span class="line">+----------------------------+---------+</span><br></pre></td></tr></table></figure>
<h3 id="Add-security-group-rules"><a href="#Add-security-group-rules" class="headerlink" title="Add security group rules"></a>Add security group rules</h3><p>By default, the <code>default</code> security group applies to all instances and includes firewall rules that deny remote access to instances. For Linux images such as CirrOS, we recommend allowing at least ICMP (ping) and secure shell (SSH).</p>
<ul>
<li><p>Add rules to the <code>default</code> security group:</p>
<ul>
<li><p>Permit <a href="https://docs.openstack.org/newton/install-guide-ubuntu/common/glossary.html#term-internet-control-message-protocol-icmp">ICMP</a> (ping):</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack security group rule create --proto icmp default</span><br><span class="line"></span><br><span class="line">+-------------------+--------------------------------------+</span><br><span class="line">| Field             | Value                                |</span><br><span class="line">+-------------------+--------------------------------------+</span><br><span class="line">| created_at        | 2016-10-05T09:52:31Z                 |</span><br><span class="line">| description       |                                      |</span><br><span class="line">| direction         | ingress                              |</span><br><span class="line">| ethertype         | IPv4                                 |</span><br><span class="line">| headers           |                                      |</span><br><span class="line">| id                | 6ee8d630-9803-4d3d-9aea-8c795abbedc2 |</span><br><span class="line">| port_range_max    | None                                 |</span><br><span class="line">| port_range_min    | None                                 |</span><br><span class="line">| project_id        | 77ae8d7104024123af342ffb0a6f1d88     |</span><br><span class="line">| project_id        | 77ae8d7104024123af342ffb0a6f1d88     |</span><br><span class="line">| protocol          | icmp                                 |</span><br><span class="line">| remote_group_id   | None                                 |</span><br><span class="line">| remote_ip_prefix  | 0.0.0.0/0                            |</span><br><span class="line">| revision_number   | 1                                    |</span><br><span class="line">| security_group_id | 4ceee3d4-d2fe-46c1-895c-382033e87b0d |</span><br><span class="line">| updated_at        | 2016-10-05T09:52:31Z                 |</span><br><span class="line">+-------------------+--------------------------------------+</span><br></pre></td></tr></table></figure></li>
<li><p>Permit secure shell (SSH) access:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack security group rule create --proto tcp --dst-port 22 default</span><br><span class="line"></span><br><span class="line">+-------------------+--------------------------------------+</span><br><span class="line">| Field             | Value                                |</span><br><span class="line">+-------------------+--------------------------------------+</span><br><span class="line">| created_at        | 2016-10-05T09:54:50Z                 |</span><br><span class="line">| description       |                                      |</span><br><span class="line">| direction         | ingress                              |</span><br><span class="line">| ethertype         | IPv4                                 |</span><br><span class="line">| headers           |                                      |</span><br><span class="line">| id                | 3cd0a406-43df-4741-ab29-b5e7dcb7469d |</span><br><span class="line">| port_range_max    | 22                                   |</span><br><span class="line">| port_range_min    | 22                                   |</span><br><span class="line">| project_id        | 77ae8d7104024123af342ffb0a6f1d88     |</span><br><span class="line">| project_id        | 77ae8d7104024123af342ffb0a6f1d88     |</span><br><span class="line">| protocol          | tcp                                  |</span><br><span class="line">| remote_group_id   | None                                 |</span><br><span class="line">| remote_ip_prefix  | 0.0.0.0/0                            |</span><br><span class="line">| revision_number   | 1                                    |</span><br><span class="line">| security_group_id | 4ceee3d4-d2fe-46c1-895c-382033e87b0d |</span><br><span class="line">| updated_at        | 2016-10-05T09:54:50Z                 |</span><br><span class="line">+-------------------+--------------------------------------+</span><br></pre></td></tr></table></figure>
<h3 id="Launch-an-instance"><a href="#Launch-an-instance" class="headerlink" title="Launch an instance"></a>Launch an instance</h3></li>
</ul>
</li>
</ul>
<p>ref: <a href="https://docs.openstack.org/newton/install-guide-ubuntu/launch-instance-provider.html">Launch an instance on the provider network</a></p>
<h3 id="Determine-instance-options"><a href="#Determine-instance-options" class="headerlink" title="Determine instance options"></a>Determine instance options</h3><p>To launch an instance, you must at least specify the flavor, image name, network, security group, key, and instance name.</p>
<ol>
<li><p>On the controller node, source the <code>demo</code> credentials to gain access to user-only CLI commands:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ . demo-openrc</span><br></pre></td></tr></table></figure></li>
<li><p>A flavor specifies a virtual resource allocation profile which includes processor, memory, and storage.</p>
<p>List available flavors:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack flavor list</span><br><span class="line"></span><br><span class="line">+----+---------+-----+------+-----------+-------+-----------+</span><br><span class="line">| ID | Name    | RAM | Disk | Ephemeral | VCPUs | Is Public |</span><br><span class="line">+----+---------+-----+------+-----------+-------+-----------+</span><br><span class="line">| 0  | m1.nano |  64 |    1 |         0 |     1 | True      |</span><br><span class="line">+----+---------+-----+------+-----------+-------+-----------+</span><br></pre></td></tr></table></figure>
<p>You can also reference a flavor by ID.</p>
</li>
<li><p>List available images:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack image list</span><br><span class="line"></span><br><span class="line">+--------------------------------------+--------+--------+</span><br><span class="line">| ID                                   | Name   | Status |</span><br><span class="line">+--------------------------------------+--------+--------+</span><br><span class="line">| 390eb5f7-8d49-41ec-95b7-68c0d5d54b34 | cirros | active |</span><br><span class="line">+--------------------------------------+--------+--------+</span><br></pre></td></tr></table></figure>
<p>This instance uses the <code>cirros</code> image.</p>
</li>
<li><p>List available networks:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack network list</span><br><span class="line"></span><br><span class="line">+--------------------------------------+--------------+--------------------------------------+</span><br><span class="line">| ID                                   | Name         | Subnets                              |</span><br><span class="line">+--------------------------------------+--------------+--------------------------------------+</span><br><span class="line">| 4716ddfe-6e60-40e7-b2a8-42e57bf3c31c | selfservice  | 2112d5eb-f9d6-45fd-906e-7cabd38b7c7c |</span><br><span class="line">| b5b6993c-ddf9-40e7-91d0-86806a42edb8 | provider     | 310911f6-acf0-4a47-824e-3032916582ff |</span><br><span class="line">+--------------------------------------+--------------+--------------------------------------+</span><br></pre></td></tr></table></figure>
<p>This instance uses the <code>provider</code> provider network. However, you must reference this network using the ID instead of the name.</p>
</li>
</ol>
<ol start="5">
<li><p>List available security groups:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack security group list</span><br><span class="line"></span><br><span class="line">+--------------------------------------+---------+------------------------+----------------------------------+</span><br><span class="line">| ID                                   | Name    | Description            | Project                          |</span><br><span class="line">+--------------------------------------+---------+------------------------+----------------------------------+</span><br><span class="line">| dd2b614c-3dad-48ed-958b-b155a3b38515 | default | Default security group | a516b957032844328896baa01e0f906c |</span><br><span class="line">+--------------------------------------+---------+------------------------+----------------------------------+</span><br></pre></td></tr></table></figure>
<p>This instance uses the <code>default</code> security group.</p>
</li>
</ol>
<h3 id="Launch-the-instance"><a href="#Launch-the-instance" class="headerlink" title="Launch the instance"></a>Launch the instance</h3><ol>
<li><p>Launch the instance:</p>
<p>Replace <code>PROVIDER_NET_ID</code> with the ID of the <code>provider</code> provider network.</p>
<p>If you chose option 1 and your environment contains only one network, you can omit the <code>--nic</code> option because OpenStack automatically chooses the only network available.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@controller:~<span class="comment"># openstack server create --flavor m1.nano --image cirros \</span></span><br><span class="line">&gt;   --nic net-id=2a33434f-ba29-4645-9b5d-24f1509066f1 --security-group default provider-instance</span><br><span class="line">+-----------------------------+-----------------------------------------------+</span><br><span class="line">| Field                       | Value                                         |</span><br><span class="line">+-----------------------------+-----------------------------------------------+</span><br><span class="line">| OS-DCF:diskConfig           | MANUAL                                        |</span><br><span class="line">| OS-EXT-AZ:availability_zone |                                               |</span><br><span class="line">| OS-EXT-STS:power_state      | NOSTATE                                       |</span><br><span class="line">| OS-EXT-STS:task_state       | scheduling                                    |</span><br><span class="line">| OS-EXT-STS:vm_state         | building                                      |</span><br><span class="line">| OS-SRV-USG:launched_at      | None                                          |</span><br><span class="line">| OS-SRV-USG:terminated_at    | None                                          |</span><br><span class="line">| accessIPv4                  |                                               |</span><br><span class="line">| accessIPv6                  |                                               |</span><br><span class="line">| addresses                   |                                               |</span><br><span class="line">| adminPass                   | MnjXdXf3qHia                                  |</span><br><span class="line">| config_drive                |                                               |</span><br><span class="line">| created                     | 2017-08-23T17:29:04Z                          |</span><br><span class="line">| flavor                      | m1.nano (0)                                   |</span><br><span class="line">| hostId                      |                                               |</span><br><span class="line">| id                          | 02f54ef9-e867-4c1a-88f9-8eddd144da6f          |</span><br><span class="line">| image                       | cirros (c17e391e-93e1-4480-9cf3-bf8623063e61) |</span><br><span class="line">| key_name                    | None                                          |</span><br><span class="line">| name                        | provider-instance                             |</span><br><span class="line">| progress                    | 0                                             |</span><br><span class="line">| project_id                  | cb015df53fb34d90b077e4c36ce35826              |</span><br><span class="line">| properties                  |                                               |</span><br><span class="line">| security_groups             | name=<span class="string">&#x27;default&#x27;</span>                                |</span><br><span class="line">| status                      | BUILD                                         |</span><br><span class="line">| updated                     | 2017-08-23T17:29:05Z                          |</span><br><span class="line">| user_id                     | cb98fad69e84459bb48f42130d5c0ce5              |</span><br><span class="line">| volumes_attached            |                                               |</span><br><span class="line">+-----------------------------+-----------------------------------------------+</span><br></pre></td></tr></table></figure></li>
<li><p>Check the status of your instance:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@controller:~<span class="comment"># nova list</span></span><br><span class="line">+--------------------------------------+-------------------+--------+------------+-------------+----------+</span><br><span class="line">| ID                                   | Name              | Status | Task State | Power State | Networks |</span><br><span class="line">+--------------------------------------+-------------------+--------+------------+-------------+----------+</span><br><span class="line">| 02f54ef9-e867-4c1a-88f9-8eddd144da6f | provider-instance | BUILD  | scheduling | NOSTATE     |          |</span><br><span class="line">+--------------------------------------+-------------------+--------+------------+-------------+----------+</span><br><span class="line"></span><br><span class="line">root@controller:~<span class="comment"># openstack server list</span></span><br><span class="line">+--------------------------------------+-------------------+--------+----------+------------+</span><br><span class="line">| ID                                   | Name              | Status | Networks | Image Name |</span><br><span class="line">+--------------------------------------+-------------------+--------+----------+------------+</span><br><span class="line">| 02f54ef9-e867-4c1a-88f9-8eddd144da6f | provider-instance | BUILD  |          | cirros     |</span><br><span class="line">+--------------------------------------+-------------------+--------+----------+------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>The status changes from <code>BUILD</code> to <code>ACTIVE</code> when the build process successfully completes.</p>
</li>
</ol>
<h3 id="Access-the-instance-using-the-virtual-console"><a href="#Access-the-instance-using-the-virtual-console" class="headerlink" title="Access the instance using the virtual console"></a>Access the instance using the virtual console</h3><ol>
<li><p>Obtain a <a href="https://docs.openstack.org/newton/install-guide-ubuntu/common/glossary.html#term-virtual-network-computing-vnc">Virtual Network Computing (VNC)</a> session URL for your instance and access it from a web browser:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack console url show provider-instance</span><br><span class="line"></span><br><span class="line">+-------+---------------------------------------------------------------------------------+</span><br><span class="line">| Field | Value                                                                           |</span><br><span class="line">+-------+---------------------------------------------------------------------------------+</span><br><span class="line">| <span class="built_in">type</span>  | novnc                                                                           |</span><br><span class="line">| url   | http://controller:6080/vnc_auto.html?token=5eeccb47-525c-4918-ac2a-3ad1e9f1f493 |</span><br><span class="line">+-------+---------------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>
<p>If your web browser runs on a host that cannot resolve the <code>controller</code> host name, you can replace <code>controller</code> with the IP address of the management interface on your controller node.</p>
<p>The CirrOS image includes conventional user name/password authentication and provides these credentials at the login prompt. After logging into CirrOS, we recommend that you verify network connectivity using <code>ping</code>.</p>
</li>
<li><p>Verify access to the provider physical network gateway:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ping -c 4 172.16.0.1</span><br><span class="line"></span><br><span class="line">PING 203.0.113.1 (172.16.0.1) 56(84) bytes of data.</span><br><span class="line">64 bytes from 172.16.0.1: icmp_req=1 ttl=64 time=0.357 ms</span><br><span class="line">64 bytes from 172.16.0.1: icmp_req=2 ttl=64 time=0.473 ms</span><br><span class="line">64 bytes from 172.16.0.1: icmp_req=3 ttl=64 time=0.504 ms</span><br><span class="line">64 bytes from 172.16.0.1: icmp_req=4 ttl=64 time=0.470 ms</span><br><span class="line"></span><br><span class="line">--- 172.16.0.1 ping statistics ---</span><br><span class="line">4 packets transmitted, 4 received, 0% packet loss, time 2998ms</span><br><span class="line">rtt min/avg/max/mdev = 0.357/0.451/0.504/0.055 ms</span><br></pre></td></tr></table></figure></li>
<li><p>Verify access to the internet:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ping -c 4 openstack.org</span><br><span class="line"></span><br><span class="line">PING openstack.org (174.143.194.225) 56(84) bytes of data.</span><br><span class="line">64 bytes from 174.143.194.225: icmp_req=1 ttl=53 time=17.4 ms</span><br><span class="line">64 bytes from 174.143.194.225: icmp_req=2 ttl=53 time=17.5 ms</span><br><span class="line">64 bytes from 174.143.194.225: icmp_req=3 ttl=53 time=17.7 ms</span><br><span class="line">64 bytes from 174.143.194.225: icmp_req=4 ttl=53 time=17.5 ms</span><br><span class="line"></span><br><span class="line">--- openstack.org ping statistics ---</span><br><span class="line">4 packets transmitted, 4 received, 0% packet loss, time 3003ms</span><br><span class="line">rtt min/avg/max/mdev = 17.431/17.575/17.734/0.143 ms</span><br></pre></td></tr></table></figure>
<h3 id="Access-the-instance-remotely"><a href="#Access-the-instance-remotely" class="headerlink" title="Access the instance remotely"></a>Access the instance remotely</h3></li>
<li><p>Verify connectivity to the instance from the controller node or any host on the provider physical network:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ping -c 4 172.16.0.103</span><br><span class="line"></span><br><span class="line">PING 203.0.113.103 (203.0.113.103) 56(84) bytes of data.</span><br><span class="line">64 bytes from 203.0.113.103: icmp_req=1 ttl=63 time=3.18 ms</span><br><span class="line">64 bytes from 203.0.113.103: icmp_req=2 ttl=63 time=0.981 ms</span><br><span class="line">64 bytes from 203.0.113.103: icmp_req=3 ttl=63 time=1.06 ms</span><br><span class="line">64 bytes from 203.0.113.103: icmp_req=4 ttl=63 time=0.929 ms</span><br><span class="line"></span><br><span class="line">--- 203.0.113.103 ping statistics ---</span><br><span class="line">4 packets transmitted, 4 received, 0% packet loss, time 3002ms</span><br><span class="line">rtt min/avg/max/mdev = 0.929/1.539/3.183/0.951 ms</span><br></pre></td></tr></table></figure></li>
<li><p>Access your instance using SSH from the controller node or any host on the provider physical network:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ssh cirros@203.0.113.103</span><br><span class="line"></span><br><span class="line">The authenticity of host <span class="string">&#x27;203.0.113.102 (203.0.113.102)&#x27;</span> can<span class="string">&#x27;t be established.</span></span><br><span class="line"><span class="string">RSA key fingerprint is ed:05:e9:e7:52:a0:ff:83:68:94:c7:d1:f2:f8:e2:e9.</span></span><br><span class="line"><span class="string">Are you sure you want to continue connecting (yes/no)? yes</span></span><br><span class="line"><span class="string">Warning: Permanently added &#x27;</span>203.0.113.102<span class="string">&#x27; (RSA) to the list of known hosts.</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>
<p>If your instance does not launch or seem to work as you expect, see the <a href="http://docs.openstack.org/ops-guide/ops-maintenance-compute.html#instances">Instance Boot Failures</a> section in OpenStack Operations Guide for more information or use one of the <a href="https://docs.openstack.org/newton/install-guide-ubuntu/common/app-support.html"><em>many other options</em></a> to seek assistance. We want your first installation to work!</p>
</li>
</ol>
<p>Return to <a href="https://docs.openstack.org/newton/install-guide-ubuntu/launch-instance.html#launch-instance-complete">Launch an instance</a>.</p>
<h2 id="ISSUE-DHCP-failure-in-VM-troubleshooting"><a href="#ISSUE-DHCP-failure-in-VM-troubleshooting" class="headerlink" title="[ISSUE] DHCP failure in VM troubleshooting"></a>[ISSUE] DHCP failure in VM troubleshooting</h2><blockquote>
<p> ref: <a href="https://docs.openstack.org/neutron/pike/admin/intro-basic-networking.html">https://docs.openstack.org/neutron/pike/admin/intro-basic-networking.html</a></p>
</blockquote>
<h3 id="what-it-is-like"><a href="#what-it-is-like" class="headerlink" title="what it is like"></a>what it is like</h3><p>in VM console ( initial dhcp discover)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ifup eth0</span><br><span class="line">udhcpc (v1.20.1) started</span><br><span class="line">Sending discover...</span><br><span class="line">Sending discover...</span><br><span class="line">Sending discover...</span><br><span class="line">Usage: /sbin/cirros-dhcpc &lt;up|down&gt;</span><br><span class="line">No lease, failing</span><br></pre></td></tr></table></figure>
<p>in controller console (monitor log)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@controller:~<span class="comment"># tail -f /var/log/syslog</span></span><br><span class="line">Aug 24 03:06:30 controller dhclient[1166]: DHCPREQUEST of 146.11.41.129 on enp0s10 to 147.128.5.12 port 67 (xid=0x5d38ef7e)</span><br><span class="line">Aug 24 03:06:30 controller dhclient[1166]: DHCPACK of 146.11.41.129 from 147.128.5.12</span><br><span class="line">Aug 24 03:06:30 controller dhclient[1166]: Invalid domain list.</span><br><span class="line">Aug 24 03:06:30 controller dhclient[1166]: suspect value <span class="keyword">in</span> domain_search option - discarded</span><br><span class="line">Aug 24 03:06:30 controller dhclient[1166]: Invalid domain list.</span><br><span class="line">Aug 24 03:06:30 controller dhclient[1166]: suspect value <span class="keyword">in</span> domain_search option - discarded</span><br><span class="line">Aug 24 03:06:30 controller dhclient[1166]: Invalid domain list.</span><br><span class="line">Aug 24 03:06:30 controller dhclient[1166]: bound to 146.11.41.129 -- renewal <span class="keyword">in</span> 12824 seconds.</span><br><span class="line">Aug 24 03:12:18 controller dnsmasq-dhcp[18894]: DHCPDISCOVER(ns-a6e0220e-ec) fa:16:3e:bb:c6:13</span><br><span class="line">Aug 24 03:12:18 controller dnsmasq-dhcp[18894]: DHCPOFFER(ns-a6e0220e-ec) 146.11.41.232 fa:16:3e:bb:c6:13</span><br><span class="line">Aug 24 03:13:19 controller dnsmasq-dhcp[18894]: DHCPDISCOVER(ns-a6e0220e-ec) fa:16:3e:bb:c6:13</span><br><span class="line">Aug 24 03:13:19 controller dnsmasq-dhcp[18894]: DHCPOFFER(ns-a6e0220e-ec) 146.11.41.232 fa:16:3e:bb:c6:13</span><br><span class="line">Aug 24 03:14:19 controller dnsmasq-dhcp[18894]: DHCPDISCOVER(ns-a6e0220e-ec) fa:16:3e:bb:c6:13</span><br><span class="line">Aug 24 03:14:19 controller dnsmasq-dhcp[18894]: DHCPOFFER(ns-a6e0220e-ec) 146.11.41.232 fa:16:3e:bb:c6:13</span><br></pre></td></tr></table></figure>
<p>By tcpdump from controllor bridge, it’s found the DHCPOFFER was sent to VM:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@controller:~<span class="comment"># tcpdump -i  brq2a33434f-ba -vv port 67 or port 68 -e -n</span></span><br><span class="line">tcpdump: listening on brq2a33434f-ba, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">04:04:22.830138 fa:16:3e:bb:c6:13 &gt; ff:ff:ff:ff:ff:ff, ethertype IPv4 (0x0800), length 332: (tos 0x0, ttl 64, id 0, offset 0, flags [none], proto UDP (17), length 318)</span><br><span class="line">    0.0.0.0.68 &gt; 255.255.255.255.67: [udp sum ok] BOOTP/DHCP, Request from fa:16:3e:bb:c6:13, length 290, xid 0x1fac2751, Flags [none] (0x0000)</span><br><span class="line">          Client-Ethernet-Address fa:16:3e:bb:c6:13</span><br><span class="line">          Vendor-rfc1048 Extensions</span><br><span class="line">            Magic Cookie 0x63825363</span><br><span class="line">            DHCP-Message Option 53, length 1: Discover</span><br><span class="line">            Client-ID Option 61, length 7: ether fa:16:3e:bb:c6:13</span><br><span class="line">            MSZ Option 57, length 2: 576</span><br><span class="line">            Parameter-Request Option 55, length 9:</span><br><span class="line">              Subnet-Mask, Default-Gateway, Domain-Name-Server, Hostname</span><br><span class="line">              Domain-Name, MTU, BR, NTP</span><br><span class="line">              Classless-Static-Route</span><br><span class="line">            Vendor-Class Option 60, length 12: <span class="string">&quot;udhcp 1.20.1&quot;</span></span><br><span class="line">            Hostname Option 12, length 6: <span class="string">&quot;cirros&quot;</span></span><br><span class="line">04:04:22.831801 fa:16:3e:8b:53:5e &gt; fa:16:3e:bb:c6:13, ethertype IPv4 (0x0800), length 370: (tos 0xc0, ttl 64, id 3044, offset 0, flags [none], proto UDP (17), length 356)</span><br><span class="line">    146.11.41.230.67 &gt; 146.11.41.232.68: [udp sum ok] BOOTP/DHCP, Reply, length 328, xid 0x1fac2751, Flags [none] (0x0000)</span><br><span class="line">          Your-IP 146.11.41.232</span><br><span class="line">          Server-IP 146.11.41.230</span><br><span class="line">          Client-Ethernet-Address fa:16:3e:bb:c6:13</span><br><span class="line">          Vendor-rfc1048 Extensions</span><br><span class="line">            Magic Cookie 0x63825363</span><br><span class="line">            DHCP-Message Option 53, length 1: Offer</span><br><span class="line">            Server-ID Option 54, length 4: 146.11.41.230</span><br><span class="line">            Lease-Time Option 51, length 4: 86400</span><br><span class="line">            RN Option 58, length 4: 43200</span><br><span class="line">            RB Option 59, length 4: 75600</span><br><span class="line">            Subnet-Mask Option 1, length 4: 255.255.254.0</span><br><span class="line">            BR Option 28, length 4: 146.11.41.255</span><br><span class="line">            Domain-Name Option 15, length 14: <span class="string">&quot;openstacklocal&quot;</span></span><br><span class="line">            Default-Gateway Option 3, length 4: 146.11.40.1</span><br><span class="line">            Classless-Static-Route Option 121, length 14: (169.254.169.254/32:146.11.41.230),(default:146.11.40.1)</span><br><span class="line">            Domain-Name-Server Option 6, length 4: 147.128.5.12</span><br><span class="line">            MTU Option 26, length 2: 1500</span><br><span class="line">04:04:52.504181 08:2e:5f:5d:63:00 &gt; ff:ff:ff:ff:ff:ff, ethertype IPv4 (0x0800), length 358: (tos 0x0, ttl 120, id 5320, offset 0, flags [DF], proto UDP (17), length 344)</span><br></pre></td></tr></table></figure>
<p>While from compute , tcpdump the br-int bridge shows it’s not received </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@compute:~<span class="comment"># tcpdump -i brq2a33434f-ba -vv port 67 or port 68 -e -n</span></span><br><span class="line">tcpdump: listening on brq2a33434f-ba, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">03:51:04.456668 fa:16:3e:bb:c6:13 &gt; ff:ff:ff:ff:ff:ff, ethertype IPv4 (0x0800), length 332: (tos 0x0, ttl 64, id 0, offset 0, flags [none], proto UDP (17), length 318)</span><br><span class="line">    0.0.0.0.68 &gt; 255.255.255.255.67: [udp sum ok] BOOTP/DHCP, Request from fa:16:3e:bb:c6:13, length 290, xid 0xe5e8f024, Flags [none] (0x0000)</span><br><span class="line">          Client-Ethernet-Address fa:16:3e:bb:c6:13</span><br><span class="line">          Vendor-rfc1048 Extensions</span><br><span class="line">            Magic Cookie 0x63825363</span><br><span class="line">            DHCP-Message Option 53, length 1: Discover</span><br><span class="line">            Client-ID Option 61, length 7: ether fa:16:3e:bb:c6:13</span><br><span class="line">            MSZ Option 57, length 2: 576</span><br><span class="line">            Parameter-Request Option 55, length 9:</span><br><span class="line">              Subnet-Mask, Default-Gateway, Domain-Name-Server, Hostname</span><br><span class="line">              Domain-Name, MTU, BR, NTP</span><br><span class="line">              Classless-Static-Route</span><br><span class="line">            Vendor-Class Option 60, length 12: <span class="string">&quot;udhcp 1.20.1&quot;</span></span><br><span class="line">            Hostname Option 12, length 6: <span class="string">&quot;cirros&quot;</span></span><br><span class="line">03:51:30.022360 08:2e:5f:5d:63:00 &gt; ff:ff:ff:ff:ff:ff, ethertype IPv4 (0x0800), length 358: (tos 0x0, ttl 120, id 29901, offset 0, flags [DF], proto UDP (17), length 344)</span><br><span class="line">    147.128.5.12.67 &gt; 255.255.255.255.68: [udp sum ok] BOOTP/DHCP, Reply, length 316, xid 0x4a42e788, Flags [Broadcast] (0x8000)</span><br><span class="line">          Client-IP 146.11.40.250</span><br><span class="line">          Gateway-IP 146.11.40.1</span><br><span class="line">          Client-Ethernet-Address d0:bf:9c:df:7a:a5</span><br><span class="line">          Vendor-rfc1048 Extensions</span><br><span class="line">            Magic Cookie 0x63825363</span><br><span class="line">            DHCP-Message Option 53, length 1: ACK</span><br><span class="line">            Server-ID Option 54, length 4: 147.128.5.12</span><br><span class="line">            Subnet-Mask Option 1, length 4: 255.255.254.0</span><br><span class="line">            Vendor-Option Option 43, length 5: 220.3.78.65.80</span><br><span class="line">            Domain-Name Option 15, length 18: <span class="string">&quot;^@&quot;</span></span><br><span class="line">            Default-Gateway Option 3, length 4: 146.11.40.1</span><br><span class="line">            Domain-Name-Server Option 6, length 12: 147.128.5.12,193.181.14.11,193.181.14.10</span><br><span class="line">            Netbios-Name-Server Option 44, length 8: 146.11.115.50,146.11.116.30</span><br><span class="line">            Netbios-Node Option 46, length 1: h-node</span><br><span class="line">03:51:30.023490 2c:76:8a:1f:47:00 &gt; ff:ff:ff:ff:ff:ff, ethertype IPv4 (0x0800), length 358: (tos 0x0, ttl 119, id 2187, offset 0, flags [DF], proto UDP (17), length 344)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion:"></a>Conclusion:</h3><p>the DHCP offer was sent out from DHCP agent dnsmasq, but the package cannot be captured from host bridge connecting to vm eth0. the issue is located in the provider network router, the ECN router 146.11.40.1 in our office.</p>
<p>By searching online, there is a tech called DHCP snooping to prevent multiple dhcp server in one LAN from router, which makes sense. </p>
<h2 id="Cinder"><a href="#Cinder" class="headerlink" title="Cinder"></a>Cinder</h2><h2 id="Cinder-on-controller"><a href="#Cinder-on-controller" class="headerlink" title="Cinder on controller"></a>Cinder on controller</h2><p>Here we provide a iSCSI driver backend cinder practice </p>
<blockquote>
<p> ref: <a href="https://docs.openstack.org/ocata/install-guide-ubuntu/cinder.html">https://docs.openstack.org/ocata/install-guide-ubuntu/cinder.html</a></p>
</blockquote>
<p>The OpenStack Block Storage service (cinder) adds persistent storage to a virtual machine. Block Storage provides an infrastructure for managing volumes, and interacts with OpenStack Compute to provide volumes for instances. The service also enables management of volume snapshots, and volume types.</p>
<p>The Block Storage service consists of the following components:</p>
<ul>
<li><p>cinder-api</p>
<p>Accepts API requests, and routes them to the <code>cinder-volume</code> for action.</p>
</li>
<li><p>cinder-volume</p>
<p>Interacts directly with the Block Storage service, and processes such as the <code>cinder-scheduler</code>. It also interacts with these processes through a message queue. The <code>cinder-volume</code> service responds to read and write requests sent to the Block Storage service to maintain state. It can interact with a variety of storage providers through a driver architecture.</p>
</li>
<li><p>cinder-scheduler daemon</p>
<p>Selects the optimal storage provider node on which to create the volume. A similar component to the <code>nova-scheduler</code>.</p>
</li>
<li><p>cinder-backup daemon</p>
<p>The <code>cinder-backup</code> service provides backing up volumes of any type to a backup storage provider. Like the <code>cinder-volume</code> service, it can interact with a variety of storage providers through a driver architecture.</p>
</li>
<li><p>Messaging queue</p>
<p>Routes information between the Block Storage processes.</p>
</li>
</ul>
<h3 id="Install-and-configure-controller-node"><a href="#Install-and-configure-controller-node" class="headerlink" title="Install and configure controller node"></a>Install and configure controller node</h3><p>This section describes how to install and configure the Block Storage service, code-named cinder, on the controller node. This service requires at least one additional storage node that provides volumes to instances.</p>
<h3 id="Prerequisites-3"><a href="#Prerequisites-3" class="headerlink" title="Prerequisites"></a>Prerequisites</h3><p>Before you install and configure the Block Storage service, you must create a database, service credentials, and API endpoints.</p>
<ol>
<li><p>To create the database, complete these steps:</p>
<ul>
<li><p>Use the database access client to connect to the database server as the <code>root</code> user:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mysql</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ol>
<ul>
<li><p>Create the <code>cinder</code> database:</p>
  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; CREATE DATABASE cinder;</span><br></pre></td></tr></table></figure></li>
<li><p>Grant proper access to the <code>cinder</code> database:</p>
<pre><code> ​```
 MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON cinder.* TO &#39;cinder&#39;@&#39;localhost&#39; \
   IDENTIFIED BY &#39;CINDER_DBPASS&#39;;
 MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON cinder.* TO &#39;cinder&#39;@&#39;%&#39; \
   IDENTIFIED BY &#39;CINDER_DBPASS&#39;;
 ​```

 Replace `CINDER_DBPASS` with a suitable password.</code></pre>
<ul>
<li>Exit the database access client.</li>
</ul>
</li>
</ul>
<ol>
<li><p>Source the <code>admin</code> credentials to gain access to admin-only CLI commands:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ . admin-openrc</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>To create the service credentials, complete these steps:</p>
<ul>
<li><p>Create a <code>cinder</code> user:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack user create --domain default --password-prompt cinder</span><br><span class="line"></span><br><span class="line">User Password:</span><br><span class="line">Repeat User Password:</span><br><span class="line">+---------------------+----------------------------------+</span><br><span class="line">| Field               | Value                            |</span><br><span class="line">+---------------------+----------------------------------+</span><br><span class="line">| domain_id           | default                          |</span><br><span class="line">| enabled             | True                             |</span><br><span class="line">| id                  | 9d7e33de3e1a498390353819bc7d245d |</span><br><span class="line">| name                | cinder                           |</span><br><span class="line">| options             | &#123;&#125;                               |</span><br><span class="line">| password_expires_at | None                             |</span><br><span class="line">+---------------------+----------------------------------+</span><br></pre></td></tr></table></figure></li>
<li><p>Add the <code>admin</code> role to the <code>cinder</code> user:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack role add --project service --user cinder admin</span><br></pre></td></tr></table></figure>
<p>This command provides no output.</p>
</li>
<li><p>Create the <code>cinderv2</code> and <code>cinderv3</code> service entities:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack service create --name cinderv2 \</span><br><span class="line">  --description <span class="string">&quot;OpenStack Block Storage&quot;</span> volumev2</span><br><span class="line"></span><br><span class="line">+-------------+----------------------------------+</span><br><span class="line">| Field       | Value                            |</span><br><span class="line">+-------------+----------------------------------+</span><br><span class="line">| description | OpenStack Block Storage          |</span><br><span class="line">| enabled     | True                             |</span><br><span class="line">| id          | eb9fd245bdbc414695952e93f29fe3ac |</span><br><span class="line">| name        | cinderv2                         |</span><br><span class="line">| <span class="built_in">type</span>        | volumev2                         |</span><br><span class="line">+-------------+----------------------------------+</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack service create --name cinderv3 \</span><br><span class="line">  --description <span class="string">&quot;OpenStack Block Storage&quot;</span> volumev3</span><br><span class="line"></span><br><span class="line">+-------------+----------------------------------+</span><br><span class="line">| Field       | Value                            |</span><br><span class="line">+-------------+----------------------------------+</span><br><span class="line">| description | OpenStack Block Storage          |</span><br><span class="line">| enabled     | True                             |</span><br><span class="line">| id          | ab3bbbef780845a1a283490d281e7fda |</span><br><span class="line">| name        | cinderv3                         |</span><br><span class="line">| <span class="built_in">type</span>        | volumev3                         |</span><br><span class="line">+-------------+----------------------------------+</span><br></pre></td></tr></table></figure>
<p>The Block Storage services require two service entities.</p>
</li>
</ul>
</li>
<li><p>Create the Block Storage service API endpoints:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack endpoint create --region RegionOne \</span><br><span class="line">  volumev2 public http://controller:8776/v2/%\(project_id\)s</span><br><span class="line"></span><br><span class="line">+--------------+------------------------------------------+</span><br><span class="line">| Field        | Value                                    |</span><br><span class="line">+--------------+------------------------------------------+</span><br><span class="line">| enabled      | True                                     |</span><br><span class="line">| id           | 513e73819e14460fb904163f41ef3759         |</span><br><span class="line">| interface    | public                                   |</span><br><span class="line">| region       | RegionOne                                |</span><br><span class="line">| region_id    | RegionOne                                |</span><br><span class="line">| service_id   | eb9fd245bdbc414695952e93f29fe3ac         |</span><br><span class="line">| service_name | cinderv2                                 |</span><br><span class="line">| service_type | volumev2                                 |</span><br><span class="line">| url          | http://controller:8776/v2/%(project_id)s |</span><br><span class="line">+--------------+------------------------------------------+</span><br><span class="line"></span><br><span class="line">$ openstack endpoint create --region RegionOne \</span><br><span class="line">  volumev2 internal http://controller:8776/v2/%\(project_id\)s</span><br><span class="line"></span><br><span class="line">+--------------+------------------------------------------+</span><br><span class="line">| Field        | Value                                    |</span><br><span class="line">+--------------+------------------------------------------+</span><br><span class="line">| enabled      | True                                     |</span><br><span class="line">| id           | 6436a8a23d014cfdb69c586eff146a32         |</span><br><span class="line">| interface    | internal                                 |</span><br><span class="line">| region       | RegionOne                                |</span><br><span class="line">| region_id    | RegionOne                                |</span><br><span class="line">| service_id   | eb9fd245bdbc414695952e93f29fe3ac         |</span><br><span class="line">| service_name | cinderv2                                 |</span><br><span class="line">| service_type | volumev2                                 |</span><br><span class="line">| url          | http://controller:8776/v2/%(project_id)s |</span><br><span class="line">+--------------+------------------------------------------+</span><br><span class="line"></span><br><span class="line">$ openstack endpoint create --region RegionOne \</span><br><span class="line">  volumev2 admin http://controller:8776/v2/%\(project_id\)s</span><br><span class="line"></span><br><span class="line">+--------------+------------------------------------------+</span><br><span class="line">| Field        | Value                                    |</span><br><span class="line">+--------------+------------------------------------------+</span><br><span class="line">| enabled      | True                                     |</span><br><span class="line">| id           | e652cf84dd334f359ae9b045a2c91d96         |</span><br><span class="line">| interface    | admin                                    |</span><br><span class="line">| region       | RegionOne                                |</span><br><span class="line">| region_id    | RegionOne                                |</span><br><span class="line">| service_id   | eb9fd245bdbc414695952e93f29fe3ac         |</span><br><span class="line">| service_name | cinderv2                                 |</span><br><span class="line">| service_type | volumev2                                 |</span><br><span class="line">| url          | http://controller:8776/v2/%(project_id)s |</span><br><span class="line">+--------------+------------------------------------------+</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack endpoint create --region RegionOne \</span><br><span class="line">  volumev3 public http://controller:8776/v3/%\(project_id\)s</span><br><span class="line"></span><br><span class="line">+--------------+------------------------------------------+</span><br><span class="line">| Field        | Value                                    |</span><br><span class="line">+--------------+------------------------------------------+</span><br><span class="line">| enabled      | True                                     |</span><br><span class="line">| id           | 03fa2c90153546c295bf30ca86b1344b         |</span><br><span class="line">| interface    | public                                   |</span><br><span class="line">| region       | RegionOne                                |</span><br><span class="line">| region_id    | RegionOne                                |</span><br><span class="line">| service_id   | ab3bbbef780845a1a283490d281e7fda         |</span><br><span class="line">| service_name | cinderv3                                 |</span><br><span class="line">| service_type | volumev3                                 |</span><br><span class="line">| url          | http://controller:8776/v3/%(project_id)s |</span><br><span class="line">+--------------+------------------------------------------+</span><br><span class="line"></span><br><span class="line">$ openstack endpoint create --region RegionOne \</span><br><span class="line">  volumev3 internal http://controller:8776/v3/%\(project_id\)s</span><br><span class="line"></span><br><span class="line">+--------------+------------------------------------------+</span><br><span class="line">| Field        | Value                                    |</span><br><span class="line">+--------------+------------------------------------------+</span><br><span class="line">| enabled      | True                                     |</span><br><span class="line">| id           | 94f684395d1b41068c70e4ecb11364b2         |</span><br><span class="line">| interface    | internal                                 |</span><br><span class="line">| region       | RegionOne                                |</span><br><span class="line">| region_id    | RegionOne                                |</span><br><span class="line">| service_id   | ab3bbbef780845a1a283490d281e7fda         |</span><br><span class="line">| service_name | cinderv3                                 |</span><br><span class="line">| service_type | volumev3                                 |</span><br><span class="line">| url          | http://controller:8776/v3/%(project_id)s |</span><br><span class="line">+--------------+------------------------------------------+</span><br><span class="line"></span><br><span class="line">$ openstack endpoint create --region RegionOne \</span><br><span class="line">  volumev3 admin http://controller:8776/v3/%\(project_id\)s</span><br><span class="line"></span><br><span class="line">+--------------+------------------------------------------+</span><br><span class="line">| Field        | Value                                    |</span><br><span class="line">+--------------+------------------------------------------+</span><br><span class="line">| enabled      | True                                     |</span><br><span class="line">| id           | 4511c28a0f9840c78bacb25f10f62c98         |</span><br><span class="line">| interface    | admin                                    |</span><br><span class="line">| region       | RegionOne                                |</span><br><span class="line">| region_id    | RegionOne                                |</span><br><span class="line">| service_id   | ab3bbbef780845a1a283490d281e7fda         |</span><br><span class="line">| service_name | cinderv3                                 |</span><br><span class="line">| service_type | volumev3                                 |</span><br><span class="line">| url          | http://controller:8776/v3/%(project_id)s |</span><br><span class="line">+--------------+------------------------------------------+</span><br></pre></td></tr></table></figure>
<p>The Block Storage services require endpoints for each service entity.</p>
</li>
</ol>
<h3 id="Install-and-configure-components-3"><a href="#Install-and-configure-components-3" class="headerlink" title="Install and configure components"></a>Install and configure components</h3><p>Install the packages:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># apt install cinder-api cinder-scheduler</span></span><br></pre></td></tr></table></figure>
<p>Edit the <code>/etc/cinder/cinder.conf</code> file and complete the following actions:</p>
<ul>
<li><p>In the <code>[database]</code> section, configure database access:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[database]</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">connection = mysql+pymysql://cinder:CINDER_DBPASS@controller/cinder</span><br></pre></td></tr></table></figure>
<p>Replace <code>CINDER_DBPASS</code> with the password you chose for the Block Storage database.</p>
</li>
<li><p>In the <code>[DEFAULT]</code> section, configure <code>RabbitMQ</code> message queue access:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">transport_url = rabbit://openstack:RABBIT_PASS@controller</span><br></pre></td></tr></table></figure>
<p>Replace <code>RABBIT_PASS</code> with the password you chose for the <code>openstack</code> account in <code>RabbitMQ</code>.</p>
</li>
<li><p>In the <code>[DEFAULT]</code> and <code>[keystone_authtoken]</code> sections, configure Identity service access:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">auth_strategy = keystone</span><br><span class="line"></span><br><span class="line">[keystone_authtoken]</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">auth_uri = http://controller:5000</span><br><span class="line">auth_url = http://controller:35357</span><br><span class="line">memcached_servers = controller:11211</span><br><span class="line">auth_type = password</span><br><span class="line">project_domain_name = default</span><br><span class="line">user_domain_name = default</span><br><span class="line">project_name = service</span><br><span class="line">username = cinder</span><br><span class="line">password = cinder</span><br></pre></td></tr></table></figure>
<p>Replace <code>password</code> with the password you chose for the <code>cinder</code> user in the Identity service.</p>
<p>Comment out or remove any other options in the <code>[keystone_authtoken]</code> section.</p>
</li>
<li><p>In the <code>[DEFAULT]</code> section, configure the <code>my_ip</code> option to use the management interface IP address of the controller node:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">my_ip = 10.20.0.10</span><br></pre></td></tr></table></figure>
</li>
<li><p>In the <code>[oslo_concurrency]</code> section, configure the lock path:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[oslo_concurrency]</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">lock_path = /var/lib/cinder/tmp</span><br></pre></td></tr></table></figure>
<p>Populate the Block Storage database:</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># su -s /bin/sh -c &quot;cinder-manage db sync&quot; cinder</span></span><br></pre></td></tr></table></figure>
<p>Ignore any deprecation messages in this output.</p>
<h3 id="Configure-Compute-to-use-Block-Storage"><a href="#Configure-Compute-to-use-Block-Storage" class="headerlink" title="Configure Compute to use Block Storage"></a>Configure Compute to use Block Storage</h3><ul>
<li><p>Edit the <code>/etc/nova/nova.conf</code> file and add the following to it:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[cinder]</span><br><span class="line">os_region_name = RegionOne</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="Finalize-installation-5"><a href="#Finalize-installation-5" class="headerlink" title="Finalize installation"></a>Finalize installation</h3></li>
</ul>
<ol>
<li><p>Restart the Compute API service:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># service nova-api restart</span></span><br></pre></td></tr></table></figure></li>
<li><p>Restart the Block Storage services:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># service cinder-scheduler restart</span></span><br><span class="line"><span class="comment"># service apache2 restart</span></span><br></pre></td></tr></table></figure>
<h2 id="Cinder-on-block-storage-node"><a href="#Cinder-on-block-storage-node" class="headerlink" title="Cinder on block storage node"></a>Cinder on block storage node</h2></li>
</ol>
<h3 id="configure-storage-network-for-compute"><a href="#configure-storage-network-for-compute" class="headerlink" title="configure storage network for compute"></a>configure storage network for compute</h3><p>Check nic name</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@compute:~<span class="comment"># dmesg | grep renamed</span></span><br><span class="line">[    2.730898] e1000 0000:00:09.0 enp0s9: renamed from eth2</span><br><span class="line">[    2.731826] e1000 0000:00:08.0 enp0s8: renamed from eth1</span><br><span class="line">[    2.732819] e1000 0000:00:0a.0 enp0s10: renamed from eth3</span><br><span class="line">[    2.735645] e1000 0000:00:03.0 enp0s3: renamed from eth0</span><br></pre></td></tr></table></figure>
<p><code>eth2</code> was named as <code>enp0s9</code></p>
<p>Edit <code>/etc/network/interfaces</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># storage network eth2</span></span><br><span class="line">auto enp0s9</span><br><span class="line">iface enp0s9 inet static</span><br><span class="line">address 192.168.99.20</span><br><span class="line">netmask 255.255.255.0</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ifup enp0s9</span></span><br></pre></td></tr></table></figure>
<h3 id="Create-cinder-machine-storage"><a href="#Create-cinder-machine-storage" class="headerlink" title="Create cinder machine: storage"></a>Create cinder machine: storage</h3><h2 id="Storage-node-actions"><a href="#Storage-node-actions" class="headerlink" title="Storage node actions"></a>Storage node actions</h2><blockquote>
<p> Clone it from base VM and add a virtual disk for storage vm</p>
</blockquote>
<h3 id="Management-net-eth0-enp0s3-and-storage-net-eth2-enp0s9"><a href="#Management-net-eth0-enp0s3-and-storage-net-eth2-enp0s9" class="headerlink" title="Management net eth0 (enp0s3) and storage net eth2 (enp0s9)"></a>Management net eth0 (enp0s3) and storage net eth2 (enp0s9)</h3><p>Edit <code>/etc/network/interfaces</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># management network eth0</span></span><br><span class="line"></span><br><span class="line">auto enp0s3</span><br><span class="line">iface enp0s3 inet static</span><br><span class="line">address 10.20.0.30</span><br><span class="line">netmask 255.255.255.0</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># storage network eth2</span></span><br><span class="line">auto enp0s9</span><br><span class="line">iface enp0s9 inet static</span><br><span class="line">address 192.168.99.30</span><br><span class="line">netmask 255.255.255.0</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">//start the two nics</span><br><span class="line"><span class="comment"># ifup enp0s3</span></span><br><span class="line"><span class="comment"># ifup enp0s9</span></span><br></pre></td></tr></table></figure>
<h3 id="configure-NTP-by-editing-etc-chrony-chrony-conf-1"><a href="#configure-NTP-by-editing-etc-chrony-chrony-conf-1" class="headerlink" title="configure NTP by editing /etc/chrony/chrony.conf"></a>configure NTP by editing <code>/etc/chrony/chrony.conf</code></h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server 10.20.0.10 iburst</span><br></pre></td></tr></table></figure>
<p>change hostname and hosts</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># echo storage &gt; /etc/hostname</span></span><br><span class="line"><span class="comment"># echo 10.20.0.10    controller &gt;&gt; /etc/hosts</span></span><br><span class="line"><span class="comment"># echo 10.20.0.20    compute &gt;&gt; /etc/hosts</span></span><br><span class="line"><span class="comment"># hostname storage</span></span><br></pre></td></tr></table></figure>
<h3 id="Check-new-disk-was-there-already"><a href="#Check-new-disk-was-there-already" class="headerlink" title="Check new disk was there already"></a>Check new disk was there already</h3><p>check by <code>fdisk -l</code> , /dev/sdb is there :-) .</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@storage:~<span class="comment"># fdisk -l</span></span><br><span class="line">Disk /dev/sda: 50 GiB, 53687091200 bytes, 104857600 sectors</span><br><span class="line">Units: sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">Disklabel <span class="built_in">type</span>: dos</span><br><span class="line">Disk identifier: 0x3ce50a75</span><br><span class="line"></span><br><span class="line">Device     Boot   Start       End   Sectors  Size Id Type</span><br><span class="line">/dev/sda1  *       2048    999423    997376  487M 83 Linux</span><br><span class="line">/dev/sda2       1001470 104855551 103854082 49.5G  5 Extended</span><br><span class="line">/dev/sda5       1001472 104855551 103854080 49.5G 8e Linux LVM</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disk /dev/sdb: 50 GiB, 53687091200 bytes, 104857600 sectors</span><br><span class="line">Units: sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disk /dev/mapper/ubuntu--vg-root: 45.5 GiB, 48876224512 bytes, 95461376 sectors</span><br><span class="line">Units: sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disk /dev/mapper/ubuntu--vg-swap_1: 4 GiB, 4294967296 bytes, 8388608 sectors</span><br><span class="line">Units: sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br></pre></td></tr></table></figure>


<h2 id="Cinder-on-storage-node"><a href="#Cinder-on-storage-node" class="headerlink" title="Cinder on storage node"></a>Cinder on storage node</h2><h3 id="Install-and-configure-a-storage-node"><a href="#Install-and-configure-a-storage-node" class="headerlink" title="Install and configure a storage node"></a>Install and configure a storage node</h3><p>This section describes how to install and configure storage nodes for the Block Storage service. For simplicity, this configuration references one storage node with an empty local block storage device. The instructions use <code>/dev/sdb</code>, but you can substitute a different value for your particular node.</p>
<p>The service provisions logical volumes on this device using the <a href="https://docs.openstack.org/ocata/install-guide-ubuntu/common/glossary.html#term-logical-volume-manager-lvm">LVM</a> driver and provides them to instances via <a href="https://docs.openstack.org/ocata/install-guide-ubuntu/common/glossary.html#term-iscsi-qualified-name-iqn">iSCSI</a> transport. You can follow these instructions with minor modifications to horizontally scale your environment with additional storage nodes.</p>
<h3 id="Prerequisites-4"><a href="#Prerequisites-4" class="headerlink" title="Prerequisites"></a>Prerequisites</h3><p>Before you install and configure the Block Storage service on the storage node, you must prepare the storage device.</p>
<p>Perform these steps on the storage node.</p>
<ol>
<li><p>Install the supporting utility packages:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># apt install lvm2</span></span><br></pre></td></tr></table></figure>
<p> Some distributions include LVM by default.</p>
</li>
<li><p>Create the LVM physical volume <code>/dev/sdb</code>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># pvcreate /dev/sdb</span></span><br><span class="line"></span><br><span class="line">Physical volume <span class="string">&quot;/dev/sdb&quot;</span> successfully created</span><br></pre></td></tr></table></figure></li>
<li><p>Create the LVM volume group <code>cinder-volumes</code>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vgcreate cinder-volumes /dev/sdb</span></span><br><span class="line"></span><br><span class="line">Volume group <span class="string">&quot;cinder-volumes&quot;</span> successfully created</span><br></pre></td></tr></table></figure>
<p>The Block Storage service creates logical volumes in this volume group.</p>
</li>
<li><p>Only instances can access Block Storage volumes. However, the underlying operating system manages the devices associated with the volumes. By default, the LVM volume scanning tool scans the <code>/dev</code> directory for block storage devices that contain volumes. If projects use LVM on their volumes, the scanning tool detects these volumes and attempts to cache them which can cause a variety of problems with both the underlying operating system and project volumes. You must reconfigure LVM to scan only the devices that contain the <code>cinder-volumes</code> volume group. Edit the <code>/etc/lvm/lvm.conf</code> file and complete the following actions:</p>
<ul>
<li><p>In the <code>devices</code> section, add a filter that accepts the <code>/dev/sdb</code> device and rejects all other devices:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">devices &#123;</span><br><span class="line">...</span><br><span class="line">filter = [ <span class="string">&quot;a/sdb/&quot;</span>, <span class="string">&quot;r/.*/&quot;</span>]</span><br></pre></td></tr></table></figure>
<p>Each item in the filter array begins with <code>a</code> for <strong>accept</strong> or <code>r</code> for <strong>reject</strong> and includes a regular expression for the device name. The array must end with <code>r/.*/</code> to reject any remaining devices. You can use the <strong>vgs -vvvv</strong> command to test filters.</p>
<p>If your storage nodes use LVM on the operating system disk, you must also add the associated device to the filter. For example, if the <code>/dev/sda</code> device contains the operating system:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">filter = [ <span class="string">&quot;a/sda/&quot;</span>, <span class="string">&quot;a/sdb/&quot;</span>, <span class="string">&quot;r/.*/&quot;</span>]</span><br><span class="line"></span><br><span class="line">​```bash</span><br><span class="line"></span><br><span class="line">Similarly, <span class="keyword">if</span> your compute nodes use LVM on the operating system disk, you must also modify the filter <span class="keyword">in</span> the`/etc/lvm/lvm.conf` file on those nodes to include only the operating system disk. For example, <span class="keyword">if</span> the `/dev/sda`device contains the operating system:</span><br><span class="line"></span><br><span class="line">​```bash</span><br><span class="line">filter = [ <span class="string">&quot;a/sda/&quot;</span>, <span class="string">&quot;r/.*/&quot;</span>]</span><br></pre></td></tr></table></figure>
<h3 id="Install-and-configure-components-4"><a href="#Install-and-configure-components-4" class="headerlink" title="Install and configure components"></a>Install and configure components</h3></li>
</ul>
</li>
</ol>
<p>Install the packages:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># apt install cinder-volume -y</span></span><br></pre></td></tr></table></figure>
<ol>
<li><p>Edit the <code>/etc/cinder/cinder.conf</code> file and complete the following actions:</p>
<ul>
<li><p>In the <code>[database]</code> section, configure database access:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[database]</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">connection = mysql+pymysql://cinder:CINDER_DBPASS@controller/cinder</span><br></pre></td></tr></table></figure>
<p>Replace <code>CINDER_DBPASS</code> with the password you chose for the Block Storage database.</p>
</li>
<li><p>In the <code>[DEFAULT]</code> section, configure <code>RabbitMQ</code> message queue access:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">transport_url = rabbit://openstack:RABBIT_PASS@controller</span><br></pre></td></tr></table></figure>
<p>Replace <code>RABBIT_PASS</code> with the password you chose for the <code>openstack</code> account in <code>RabbitMQ</code>.</p>
</li>
<li><p>In the <code>[DEFAULT]</code> and <code>[keystone_authtoken]</code> sections, configure Identity service access:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">auth_strategy = keystone</span><br><span class="line"></span><br><span class="line">[keystone_authtoken]</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">auth_uri = http://controller:5000</span><br><span class="line">auth_url = http://controller:35357</span><br><span class="line">memcached_servers = controller:11211</span><br><span class="line">auth_type = password</span><br><span class="line">project_domain_name = default</span><br><span class="line">user_domain_name = default</span><br><span class="line">project_name = service</span><br><span class="line">username = cinder</span><br><span class="line">password = cinder</span><br></pre></td></tr></table></figure>
<p>Replace <code>password</code> with the password you chose for the <code>cinder</code> user in the Identity service.</p>
<p>Comment out or remove any other options in the <code>[keystone_authtoken]</code> section.</p>
</li>
<li><p>In the <code>[DEFAULT]</code> section, configure the <code>my_ip</code> option:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">my_ip = STORAGE_INTERFACE_IP_ADDRESS</span><br></pre></td></tr></table></figure>
<p>Replace <code>STORAGE_INTERFACE_IP_ADDRESS</code> with the IP address of the storage network (eth2).</p>
</li>
</ul>
</li>
</ol>
<ul>
<li><p>In the <code>[lvm]</code> section, configure the LVM back end with the LVM driver, <code>cinder-volumes</code> volume group, iSCSI protocol, and appropriate iSCSI service:</p>
   <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[lvm]</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">volume_driver = cinder.volume.drivers.lvm.LVMVolumeDriver</span><br><span class="line">volume_group = cinder-volumes</span><br><span class="line">iscsi_protocol = iscsi</span><br><span class="line">iscsi_helper = tgtadm</span><br></pre></td></tr></table></figure>
</li>
<li><p>In the <code>[DEFAULT]</code> section, enable the LVM back end:</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">enabled_backends = lvm</span><br></pre></td></tr></table></figure>
<p>  Back-end names are arbitrary. As an example, this guide uses the name of the driver as the name of the back end.</p>
</li>
<li><p>In the <code>[DEFAULT]</code> section, configure the location of the Image service API:</p>
<pre><code> ​```
 [DEFAULT]
 # ...
 glance_api_servers = http://controller:9292
 ​```</code></pre>
<ul>
<li><p>In the <code>[oslo_concurrency]</code> section, configure the lock path:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[oslo_concurrency]</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">lock_path = /var/lib/cinder/tmp</span><br></pre></td></tr></table></figure>
<h3 id="Finalize-installation-6"><a href="#Finalize-installation-6" class="headerlink" title="Finalize installation"></a>Finalize installation</h3></li>
</ul>
</li>
</ul>
<ol>
<li><p>Restart the Block Storage volume service including its dependencies:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># service tgt restart</span></span><br><span class="line"><span class="comment"># service cinder-volume restart</span></span><br></pre></td></tr></table></figure>


</li>
</ol>
<h3 id="Verify-operation-4"><a href="#Verify-operation-4" class="headerlink" title="Verify operation"></a>Verify operation</h3><p>Verify operation of the Block Storage service. </p>
<p>Perform these commands on the controller node.</p>
<ol>
<li><p>Source the <code>admin</code> credentials to gain access to admin-only CLI commands:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ . admin-openrc</span><br></pre></td></tr></table></figure></li>
<li><p>List service components to verify successful launch of each process:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@controller:~<span class="comment"># openstack volume service list</span></span><br><span class="line">+------------------+-------------+------+---------+-------+----------------------------+</span><br><span class="line">| Binary           | Host        | Zone | Status  | State | Updated At                 |</span><br><span class="line">+------------------+-------------+------+---------+-------+----------------------------+</span><br><span class="line">| cinder-scheduler | controller  | nova | enabled | up    | 2017-08-24T14:35:44.000000 |</span><br><span class="line">| cinder-volume    | storage@lvm | nova | enabled | up    | 2017-08-24T14:35:39.000000 |</span><br><span class="line">+------------------+-------------+------+---------+-------+----------------------------+</span><br></pre></td></tr></table></figure>


</li>
</ol>
<h2 id="Let’s-try-something-on-block-storage"><a href="#Let’s-try-something-on-block-storage" class="headerlink" title="Let’s try something on block storage!"></a>Let’s try something on block storage!</h2><h3 id="Create-a-volume"><a href="#Create-a-volume" class="headerlink" title="Create a volume"></a>Create a volume</h3><ol>
<li><p>Source the <code>demo</code> credentials to perform the following steps as a non-administrative project:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ . demo-openrc</span><br></pre></td></tr></table></figure></li>
<li><p>Create a 1 GB volume:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack volume create --size 1 volume1</span><br><span class="line"></span><br><span class="line">+---------------------+--------------------------------------+</span><br><span class="line">| Field               | Value                                |</span><br><span class="line">+---------------------+--------------------------------------+</span><br><span class="line">| attachments         | []                                   |</span><br><span class="line">| availability_zone   | nova                                 |</span><br><span class="line">| bootable            | <span class="literal">false</span>                                |</span><br><span class="line">| consistencygroup_id | None                                 |</span><br><span class="line">| created_at          | 2016-03-08T14:30:48.391027           |</span><br><span class="line">| description         | None                                 |</span><br><span class="line">| encrypted           | False                                |</span><br><span class="line">| id                  | a1e8be72-a395-4a6f-8e07-856a57c39524 |</span><br><span class="line">| multiattach         | False                                |</span><br><span class="line">| name                | volume1                              |</span><br><span class="line">| properties          |                                      |</span><br><span class="line">| replication_status  | disabled                             |</span><br><span class="line">| size                | 1                                    |</span><br><span class="line">| snapshot_id         | None                                 |</span><br><span class="line">| source_volid        | None                                 |</span><br><span class="line">| status              | creating                             |</span><br><span class="line">| <span class="built_in">type</span>                | None                                 |</span><br><span class="line">| updated_at          | None                                 |</span><br><span class="line">| user_id             | 684286a9079845359882afc3aa5011fb     |</span><br><span class="line">+---------------------+--------------------------------------+</span><br></pre></td></tr></table></figure></li>
<li><p>After a short time, the volume status should change from <code>creating</code> to <code>available</code>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@controller:~<span class="comment"># openstack volume list</span></span><br><span class="line">+--------------------------------------+--------------+-----------+------+-------------+</span><br><span class="line">| ID                                   | Display Name | Status    | Size | Attached to |</span><br><span class="line">+--------------------------------------+--------------+-----------+------+-------------+</span><br><span class="line">| 81ffed40-ed71-495d-bfa9-8fb8c72cf222 | volume1      | available |    1 |             |</span><br><span class="line">+--------------------------------------+--------------+-----------+------+-------------+</span><br></pre></td></tr></table></figure></li>
<li><p>check where it is?</p>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@storage:~<span class="comment"># lvdisplay</span></span><br><span class="line">  --- Logical volume ---</span><br><span class="line">  LV Path                /dev/ubuntu-vg/root</span><br><span class="line">  LV Name                root</span><br><span class="line">  VG Name                ubuntu-vg</span><br><span class="line">  LV UUID                NA7DgH-V0Sv-cH8E-wvej-aJmP-6EBO-joXO0C</span><br><span class="line">  LV Write Access        <span class="built_in">read</span>/write</span><br><span class="line">  LV Creation host, time ubuntu, 2017-08-23 16:30:36 +0800</span><br><span class="line">  LV Status              available</span><br><span class="line">  <span class="comment"># open                 1</span></span><br><span class="line">  LV Size                45.52 GiB</span><br><span class="line">  Current LE             11653</span><br><span class="line">  Segments               1</span><br><span class="line">  Allocation             inherit</span><br><span class="line">  Read ahead sectors     auto</span><br><span class="line">  - currently <span class="built_in">set</span> to     256</span><br><span class="line">  Block device           252:0</span><br><span class="line"></span><br><span class="line">  --- Logical volume ---</span><br><span class="line">  LV Path                /dev/ubuntu-vg/swap_1</span><br><span class="line">  LV Name                swap_1</span><br><span class="line">  VG Name                ubuntu-vg</span><br><span class="line">  LV UUID                Vtixi8-qKcP-f1LH-bHqM-E73h-NN7z-eSD2zk</span><br><span class="line">  LV Write Access        <span class="built_in">read</span>/write</span><br><span class="line">  LV Creation host, time ubuntu, 2017-08-23 16:30:36 +0800</span><br><span class="line">  LV Status              available</span><br><span class="line">  <span class="comment"># open                 2</span></span><br><span class="line">  LV Size                4.00 GiB</span><br><span class="line">  Current LE             1024</span><br><span class="line">  Segments               1</span><br><span class="line">  Allocation             inherit</span><br><span class="line">  Read ahead sectors     auto</span><br><span class="line">  - currently <span class="built_in">set</span> to     256</span><br><span class="line">  Block device           252:1</span><br><span class="line"></span><br><span class="line">  --- Logical volume ---</span><br><span class="line">  LV Path                /dev/cinder-volumes/volume-81ffed40-ed71-495d-bfa9-8fb8c72cf222</span><br><span class="line">  LV Name                volume-81ffed40-ed71-495d-bfa9-8fb8c72cf222</span><br><span class="line">  VG Name                cinder-volumes</span><br><span class="line">  LV UUID                6jbPGA-i3Eo-O4ng-8Mf3-IoeF-9WF7-g1DGEA</span><br><span class="line">  LV Write Access        <span class="built_in">read</span>/write</span><br><span class="line">  LV Creation host, time storage, 2017-08-24 22:38:28 +0800</span><br><span class="line">  LV Status              available</span><br><span class="line">  <span class="comment"># open                 0</span></span><br><span class="line">  LV Size                1.00 GiB</span><br><span class="line">  Current LE             256</span><br><span class="line">  Segments               1</span><br><span class="line">  Allocation             inherit</span><br><span class="line">  Read ahead sectors     auto</span><br><span class="line">  - currently <span class="built_in">set</span> to     256</span><br><span class="line">  Block device           252:2</span><br><span class="line"></span><br><span class="line">​```bash</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### Attach the volume to an instance</span></span><br><span class="line"></span><br><span class="line">1.   Attach a volume to an instance:</span><br><span class="line"></span><br><span class="line">  ```bash</span><br><span class="line">  $ openstack server add volume INSTANCE_NAME VOLUME_NAME</span><br></pre></td></tr></table></figure>
<p>  Replace <code>INSTANCE_NAME</code> with the name of the instance and <code>VOLUME_NAME</code> with the name of the volume you want to attach to it.</p>
<p>  <strong>Example</strong></p>
<p>  Attach the <code>volume1</code> volume to the <code>provider-instance</code> instance:</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack server add volume provider-instance volume1</span><br></pre></td></tr></table></figure>
<p>  This command provides no output.</p>
<ol start="2">
<li>  List volumes:</li>
</ol>
<pre><code>  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@controller:~<span class="comment"># openstack volume list</span></span><br><span class="line">+--------------------------------------+--------------+--------+------+--------------------------------------------+</span><br><span class="line">| ID                                   | Display Name | Status | Size | Attached to                                |</span><br><span class="line">+--------------------------------------+--------------+--------+------+--------------------------------------------+</span><br><span class="line">| 81ffed40-ed71-495d-bfa9-8fb8c72cf222 | volume1      | in-use |    1 | Attached to provider-instance on /dev/vdb  |</span><br><span class="line">+--------------------------------------+--------------+--------+------+--------------------------------------------+</span><br><span class="line">    </span><br><span class="line">root@storage:~<span class="comment"># lvdisplay</span></span><br><span class="line">  --- Logical volume ---</span><br><span class="line">  LV Path                /dev/ubuntu-vg/root</span><br><span class="line">  LV Name                root</span><br><span class="line">  VG Name                ubuntu-vg</span><br><span class="line">  LV UUID                NA7DgH-V0Sv-cH8E-wvej-aJmP-6EBO-joXO0C</span><br><span class="line">  LV Write Access        <span class="built_in">read</span>/write</span><br><span class="line">  LV Creation host, time ubuntu, 2017-08-23 16:30:36 +0800</span><br><span class="line">  LV Status              available</span><br><span class="line">  <span class="comment"># open                 1</span></span><br><span class="line">  LV Size                45.52 GiB</span><br><span class="line">  Current LE             11653</span><br><span class="line">  Segments               1</span><br><span class="line">  Allocation             inherit</span><br><span class="line">  Read ahead sectors     auto</span><br><span class="line"></span><br><span class="line"> - currently <span class="built_in">set</span> to     256</span><br><span class="line"> Block device           252:0</span><br><span class="line"></span><br><span class="line"> --- Logical volume ---</span><br><span class="line"> LV Path                /dev/ubuntu-vg/swap_1</span><br><span class="line"> LV Name                swap_1</span><br><span class="line"> VG Name                ubuntu-vg</span><br><span class="line"> LV UUID                Vtixi8-qKcP-f1LH-bHqM-E73h-NN7z-eSD2zk</span><br><span class="line"> LV Write Access        <span class="built_in">read</span>/write</span><br><span class="line"> LV Creation host, time ubuntu, 2017-08-23 16:30:36 +0800</span><br><span class="line"> LV Status              available</span><br><span class="line"> <span class="comment"># open                 2</span></span><br><span class="line"> LV Size                4.00 GiB</span><br><span class="line"> Current LE             1024</span><br><span class="line"> Segments               1</span><br><span class="line"> Allocation             inherit</span><br><span class="line"> Read ahead sectors     auto</span><br><span class="line"> - currently <span class="built_in">set</span> to     256</span><br><span class="line"> Block device           252:1</span><br><span class="line"></span><br><span class="line"> --- Logical volume ---</span><br><span class="line"> LV Path                /dev/cinder-volumes/volume-81ffed40-ed71-495d-bfa9-8fb8c72cf222</span><br><span class="line"> LV Name                volume-81ffed40-ed71-495d-bfa9-8fb8c72cf222</span><br><span class="line"> VG Name                cinder-volumes</span><br><span class="line"> LV UUID                6jbPGA-i3Eo-O4ng-8Mf3-IoeF-9WF7-g1DGEA</span><br><span class="line"> LV Write Access        <span class="built_in">read</span>/write</span><br><span class="line"> LV Creation host, time storage, 2017-08-24 22:38:28 +0800</span><br><span class="line"> LV Status              available</span><br><span class="line"> <span class="comment"># open                 1</span></span><br><span class="line"> LV Size                1.00 GiB</span><br><span class="line"> Current LE             256</span><br><span class="line"> Segments               1</span><br><span class="line"> Allocation             inherit</span><br><span class="line"> Read ahead sectors     auto</span><br><span class="line"> - currently <span class="built_in">set</span> to     256</span><br><span class="line"> Block device           252:2</span><br><span class="line">    </span><br></pre></td></tr></table></figure></code></pre>
<ol start="3">
<li><p>Access your instance using SSH or <code>virsh console</code> and use the <code>fdisk</code> command to verify presence of the volume as the <code>/dev/vdb</code> block storage device:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo fdisk -l</span><br><span class="line"></span><br><span class="line">Disk /dev/vda: 1073 MB, 1073741824 bytes</span><br><span class="line">255 heads, 63 sectors/track, 130 cylinders, total 2097152 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">Disk identifier: 0x00000000</span><br><span class="line"></span><br><span class="line">   Device Boot      Start         End      Blocks   Id  System</span><br><span class="line">/dev/vda1   *       16065     2088449     1036192+  83  Linux</span><br><span class="line"></span><br><span class="line">Disk /dev/vdb: 1073 MB, 1073741824 bytes</span><br><span class="line">16 heads, 63 sectors/track, 2080 cylinders, total 2097152 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">Disk identifier: 0x00000000</span><br><span class="line"></span><br><span class="line">Disk /dev/vdb doesn<span class="string">&#x27;t contain a valid partition table</span></span><br></pre></td></tr></table></figure></li>
<li><p>Check from storage node on iSCSI target point of view, it’s found </p>
<ul>
<li>Initiator: <code>iqn.1993-08.org.debian:01:e7b693dedcab alias: compute</code></li>
<li>LUN 1: <code>Backing store path: /dev/cinder-volumes/volume-81ffed40-ed71-495d-bfa9-8fb8c72cf222</code></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@storage:~<span class="comment"># tgtadm --lld iscsi --op show --mode target</span></span><br><span class="line">Target 1: iqn.2010-10.org.openstack:volume-81ffed40-ed71-495d-bfa9-8fb8c72cf222</span><br><span class="line">    System information:</span><br><span class="line">        Driver: iscsi</span><br><span class="line">        State: ready</span><br><span class="line">    I_T nexus information:</span><br><span class="line">        I_T nexus: 1</span><br><span class="line">            Initiator: iqn.1993-08.org.debian:01:e7b693dedcab <span class="built_in">alias</span>: compute</span><br><span class="line">            Connection: 0</span><br><span class="line">                IP Address: 192.168.199.20</span><br><span class="line">    LUN information:</span><br><span class="line">        LUN: 0</span><br><span class="line">            Type: controller</span><br><span class="line">            SCSI ID: IET     00010000</span><br><span class="line">            SCSI SN: beaf10</span><br><span class="line">            Size: 0 MB, Block size: 1</span><br><span class="line">            Online: Yes</span><br><span class="line">            Removable media: No</span><br><span class="line">            Prevent removal: No</span><br><span class="line">            Readonly: No</span><br><span class="line">            SWP: No</span><br><span class="line">            Thin-provisioning: No</span><br><span class="line">            Backing store <span class="built_in">type</span>: null</span><br><span class="line">            Backing store path: None</span><br><span class="line">            Backing store flags:</span><br><span class="line">        LUN: 1</span><br><span class="line">            Type: disk</span><br><span class="line">            SCSI ID: IET     00010001</span><br><span class="line">            SCSI SN: beaf11</span><br><span class="line">            Size: 1074 MB, Block size: 512</span><br><span class="line">            Online: Yes</span><br><span class="line">            Removable media: No</span><br><span class="line">            Prevent removal: No</span><br><span class="line">            Readonly: No</span><br><span class="line">            SWP: No</span><br><span class="line">            Thin-provisioning: No</span><br><span class="line">            Backing store <span class="built_in">type</span>: rdwr</span><br><span class="line">            Backing store path: /dev/cinder-volumes/volume-81ffed40-ed71-495d-bfa9-8fb8c72cf222</span><br><span class="line">            Backing store flags:</span><br><span class="line">    Account information:</span><br><span class="line">        7jTnhhxXsVM4BwqxG979</span><br><span class="line">    ACL information:</span><br><span class="line">        ALL</span><br></pre></td></tr></table></figure>


</li>
</ol>
<ol start="5">
<li><p>Checking from compute via <code>virsh dumpxml &lt;instance-id&gt;</code></p>
<p>It’s shown the device from initiator point of view:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;disk <span class="built_in">type</span>=<span class="string">&#x27;block&#x27;</span> device=<span class="string">&#x27;disk&#x27;</span>&gt;</span><br><span class="line">  &lt;driver name=<span class="string">&#x27;qemu&#x27;</span> <span class="built_in">type</span>=<span class="string">&#x27;raw&#x27;</span> cache=<span class="string">&#x27;none&#x27;</span> io=<span class="string">&#x27;native&#x27;</span>/&gt;</span><br><span class="line">  &lt;<span class="built_in">source</span> dev=<span class="string">&#x27;/dev/disk/by-path/ip-192.168.199.30:3260-iscsi-iqn.2010-10.org.openstack:volume-81ffed40-ed71-495d-bfa9-8fb8c72cf222-lun-1&#x27;</span>/&gt;</span><br><span class="line">  &lt;backingStore/&gt;</span><br><span class="line">  &lt;target dev=<span class="string">&#x27;vdb&#x27;</span> bus=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span><br><span class="line">  &lt;serial&gt;81ffed40-ed71-495d-bfa9-8fb8c72cf222&lt;/serial&gt;</span><br><span class="line">  &lt;<span class="built_in">alias</span> name=<span class="string">&#x27;virtio-disk1&#x27;</span>/&gt;</span><br><span class="line">  &lt;address <span class="built_in">type</span>=<span class="string">&#x27;pci&#x27;</span> domain=<span class="string">&#x27;0x0000&#x27;</span> bus=<span class="string">&#x27;0x00&#x27;</span> slot=<span class="string">&#x27;0x05&#x27;</span> <span class="keyword">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span><br><span class="line">&lt;/disk&gt;</span><br></pre></td></tr></table></figure>


</li>
</ol>
<h2 id="Heat"><a href="#Heat" class="headerlink" title="Heat"></a>Heat</h2><h3 id="Install-and-configure-1"><a href="#Install-and-configure-1" class="headerlink" title="Install and configure"></a>Install and configure</h3><p>This section describes how to install and configure the Orchestration service for Ubuntu 14.04 (LTS).</p>
<p>While our Ubuntu 16.04.3 LTS will be ok as well. </p>
<h3 id="Prerequisites-5"><a href="#Prerequisites-5" class="headerlink" title="Prerequisites"></a>Prerequisites</h3><p>Before you install and configure Orchestration, you must create a database, service credentials, and API endpoints. Orchestration also requires additional information in the Identity service.</p>
<ol>
<li><p>To create the database, complete these steps:</p>
<ul>
<li>Use the database access client to connect to the database server as the <code>root</code> user:</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mysql</span><br></pre></td></tr></table></figure>
<ul>
<li>Create the <code>heat</code> database:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE DATABASE heat;</span><br></pre></td></tr></table></figure>
<ul>
<li>Grant proper access to the <code>heat</code> database:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">​&#96;&#96;&#96;</span><br><span class="line">GRANT ALL PRIVILEGES ON heat.* TO &#39;heat&#39;@&#39;localhost&#39; \</span><br><span class="line">  IDENTIFIED BY &#39;HEAT_DBPASS&#39;;</span><br><span class="line">GRANT ALL PRIVILEGES ON heat.* TO &#39;heat&#39;@&#39;%&#39; \</span><br><span class="line">  IDENTIFIED BY &#39;HEAT_DBPASS&#39;;</span><br><span class="line">​&#96;&#96;&#96;</span><br><span class="line"></span><br><span class="line">Replace &#96;HEAT_DBPASS&#96; with a suitable password.</span><br></pre></td></tr></table></figure>
<ul>
<li>Exit the database access client.</li>
</ul>
</li>
<li><p>Source the <code>admin</code> credentials to gain access to admin-only CLI commands:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ . admin-openrc</span><br><span class="line"></span><br><span class="line">​```bash</span><br></pre></td></tr></table></figure></li>
<li><p>To create the service credentials, complete these steps:</p>
<ul>
<li><p>Create the <code>heat</code> user:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack user create --domain default --password-prompt heat</span><br><span class="line">User Password:</span><br><span class="line">Repeat User Password:</span><br><span class="line">+-----------+----------------------------------+</span><br><span class="line">| Field     | Value                            |</span><br><span class="line">+-----------+----------------------------------+</span><br><span class="line">| domain_id | e0353a670a9e496da891347c589539e9 |</span><br><span class="line">| enabled   | True                             |</span><br><span class="line">| id        | ca2e175b851943349be29a328cc5e360 |</span><br><span class="line">| name      | heat                             |</span><br><span class="line">+-----------+----------------------------------+</span><br></pre></td></tr></table></figure></li>
<li><p>Add the <code>admin</code> role to the <code>heat</code> user:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack role add --project service --user heat admin</span><br></pre></td></tr></table></figure>
<p>This command provides no output.</p>
</li>
<li><p>Create the <code>heat</code> and <code>heat-cfn</code> service entities:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack service create --name heat \</span><br><span class="line">  --description <span class="string">&quot;Orchestration&quot;</span> orchestration</span><br><span class="line">+-------------+----------------------------------+</span><br><span class="line">| Field       | Value                            |</span><br><span class="line">+-------------+----------------------------------+</span><br><span class="line">| description | Orchestration                    |</span><br><span class="line">| enabled     | True                             |</span><br><span class="line">| id          | 727841c6f5df4773baa4e8a5ae7d72eb |</span><br><span class="line">| name        | heat                             |</span><br><span class="line">| <span class="built_in">type</span>        | orchestration                    |</span><br><span class="line">+-------------+----------------------------------+</span><br><span class="line"></span><br><span class="line">$ openstack service create --name heat-cfn \</span><br><span class="line">  --description <span class="string">&quot;Orchestration&quot;</span>  cloudformation</span><br><span class="line">+-------------+----------------------------------+</span><br><span class="line">| Field       | Value                            |</span><br><span class="line">+-------------+----------------------------------+</span><br><span class="line">| description | Orchestration                    |</span><br><span class="line">| enabled     | True                             |</span><br><span class="line">| id          | c42cede91a4e47c3b10c8aedc8d890c6 |</span><br><span class="line">| name        | heat-cfn                         |</span><br><span class="line">| <span class="built_in">type</span>        | cloudformation                   |</span><br><span class="line">+-------------+----------------------------------+</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>Create the Orchestration service API endpoints:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack endpoint create --region RegionOne \</span><br><span class="line">  orchestration public http://controller:8004/v1/%\(tenant_id\)s</span><br><span class="line">+--------------+-----------------------------------------+</span><br><span class="line">| Field        | Value                                   |</span><br><span class="line">+--------------+-----------------------------------------+</span><br><span class="line">| enabled      | True                                    |</span><br><span class="line">| id           | 3f4dab34624e4be7b000265f25049609        |</span><br><span class="line">| interface    | public                                  |</span><br><span class="line">| region       | RegionOne                               |</span><br><span class="line">| region_id    | RegionOne                               |</span><br><span class="line">| service_id   | 727841c6f5df4773baa4e8a5ae7d72eb        |</span><br><span class="line">| service_name | heat                                    |</span><br><span class="line">| service_type | orchestration                           |</span><br><span class="line">| url          | http://controller:8004/v1/%(tenant_id)s |</span><br><span class="line">+--------------+-----------------------------------------+</span><br><span class="line"></span><br><span class="line">$ openstack endpoint create --region RegionOne \</span><br><span class="line">  orchestration internal http://controller:8004/v1/%\(tenant_id\)s</span><br><span class="line">+--------------+-----------------------------------------+</span><br><span class="line">| Field        | Value                                   |</span><br><span class="line">+--------------+-----------------------------------------+</span><br><span class="line">| enabled      | True                                    |</span><br><span class="line">| id           | 9489f78e958e45cc85570fec7e836d98        |</span><br><span class="line">| interface    | internal                                |</span><br><span class="line">| region       | RegionOne                               |</span><br><span class="line">| region_id    | RegionOne                               |</span><br><span class="line">| service_id   | 727841c6f5df4773baa4e8a5ae7d72eb        |</span><br><span class="line">| service_name | heat                                    |</span><br><span class="line">| service_type | orchestration                           |</span><br><span class="line">| url          | http://controller:8004/v1/%(tenant_id)s |</span><br><span class="line">+--------------+-----------------------------------------+</span><br><span class="line"></span><br><span class="line">$ openstack endpoint create --region RegionOne \</span><br><span class="line">  orchestration admin http://controller:8004/v1/%\(tenant_id\)s</span><br><span class="line">+--------------+-----------------------------------------+</span><br><span class="line">| Field        | Value                                   |</span><br><span class="line">+--------------+-----------------------------------------+</span><br><span class="line">| enabled      | True                                    |</span><br><span class="line">| id           | 76091559514b40c6b7b38dde790efe99        |</span><br><span class="line">| interface    | admin                                   |</span><br><span class="line">| region       | RegionOne                               |</span><br><span class="line">| region_id    | RegionOne                               |</span><br><span class="line">| service_id   | 727841c6f5df4773baa4e8a5ae7d72eb        |</span><br><span class="line">| service_name | heat                                    |</span><br><span class="line">| service_type | orchestration                           |</span><br><span class="line">| url          | http://controller:8004/v1/%(tenant_id)s |</span><br><span class="line">+--------------+-----------------------------------------+</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack endpoint create --region RegionOne \</span><br><span class="line">  cloudformation public http://controller:8000/v1</span><br><span class="line">+--------------+----------------------------------+</span><br><span class="line">| Field        | Value                            |</span><br><span class="line">+--------------+----------------------------------+</span><br><span class="line">| enabled      | True                             |</span><br><span class="line">| id           | b3ea082e019c4024842bf0a80555052c |</span><br><span class="line">| interface    | public                           |</span><br><span class="line">| region       | RegionOne                        |</span><br><span class="line">| region_id    | RegionOne                        |</span><br><span class="line">| service_id   | c42cede91a4e47c3b10c8aedc8d890c6 |</span><br><span class="line">| service_name | heat-cfn                         |</span><br><span class="line">| service_type | cloudformation                   |</span><br><span class="line">| url          | http://controller:8000/v1        |</span><br><span class="line">+--------------+----------------------------------+</span><br><span class="line"></span><br><span class="line">$ openstack endpoint create --region RegionOne \</span><br><span class="line">  cloudformation internal http://controller:8000/v1</span><br><span class="line">+--------------+----------------------------------+</span><br><span class="line">| Field        | Value                            |</span><br><span class="line">+--------------+----------------------------------+</span><br><span class="line">| enabled      | True                             |</span><br><span class="line">| id           | 169df4368cdc435b8b115a9cb084044e |</span><br><span class="line">| interface    | internal                         |</span><br><span class="line">| region       | RegionOne                        |</span><br><span class="line">| region_id    | RegionOne                        |</span><br><span class="line">| service_id   | c42cede91a4e47c3b10c8aedc8d890c6 |</span><br><span class="line">| service_name | heat-cfn                         |</span><br><span class="line">| service_type | cloudformation                   |</span><br><span class="line">| url          | http://controller:8000/v1        |</span><br><span class="line">+--------------+----------------------------------+</span><br><span class="line"></span><br><span class="line">$ openstack endpoint create --region RegionOne \</span><br><span class="line">  cloudformation admin http://controller:8000/v1</span><br><span class="line">+--------------+----------------------------------+</span><br><span class="line">| Field        | Value                            |</span><br><span class="line">+--------------+----------------------------------+</span><br><span class="line">| enabled      | True                             |</span><br><span class="line">| id           | 3d3edcd61eb343c1bbd629aa041ff88b |</span><br><span class="line">| interface    | internal                         |</span><br><span class="line">| region       | RegionOne                        |</span><br><span class="line">| region_id    | RegionOne                        |</span><br><span class="line">| service_id   | c42cede91a4e47c3b10c8aedc8d890c6 |</span><br><span class="line">| service_name | heat-cfn                         |</span><br><span class="line">| service_type | cloudformation                   |</span><br><span class="line">| url          | http://controller:8000/v1        |</span><br><span class="line">+--------------+----------------------------------+</span><br></pre></td></tr></table></figure></li>
<li><p>Orchestration requires additional information in the Identity service to manage stacks. To add this information, complete these steps:</p>
<ul>
<li><p>Create the <code>heat</code> domain that contains projects and users for stacks:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack domain create --description <span class="string">&quot;Stack projects and users&quot;</span> heat</span><br><span class="line">+-------------+----------------------------------+</span><br><span class="line">| Field       | Value                            |</span><br><span class="line">+-------------+----------------------------------+</span><br><span class="line">| description | Stack projects and users         |</span><br><span class="line">| enabled     | True                             |</span><br><span class="line">| id          | 0f4d1bd326f2454dacc72157ba328a47 |</span><br><span class="line">| name        | heat                             |</span><br><span class="line">+-------------+----------------------------------+</span><br></pre></td></tr></table></figure></li>
<li><p>Create the <code>heat_domain_admin</code> user to manage projects and users in the <code>heat</code> domain:</p>
<blockquote>
<p>here i gave password: heat_domain_admin</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack user create --domain heat --password-prompt heat_domain_admin</span><br><span class="line">User Password:</span><br><span class="line">Repeat User Password:</span><br><span class="line">+-----------+----------------------------------+</span><br><span class="line">| Field     | Value                            |</span><br><span class="line">+-----------+----------------------------------+</span><br><span class="line">| domain_id | 0f4d1bd326f2454dacc72157ba328a47 |</span><br><span class="line">| enabled   | True                             |</span><br><span class="line">| id        | b7bd1abfbcf64478b47a0f13cd4d970a |</span><br><span class="line">| name      | heat_domain_admin                |</span><br><span class="line">+-----------+----------------------------------+</span><br></pre></td></tr></table></figure></li>
<li><p>Add the <code>admin</code> role to the <code>heat_domain_admin</code> user in the <code>heat</code> domain to enable administrative stack management privileges by the <code>heat_domain_admin</code> user:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack role add --domain heat --user-domain heat --user heat_domain_admin admin</span><br></pre></td></tr></table></figure>
<p>This command provides no output.</p>
</li>
<li><p>Create the <code>heat_stack_owner</code> role:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack role create heat_stack_owner</span><br><span class="line">+-----------+----------------------------------+</span><br><span class="line">| Field     | Value                            |</span><br><span class="line">+-----------+----------------------------------+</span><br><span class="line">| domain_id | None                             |</span><br><span class="line">| id        | 15e34f0c4fed4e68b3246275883c8630 |</span><br><span class="line">| name      | heat_stack_owner                 |</span><br><span class="line">+-----------+----------------------------------+</span><br></pre></td></tr></table></figure></li>
<li><p>Add the <code>heat_stack_owner</code> role to the <code>demo</code> project and user to enable stack management by the <code>demo</code> user:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack role add --project demo --user demo heat_stack_owner</span><br></pre></td></tr></table></figure>
<p>This command provides no output.</p>
<blockquote>
<p> You must add the <code>heat_stack_owner</code> role to each user that manages stacks.</p>
</blockquote>
</li>
<li><p>Create the <code>heat_stack_user</code> role:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack role create heat_stack_user</span><br><span class="line">+-----------+----------------------------------+</span><br><span class="line">| Field     | Value                            |</span><br><span class="line">+-----------+----------------------------------+</span><br><span class="line">| domain_id | None                             |</span><br><span class="line">| id        | 88849d41a55d4d1d91e4f11bffd8fc5c |</span><br><span class="line">| name      | heat_stack_user                  |</span><br><span class="line">+-----------+----------------------------------+</span><br></pre></td></tr></table></figure>
<p>The Orchestration service automatically assigns the <code>heat_stack_user</code> role to users that it creates during stack deployment. By default, this role restricts API &lt;Application Programming Interface (API)&gt; operations. To avoid conflicts, do not add this role to users with the <code>heat_stack_owner</code> role.</p>
</li>
</ul>
</li>
</ol>
<h3 id="Install-and-configure-components-5"><a href="#Install-and-configure-components-5" class="headerlink" title="Install and configure components"></a>Install and configure components</h3><p>Install the packages:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># apt-get install heat-api heat-api-cfn heat-engine</span></span><br></pre></td></tr></table></figure>
<ol>
<li><p>Edit the <code>/etc/heat/heat.conf</code> file and complete the following actions:</p>
<ul>
<li><p>In the <code>[database]</code> section, configure database access:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[database]</span><br><span class="line">...</span><br><span class="line">connection = mysql+pymysql://heat:HEAT_DBPASS@controller/heat</span><br></pre></td></tr></table></figure>
<p>Replace <code>HEAT_DBPASS</code> with the password you chose for the Orchestration database.</p>
</li>
<li><p>In the <code>[DEFAULT]</code> section, configure <code>RabbitMQ</code> message queue access:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line">...</span><br><span class="line">transport_url = rabbit://openstack:RABBIT_PASS@controller</span><br></pre></td></tr></table></figure>
<p>Replace <code>RABBIT_PASS</code> with the password you chose for the <code>openstack</code> account in <code>RabbitMQ</code>.</p>
</li>
<li><p>In the <code>[keystone_authtoken]</code>, <code>[trustee]</code> and <code>[clients_keystone]</code> sections, configure Identity service access:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[keystone_authtoken]</span><br><span class="line">...</span><br><span class="line">auth_uri = http://controller:5000</span><br><span class="line">auth_url = http://controller:35357</span><br><span class="line">memcached_servers = controller:11211</span><br><span class="line">auth_type = password</span><br><span class="line">project_domain_name = default</span><br><span class="line">user_domain_name = default</span><br><span class="line">project_name = service</span><br><span class="line">username = heat</span><br><span class="line">password = HEAT_PASS</span><br><span class="line"></span><br><span class="line">[trustee]</span><br><span class="line">...</span><br><span class="line">auth_type = password</span><br><span class="line">auth_url = http://controller:35357</span><br><span class="line">username = heat</span><br><span class="line">password = heat</span><br><span class="line">user_domain_name = default</span><br><span class="line"></span><br><span class="line">[clients_keystone]</span><br><span class="line">...</span><br><span class="line">auth_uri = http://controller:5000</span><br></pre></td></tr></table></figure>
<p>Replace <code>password</code> with the password you chose for the <code>heat</code> user in the Identity service.</p>
</li>
<li><p>In the <code>[DEFAULT]</code> section, configure the metadata and wait condition URLs:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line">...</span><br><span class="line">heat_metadata_server_url = http://controller:8000</span><br><span class="line">heat_waitcondition_server_url = http://controller:8000/v1/waitcondition</span><br></pre></td></tr></table></figure></li>
<li><p>In the <code>[DEFAULT]</code> section, configure the stack domain and administrative credentials:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line">...</span><br><span class="line">stack_domain_admin = heat_domain_admin</span><br><span class="line">stack_domain_admin_password = heat_domain_admin</span><br><span class="line">stack_user_domain_name = heat</span><br></pre></td></tr></table></figure>
<p>Replace <code>heat_domain_admin</code> with the password you chose for the <code>heat_domain_admin</code> user in the Identity service.</p>
</li>
</ul>
</li>
<li><p>Populate the Orchestration database:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># su -s /bin/sh -c &quot;heat-manage db_sync&quot; heat</span></span><br></pre></td></tr></table></figure>
<p>Ignore any deprecation messages in this output.</p>
</li>
</ol>
<h3 id="Finalize-installation-7"><a href="#Finalize-installation-7" class="headerlink" title="Finalize installation"></a>Finalize installation</h3><ol>
<li><p>Restart the Orchestration services:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># service heat-api restart</span></span><br><span class="line"><span class="comment"># service heat-api-cfn restart</span></span><br><span class="line"><span class="comment"># service heat-engine restart</span></span><br></pre></td></tr></table></figure>
<h3 id="Verify-operation-5"><a href="#Verify-operation-5" class="headerlink" title="Verify operation"></a>Verify operation</h3></li>
</ol>
<p>Verify operation of the Orchestration service. </p>
<p>Perform these commands on the controller node.</p>
<ol>
<li><p>Source the <code>admin</code> tenant credentials:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ . admin-openrc</span><br></pre></td></tr></table></figure></li>
<li><p>List service components to verify successful launch and registration of each process:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack orchestration service list</span><br><span class="line">+------------+-------------+--------------------------------------+------------+--------+----------------------------+--------+</span><br><span class="line">| hostname   | binary      | engine_id                            | host       | topic  | updated_at                 | status |</span><br><span class="line">+------------+-------------+--------------------------------------+------------+--------+----------------------------+--------+</span><br><span class="line">| controller | heat-engine | 3e85d1ab-a543-41aa-aa97-378c381fb958 | controller | engine | 2015-10-13T14:16:06.000000 | up     |</span><br><span class="line">| controller | heat-engine | 45dbdcf6-5660-4d5f-973a-c4fc819da678 | controller | engine | 2015-10-13T14:16:06.000000 | up     |</span><br><span class="line">| controller | heat-engine | 51162b63-ecb8-4c6c-98c6-993af899c4f7 | controller | engine | 2015-10-13T14:16:06.000000 | up     |</span><br><span class="line">| controller | heat-engine | 8d7edc6d-77a6-460d-bd2a-984d76954646 | controller | engine | 2015-10-13T14:16:06.000000 | up     |</span><br><span class="line">+------------+-------------+--------------------------------------+------------+--------+----------------------------+--------+</span><br></pre></td></tr></table></figure>
<p>This output should indicate four <code>heat-engine</code> components (default to 4 or number of CPUs on the host, whichever is greater) on the controller node.</p>
</li>
</ol>
<h2 id="ISSUE-list-heat-service-failure"><a href="#ISSUE-list-heat-service-failure" class="headerlink" title="[ISSUE] list heat service failure"></a>[ISSUE] list heat service failure</h2><h3 id="error-occurred-during-openstack-orchestration-service-list"><a href="#error-occurred-during-openstack-orchestration-service-list" class="headerlink" title="error occurred during openstack orchestration service list"></a>error occurred during <code>openstack orchestration service list</code></h3><p>the initial output is very nonsense as below:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># openstack orchestration service list</span></span><br><span class="line">ERROR: None</span><br></pre></td></tr></table></figure>
<p> give <code>--debug</code> to have detailed information</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">REQ: curl -g -i -X GET http://controller:8004/v1/78c9c849237649a3a8c4526167427589/services -H <span class="string">&quot;User-Agent: python-heatclient&quot;</span> -H <span class="string">&quot;Accept: application/json&quot;</span> -H <span class="string">&quot;X-Auth-Token: &#123;SHA1&#125;d4b406278269babd78368ed572cbe50382938cb6&quot;</span></span><br><span class="line">Starting new HTTP connection (1): controller</span><br><span class="line">http://controller:8004 <span class="string">&quot;GET /v1/78c9c849237649a3a8c4526167427589/services HTTP/1.1&quot;</span> 503 170</span><br><span class="line">RESP: [503] Content-Length: 170 Content-Type: application/json; charset=UTF-8 X-Openstack-Request-Id: req-e38d405a-776d-44fa-bb31-e180d62c42e0 Date: Fri, 25 Aug 2017 06:05:45 GMT Connection: keep-alive</span><br><span class="line">RESP BODY: &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;The server is currently unavailable. Please try again at a later time.&lt;br /&gt;&lt;br /&gt;\n\n\n&quot;</span>, <span class="string">&quot;code&quot;</span>: <span class="string">&quot;503 Service Unavailable&quot;</span>, <span class="string">&quot;title&quot;</span>: <span class="string">&quot;Service Unavailable&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">GET call to orchestration <span class="keyword">for</span> http://controller:8004/v1/78c9c849237649a3a8c4526167427589/services used request id req-e38d405a-776d-44fa-bb31-e180d62c42e0</span><br><span class="line">ERROR: None</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python2.7/dist-packages/cliff/app.py&quot;</span>, line 400, <span class="keyword">in</span> run_subcommand</span><br><span class="line">    result = cmd.run(parsed_args)</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python2.7/dist-packages/osc_lib/command/command.py&quot;</span>, line 41, <span class="keyword">in</span> run</span><br><span class="line">    <span class="built_in">return</span> super(Command, self).run(parsed_args)</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python2.7/dist-packages/cliff/display.py&quot;</span>, line 112, <span class="keyword">in</span> run</span><br><span class="line">    column_names, data = self.take_action(parsed_args)</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python2.7/dist-packages/heatclient/osc/v1/service.py&quot;</span>, line 37, <span class="keyword">in</span> take_action</span><br><span class="line"></span><br><span class="line">  File <span class="string">&quot;/usr/lib/python2.7/dist-packages/heatclient/v1/services.py&quot;</span>, line 33, <span class="keyword">in</span> list</span><br><span class="line">    <span class="built_in">return</span> self._list(url, <span class="string">&quot;services&quot;</span>)</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python2.7/dist-packages/heatclient/common/base.py&quot;</span>, line 114, <span class="keyword">in</span> _list</span><br><span class="line"></span><br><span class="line">  File <span class="string">&quot;/usr/lib/python2.7/dist-packages/keystoneauth1/adapter.py&quot;</span>, line 217, <span class="keyword">in</span> get</span><br><span class="line">    <span class="built_in">return</span> self.request(url, <span class="string">&#x27;GET&#x27;</span>, **kwargs)</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python2.7/dist-packages/heatclient/common/http.py&quot;</span>, line 318, <span class="keyword">in</span> request</span><br><span class="line">    raise exc.from_response(resp)</span><br><span class="line">HTTPServiceUnavailable: ERROR: None</span><br><span class="line">clean_up ListService: ERROR: None</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python2.7/dist-packages/osc_lib/shell.py&quot;</span>, line 135, <span class="keyword">in</span> run</span><br><span class="line">    ret_val = super(OpenStackShell, self).run(argv)</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python2.7/dist-packages/cliff/app.py&quot;</span>, line 279, <span class="keyword">in</span> run</span><br><span class="line">    result = self.run_subcommand(remainder)</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python2.7/dist-packages/osc_lib/shell.py&quot;</span>, line 180, <span class="keyword">in</span> run_subcommand</span><br><span class="line">    ret_value = super(OpenStackShell, self).run_subcommand(argv)</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python2.7/dist-packages/cliff/app.py&quot;</span>, line 400, <span class="keyword">in</span> run_subcommand</span><br><span class="line">    result = cmd.run(parsed_args)</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python2.7/dist-packages/osc_lib/command/command.py&quot;</span>, line 41, <span class="keyword">in</span> run</span><br><span class="line">    <span class="built_in">return</span> super(Command, self).run(parsed_args)</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python2.7/dist-packages/cliff/display.py&quot;</span>, line 112, <span class="keyword">in</span> run</span><br><span class="line">    column_names, data = self.take_action(parsed_args)</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python2.7/dist-packages/heatclient/osc/v1/service.py&quot;</span>, line 37, <span class="keyword">in</span> take_action</span><br><span class="line">    services = heat_client.services.list()</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python2.7/dist-packages/heatclient/v1/services.py&quot;</span>, line 33, <span class="keyword">in</span> list</span><br><span class="line">    <span class="built_in">return</span> self._list(url, <span class="string">&quot;services&quot;</span>)</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python2.7/dist-packages/heatclient/common/base.py&quot;</span>, line 114, <span class="keyword">in</span> _list</span><br><span class="line">    body = self.client.get(url).json()</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python2.7/dist-packages/keystoneauth1/adapter.py&quot;</span>, line 217, <span class="keyword">in</span> get</span><br><span class="line">    <span class="built_in">return</span> self.request(url, <span class="string">&#x27;GET&#x27;</span>, **kwargs)</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python2.7/dist-packages/heatclient/common/http.py&quot;</span>, line 318, <span class="keyword">in</span> request</span><br><span class="line">    raise exc.from_response(resp)</span><br><span class="line">HTTPServiceUnavailable: ERROR: None</span><br><span class="line"></span><br><span class="line">END <span class="built_in">return</span> value: 1</span><br></pre></td></tr></table></figure>
<p>We could see it got <code>503</code> when performing api call in <code>8004</code> port</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">REQ: curl -g -i -X GET http://controller:8004/v1/78c9c849237649a3a8c4526167427589/services -H <span class="string">&quot;User-Agent: python-heatclient&quot;</span> -H <span class="string">&quot;Accept: application/json&quot;</span> -H <span class="string">&quot;X-Auth-Token: &#123;SHA1&#125;d4b406278269babd78368ed572cbe50382938cb6&quot;</span></span><br><span class="line">Starting new HTTP connection (1): controller</span><br><span class="line">http://controller:8004 <span class="string">&quot;GET /v1/78c9c849237649a3a8c4526167427589/services HTTP/1.1&quot;</span> 503 170</span><br><span class="line">RESP: [503] Content-Length: 170 Content-Type: application/json; charset=UTF-8 X-Openstack-Request-Id: req-e38d405a-776d-44fa-bb31-e180d62c42e0 Date: Fri, 25 Aug 2017 06:05:45 GMT Connection: keep-alive</span><br><span class="line">RESP BODY: &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;The server is currently unavailable. Please try again at a later time.&lt;br /&gt;&lt;br /&gt;\n\n\n&quot;</span>, <span class="string">&quot;code&quot;</span>: <span class="string">&quot;503 Service Unavailable&quot;</span>, <span class="string">&quot;title&quot;</span>: <span class="string">&quot;Service Unavailable&quot;</span>&#125;</span><br></pre></td></tr></table></figure>
<p>it’s checked to be heat wsgi service</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># openstack endpoint list | grep 8004</span></span><br><span class="line">| 1d6153de2a7a4bfc8f5277b360d5b695 | RegionOne | heat         | orchestration  | True    | internal  | http://controller:8004/v1/%(tenant_id)s   |</span><br><span class="line">| 38dd2f686f5840e6ae9381b6df1076d8 | RegionOne | heat         | orchestration  | True    | admin     | http://controller:8004/v1/%(tenant_id)s   |</span><br><span class="line">| 88b0e0667eb149efa337e6e0428c98ad | RegionOne | heat         | orchestration  | True    | public    | http://controller:8004/v1/%(tenant_id)s   |</span><br></pre></td></tr></table></figure>
<p>Then let’s check <code>503</code> in <code>/var/log/heat/heat-api.log</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">2017-08-25 14:24:48.962 2778 WARNING keystonemiddleware.auth_token [-] Identity response: &#123;<span class="string">&quot;error&quot;</span>: &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;The request you have made requires authentication.&quot;</span>, <span class="string">&quot;code&quot;</span>: 401, <span class="string">&quot;title&quot;</span>: <span class="string">&quot;Unauthorized&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>it’s keystone <code>401</code> meaning the credential is with issues when requesting token from keystone, let us check keystone logs:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># grep &quot;Authorization failed&quot; /var/log/apache2/keyston*.log</span></span><br><span class="line"></span><br><span class="line">/var/<span class="built_in">log</span>/apache2/keystone.log:2017-08-25 14:24:48.954127 2017-08-25 14:24:48.953 3388 WARNING keystone.common.wsgi [req-fc1e6351-ab7a-40e3-967d-4e7376ced9d9 - - - - -] Authorization failed. The request you have made requires authentication. from 10.20.0.10</span><br></pre></td></tr></table></figure>
<h3 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h3><p>Where the credential for heat keystone call was configured? <code>/etc/heat/heat.conf</code> , it turned out we set wrong password for keystone, the one we set was <code>heat</code> while HEAT_PASS was configured, changed it as below and restart services will solve the issue.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[keystone_authtoken]</span><br><span class="line">...</span><br><span class="line">password = heat</span><br><span class="line"></span><br><span class="line">[trustee]</span><br><span class="line">...</span><br><span class="line">password = heat</span><br></pre></td></tr></table></figure>
<p>restart services to make it work</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># service heat-api restart</span></span><br><span class="line"><span class="comment"># service heat-api-cfn restart</span></span><br><span class="line"><span class="comment"># service heat-engine restart</span></span><br></pre></td></tr></table></figure>
<p>and verify it:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@controller:/var/<span class="built_in">log</span><span class="comment"># openstack orchestration service list --max-width 85 </span></span><br><span class="line">+------------+------------+------------+------------+--------+-------------+--------+</span><br><span class="line">| Hostname   | Binary     | Engine ID  | Host       | Topic  | Updated At  | Status |</span><br><span class="line">+------------+------------+------------+------------+--------+-------------+--------+</span><br><span class="line">| controller | heat-      | 07ff1da7   | controller | engine | 2017-08-25T | up     |</span><br><span class="line">|            | engine     | -a77b-4d52 |            |        | 06:49:36.00 |        |</span><br><span class="line">|            |            | -95e6-cb53 |            |        | 0000        |        |</span><br><span class="line">|            |            | 89a106dc   |            |        |             |        |</span><br><span class="line">|            | engine     | de8-45eb-9 |            |        | 06:24:52.00 |        |</span><br><span class="line">|            |            | 839-4d038d |            |        | 0000        |        |</span><br><span class="line">|            |            | a4a330     |            |        |             |        |</span><br><span class="line">| controller | heat-      | 279303d6-2 | controller | engine | 2017-08-25T | up     |</span><br><span class="line">|            | engine     | d06-4e55-b |            |        | 06:49:36.00 |        |</span><br><span class="line">|            |            | 931-2c8ad0 |            |        | 0000        |        |</span><br><span class="line">|            |            | eadca7     |            |        |             |        |</span><br><span class="line">| controller | heat-      | 2cd3a832-d | controller | engine | 2017-08-25T | up     |</span><br><span class="line">|            | engine     | c21-4cfa-  |            |        | 06:49:36.00 |        |</span><br><span class="line">|            |            | 8a4b-bddd8 |            |        | 0000        |        |</span><br><span class="line">|            |            | dadba12    |            |        |             |        |</span><br><span class="line">| controller | heat-      | e1b05787   | controller | engine | 2017-08-25T | up     |</span><br><span class="line">|            | engine     | -9eda-46c3 |            |        | 06:49:36.00 |        |</span><br><span class="line">|            |            | -acca-b1f9 |            |        | 0000        |        |</span><br><span class="line">|            |            | bcf7b653   |            |        |             |        |</span><br><span class="line">|            | engine     | 1fa-4844-9 |            |        | 06:24:52.00 |        |</span><br><span class="line">|            |            | f68-688486 |            |        | 0000        |        |</span><br><span class="line">|            |            | f4ccfb     |            |        |             |        |</span><br><span class="line">|            | engine     | 023-4d10   |            |        | 06:24:52.00 |        |</span><br><span class="line">|            |            | -89ea-30af |            |        | 0000        |        |</span><br><span class="line">|            |            | f5430d25   |            |        |             |        |</span><br><span class="line">|            | engine     | b86-41af-  |            |        | 06:24:52.00 |        |</span><br><span class="line">|            |            | 895a-0c43a |            |        | 0000        |        |</span><br><span class="line">|            |            | f016950    |            |        |             |        |</span><br><span class="line">+------------+------------+------------+------------+--------+-------------+--------+</span><br></pre></td></tr></table></figure>


<h2 id="Start-Orchestration-let’s-start-from-a-single-instance-HOT"><a href="#Start-Orchestration-let’s-start-from-a-single-instance-HOT" class="headerlink" title="Start Orchestration! let’s start from a single instance HOT"></a>Start Orchestration! let’s start from a single instance HOT</h2><blockquote>
<p>ref: <a href="https://docs.openstack.org/heat/latest/install/launch-instance.html">https://docs.openstack.org/heat/latest/install/launch-instance.html</a></p>
</blockquote>
<p>In environments that include the Orchestration service, you can create a stack that launches an instance.</p>
<h3 id="Create-a-template"><a href="#Create-a-template" class="headerlink" title="Create a template"></a>Create a template</h3><p>The Orchestration service uses templates to describe stacks. To learn about the template language, see <a href="http://docs.openstack.org/developer/heat/template_guide/index.html">the Template Guide</a> in the <a href="http://docs.openstack.org/developer/heat/index.html">Heat developer documentation</a>.</p>
<ul>
<li><p> Create the <code>HOT-demo.yml</code> file with the following content:</p>
<blockquote>
<p>You could fetch it from here to avoid format error: </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># wget https:&#x2F;&#x2F;github.com&#x2F;wey-gu&#x2F;workshops&#x2F;raw&#x2F;master&#x2F;00-Openstack-Basic&#x2F;HOT-demo.yml</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">heat_template_version: 2015-10-15</span><br><span class="line">description: Launch a basic instance with CirrOS image using the</span><br><span class="line">             ``m1.nano`` flavor,  and one network.</span><br><span class="line"></span><br><span class="line">parameters:</span><br><span class="line">  NetID:</span><br><span class="line">    <span class="built_in">type</span>: string</span><br><span class="line">    description: Network ID to use <span class="keyword">for</span> the instance.</span><br><span class="line"></span><br><span class="line">resources:</span><br><span class="line">  server:</span><br><span class="line">    <span class="built_in">type</span>: OS::Nova::Server</span><br><span class="line">    properties:</span><br><span class="line">      image: cirros</span><br><span class="line">      flavor: m1.nano</span><br><span class="line">      networks:</span><br><span class="line">      - network: &#123; get_param: NetID &#125;       </span><br><span class="line">outputs:</span><br><span class="line">  instance_name:</span><br><span class="line">    description: Name of the instance.</span><br><span class="line">    value: &#123; get_attr: [ server, name ] &#125;</span><br><span class="line">  instance_ip:</span><br><span class="line">    description: IP address of the instance.</span><br><span class="line">    value: &#123; get_attr: [ server, first_address ] &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Create-a-stack"><a href="#Create-a-stack" class="headerlink" title="Create a stack"></a>Create a stack</h3><p>Create a stack using the <code>demo-template.yml</code> template.</p>
<ol>
<li><p>Source the <code>demo</code> credentials to perform the following steps as a non-administrative project:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ . demo-openrc</span><br></pre></td></tr></table></figure></li>
<li><p>Determine available networks.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@controller:~<span class="comment"># openstack network list</span></span><br><span class="line">+--------------------------------------+----------+--------------------------------------+</span><br><span class="line">| ID                                   | Name     | Subnets                              |</span><br><span class="line">+--------------------------------------+----------+--------------------------------------+</span><br><span class="line">| 2a33434f-ba29-4645-9b5d-24f1509066f1 | provider | 9b118521-59b5-40ee-a439-9d59c3b392ea |</span><br><span class="line">+--------------------------------------+----------+--------------------------------------+</span><br></pre></td></tr></table></figure>
<p>This output may differ from your environment.</p>
</li>
<li><p>Set the <code>NET_ID</code> environment variable to reflect the ID of a network. For example, using the provider network:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">export</span> NET_ID=$(openstack network list | awk <span class="string">&#x27;/ provider / &#123; print $2 &#125;&#x27;</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>Create a stack of one CirrOS instance on the provider network:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack stack create -t HOT-demo.yml --parameter <span class="string">&quot;NetID=<span class="variable">$NET_ID</span>&quot;</span> stack</span><br><span class="line">+--------------------------------------+------------+--------------------+---------------------+--------------+</span><br><span class="line">| ID                                   | Stack Name | Stack Status       | Creation Time       | Updated Time |</span><br><span class="line">+--------------------------------------+------------+--------------------+---------------------+--------------+</span><br><span class="line">| dbf46d1b-0b97-4d45-a0b3-9662a1eb6cf3 | stack      | CREATE_IN_PROGRESS | 2015-10-13T15:27:20 | None         |</span><br><span class="line">+--------------------------------------+------------+--------------------+---------------------+--------------+</span><br></pre></td></tr></table></figure></li>
<li><p>After a short time, verify successful creation of the stack:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack stack list</span><br><span class="line">+--------------------------------------+------------+-----------------+---------------------+--------------+</span><br><span class="line">| ID                                   | Stack Name | Stack Status    | Creation Time       | Updated Time |</span><br><span class="line">+--------------------------------------+------------+-----------------+---------------------+--------------+</span><br><span class="line">| dbf46d1b-0b97-4d45-a0b3-9662a1eb6cf3 | stack      | CREATE_COMPLETE | 2015-10-13T15:27:20 | None         |</span><br><span class="line">+--------------------------------------+------------+-----------------+---------------------+--------------+</span><br></pre></td></tr></table></figure></li>
<li><p>Show the name and IP address of the instance and compare with the output of the OpenStack client:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@controller:~<span class="comment"># openstack stack output show --all stack</span></span><br><span class="line">+---------------+-------------------------------------------------+</span><br><span class="line">| Field         | Value                                           |</span><br><span class="line">+---------------+-------------------------------------------------+</span><br><span class="line">| instance_name | &#123;                                               |</span><br><span class="line">|               |   <span class="string">&quot;output_value&quot;</span>: <span class="string">&quot;stack-server-bigm7yoguexa&quot;</span>,  |</span><br><span class="line">|               |   <span class="string">&quot;output_key&quot;</span>: <span class="string">&quot;instance_name&quot;</span>,                |</span><br><span class="line">|               |   <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Name of the instance.&quot;</span>        |</span><br><span class="line">|               | &#125;                                               |</span><br><span class="line">| instance_ip   | &#123;                                               |</span><br><span class="line">|               |   <span class="string">&quot;output_value&quot;</span>: <span class="string">&quot;146.11.41.233&quot;</span>,              |</span><br><span class="line">|               |   <span class="string">&quot;output_key&quot;</span>: <span class="string">&quot;instance_ip&quot;</span>,                  |</span><br><span class="line">|               |   <span class="string">&quot;description&quot;</span>: <span class="string">&quot;IP address of the instance.&quot;</span>  |</span><br><span class="line">|               | &#125;                                               |</span><br><span class="line">+---------------+-------------------------------------------------+</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@controller:~<span class="comment"># openstack server list</span></span><br><span class="line">+--------------------------------------+---------------------------+---------+------------------------+------------+</span><br><span class="line">| ID                                   | Name                      | Status  | Networks               | Image Name |</span><br><span class="line">+--------------------------------------+---------------------------+---------+------------------------+------------+</span><br><span class="line">| a81fc7b9-b5c0-4a0f-85d3-3ff739f8e5ce | stack-server-bigm7yoguexa | ACTIVE  | provider=146.11.41.233 | cirros     |</span><br><span class="line">| e73c64ac-3af3-47fd-abfe-e138e40f0a40 | provider-instance         | SHUTOFF | provider=146.11.41.232 | cirros     |</span><br><span class="line">+--------------------------------------+---------------------------+---------+------------------------+------------+</span><br></pre></td></tr></table></figure></li>
<li><p>Delete the stack.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack stack delete --yes stack</span><br></pre></td></tr></table></figure>
<h2 id="How-about-Design-a-fake-vAPG-VNF-and-instantiate-it"><a href="#How-about-Design-a-fake-vAPG-VNF-and-instantiate-it" class="headerlink" title="How about Design a fake vAPG VNF and instantiate it?"></a>How about Design a fake vAPG VNF and instantiate it?</h2></li>
</ol>
<blockquote>
<p> ref: <a href="https://docs.openstack.org/heat/latest/template_guide/index.html">https://docs.openstack.org/heat/latest/template_guide/index.html</a></p>
</blockquote>
<h3 id="HOT"><a href="#HOT" class="headerlink" title="HOT"></a>HOT</h3><blockquote>
<p>fetch it here:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://github.com/wey-gu/workshops/raw/master/00-Openstack-Basic/HOT-vAPG.yml</span></span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">heat_template_version:</span> <span class="number">2015-10-15</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">Fake</span> <span class="string">vAPG</span> <span class="string">with</span> <span class="string">CirrOS</span> <span class="string">image</span> <span class="string">using</span> <span class="string">the</span></span><br><span class="line">             <span class="string">``m1.nano``</span> <span class="string">flavor,</span>  <span class="string">and</span> <span class="string">one</span> <span class="string">network.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line">  <span class="attr">NetID:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">Network</span> <span class="string">ID</span> <span class="string">to</span> <span class="string">use</span> <span class="string">for</span> <span class="string">the</span> <span class="string">instance.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">resources:</span></span><br><span class="line">  <span class="attr">nodeA:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">OS::Nova::Server</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">cirros</span></span><br><span class="line">      <span class="attr">flavor:</span> <span class="string">m1.nano</span></span><br><span class="line">      <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">network:</span> &#123; <span class="attr">get_param:</span> <span class="string">NetID</span> &#125;</span><br><span class="line">  <span class="attr">nodeB:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">OS::Nova::Server</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">cirros</span></span><br><span class="line">      <span class="attr">flavor:</span> <span class="string">m1.nano</span></span><br><span class="line">      <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">network:</span> &#123; <span class="attr">get_param:</span> <span class="string">NetID</span> &#125;</span><br><span class="line">  <span class="attr">diskA:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">OS::Cinder::Volume</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">size:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">diskB:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">OS::Cinder::Volume</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">size:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">NodeAvolume_attachment:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">OS::Cinder::VolumeAttachment</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">volume_id:</span> &#123; <span class="attr">get_resource:</span> <span class="string">diskA</span> &#125;</span><br><span class="line">      <span class="attr">instance_uuid:</span> &#123; <span class="attr">get_resource:</span> <span class="string">nodeA</span> &#125;</span><br><span class="line">  <span class="attr">NodeBvolume_attachment:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">OS::Cinder::VolumeAttachment</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">volume_id:</span> &#123; <span class="attr">get_resource:</span> <span class="string">diskB</span> &#125;</span><br><span class="line">      <span class="attr">instance_uuid:</span> &#123; <span class="attr">get_resource:</span> <span class="string">nodeB</span> &#125;</span><br><span class="line"><span class="attr">outputs:</span></span><br><span class="line">  <span class="attr">nodeA:</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">Name</span> <span class="string">of</span> <span class="string">the</span> <span class="string">instance.</span></span><br><span class="line">    <span class="attr">value:</span> &#123; <span class="attr">get_attr:</span> [ <span class="string">nodeA</span>, <span class="string">name</span> ] &#125;</span><br><span class="line">  <span class="attr">nodeA_ip:</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">IP</span> <span class="string">address</span> <span class="string">of</span> <span class="string">the</span> <span class="string">instance.</span></span><br><span class="line">    <span class="attr">value:</span> &#123; <span class="attr">get_attr:</span> [ <span class="string">nodeA</span>, <span class="string">first_address</span> ] &#125;</span><br><span class="line">  <span class="attr">nodeB:</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">Name</span> <span class="string">of</span> <span class="string">the</span> <span class="string">instance.</span></span><br><span class="line">    <span class="attr">value:</span> &#123; <span class="attr">get_attr:</span> [ <span class="string">nodeB</span>, <span class="string">name</span> ] &#125;</span><br><span class="line">  <span class="attr">nodeB_ip:</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">IP</span> <span class="string">address</span> <span class="string">of</span> <span class="string">the</span> <span class="string">instance.</span></span><br><span class="line">    <span class="attr">value:</span> &#123; <span class="attr">get_attr:</span> [ <span class="string">nodeB</span>, <span class="string">first_address</span> ] &#125;</span><br></pre></td></tr></table></figure>


<h3 id="Instantiation-vAPG"><a href="#Instantiation-vAPG" class="headerlink" title="Instantiation vAPG"></a>Instantiation vAPG</h3><p>For simplicity we reused the existed network</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># . demo-openrc</span></span><br><span class="line"><span class="comment"># openstack stack create -t HOT-vAPG.yml --parameter &quot;NetID=$NET_ID&quot; vAPG</span></span><br><span class="line"></span><br><span class="line">// monitoring </span><br><span class="line"></span><br><span class="line"><span class="comment"># openstack stack output show --all vAPG</span></span><br></pre></td></tr></table></figure>
<p>Print outs during/after instantiation</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@controller:~<span class="comment"># openstack stack list</span></span><br><span class="line">+--------------------------------------+------------+--------------------+----------------------+--------------+</span><br><span class="line">| ID                                   | Stack Name | Stack Status       | Creation Time        | Updated Time |</span><br><span class="line">+--------------------------------------+------------+--------------------+----------------------+--------------+</span><br><span class="line">| 7c4f5cda-a943-4d64-be23-72402829c62f | vAPG       | CREATE_IN_PROGRESS | 2017-08-25T07:38:55Z | None         |</span><br><span class="line">+--------------------------------------+------------+--------------------+----------------------+--------------+</span><br><span class="line">root@controller:~<span class="comment">#</span></span><br><span class="line">root@controller:~<span class="comment">#</span></span><br><span class="line">root@controller:~<span class="comment"># openstack stack list</span></span><br><span class="line">+--------------------------------------+------------+-----------------+----------------------+--------------+</span><br><span class="line">| ID                                   | Stack Name | Stack Status    | Creation Time        | Updated Time |</span><br><span class="line">+--------------------------------------+------------+-----------------+----------------------+--------------+</span><br><span class="line">| 7c4f5cda-a943-4d64-be23-72402829c62f | vAPG       | CREATE_COMPLETE | 2017-08-25T07:38:55Z | None         |</span><br><span class="line">+--------------------------------------+------------+-----------------+----------------------+--------------+</span><br><span class="line">root@controller:~<span class="comment"># openstack stack output show --all vAPG</span></span><br><span class="line">+----------+------------------------------------------------+</span><br><span class="line">| Field    | Value                                          |</span><br><span class="line">+----------+------------------------------------------------+</span><br><span class="line">| nodeA    | &#123;                                              |</span><br><span class="line">|          |   <span class="string">&quot;output_value&quot;</span>: <span class="string">&quot;vAPG-nodeA-slvg7ccfel4j&quot;</span>,   |</span><br><span class="line">|          |   <span class="string">&quot;output_key&quot;</span>: <span class="string">&quot;nodeA&quot;</span>,                       |</span><br><span class="line">|          |   <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Name of the instance.&quot;</span>       |</span><br><span class="line">|          | &#125;                                              |</span><br><span class="line">| nodeB_ip | &#123;                                              |</span><br><span class="line">|          |   <span class="string">&quot;output_value&quot;</span>: <span class="string">&quot;146.11.41.231&quot;</span>,             |</span><br><span class="line">|          |   <span class="string">&quot;output_key&quot;</span>: <span class="string">&quot;nodeB_ip&quot;</span>,                    |</span><br><span class="line">|          |   <span class="string">&quot;description&quot;</span>: <span class="string">&quot;IP address of the instance.&quot;</span> |</span><br><span class="line">|          | &#125;                                              |</span><br><span class="line">| nodeA_ip | &#123;                                              |</span><br><span class="line">|          |   <span class="string">&quot;output_value&quot;</span>: <span class="string">&quot;146.11.41.233&quot;</span>,             |</span><br><span class="line">|          |   <span class="string">&quot;output_key&quot;</span>: <span class="string">&quot;nodeA_ip&quot;</span>,                    |</span><br><span class="line">|          |   <span class="string">&quot;description&quot;</span>: <span class="string">&quot;IP address of the instance.&quot;</span> |</span><br><span class="line">|          | &#125;                                              |</span><br><span class="line">| nodeB    | &#123;                                              |</span><br><span class="line">|          |   <span class="string">&quot;output_value&quot;</span>: <span class="string">&quot;vAPG-nodeB-rjame5ftjcrf&quot;</span>,   |</span><br><span class="line">|          |   <span class="string">&quot;output_key&quot;</span>: <span class="string">&quot;nodeB&quot;</span>,                       |</span><br><span class="line">|          |   <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Name of the instance.&quot;</span>       |</span><br><span class="line">|          | &#125;                                              |</span><br><span class="line">+----------+------------------------------------------------+</span><br><span class="line">root@controller:~<span class="comment"># openstack server list</span></span><br><span class="line">+--------------------------------------+-------------------------+---------+------------------------+------------+</span><br><span class="line">| ID                                   | Name                    | Status  | Networks               | Image Name |</span><br><span class="line">+--------------------------------------+-------------------------+---------+------------------------+------------+</span><br><span class="line">| 3eef32d9-f885-48ca-a038-365233ed300f | vAPG-nodeB-rjame5ftjcrf | ACTIVE  | provider=146.11.41.231 | cirros     |</span><br><span class="line">| 2a2709f2-9d77-42e1-be36-fd51c33b30de | vAPG-nodeA-slvg7ccfel4j | ACTIVE  | provider=146.11.41.233 | cirros     |</span><br><span class="line">| e73c64ac-3af3-47fd-abfe-e138e40f0a40 | provider-instance       | SHUTOFF | provider=146.11.41.232 | cirros     |</span><br><span class="line">+--------------------------------------+-------------------------+---------+------------------------+------------+</span><br></pre></td></tr></table></figure>
<p>Check resources afterwards</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@controller:~<span class="comment"># openstack volume list</span></span><br><span class="line">+--------------------------------+-------------------------+-----------+------+--------------------------------+</span><br><span class="line">| ID                             | Display Name            | Status    | Size | Attached to                    |</span><br><span class="line">+--------------------------------+-------------------------+-----------+------+--------------------------------+</span><br><span class="line">| 9a93c5aa-56ed-                 | vAPG-diskA-ff253tzmwhuv | in-use    |    1 | Attached to vAPG-nodeA-        |</span><br><span class="line">| 42e0-b0a0-e0e617b533e1         |                         |           |      | slvg7ccfel4j on /dev/vdb       |</span><br><span class="line">| 988f5003-2a3f-                 | vAPG-diskB-xpzh5o7pw5po | in-use    |    1 | Attached to vAPG-nodeB-        |</span><br><span class="line">| 4eeb-b836-6be6f64b0b32         |                         |           |      | rjame5ftjcrf on /dev/vdb       |</span><br><span class="line">+--------------------------------+-------------------------+-----------+------+--------------------------------+</span><br><span class="line">root@controller:~<span class="comment"># openstack server list</span></span><br><span class="line">+--------------------------------------+-------------------------+---------+------------------------+------------+</span><br><span class="line">| ID                                   | Name                    | Status  | Networks               | Image Name |</span><br><span class="line">+--------------------------------------+-------------------------+---------+------------------------+------------+</span><br><span class="line">| 3eef32d9-f885-48ca-a038-365233ed300f | vAPG-nodeB-rjame5ftjcrf | ACTIVE  | provider=146.11.41.231 | cirros     |</span><br><span class="line">| 2a2709f2-9d77-42e1-be36-fd51c33b30de | vAPG-nodeA-slvg7ccfel4j | ACTIVE  | provider=146.11.41.233 | cirros     |</span><br><span class="line">+--------------------------------------+-------------------------+---------+------------------------+------------+</span><br><span class="line"></span><br><span class="line">root@controller:~<span class="comment"># openstack port list</span></span><br><span class="line">+--------------------------------------+------+-------------------+----------------------------------------+--------+</span><br><span class="line">| ID                                   | Name | MAC Address       | Fixed IP Addresses                     | Status |</span><br><span class="line">+--------------------------------------+------+-------------------+----------------------------------------+--------+</span><br><span class="line">| 0e54bc09-29d2-4774-bd71-413739b7bffe |      | fa:16:3e:0c:8a:66 | ip_address=<span class="string">&#x27;146.11.41.233&#x27;</span>, subnet_id= | ACTIVE |</span><br><span class="line">|                                      |      |                   | <span class="string">&#x27;9b118521-59b5-40ee-a439-9d59c3b392ea&#x27;</span> |        |</span><br><span class="line">| 2aa35c9c-2b50-40cd-8971-2056fb4cf04d |      | fa:16:3e:bb:c6:13 | ip_address=<span class="string">&#x27;146.11.41.232&#x27;</span>, subnet_id= | ACTIVE |</span><br><span class="line">|                                      |      |                   | <span class="string">&#x27;9b118521-59b5-40ee-a439-9d59c3b392ea&#x27;</span> |        |</span><br><span class="line">+--------------------------------------+------+-------------------+----------------------------------------+--------+</span><br></pre></td></tr></table></figure>


<h2 id="Horizon-dashboard"><a href="#Horizon-dashboard" class="headerlink" title="Horizon dashboard"></a>Horizon dashboard</h2><p>The Dashboard (horizon) is a web interface that enables cloud administrators and users to manage various OpenStack resources and services.</p>
<p>This example deployment uses an Apache web server.</p>
<blockquote>
<p>it’s actually a Django based openstack client front-end</p>
</blockquote>
<h3 id="Install-and-configure-2"><a href="#Install-and-configure-2" class="headerlink" title="Install and configure"></a>Install and configure</h3><p>Install the packages:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># apt install openstack-dashboard</span></span><br><span class="line"></span><br><span class="line">​```bash</span><br><span class="line"></span><br><span class="line">1. Edit the `/etc/openstack-dashboard/local_settings.py` file and complete the following actions:</span><br><span class="line"></span><br><span class="line">   - Configure the dashboard to use OpenStack services on the `controller` node:</span><br><span class="line"></span><br><span class="line">​```bash</span><br><span class="line">     OPENSTACK_HOST = <span class="string">&quot;controller&quot;</span></span><br><span class="line"></span><br><span class="line">​```bash</span><br><span class="line"></span><br><span class="line">-    In the Dashboard configuration section, allow your hosts to access Dashboard:</span><br><span class="line"></span><br><span class="line">     ```bash</span><br><span class="line">     ALLOWED_HOSTS = [<span class="string">&#x27;*&#x27;</span>]</span><br></pre></td></tr></table></figure>
<pre><code> - Do not edit the `ALLOWED_HOSTS` parameter under the Ubuntu configuration section.
 - `ALLOWED_HOSTS` can also be `[&#39;*&#39;]` to accept all hosts. This may be useful for development work, but is potentially insecure and should not be used in production. See the [Django documentation](https://docs.djangoproject.com/en/dev/ref/settings/#allowed-hosts) for further information.</code></pre>
<ul>
<li><p> Configure the <code>memcached</code> session storage service:</p>
   <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">SESSION_ENGINE = <span class="string">&#x27;django.contrib.sessions.backends.cache&#x27;</span></span><br><span class="line"> </span><br><span class="line">CACHES = &#123;</span><br><span class="line">    <span class="string">&#x27;default&#x27;</span>: &#123;</span><br><span class="line">         <span class="string">&#x27;BACKEND&#x27;</span>: <span class="string">&#x27;django.core.cache.backends.memcached.MemcachedCache&#x27;</span>,</span><br><span class="line">         <span class="string">&#x27;LOCATION&#x27;</span>: <span class="string">&#x27;controller:11211&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<pre><code>     ​</code></pre>
</li>
</ul>
<pre><code> ​

 Comment out any other session storage configuration.</code></pre>
<ul>
<li><p>Enable the Identity API version 3:</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">OPENSTACK_KEYSTONE_URL = <span class="string">&quot;http://%s:5000/v3&quot;</span> % OPENSTACK_HOST</span><br></pre></td></tr></table></figure></li>
<li><p>Enable support for domains:</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"> OPENSTACK_KEYSTONE_MULTIDOMAIN_SUPPORT = True</span><br><span class="line"> ​```</span><br><span class="line"></span><br><span class="line">- Configure API versions:</span><br><span class="line"></span><br><span class="line">  ```bash</span><br><span class="line">  OPENSTACK_API_VERSIONS = &#123;</span><br><span class="line">      <span class="string">&quot;identity&quot;</span>: 3,</span><br><span class="line">      <span class="string">&quot;image&quot;</span>: 2,</span><br><span class="line">      <span class="string">&quot;volume&quot;</span>: 2,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li><p>Configure <code>Default</code> as the default domain for users that you create via the dashboard:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">OPENSTACK_KEYSTONE_DEFAULT_DOMAIN = <span class="string">&quot;Default&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>Configure <code>user</code> as the default role for users that you create via the dashboard:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">OPENSTACK_KEYSTONE_DEFAULT_ROLE = <span class="string">&quot;user&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>If you chose networking option 1, disable support for layer-3 networking services:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">OPENSTACK_NEUTRON_NETWORK = &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">&#x27;enable_router&#x27;</span>: False,</span><br><span class="line">    <span class="string">&#x27;enable_quotas&#x27;</span>: False,</span><br><span class="line">    <span class="string">&#x27;enable_ipv6&#x27;</span>: False,</span><br><span class="line">    <span class="string">&#x27;enable_distributed_router&#x27;</span>: False,</span><br><span class="line">    <span class="string">&#x27;enable_ha_router&#x27;</span>: False,</span><br><span class="line">    <span class="string">&#x27;enable_lb&#x27;</span>: False,</span><br><span class="line">    <span class="string">&#x27;enable_firewall&#x27;</span>: False,</span><br><span class="line">    <span class="string">&#x27;enable_vpn&#x27;</span>: False,</span><br><span class="line">    <span class="string">&#x27;enable_fip_topology_check&#x27;</span>: False,</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>Optionally, configure the time zone:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">TIME_ZONE = <span class="string">&quot;&lt;TIME_ZONE&gt;&quot;</span></span><br></pre></td></tr></table></figure>
<p>Replace <code>TIME_ZONE</code> with an appropriate time zone identifier. For more information, see the <a href="https://en.wikipedia.org/wiki/List_of_tz_database_time_zones">list of time zones</a>.</p>
</li>
</ul>
</li>
</ul>
<h3 id="Finalize-installation-8"><a href="#Finalize-installation-8" class="headerlink" title="Finalize installation"></a>Finalize installation</h3><ul>
<li><p>Reload the web server configuration:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># service apache2 reloadetc</span></span><br></pre></td></tr></table></figure>
<h3 id="Verify-operation-6"><a href="#Verify-operation-6" class="headerlink" title="Verify operation"></a>Verify operation</h3></li>
</ul>
<p>Verify operation of the dashboard.</p>
<p>Access the dashboard using a web browser at <code>http://controller/horizon</code>.</p>
<p>Authenticate using <code>admin</code> or <code>demo</code> user and <code>default</code> domain credentials.</p>
<blockquote>
<p>Monitoring the how process by <code>tail -f /var/log/apache2/*.log</code></p>
</blockquote>
<h2 id="ISSUE-Horizon-500-internal-error"><a href="#ISSUE-Horizon-500-internal-error" class="headerlink" title="[ISSUE] Horizon 500 internal error"></a>[ISSUE] Horizon <code>500</code> internal error</h2><h3 id="Fault-reproduce-in-cli"><a href="#Fault-reproduce-in-cli" class="headerlink" title="Fault reproduce in cli"></a>Fault reproduce in cli</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl http://10.20.0.10/horizon</span></span><br><span class="line">&lt;!DOCTYPE HTML PUBLIC <span class="string">&quot;-//IETF//DTD HTML 2.0//EN&quot;</span>&gt;</span><br><span class="line">&lt;html&gt;&lt;head&gt;</span><br><span class="line">&lt;title&gt;500 Internal Server Error&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Internal Server Error&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;The server encountered an internal error or</span><br><span class="line">misconfiguration and was unable to complete</span><br><span class="line">your request.&lt;/p&gt;</span><br><span class="line">&lt;p&gt;Please contact the server administrator at</span><br><span class="line"> webmaster@localhost to inform them of the time this error occurred,</span><br><span class="line"> and the actions you performed just before this error.&lt;/p&gt;</span><br><span class="line">&lt;p&gt;More information about this error may be available</span><br><span class="line"><span class="keyword">in</span> the server error <span class="built_in">log</span>.&lt;/p&gt;</span><br><span class="line">&lt;hr&gt;</span><br><span class="line">&lt;address&gt;Apache/2.4.18 (Ubuntu) Server at 10.20.0.10 Port 80&lt;/address&gt;</span><br><span class="line">&lt;/body&gt;&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>It’s apache2 based web service, error could be fond in <code>/var/log/apache2/error.log</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[Fri Aug 25 16:22:13.681394 2017] [wsgi:error] [pid 9401:tid 140055623386880] [remote 10.20.0.10:18248] mod_wsgi (pid=9401): Target WSGI script <span class="string">&#x27;/usr/share/openstack-dashboard/openstack_dashboard/wsgi/django.wsgi&#x27;</span> cannot be loaded as Python module.</span><br><span class="line">[Fri Aug 25 16:22:13.681453 2017] [wsgi:error] [pid 9401:tid 140055623386880] [remote 10.20.0.10:18248] mod_wsgi (pid=9401): Exception occurred processing WSGI script <span class="string">&#x27;/usr/share/openstack-dashboard/openstack_dashboard/wsgi/django.wsgi&#x27;</span>.</span><br><span class="line">[Fri Aug 25 16:22:13.681498 2017] [wsgi:error] [pid 9401:tid 140055623386880] [remote 10.20.0.10:18248] Traceback (most recent call last):</span><br><span class="line">[Fri Aug 25 16:22:13.681531 2017] [wsgi:error] [pid 9401:tid 140055623386880] [remote 10.20.0.10:18248]   File <span class="string">&quot;/usr/share/openstack-dashboard/openstack_dashboard/wsgi/django.wsgi&quot;</span>, line 16, <span class="keyword">in</span> &lt;module&gt;[Fri Aug 25 16:22:13.681621 2017] [wsgi:error] [pid 9401:tid 140055623386880] [remote 10.20.0.10:18248]     application = get_wsgi_application()</span><br><span class="line">[Fri Aug 25 16:22:13.681635 2017] [wsgi:error] [pid 9401:tid 140055623386880] [remote 10.20.0.10:18248]   File <span class="string">&quot;/usr/lib/python2.7/dist-packages/django/core/wsgi.py&quot;</span>, line 14, <span class="keyword">in</span> get_wsgi_application</span><br><span class="line">[Fri Aug 25 16:22:13.681672 2017] [wsgi:error] [pid 9401:tid 140055623386880] [remote 10.20.0.10:18248]     django.setup()</span><br><span class="line">[Fri Aug 25 16:22:13.681682 2017] [wsgi:error] [pid 9401:tid 140055623386880] [remote 10.20.0.10:18248]   File <span class="string">&quot;/usr/lib/python2.7/dist-packages/django/__init__.py&quot;</span>, line 17, <span class="keyword">in</span> setup</span><br><span class="line">[Fri Aug 25 16:22:13.681713 2017] [wsgi:error] [pid 9401:tid 140055623386880] [remote 10.20.0.10:18248]     configure_logging(settings.LOGGING_CONFIG, settings.LOGGING)</span><br><span class="line">[Fri Aug 25 16:22:13.681726 2017] [wsgi:error] [pid 9401:tid 140055623386880] [remote 10.20.0.10:18248]   File <span class="string">&quot;/usr/lib/python2.7/dist-packages/django/conf/__init__.py&quot;</span>, line 48, <span class="keyword">in</span> __getattr__</span><br><span class="line">[Fri Aug 25 16:22:13.681806 2017] [wsgi:error] [pid 9401:tid 140055623386880] [remote 10.20.0.10:18248]     self._setup(name)</span><br><span class="line">[Fri Aug 25 16:22:13.681886 2017] [wsgi:error] [pid 9401:tid 140055623386880] [remote 10.20.0.10:18248]   File <span class="string">&quot;/usr/lib/python2.7/dist-packages/django/conf/__init__.py&quot;</span>, line 44, <span class="keyword">in</span> _setup</span><br><span class="line">[Fri Aug 25 16:22:13.681909 2017] [wsgi:error] [pid 9401:tid 140055623386880] [remote 10.20.0.10:18248]     self._wrapped = Settings(settings_module)</span><br><span class="line">[Fri Aug 25 16:22:13.681916 2017] [wsgi:error] [pid 9401:tid 140055623386880] [remote 10.20.0.10:18248]   File <span class="string">&quot;/usr/lib/python2.7/dist-packages/django/conf/__init__.py&quot;</span>, line 92, <span class="keyword">in</span> __init__</span><br><span class="line">[Fri Aug 25 16:22:13.681927 2017] [wsgi:error] [pid 9401:tid 140055623386880] [remote 10.20.0.10:18248]     mod = importlib.import_module(self.SETTINGS_MODULE)</span><br><span class="line">[Fri Aug 25 16:22:13.681934 2017] [wsgi:error] [pid 9401:tid 140055623386880] [remote 10.20.0.10:18248]   File <span class="string">&quot;/usr/lib/python2.7/importlib/__init__.py&quot;</span>, line 37, <span class="keyword">in</span> import_module</span><br><span class="line">[Fri Aug 25 16:22:13.681974 2017] [wsgi:error] [pid 9401:tid 140055623386880] [remote 10.20.0.10:18248]     __import__(name)</span><br><span class="line">[Fri Aug 25 16:22:13.681984 2017] [wsgi:error] [pid 9401:tid 140055623386880] [remote 10.20.0.10:18248]   File <span class="string">&quot;/usr/share/openstack-dashboard/openstack_dashboard/settings.py&quot;</span>, line 335, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">[Fri Aug 25 16:22:13.682112 2017] [wsgi:error] [pid 9401:tid 140055623386880] [remote 10.20.0.10:18248]     from local.local_settings import *  <span class="comment"># noqa</span></span><br><span class="line">[Fri Aug 25 16:22:13.682123 2017] [wsgi:error] [pid 9401:tid 140055623386880] [remote 10.20.0.10:18248]   File <span class="string">&quot;/usr/share/openstack-dashboard/openstack_dashboard/local/local_settings.py&quot;</span>, line 131, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">[Fri Aug 25 16:22:13.682586 2017] [wsgi:error] [pid 9401:tid 140055623386880] [remote 10.20.0.10:18248]     SECRET_KEY = secret_key.generate_or_read_from_file(<span class="string">&#x27;/var/lib/openstack-dashboard/secret_key&#x27;</span>) [Fri Aug 25 16:22:13.682611 2017] [wsgi:error] [pid 9401:tid 140055623386880] [remote 10.20.0.10:18248]   File <span class="string">&quot;/usr/share/openstack-dashboard/horizon/utils/secret_key.py&quot;</span>, line 70, <span class="keyword">in</span> generate_or_read_from_file</span><br><span class="line">[Fri Aug 25 16:22:13.682688 2017] [wsgi:error] [pid 9401:tid 140055623386880] [remote 10.20.0.10:18248]     key = read_from_file(key_file)</span><br><span class="line">[Fri Aug 25 16:22:13.682699 2017] [wsgi:error] [pid 9401:tid 140055623386880] [remote 10.20.0.10:18248]   File <span class="string">&quot;/usr/share/openstack-dashboard/horizon/utils/secret_key.py&quot;</span>, line 52, <span class="keyword">in</span> read_from_file</span><br><span class="line">[Fri Aug 25 16:22:13.682714 2017] [wsgi:error] [pid 9401:tid 140055623386880] [remote 10.20.0.10:18248]     with open(key_file, <span class="string">&#x27;r&#x27;</span>) as f:</span><br><span class="line">[Fri Aug 25 16:22:13.682746 2017] [wsgi:error] [pid 9401:tid 140055623386880] [remote 10.20.0.10:18248] IOError: [Errno 13] Permission denied: <span class="string">&#x27;/var/lib/openstack-dashboard/secret_key&#x27;</span></span><br></pre></td></tr></table></figure>
<p>beautify it as below</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mod_wsgi (pid=9401): Target WSGI script <span class="string">&#x27;/usr/share/openstack-dashboard/openstack_dashboard/wsgi/django.wsgi&#x27;</span> cannot be loaded as Python module.</span><br><span class="line">mod_wsgi (pid=9401): Exception occurred processing WSGI script <span class="string">&#x27;/usr/share/openstack-dashboard/openstack_dashboard/wsgi/django.wsgi&#x27;</span>.</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;/usr/share/openstack-dashboard/openstack_dashboard/wsgi/django.wsgi&quot;</span>, line 16, <span class="keyword">in</span> &lt;module&gt;[Fri Aug 25 16:22:13.681621 2017] [wsgi:error] [pid 9401:tid 140055623386880] [remote      application = get_wsgi_application()</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python2.7/dist-packages/django/core/wsgi.py&quot;</span>, line 14, <span class="keyword">in</span> get_wsgi_application</span><br><span class="line">    django.setup()</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python2.7/dist-packages/django/__init__.py&quot;</span>, line 17, <span class="keyword">in</span> setup</span><br><span class="line">    configure_logging(settings.LOGGING_CONFIG, settings.LOGGING)</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python2.7/dist-packages/django/conf/__init__.py&quot;</span>, line 48, <span class="keyword">in</span> __getattr__</span><br><span class="line">    self._setup(name)</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python2.7/dist-packages/django/conf/__init__.py&quot;</span>, line 44, <span class="keyword">in</span> _setup</span><br><span class="line">    self._wrapped = Settings(settings_module)</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python2.7/dist-packages/django/conf/__init__.py&quot;</span>, line 92, <span class="keyword">in</span> __init__</span><br><span class="line">    mod = importlib.import_module(self.SETTINGS_MODULE)</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python2.7/importlib/__init__.py&quot;</span>, line 37, <span class="keyword">in</span> import_module</span><br><span class="line">    __import__(name)</span><br><span class="line">  File <span class="string">&quot;/usr/share/openstack-dashboard/openstack_dashboard/settings.py&quot;</span>, line 335, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    from local.local_settings import *  <span class="comment"># noqa</span></span><br><span class="line">  File <span class="string">&quot;/usr/share/openstack-dashboard/openstack_dashboard/local/local_settings.py&quot;</span>, line 131, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    SECRET_KEY = secret_key.generate_or_read_from_file(<span class="string">&#x27;/var/lib/openstack-dashboard/secret_key&#x27;</span>) [Fri Aug 25 16:22:13.682611 2017] [wsgi:error] [pid 9401:tid    File <span class="string">&quot;/usr/share/openstack-dashboard/horizon/utils/secret_key.py&quot;</span>, line 70, <span class="keyword">in</span> generate_or_read_from_file</span><br><span class="line">    key = read_from_file(key_file)</span><br><span class="line">  File <span class="string">&quot;/usr/share/openstack-dashboard/horizon/utils/secret_key.py&quot;</span>, line 52, <span class="keyword">in</span> read_from_file</span><br><span class="line">    with open(key_file, <span class="string">&#x27;r&#x27;</span>) as f:</span><br><span class="line">IOError: [Errno 13] Permission denied: <span class="string">&#x27;/var/lib/openstack-dashboard/secret_key&#x27;</span></span><br></pre></td></tr></table></figure>
<p>The log shows that the file cannot be accessed by horizon. Check its ownership and permission</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@controller:~<span class="comment"># ll /var/lib/openstack-dashboard/secret_key</span></span><br><span class="line">-rw------- 1 root root 64 Aug 25 15:49 /var/lib/openstack-dashboard/secret_key</span><br></pre></td></tr></table></figure>
<p>try chown to <code>horizon:horizon</code>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># chown -R horizon:horizon /var/lib/openstack-dashboard/secret_key</span></span><br><span class="line"><span class="comment"># ll /var/lib/openstack-dashboard/secret_key</span></span><br><span class="line">-rw------- 1 horizon:horizon 64 Aug 25 15:49 /var/lib/openstack-dashboard/secret_key</span><br><span class="line"><span class="comment"># service apache2 reload</span></span><br></pre></td></tr></table></figure>
<p>retry with <code>curl</code>, still got <code>500</code>,and with same error on apache error log</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl http://10.20.0.10/horizon</span></span><br><span class="line">&lt;!DOCTYPE HTML PUBLIC <span class="string">&quot;-//IETF//DTD HTML 2.0//EN&quot;</span>&gt;</span><br><span class="line">&lt;html&gt;&lt;head&gt;</span><br><span class="line">&lt;title&gt;500 Internal Server Error&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Internal Server Error&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;The server encountered an internal error or</span><br><span class="line">misconfiguration and was unable to complete</span><br><span class="line">your request.&lt;/p&gt;</span><br><span class="line">&lt;p&gt;Please contact the server administrator at</span><br><span class="line"> webmaster@localhost to inform them of the time this error occurred,</span><br><span class="line"> and the actions you performed just before this error.&lt;/p&gt;</span><br><span class="line">&lt;p&gt;More information about this error may be available</span><br><span class="line"><span class="keyword">in</span> the server error <span class="built_in">log</span>.&lt;/p&gt;</span><br><span class="line">&lt;hr&gt;</span><br><span class="line">&lt;address&gt;Apache/2.4.18 (Ubuntu) Server at 10.20.0.10 Port 80&lt;/address&gt;</span><br><span class="line">&lt;/body&gt;&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>We should identify the process owner and change to it accordingly.</p>
<p>By checking horizon wsgi process it’s found the user is www-data (the one for apache2 ):</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@controller:~<span class="comment"># ps -aux | grep horizon</span></span><br><span class="line">www-data 10299  0.0  0.2 251032  8292 ?        Sl   16:26   0:00 (wsgi:horizon)    -k start</span><br><span class="line">www-data 10300  0.0  0.2 251024  8292 ?        Sl   16:26   0:00 (wsgi:horizon)    -k start</span><br><span class="line">www-data 10301  0.3  4.1 550344 169144 ?       Sl   16:26   0:02 (wsgi:horizon)    -k start</span><br></pre></td></tr></table></figure>
<h3 id="Solution-1"><a href="#Solution-1" class="headerlink" title="Solution"></a>Solution</h3><p>Change owner to <code>www-data</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># chown www-data /var/lib/openstack-dashboard/secret_key</span></span><br><span class="line"><span class="comment"># service apache2 reload</span></span><br></pre></td></tr></table></figure>
<p>Retry with <code>curl http://10.20.0.10/horizon</code> no error came out :-).</p>
<h2 id="Enable-RabbitMQ-web-admin-for-studying"><a href="#Enable-RabbitMQ-web-admin-for-studying" class="headerlink" title="Enable RabbitMQ web admin for studying"></a>Enable RabbitMQ web admin for studying</h2><blockquote>
<p> ref: <a href="https://www.rabbitmq.com/management.html">https://www.rabbitmq.com/management.html</a></p>
</blockquote>
<p>Enable the plugins for this feature:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@controller:~<span class="comment"># netstat -plunt | grep 15672</span></span><br><span class="line"></span><br><span class="line">root@controller:~<span class="comment"># rabbitmq-plugins enable rabbitmq_management</span></span><br><span class="line">The following plugins have been enabled:</span><br><span class="line">  mochiweb</span><br><span class="line">  webmachine</span><br><span class="line">  rabbitmq_web_dispatch</span><br><span class="line">  amqp_client</span><br><span class="line">  rabbitmq_management_agent</span><br><span class="line">  rabbitmq_management</span><br><span class="line">  </span><br><span class="line">root@controller:~<span class="comment"># netstat -plunt | grep 15672</span></span><br><span class="line">tcp        0      0 0.0.0.0:15672           0.0.0.0:*               LISTEN      1927/beam</span><br></pre></td></tr></table></figure>
<p>Browse from web browser with URL: <code>http://controller:15672/</code>with:</p>
<ul>
<li>user: openstack</li>
<li>password: RABBIT_PASS</li>
</ul>
<p>Got failure Login failed, check logs</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># less /var/log/rabbitmq/rabbit@controller.log</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">=WARNING REPORT==== 26-Aug-2017::22:34:05 ===</span><br><span class="line">HTTP access denied: user <span class="string">&#x27;openstack&#x27;</span> - Not management user</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>Add new user ad admin grants:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">rabbitmqctl add_user admin admin</span><br><span class="line">rabbitmqctl set_user_tags admin administrator</span><br><span class="line">rabbitmqctl set_permissions -p / admin <span class="string">&quot;.*&quot;</span> <span class="string">&quot;.*&quot;</span> <span class="string">&quot;.*&quot;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Accessed !</p>
</blockquote>
<h2 id="Neutron-reconfigure-as-Linux-bridge-with-vlan"><a href="#Neutron-reconfigure-as-Linux-bridge-with-vlan" class="headerlink" title="Neutron reconfigure as Linux bridge with vlan"></a>Neutron reconfigure as Linux bridge with vlan</h2><blockquote>
<p> ref: <a href="https://docs.openstack.org/kilo/networking-guide/deploy_scenario4b.html">https://docs.openstack.org/kilo/networking-guide/deploy_scenario4b.html</a></p>
</blockquote>
<h3 id="Controller-configuration"><a href="#Controller-configuration" class="headerlink" title="Controller configuration"></a>Controller configuration</h3><ol>
<li><p>Configure the kernel to disable reverse path filtering. Edit the <code>/etc/sysctl.conf</code> file:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">net.ipv4.conf.default.rp_filter=0</span><br><span class="line">net.ipv4.conf.all.rp_filter=0</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>Load the new kernel configuration:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sysctl -p</span><br></pre></td></tr></table></figure></li>
<li><p>Configure the ML2 plug-in and Linux bridge agent. Edit the <code>/etc/neutron/plugins/ml2/.ini</code> file:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[ml2]</span><br><span class="line">type_drivers = flat,vlan</span><br><span class="line">tenant_network_types =</span><br><span class="line">mechanism_drivers = linuxbridge</span><br><span class="line"></span><br><span class="line">[ml2_type_flat]</span><br><span class="line">flat_networks = ecn,provider</span><br><span class="line"></span><br><span class="line">[ml2_type_vlan]</span><br><span class="line">network_vlan_ranges = provider:100:200</span><br></pre></td></tr></table></figure></li>
<li><p>Edit the<code>/etc/neutron/plugins/ml2/linuxbridge_agent.ini</code> file:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[linux_bridge]</span><br><span class="line">physical_interface_mappings = ecn:enp0s10,provider:enp0s8</span><br><span class="line"></span><br><span class="line">[securitygroup]</span><br><span class="line">firewall_driver = neutron.agent.linux.iptables_firewall.IptablesFirewallDriver</span><br><span class="line">enable_security_group = True</span><br><span class="line">enable_ipset = True</span><br></pre></td></tr></table></figure></li>
<li><p>Restart the Networking services.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># service neutron-server restart</span></span><br><span class="line"><span class="comment"># service neutron-linuxbridge-agent restart</span></span><br><span class="line"><span class="comment"># service neutron-dhcp-agent restart</span></span><br><span class="line"><span class="comment"># service neutron-metadata-agent restart</span></span><br></pre></td></tr></table></figure>
<h3 id="Compute-node-configuration"><a href="#Compute-node-configuration" class="headerlink" title="Compute node configuration"></a>Compute node configuration</h3></li>
<li><p>Configure the kernel to disable reverse path filtering. Edit the <code>/etc/sysctl.conf</code> file:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">net.ipv4.conf.default.rp_filter=0</span><br><span class="line">net.ipv4.conf.all.rp_filter=0</span><br></pre></td></tr></table></figure></li>
<li><p>Load the new kernel configuration:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sysctl -p</span><br></pre></td></tr></table></figure></li>
<li><p>Configure the Linux bridge agent. Edit the <code>/etc/neutron/plugins/ml2/linuxbridge_agent.ini</code> file:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[linux_bridge]</span><br><span class="line">physical_interface_mappings = ecn:enp0s10,provider:enp0s8</span><br><span class="line"></span><br><span class="line">[securitygroup]</span><br><span class="line">firewall_driver = neutron.agent.linux.iptables_firewall.IptablesFirewallDriver</span><br><span class="line">enable_security_group = True</span><br><span class="line">enable_ipset = True</span><br></pre></td></tr></table></figure>


</li>
</ol>
<h3 id="Verify-operation-7"><a href="#Verify-operation-7" class="headerlink" title="Verify operation"></a>Verify operation</h3><ol>
<li><p>Source the administrative project credentials.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">. admin-openrc</span><br></pre></td></tr></table></figure>


</li>
</ol>
<ol start="2">
<li><p>Verify presence and operation of the agents:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@controller:~<span class="comment"># neutron agent-list</span></span><br><span class="line">neutron CLI is deprecated and will be removed <span class="keyword">in</span> the future. Use openstack CLI instead.</span><br><span class="line">+--------------------------------------+--------------------+------------+-------------------+-------+----------------+---------------------------+</span><br><span class="line">| id                                   | agent_type         | host       | availability_zone | alive | admin_state_up | binary                    |</span><br><span class="line">+--------------------------------------+--------------------+------------+-------------------+-------+----------------+---------------------------+</span><br><span class="line">| 143d7731-9227-4baf-9052-292d7aea6992 | Linux bridge agent | compute    |                   | :-)   | True           | neutron-linuxbridge-agent |</span><br><span class="line">| 1d661145-0941-411d-9b18-b3371fe57c4b | Linux bridge agent | controller |                   | :-)   | True           | neutron-linuxbridge-agent |</span><br><span class="line">| 7502e1a3-998d-4aca-91e4-ca17e1b10c82 | DHCP agent         | controller | nova              | :-)   | True           | neutron-dhcp-agent        |</span><br><span class="line">| 7c47ac70-5de2-4442-8fc1-91fe97ae120f | Metadata agent     | controller |                   | :-)   | True           | neutron-metadata-agent    |</span><br><span class="line">+--------------------------------------+--------------------+------------+-------------------+-------+----------------+---------------------------+</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@controller:~<span class="comment"># openstack network agent list</span></span><br><span class="line">+--------------------------------------+--------------------+------------+-------------------+-------+-------+---------------------------+</span><br><span class="line">| ID                                   | Agent Type         | Host       | Availability Zone | Alive | State | Binary                    |</span><br><span class="line">+--------------------------------------+--------------------+------------+-------------------+-------+-------+---------------------------+</span><br><span class="line">| 143d7731-9227-4baf-9052-292d7aea6992 | Linux bridge agent | compute    | None              | True  | UP    | neutron-linuxbridge-agent |</span><br><span class="line">| 1d661145-0941-411d-9b18-b3371fe57c4b | Linux bridge agent | controller | None              | True  | UP    | neutron-linuxbridge-agent |</span><br><span class="line">| 7502e1a3-998d-4aca-91e4-ca17e1b10c82 | DHCP agent         | controller | nova              | True  | UP    | neutron-dhcp-agent        |</span><br><span class="line">| 7c47ac70-5de2-4442-8fc1-91fe97ae120f | Metadata agent     | controller | None              | True  | UP    | neutron-metadata-agent    |</span><br><span class="line">+--------------------------------------+--------------------+------------+-------------------+-------+-------+---------------------------+</span><br></pre></td></tr></table></figure>
<h3 id="Create-initial-networks"><a href="#Create-initial-networks" class="headerlink" title="Create initial networks"></a>Create initial networks</h3></li>
</ol>
<p>This example creates a VLAN provider network. Change the VLAN ID and IP address range to values suitable for your environment.</p>
<ol>
<li><p>Source the administrative project credentials.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">. demo-openrc</span><br></pre></td></tr></table></figure>


</li>
</ol>
<ol start="2">
<li><p>Create a provider network:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@controller:~<span class="comment"># openstack network create  --share --external   --provider-physical-network provider --provider-network-type vlan --provider-segment 101 provider-vlan-101</span></span><br><span class="line">+---------------------------+--------------------------------------+</span><br><span class="line">| Field                     | Value                                |</span><br><span class="line">+---------------------------+--------------------------------------+</span><br><span class="line">| admin_state_up            | UP                                   |</span><br><span class="line">| availability_zone_hints   |                                      |</span><br><span class="line">| availability_zones        |                                      |</span><br><span class="line">| created_at                | 2017-08-28T03:25:26Z                 |</span><br><span class="line">| description               |                                      |</span><br><span class="line">| dns_domain                | None                                 |</span><br><span class="line">| id                        | 152a4a85-dc52-4c62-9bbd-742eb4f7b8fa |</span><br><span class="line">| ipv4_address_scope        | None                                 |</span><br><span class="line">| ipv6_address_scope        | None                                 |</span><br><span class="line">| is_default                | None                                 |</span><br><span class="line">| mtu                       | 1500                                 |</span><br><span class="line">| name                      | provider-vlan-101                    |</span><br><span class="line">| port_security_enabled     | True                                 |</span><br><span class="line">| project_id                | 78c9c849237649a3a8c4526167427589     |</span><br><span class="line">| provider:network_type     | vlan                                 |</span><br><span class="line">| provider:physical_network | provider                             |</span><br><span class="line">| provider:segmentation_id  | 101                                  |</span><br><span class="line">| qos_policy_id             | None                                 |</span><br><span class="line">| revision_number           | 4                                    |</span><br><span class="line">| router:external           | External                             |</span><br><span class="line">| segments                  | None                                 |</span><br><span class="line">| shared                    | True                                 |</span><br><span class="line">| status                    | ACTIVE                               |</span><br><span class="line">| subnets                   |                                      |</span><br><span class="line">| updated_at                | 2017-08-28T03:25:26Z                 |</span><br><span class="line">+---------------------------+--------------------------------------+</span><br><span class="line"></span><br><span class="line">// or neutron cli</span><br><span class="line"></span><br><span class="line">$ neutron net-create provider-101 --shared  --external\</span><br><span class="line">  --provider:physical_network provider --provider:network_type vlan \</span><br><span class="line">  --provider:segmentation_id 101</span><br><span class="line">Created a new network:</span><br><span class="line">+---------------------------+--------------------------------------+</span><br><span class="line">| Field                     | Value                                |</span><br><span class="line">+---------------------------+--------------------------------------+</span><br><span class="line">| admin_state_up            | True                                 |</span><br><span class="line">| id                        | 572a3fc9-ad1f-4e54-a63a-4bf5047c1a4a |</span><br><span class="line">| name                      | provider-101                         |</span><br><span class="line">| provider:network_type     | vlan                                 |</span><br><span class="line">| provider:physical_network | provider                             |</span><br><span class="line">| provider:segmentation_id  | 101                                  |</span><br><span class="line">| router:external           | True                                |</span><br><span class="line">| shared                    | True                                 |</span><br><span class="line">| status                    | ACTIVE                               |</span><br><span class="line">| subnets                   |                                      |</span><br><span class="line">| tenant_id                 | e0bddbc9210d409795887175341b7098     |</span><br><span class="line">+---------------------------+--------------------------------------+</span><br></pre></td></tr></table></figure>
<blockquote>
<p> Note: The <code>shared</code> option allows any project to use this network.</p>
</blockquote>
</li>
<li><p>Create a subnet on the provider network:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@controller:~<span class="comment"># openstack subnet create --network provider-vlan-101 --allocation-pool start=172.16.0.100,end=172.16.0.200  --gateway 172.16.0.1   --subnet-range 172.16.0.0/24 provider-vlan-101</span></span><br><span class="line">+-------------------+--------------------------------------+</span><br><span class="line">| Field             | Value                                |</span><br><span class="line">+-------------------+--------------------------------------+</span><br><span class="line">| allocation_pools  | 172.16.0.100-172.16.0.200            |</span><br><span class="line">| cidr              | 172.16.0.0/24                        |</span><br><span class="line">| created_at        | 2017-08-28T03:32:06Z                 |</span><br><span class="line">| description       |                                      |</span><br><span class="line">| dns_nameservers   |                                      |</span><br><span class="line">| enable_dhcp       | True                                 |</span><br><span class="line">| gateway_ip        | 172.16.0.1                           |</span><br><span class="line">| host_routes       |                                      |</span><br><span class="line">| id                | 61693a58-a984-4f7b-9097-dd5e489a88bd |</span><br><span class="line">| ip_version        | 4                                    |</span><br><span class="line">| ipv6_address_mode | None                                 |</span><br><span class="line">| ipv6_ra_mode      | None                                 |</span><br><span class="line">| name              | provider-vlan-101                    |</span><br><span class="line">| network_id        | 2a33434f-ba29-4645-9b5d-24f1509066f1 |</span><br><span class="line">| project_id        | 78c9c849237649a3a8c4526167427589     |</span><br><span class="line">| revision_number   | 2                                    |</span><br><span class="line">| segment_id        | None                                 |</span><br><span class="line">| service_types     |                                      |</span><br><span class="line">| subnetpool_id     | None                                 |</span><br><span class="line">| updated_at        | 2017-08-28T03:32:06Z                 |</span><br><span class="line">+-------------------+--------------------------------------+</span><br><span class="line"></span><br><span class="line">// or via neutron cli</span><br><span class="line">$ neutron subnet-create provider-vlan-101 172.16.0.0/24  \</span><br><span class="line">  --name provider-101-subnet --gateway 172.16.0.1</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="Verify-network-operation"><a href="#Verify-network-operation" class="headerlink" title="Verify network operation"></a>Verify network operation</h3></li>
<li><p>On the controller node, verify creation of the <code>qdhcp</code> namespace:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ip netns</span><br><span class="line">qdhcp-8b868082-e312-4110-8627-298109d4401c</span><br></pre></td></tr></table></figure>
<p>Note: The <code>qdhcp</code> namespace might not exist until launching an instance.</p>
</li>
<li><p>Source the regular project credentials. The following steps use the <code>demo</code> project.</p>
</li>
<li><p>Create the appropriate security group rules to allow ping and SSH access to the instance. </p>
<blockquote>
<p>for OSC command referring to above chapters below is command for nova cli</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@controller:~<span class="comment"># openstack network list</span></span><br><span class="line">+--------------------------------------+-------------------+--------------------------------------+</span><br><span class="line">| ID                                   | Name              | Subnets                              |</span><br><span class="line">+--------------------------------------+-------------------+--------------------------------------+</span><br><span class="line">| 152a4a85-dc52-4c62-9bbd-742eb4f7b8fa | provider-vlan-101 | 91d305ac-762a-4062-b1da-8a55d7ebd735 |</span><br><span class="line">+--------------------------------------+-------------------+--------------------------------------+</span><br><span class="line">root@controller:~<span class="comment"># openstack server create --flavor m1.nano --image cirros   --nic net-id=152a4a85-dc52-4c62-9bbd-742eb4f7b8fa --security-group default provider-vlan-instance</span></span><br><span class="line">+-------------------------------------+-----------------------------------------------+</span><br><span class="line">| Field                               | Value                                         |</span><br><span class="line">+-------------------------------------+-----------------------------------------------+</span><br><span class="line">| OS-DCF:diskConfig                   | MANUAL                                        |</span><br><span class="line">| OS-EXT-AZ:availability_zone         |                                               |</span><br><span class="line">| OS-EXT-SRV-ATTR:host                | None                                          |</span><br><span class="line">| OS-EXT-SRV-ATTR:hypervisor_hostname | None                                          |</span><br><span class="line">| OS-EXT-SRV-ATTR:instance_name       |                                               |</span><br><span class="line">| OS-EXT-STS:power_state              | NOSTATE                                       |</span><br><span class="line">| OS-EXT-STS:task_state               | scheduling                                    |</span><br><span class="line">| OS-EXT-STS:vm_state                 | building                                      |</span><br><span class="line">| OS-SRV-USG:launched_at              | None                                          |</span><br><span class="line">| OS-SRV-USG:terminated_at            | None                                          |</span><br><span class="line">| accessIPv4                          |                                               |</span><br><span class="line">| accessIPv6                          |                                               |</span><br><span class="line">| addresses                           |                                               |</span><br><span class="line">| adminPass                           | e9YKhRWy7XmN                                  |</span><br><span class="line">| config_drive                        |                                               |</span><br><span class="line">| created                             | 2017-08-28T03:44:10Z                          |</span><br><span class="line">| flavor                              | m1.nano (0)                                   |</span><br><span class="line">| hostId                              |                                               |</span><br><span class="line">| id                                  | 2b78d9ee-3476-4e6b-9c4e-09ad2b7f115e          |</span><br><span class="line">| image                               | cirros (c17e391e-93e1-4480-9cf3-bf8623063e61) |</span><br><span class="line">| key_name                            | None                                          |</span><br><span class="line">| name                                | provider-vlan-instance                        |</span><br><span class="line">| progress                            | 0                                             |</span><br><span class="line">| project_id                          | 78c9c849237649a3a8c4526167427589              |</span><br><span class="line">| properties                          |                                               |</span><br><span class="line">| security_groups                     | name=<span class="string">&#x27;default&#x27;</span>                                |</span><br><span class="line">| status                              | BUILD                                         |</span><br><span class="line">| updated                             | 2017-08-28T03:44:10Z                          |</span><br><span class="line">| user_id                             | d8efd16c30904a7992010abe4bdb9a2b              |</span><br><span class="line">| volumes_attached                    |                                               |</span><br><span class="line">+-------------------------------------+-----------------------------------------------+</span><br></pre></td></tr></table></figure></li>
<li><p>Launch an instance with an interface on the provider network.</p>
<p>Note</p>
<p>This example uses a CirrOS image that was manually uploaded into the Image Service</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ nova boot --flavor m1.tiny --image cirros-0.3.3-x86_64-disk test_server</span><br><span class="line">+--------------------------------------+-----------------------------------------------------------------+</span><br><span class="line">| Property                             | Value                                                           |</span><br><span class="line">+--------------------------------------+-----------------------------------------------------------------+</span><br><span class="line">| OS-DCF:diskConfig                    | MANUAL                                                          |</span><br><span class="line">| OS-EXT-AZ:availability_zone          | nova                                                            |</span><br><span class="line">| OS-EXT-SRV-ATTR:host                 | -                                                               |</span><br><span class="line">| OS-EXT-SRV-ATTR:hypervisor_hostname  | -                                                               |</span><br><span class="line">| OS-EXT-SRV-ATTR:instance_name        | instance-00000001                                               |</span><br><span class="line">| OS-EXT-STS:power_state               | 0                                                               |</span><br><span class="line">| OS-EXT-STS:task_state                | scheduling                                                      |</span><br><span class="line">| OS-EXT-STS:vm_state                  | building                                                        |</span><br><span class="line">| OS-SRV-USG:launched_at               | -                                                               |</span><br><span class="line">| OS-SRV-USG:terminated_at             | -                                                               |</span><br><span class="line">| accessIPv4                           |                                                                 |</span><br><span class="line">| accessIPv6                           |                                                                 |</span><br><span class="line">| adminPass                            | h7CkMdkRXuuh                                                    |</span><br><span class="line">| config_drive                         |                                                                 |</span><br><span class="line">| created                              | 2015-07-22T20:40:16Z                                            |</span><br><span class="line">| flavor                               | m1.tiny (1)                                                     |</span><br><span class="line">| hostId                               |                                                                 |</span><br><span class="line">| id                                   | dee2a9f4-e24c-444d-8c94-386f11f74af5                            |</span><br><span class="line">| image                                | cirros-0.3.3-x86_64-disk (2b6bb38f-f69f-493c-a1c0-264dfd4188d8) |</span><br><span class="line">| key_name                             | -                                                               |</span><br><span class="line">| metadata                             | &#123;&#125;                                                              |</span><br><span class="line">| name                                 | test_server                                                     |</span><br><span class="line">| os-extended-volumes:volumes_attached | []                                                              |</span><br><span class="line">| progress                             | 0                                                               |</span><br><span class="line">| security_groups                      | default                                                         |</span><br><span class="line">| status                               | BUILD                                                           |</span><br><span class="line">| tenant_id                            | 5f2db133e98e4bc2999ac2850ce2acd1                                |</span><br><span class="line">| updated                              | 2015-07-22T20:40:16Z                                            |</span><br><span class="line">| user_id                              | ea417ebfa86741af86f84a5dbcc97cd2                                |</span><br><span class="line">+--------------------------------------+-----------------------------------------------------------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>Determine the IP address of the instance. The following step uses 203.0.113.3.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ nova list</span><br><span class="line">+--------------------------------------+-------------+--------+------------+-------------+--------------------------+</span><br><span class="line">| ID                                   | Name        | Status | Task State | Power State | Networks                 |</span><br><span class="line">+--------------------------------------+-------------+--------+------------+-------------+--------------------------+</span><br><span class="line">| dee2a9f4-e24c-444d-8c94-386f11f74af5 | test_server | ACTIVE | -          | Running     | provider-101=203.0.113.3 |</span><br><span class="line">+--------------------------------------+-------------+--------+------------+-------------+--------------------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>On the controller node or any host with access to the provider network, ping the IP address of the instance:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ping -c 4 203.0.113.3</span><br><span class="line">PING 203.0.113.3 (203.0.113.3) 56(84) bytes of data.</span><br><span class="line">64 bytes from 203.0.113.3: icmp_req=1 ttl=63 time=3.18 ms</span><br><span class="line">64 bytes from 203.0.113.3: icmp_req=2 ttl=63 time=0.981 ms</span><br><span class="line">64 bytes from 203.0.113.3: icmp_req=3 ttl=63 time=1.06 ms</span><br><span class="line">64 bytes from 203.0.113.3: icmp_req=4 ttl=63 time=0.929 ms</span><br><span class="line"></span><br><span class="line">--- 203.0.113.3 ping statistics ---</span><br><span class="line">4 packets transmitted, 4 received, 0% packet loss, time 3002ms</span><br><span class="line">rtt min/avg/max/mdev = 0.929/1.539/3.183/0.951 ms</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>Obtain access to the instance.</p>
</li>
<li><p>Test connectivity to the Internet:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ping -c 4 openstack.org</span><br><span class="line">PING openstack.org (174.143.194.225) 56(84) bytes of data.</span><br><span class="line">64 bytes from 174.143.194.225: icmp_req=1 ttl=53 time=17.4 ms</span><br><span class="line">64 bytes from 174.143.194.225: icmp_req=2 ttl=53 time=17.5 ms</span><br><span class="line">64 bytes from 174.143.194.225: icmp_req=3 ttl=53 time=17.7 ms</span><br><span class="line">64 bytes from 174.143.194.225: icmp_req=4 ttl=53 time=17.5 ms</span><br><span class="line"></span><br><span class="line">--- openstack.org ping statistics ---</span><br><span class="line">4 packets transmitted, 4 received, 0% packet loss, time 3003ms</span><br><span class="line">rtt min/avg/max/mdev = 17.431/17.575/17.734/0.143 ms</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="ISSUE-Troubleshooting-vlan-dhcp"><a href="#ISSUE-Troubleshooting-vlan-dhcp" class="headerlink" title="[ISSUE] Troubleshooting vlan dhcp"></a>[ISSUE] Troubleshooting vlan dhcp</h2><p>console to vm, it’s blocked on dhcp discover, after dhcp failure, metadata network is not ok as well…</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@compute:~<span class="comment"># virsh console 1</span></span><br><span class="line">Connected to domain instance-00000008</span><br><span class="line">Escape character is ^]</span><br><span class="line"></span><br><span class="line">Sending discover...</span><br><span class="line">Usage: /sbin/cirros-dhcpc &lt;up|down&gt;</span><br><span class="line">No lease, failing</span><br><span class="line">WARN: /etc/rc3.d/S40-network failed</span><br><span class="line">cirros-ds <span class="string">&#x27;net&#x27;</span> up at 187.22</span><br><span class="line">checking http://169.254.169.254/2009-04-04/instance-id</span><br><span class="line">failed 1/20: up 187.48. request failed</span><br><span class="line">failed 2/20: up 189.90. request failed</span><br><span class="line">failed 3/20: up 192.04. request failed</span><br><span class="line">failed 4/20: up 194.30. request failed</span><br><span class="line">failed 5/20: up 196.44. request failed</span><br><span class="line">failed 6/20: up 198.55. request failed</span><br><span class="line">failed 7/20: up 200.80. request failed</span><br><span class="line">failed 8/20: up 202.97. request failed</span><br><span class="line">failed 9/20: up 205.13. request failed</span><br><span class="line">failed 10/20: up 207.37. request failed</span><br><span class="line">failed 11/20: up 209.54. request failed</span><br><span class="line">failed 12/20: up 211.67. request failed</span><br><span class="line">failed 13/20: up 213.91. request failed</span><br><span class="line">failed 14/20: up 216.05. request failed</span><br><span class="line">failed 15/20: up 218.21. request failed</span><br><span class="line">failed 16/20: up 220.49. request failed</span><br><span class="line">failed 17/20: up 222.61. request failed</span><br><span class="line">failed 18/20: up 224.75. request failed</span><br><span class="line">failed 19/20: up 227.00. request failed</span><br><span class="line">failed 20/20: up 229.12. request failed</span><br><span class="line">failed to <span class="built_in">read</span> iid from metadata. tried 20</span><br></pre></td></tr></table></figure>
<p>from compute nothing received after discover sent out</p>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@compute:~<span class="comment"># tcpdump -i  brq152a4a85-dc -vv port 67 or port 68 -e -n</span></span><br><span class="line">tcpdump: listening on brq152a4a85-dc, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">11:56:52.659297 fa:16:3e:66:84:cc &gt; ff:ff:ff:ff:ff:ff, ethertype IPv4 (0x0800), length 332: (tos 0x0, ttl 64, id 0, offset 0, flags [none], proto UDP (17), length 318)</span><br><span class="line">    0.0.0.0.68 &gt; 255.255.255.255.67: [udp sum ok] BOOTP/DHCP, Request from fa:16:3e:66:84:cc, length 290, xid 0xd0ed70a, Flags [none] (0x0000)</span><br><span class="line">          Client-Ethernet-Address fa:16:3e:66:84:cc</span><br><span class="line">          Vendor-rfc1048 Extensions</span><br><span class="line">            Magic Cookie 0x63825363</span><br><span class="line">            DHCP-Message Option 53, length 1: Discover</span><br><span class="line">            Client-ID Option 61, length 7: ether fa:16:3e:66:84:cc</span><br><span class="line">            MSZ Option 57, length 2: 576</span><br><span class="line">            Parameter-Request Option 55, length 9:</span><br><span class="line">              Subnet-Mask, Default-Gateway, Domain-Name-Server, Hostname</span><br><span class="line">              Domain-Name, MTU, BR, NTP</span><br><span class="line">              Classless-Static-Route</span><br><span class="line">            Vendor-Class Option 60, length 12: <span class="string">&quot;udhcp 1.20.1&quot;</span></span><br><span class="line">            Hostname Option 12, length 6: <span class="string">&quot;cirros&quot;</span></span><br><span class="line">11:57:52.726797 fa:16:3e:66:84:cc &gt; ff:ff:ff:ff:ff:ff, ethertype IPv4 (0x0800), length 332: (tos 0x0, ttl 64, id 0, offset 0, flags [none], proto UDP (17), length 318)</span><br><span class="line">    0.0.0.0.68 &gt; 255.255.255.255.67: [udp sum ok] BOOTP/DHCP, Request from fa:16:3e:66:84:cc, length 290, xid 0xd0ed70a, secs 60, Flags [none] (0x0000)</span><br><span class="line">          Client-Ethernet-Address fa:16:3e:66:84:cc</span><br><span class="line">          Vendor-rfc1048 Extensions</span><br><span class="line">            Magic Cookie 0x63825363</span><br><span class="line">            DHCP-Message Option 53, length 1: Discover</span><br><span class="line">            Client-ID Option 61, length 7: ether fa:16:3e:66:84:cc</span><br><span class="line">            MSZ Option 57, length 2: 576</span><br><span class="line">            Parameter-Request Option 55, length 9:</span><br><span class="line">              Subnet-Mask, Default-Gateway, Domain-Name-Server, Hostname</span><br><span class="line">              Domain-Name, MTU, BR, NTP</span><br><span class="line">              Classless-Static-Route</span><br><span class="line">            Vendor-Class Option 60, length 12: <span class="string">&quot;udhcp 1.20.1&quot;</span></span><br><span class="line">            Hostname Option 12, length 6: <span class="string">&quot;cirros&quot;</span></span><br></pre></td></tr></table></figure>
<p>While it had been sent out from dhcp agent “DHCP OFFER”</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">tcpdump: listening on brq152a4a85-dc, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">11:56:52.259801 fa:16:3e:66:84:cc &gt; ff:ff:ff:ff:ff:ff, ethertype IPv4 (0x0800), length 332: (tos 0x0, ttl 64, id 0, offset 0, flags [none], proto UDP (17), length 318)</span><br><span class="line">    0.0.0.0.68 &gt; 255.255.255.255.67: [udp sum ok] BOOTP/DHCP, Request from fa:16:3e:66:84:cc, length 290, xid 0xd0ed70a, Flags [none] (0x0000)</span><br><span class="line">          Client-Ethernet-Address fa:16:3e:66:84:cc</span><br><span class="line">          Vendor-rfc1048 Extensions</span><br><span class="line">            Magic Cookie 0x63825363</span><br><span class="line">            DHCP-Message Option 53, length 1: Discover</span><br><span class="line">            Client-ID Option 61, length 7: ether fa:16:3e:66:84:cc</span><br><span class="line">            MSZ Option 57, length 2: 576</span><br><span class="line">            Parameter-Request Option 55, length 9:</span><br><span class="line">              Subnet-Mask, Default-Gateway, Domain-Name-Server, Hostname</span><br><span class="line">              Domain-Name, MTU, BR, NTP</span><br><span class="line">              Classless-Static-Route</span><br><span class="line">            Vendor-Class Option 60, length 12: <span class="string">&quot;udhcp 1.20.1&quot;</span></span><br><span class="line">            Hostname Option 12, length 6: <span class="string">&quot;cirros&quot;</span></span><br><span class="line">11:56:52.261241 fa:16:3e:56:9f:61 &gt; fa:16:3e:66:84:cc, ethertype IPv4 (0x0800), length 370: (tos 0xc0, ttl 64, id 11060, offset 0, flags [none], proto UDP (17), length 356)</span><br><span class="line">    172.16.0.100.67 &gt; 172.16.0.105.68: [udp sum ok] BOOTP/DHCP, Reply, length 328, xid 0xd0ed70a, Flags [none] (0x0000)</span><br><span class="line">          Your-IP 172.16.0.105</span><br><span class="line">          Server-IP 172.16.0.100</span><br><span class="line">          Client-Ethernet-Address fa:16:3e:66:84:cc</span><br><span class="line">          Vendor-rfc1048 Extensions</span><br><span class="line">            Magic Cookie 0x63825363</span><br><span class="line">            DHCP-Message Option 53, length 1: Offer</span><br><span class="line">            Server-ID Option 54, length 4: 172.16.0.100</span><br><span class="line">            Lease-Time Option 51, length 4: 86400</span><br><span class="line">            RN Option 58, length 4: 43200</span><br><span class="line">            RB Option 59, length 4: 75600</span><br><span class="line">            Subnet-Mask Option 1, length 4: 255.255.255.0</span><br><span class="line">            BR Option 28, length 4: 172.16.0.255</span><br><span class="line">            Domain-Name-Server Option 6, length 4: 172.16.0.100</span><br><span class="line">            Domain-Name Option 15, length 14: <span class="string">&quot;openstacklocal&quot;</span></span><br><span class="line">            Default-Gateway Option 3, length 4: 172.16.0.1</span><br><span class="line">            Classless-Static-Route Option 121, length 14: (169.254.169.254/32:172.16.0.100),(default:172.16.0.1)</span><br><span class="line">            MTU Option 26, length 2: 1500</span><br></pre></td></tr></table></figure>
<p>The network configured in virtualbox was not in promiscuous mode caus</p>
<p>succeeded:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">udhcpc (v1.20.1) started</span><br><span class="line">Sending discover...</span><br><span class="line">Sending discover...</span><br><span class="line">Sending select <span class="keyword">for</span> 172.16.0.105...</span><br><span class="line">Lease of 172.16.0.105 obtained, lease time 86400</span><br><span class="line">route: SIOCADDRT: File exists</span><br><span class="line">WARN: failed: route add -net <span class="string">&quot;0.0.0.0/0&quot;</span> gw <span class="string">&quot;172.16.0.1&quot;</span></span><br><span class="line">cirros-ds <span class="string">&#x27;net&#x27;</span> up at 74.67</span><br><span class="line">checking http://169.254.169.254/2009-04-04/instance-id</span><br><span class="line">successful after 1/20 tries: up 75.02. iid=i-00000009</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>openstack</category>
      </categories>
      <tags>
        <tag>openstack</tag>
      </tags>
  </entry>
</search>
